setup:
    sudo apt install -y network-manager firewalld dnsmasq-base avahi-utils
    sudo cp public.xml /etc/firewalld/zones/
    sudo cp nm-shared.xml /etc/firewalld/zones/
    sudo systemctl enable NetworkManager firewalld
    sudo cp -r cfg80211_regdomain.conf /etc/modprobe.d/
    sudo cp wlan0-hotspot.ini /etc/NetworkManager/system-connections/wlan0-hotspot.nmconnection
    # "failed to load connection: File permissions (100644) are insecure"
    sudo chmod 0600 /etc/NetworkManager/system-connections/wlan0-hotspot.nmconnection
    # By default we are greeted with
    # "Wi-Fi is currently blocked by rfkill.
    # Enable wifi, country is unset, user will set it.
    # See https://github.com/RPi-Distro/raspberrypi-net-mods/blob/master/etc/profile.d/wifi-check.sh
    sudo rm -f /etc/profile.d/wifi-check.sh

    # Enable wifi by default
    sudo cp wifi.sh /etc/profile.d

    wget https://github.com/grishy/go-avahi-cname/releases/download/v2.2.5/go-avahi-cname_2.2.5_linux_arm64.tar.gz -P /tmp
    cd /tmp && tar -xzf /tmp/go-avahi-cname_2.2.5_linux_arm64.tar.gz go-avahi-cname
    # cp: cannot create regular file '/usr/bin/go-avahi-cname': Text file busy
    sudo killall go-avahi-cname || true
    sleep 1
    sudo cp /tmp/go-avahi-cname /usr/bin/go-avahi-cname
    sudo cp avahi-publish-cname@.service /usr/lib/systemd/system
    sudo systemctl enable avahi-publish-cname@planktoscope.local.service
    sudo systemctl enable avahi-publish-cname@pkscope.local.service

    sudo cp hosts /etc/
    sudo cp dnsmasq-shared.properties /etc/NetworkManager/dnsmasq-shared.d/40-config.conf
    sudo ./setup-hostname.sh

format:
    just --fmt --unstable

test:
    just --fmt --check --unstable
    validator nm-shared.xml
    validator public.xml
    validator wlan0-hotspot.ini
    validator dnsmasq-shared.properties
