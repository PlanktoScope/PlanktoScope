[
    {
        "id": "1b667c6443413ced",
        "type": "tab",
        "label": "Home dashboard2",
        "disabled": false,
        "info": "",
        "env": []
    },
    {
        "id": "ab58b3fd0e6bcd77",
        "type": "tab",
        "label": "Preview",
        "disabled": false,
        "info": "",
        "env": []
    },
    {
        "id": "190b0c9aa75e8843",
        "type": "tab",
        "label": "Metadata",
        "disabled": false,
        "info": "",
        "env": []
    },
    {
        "id": "35d7387466dd0bc0",
        "type": "tab",
        "label": "Acquisition",
        "disabled": false,
        "info": "",
        "env": []
    },
    {
        "id": "0fd76ac156d78937",
        "type": "tab",
        "label": "Segmentation",
        "disabled": false,
        "info": "",
        "env": []
    },
    {
        "id": "14f8c9b5ce1235cc",
        "type": "tab",
        "label": "Visualization",
        "disabled": false,
        "info": "",
        "env": []
    },
    {
        "id": "8555b76c53e789e0",
        "type": "tab",
        "label": "[TEST] EcoTaxa",
        "disabled": false,
        "info": "",
        "env": []
    },
    {
        "id": "8018bd5586fd4054",
        "type": "tab",
        "label": "Calibration",
        "disabled": false,
        "info": "",
        "env": []
    },
    {
        "id": "6426e7bea6900426",
        "type": "tab",
        "label": "Calibration - Saturation Level",
        "disabled": false,
        "info": "",
        "env": []
    },
    {
        "id": "14c685bd04db8be5",
        "type": "tab",
        "label": "Calibration - Lightness",
        "disabled": false,
        "info": "",
        "env": []
    },
    {
        "id": "3afb1d2b21be9114",
        "type": "tab",
        "label": "Calibration - Pixel size",
        "disabled": false,
        "info": "",
        "env": []
    },
    {
        "id": "d5b2c64b84f8ed4f",
        "type": "tab",
        "label": "Calibration - Pump",
        "disabled": false,
        "info": "",
        "env": []
    },
    {
        "id": "a02961610bc3982a",
        "type": "tab",
        "label": "[TEST] PlanktoScope nodes",
        "disabled": false,
        "info": "",
        "env": []
    },
    {
        "id": "4ed26b8b.253504",
        "type": "subflow",
        "name": "Save hardware config",
        "info": "",
        "category": "",
        "in": [
            {
                "x": 40,
                "y": 40,
                "wires": [
                    {
                        "id": "53d163be.47cf24"
                    }
                ]
            }
        ],
        "out": [],
        "env": [],
        "meta": {},
        "color": "#DDAA99"
    },
    {
        "id": "b7861ce703215a01",
        "type": "subflow",
        "name": "Load hardware config",
        "info": "",
        "category": "",
        "in": [
            {
                "x": 40,
                "y": 40,
                "wires": [
                    {
                        "id": "0f16258953fae292"
                    }
                ]
            }
        ],
        "out": [
            {
                "x": 900,
                "y": 40,
                "wires": [
                    {
                        "id": "d0fbcd200cd09981",
                        "port": 0
                    }
                ]
            }
        ],
        "env": [],
        "meta": {},
        "color": "#DDAA99"
    },
    {
        "id": "63c85b96537b7355",
        "type": "subflow",
        "name": "Config",
        "info": "An input to this subflow will get the configuration to be saved to disk.\n\nOn startup, this node outputs the loaded configuration",
        "category": "",
        "in": [
            {
                "x": 220,
                "y": 160,
                "wires": [
                    {
                        "id": "5248e5e225d854d1"
                    }
                ]
            }
        ],
        "out": [
            {
                "x": 1040,
                "y": 60,
                "wires": [
                    {
                        "id": "f1c0a882a9e3d927",
                        "port": 0
                    }
                ]
            }
        ],
        "env": [],
        "color": "#DDAA99"
    },
    {
        "id": "f591255fbfc6c466",
        "type": "group",
        "z": "6426e7bea6900426",
        "name": "Step Bar",
        "style": {
            "label": true
        },
        "nodes": [
            "062a3af5e12e8445",
            "e5da27b9abdcb156"
        ],
        "x": 994,
        "y": 19,
        "w": 372,
        "h": 82
    },
    {
        "id": "da1cb3ed0c90bb56",
        "type": "group",
        "z": "3afb1d2b21be9114",
        "name": "Step Bar",
        "style": {
            "label": true
        },
        "nodes": [
            "05a5a9c4530d07ea",
            "419cccaf23eb2548"
        ],
        "x": 994,
        "y": 19,
        "w": 372,
        "h": 82
    },
    {
        "id": "0861054b07c3373d",
        "type": "group",
        "z": "d5b2c64b84f8ed4f",
        "name": "Step Bar",
        "style": {
            "label": true
        },
        "nodes": [
            "c92cd7e25b01278d",
            "f8db1578262f6bc8"
        ],
        "x": 994,
        "y": 19,
        "w": 372,
        "h": 82
    },
    {
        "id": "426f6cef77fbb290",
        "type": "group",
        "z": "14c685bd04db8be5",
        "name": "Step Bar",
        "style": {
            "label": true
        },
        "nodes": [
            "5fbdba7e61973f9a",
            "25cb0163587aee15"
        ],
        "x": 994,
        "y": 19,
        "w": 372,
        "h": 82
    },
    {
        "id": "3bb20cd87e85a6b8",
        "type": "group",
        "z": "a02961610bc3982a",
        "style": {
            "stroke": "#999999",
            "stroke-opacity": "1",
            "fill": "none",
            "fill-opacity": "1",
            "label": true,
            "label-position": "nw",
            "color": "#a4a4a4"
        },
        "nodes": [
            "abc662f31074fc22",
            "d082d59bfaddcd80",
            "9f5061a034f606a3",
            "1f6f854383bffbc8",
            "0e1835e8b7c470ee"
        ],
        "x": 14,
        "y": 19,
        "w": 752,
        "h": 202
    },
    {
        "id": "153af3e4645145a8",
        "type": "group",
        "z": "a02961610bc3982a",
        "style": {
            "stroke": "#999999",
            "stroke-opacity": "1",
            "fill": "none",
            "fill-opacity": "1",
            "label": true,
            "label-position": "nw",
            "color": "#a4a4a4"
        },
        "nodes": [
            "7ccb5c8c66ad170a",
            "7bf0f35f3f491657",
            "89c198d4d49eca98",
            "2fe0de4d0d304630",
            "bcdab829fb50bc57"
        ],
        "x": 14,
        "y": 239,
        "w": 812,
        "h": 202
    },
    {
        "id": "cef91df1f697848e",
        "type": "group",
        "z": "a02961610bc3982a",
        "style": {
            "stroke": "#999999",
            "stroke-opacity": "1",
            "fill": "none",
            "fill-opacity": "1",
            "label": true,
            "label-position": "nw",
            "color": "#a4a4a4"
        },
        "nodes": [
            "29b3163c363f83d7",
            "19da48e7c9119862",
            "28f8ab1b6c179786",
            "4966524cdc764174",
            "f640495d00bb68b9"
        ],
        "x": 14,
        "y": 459,
        "w": 932,
        "h": 182
    },
    {
        "id": "3fe3efd04fb1a41a",
        "type": "group",
        "z": "a02961610bc3982a",
        "style": {
            "stroke": "#999999",
            "stroke-opacity": "1",
            "fill": "none",
            "fill-opacity": "1",
            "label": true,
            "label-position": "nw",
            "color": "#a4a4a4"
        },
        "nodes": [
            "1433d7bb97c2b52e",
            "58b352badddb48f5",
            "1f1c86a14bf3ac61"
        ],
        "x": 14,
        "y": 659,
        "w": 372,
        "h": 142
    },
    {
        "id": "9c49d230dea06fdf",
        "type": "group",
        "z": "a02961610bc3982a",
        "style": {
            "stroke": "#999999",
            "stroke-opacity": "1",
            "fill": "none",
            "fill-opacity": "1",
            "label": true,
            "label-position": "nw",
            "color": "#a4a4a4"
        },
        "nodes": [
            "79d35d7ad73f89f9",
            "39cd9534b43ef484",
            "7e293f564d4fbfc4"
        ],
        "x": 14,
        "y": 819,
        "w": 372,
        "h": 142
    },
    {
        "id": "27e22d982f0bcb2f",
        "type": "group",
        "z": "a02961610bc3982a",
        "style": {
            "stroke": "#999999",
            "stroke-opacity": "1",
            "fill": "none",
            "fill-opacity": "1",
            "label": true,
            "label-position": "nw",
            "color": "#a4a4a4"
        },
        "nodes": [
            "959839bc2c390088",
            "0d10e66bb2b9d1cc",
            "53516cda8e4f5a3c"
        ],
        "x": 414,
        "y": 819,
        "w": 352,
        "h": 142
    },
    {
        "id": "fc6b573a63d6dfaa",
        "type": "group",
        "z": "a02961610bc3982a",
        "style": {
            "stroke": "#999999",
            "stroke-opacity": "1",
            "fill": "none",
            "fill-opacity": "1",
            "label": true,
            "label-position": "nw",
            "color": "#a4a4a4"
        },
        "nodes": [
            "c34bff0e83b45e68",
            "dc07c747a235da10",
            "f12fd63508bb1b63",
            "2babe27c1bf9d6ef",
            "15f16463c05bb479",
            "b552ca516cc07737",
            "94a433cec8b54203"
        ],
        "x": 934,
        "y": 39,
        "w": 352,
        "h": 262
    },
    {
        "id": "dc792afbab434446",
        "type": "group",
        "z": "a02961610bc3982a",
        "style": {
            "stroke": "#999999",
            "stroke-opacity": "1",
            "fill": "none",
            "fill-opacity": "1",
            "label": true,
            "label-position": "nw",
            "color": "#a4a4a4"
        },
        "nodes": [
            "50128147f802f133",
            "b9c2e0abaad12bd9",
            "61ebceb724041fb2"
        ],
        "x": 994,
        "y": 499,
        "w": 412,
        "h": 142
    },
    {
        "id": "dc307bb5d26c60f4",
        "type": "group",
        "z": "a02961610bc3982a",
        "style": {
            "stroke": "#999999",
            "stroke-opacity": "1",
            "fill": "none",
            "fill-opacity": "1",
            "label": true,
            "label-position": "nw",
            "color": "#a4a4a4"
        },
        "nodes": [
            "300343e6b56f088e",
            "da645aa8ebbed646",
            "7d1f9414be49d7c3"
        ],
        "x": 994,
        "y": 659,
        "w": 412,
        "h": 142
    },
    {
        "id": "855d9ef468b5db0f",
        "type": "group",
        "z": "a02961610bc3982a",
        "style": {
            "stroke": "#999999",
            "stroke-opacity": "1",
            "fill": "none",
            "fill-opacity": "1",
            "label": true,
            "label-position": "nw",
            "color": "#a4a4a4"
        },
        "nodes": [
            "f7c18ab2aa687120",
            "ede7a86fd97b5e1b",
            "af8ce4702c170449",
            "9249e16ed7ae4929"
        ],
        "x": 14,
        "y": 979,
        "w": 562,
        "h": 162
    },
    {
        "id": "91f8b76bf61fc59c",
        "type": "group",
        "z": "a02961610bc3982a",
        "style": {
            "stroke": "#999999",
            "stroke-opacity": "1",
            "fill": "none",
            "fill-opacity": "1",
            "label": true,
            "label-position": "nw",
            "color": "#a4a4a4"
        },
        "nodes": [
            "a98bde5f8940edbc",
            "59ec9623add53a47",
            "750a1061c84bdae2"
        ],
        "x": 994,
        "y": 819,
        "w": 412,
        "h": 142
    },
    {
        "id": "e6ae26617c24c3ea",
        "type": "ui-base",
        "name": "PlanktoScope",
        "path": "/dashboard",
        "appIcon": "",
        "includeClientData": true,
        "acceptsClientConfig": [
            "ui-notification",
            "ui-control"
        ],
        "showPathInSidebar": true,
        "headerContent": "dashboard",
        "navigationStyle": "none",
        "titleBarStyle": "fixed",
        "showReconnectNotification": true,
        "notificationDisplayTime": "1",
        "showDisconnectNotification": true,
        "allowInstall": true
    },
    {
        "id": "8dc3722c.06efa8",
        "type": "mqtt-broker",
        "name": "",
        "broker": "0.0.0.0",
        "port": "1883",
        "clientid": "Client_node",
        "autoConnect": true,
        "usetls": false,
        "compatmode": false,
        "protocolVersion": 4,
        "keepalive": "60",
        "cleansession": true,
        "birthTopic": "",
        "birthQos": "0",
        "birthPayload": "",
        "closeTopic": "",
        "closeQos": "0",
        "closePayload": "",
        "willTopic": "",
        "willQos": "0",
        "willPayload": ""
    },
    {
        "id": "81a80e32347ff991",
        "type": "ui_base",
        "theme": {
            "name": "theme-light",
            "lightTheme": {
                "default": "#0094CE",
                "baseColor": "#5900ce",
                "baseFont": "-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen-Sans,Ubuntu,Cantarell,Helvetica Neue,sans-serif",
                "edited": true,
                "reset": false
            },
            "darkTheme": {
                "default": "#097479",
                "baseColor": "#097479",
                "baseFont": "-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen-Sans,Ubuntu,Cantarell,Helvetica Neue,sans-serif",
                "edited": true,
                "reset": false
            },
            "customTheme": {
                "name": "Untitled Theme 1",
                "default": "#4B7930",
                "baseColor": "#4B7930",
                "baseFont": "-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen-Sans,Ubuntu,Cantarell,Helvetica Neue,sans-serif"
            },
            "themeState": {
                "base-color": {
                    "default": "#0094CE",
                    "value": "#0094CE",
                    "edited": true
                },
                "page-titlebar-backgroundColor": {
                    "value": "#5900ce",
                    "edited": false
                },
                "page-backgroundColor": {
                    "value": "#fafafa",
                    "edited": false
                },
                "page-sidebar-backgroundColor": {
                    "value": "#333333",
                    "edited": false
                },
                "group-textColor": {
                    "value": "#7e1bff",
                    "edited": false
                },
                "group-borderColor": {
                    "value": "#ffffff",
                    "edited": false
                },
                "group-backgroundColor": {
                    "value": "#ffffff",
                    "edited": false
                },
                "widget-textColor": {
                    "value": "#111111",
                    "edited": false
                },
                "widget-backgroundColor": {
                    "value": "#5900ce",
                    "edited": false
                },
                "widget-borderColor": {
                    "value": "#ffffff",
                    "edited": false
                },
                "base-font": {
                    "value": "-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen-Sans,Ubuntu,Cantarell,Helvetica Neue,sans-serif"
                }
            },
            "angularTheme": {
                "primary": "indigo",
                "accents": "blue",
                "warn": "red",
                "background": "grey",
                "palette": "light"
            }
        },
        "site": {
            "name": "PlanktoScope",
            "hideToolbar": "false",
            "allowSwipe": "false",
            "lockMenu": "false",
            "allowTempTheme": "true",
            "dateFormat": "Y-MM-DD",
            "sizes": {
                "sx": 55,
                "sy": 55,
                "gx": 4,
                "gy": 4,
                "cx": 4,
                "cy": 4,
                "px": 4,
                "py": 4
            }
        }
    },
    {
        "id": "f7770f0b818c3a67",
        "type": "ui-theme",
        "name": "PlanktoScope GUI 2",
        "colors": {
            "surface": "#ffffff",
            "primary": "#1976d2",
            "bgPage": "#dedede",
            "groupBg": "#ffffff",
            "groupOutline": "#9c9c9c"
        },
        "sizes": {
            "density": "default",
            "pagePadding": "1rem",
            "groupGap": "1rem",
            "groupBorderRadius": "4px",
            "widgetGap": "0px"
        }
    },
    {
        "id": "73070e06474249b4",
        "type": "ui-page",
        "name": "Metadata",
        "ui": "e6ae26617c24c3ea",
        "path": "/metadata",
        "icon": "information-outline",
        "layout": "grid",
        "theme": "f7770f0b818c3a67",
        "breakpoints": [
            {
                "name": "Default",
                "px": "0",
                "cols": "3"
            },
            {
                "name": "Tablet",
                "px": "576",
                "cols": "6"
            },
            {
                "name": "Small Desktop",
                "px": "768",
                "cols": "9"
            },
            {
                "name": "Desktop",
                "px": "1024",
                "cols": "12"
            }
        ],
        "order": 3,
        "className": "",
        "visible": "true",
        "disabled": "false"
    },
    {
        "id": "dd015fda7456b9b0",
        "type": "ui-group",
        "name": "Navigation Top",
        "page": "73070e06474249b4",
        "width": "12",
        "height": 1,
        "order": 1,
        "showTitle": false,
        "className": "",
        "visible": "true",
        "disabled": "false",
        "groupType": "default"
    },
    {
        "id": "69c772603e9cec0d",
        "type": "ui-group",
        "name": "Sample Information",
        "page": "73070e06474249b4",
        "width": "12",
        "height": 1,
        "order": 2,
        "showTitle": true,
        "className": "",
        "visible": "true",
        "disabled": "false",
        "groupType": "default"
    },
    {
        "id": "6fab47af451c6d95",
        "type": "ui-group",
        "name": "Starting point",
        "page": "73070e06474249b4",
        "width": "6",
        "height": 1,
        "order": 3,
        "showTitle": true,
        "className": "",
        "visible": "true",
        "disabled": "false",
        "groupType": "default"
    },
    {
        "id": "1cfe3062a8353012",
        "type": "ui-group",
        "name": "Ending point",
        "page": "73070e06474249b4",
        "width": "6",
        "height": 1,
        "order": 4,
        "showTitle": true,
        "className": "",
        "visible": "true",
        "disabled": "false",
        "groupType": "default"
    },
    {
        "id": "cb3521392eb4e9ed",
        "type": "ui-group",
        "name": "Net Specificity",
        "page": "73070e06474249b4",
        "width": "12",
        "height": 1,
        "order": 5,
        "showTitle": true,
        "className": "",
        "visible": "true",
        "disabled": "false",
        "groupType": "default"
    },
    {
        "id": "dd4d9707051041c9",
        "type": "ui-group",
        "name": "Other informations",
        "page": "73070e06474249b4",
        "width": "12",
        "height": 1,
        "order": 6,
        "showTitle": true,
        "className": "",
        "visible": "true",
        "disabled": "false",
        "groupType": "default"
    },
    {
        "id": "59ce6abfbb7f8683",
        "type": "ui-group",
        "name": "Navigation Bottom",
        "page": "73070e06474249b4",
        "width": "12",
        "height": 1,
        "order": 7,
        "showTitle": false,
        "className": "",
        "visible": "true",
        "disabled": "false",
        "groupType": "default"
    },
    {
        "id": "7a4e042a60b734a6",
        "type": "ui-page",
        "name": "Segmentation",
        "ui": "e6ae26617c24c3ea",
        "path": "/segmentation",
        "icon": "crop",
        "layout": "grid",
        "theme": "f7770f0b818c3a67",
        "breakpoints": [
            {
                "name": "Default",
                "px": "0",
                "cols": "3"
            },
            {
                "name": "Tablet",
                "px": "576",
                "cols": "6"
            },
            {
                "name": "Small Desktop",
                "px": "768",
                "cols": "9"
            },
            {
                "name": "Desktop",
                "px": "1024",
                "cols": "12"
            }
        ],
        "order": 5,
        "className": "",
        "visible": "true",
        "disabled": "false"
    },
    {
        "id": "bfd4acb7b243514f",
        "type": "ui-group",
        "name": "Table",
        "page": "7a4e042a60b734a6",
        "width": "12",
        "height": 1,
        "order": 3,
        "showTitle": false,
        "className": "",
        "visible": "true",
        "disabled": "false",
        "groupType": "default"
    },
    {
        "id": "f22f627015431032",
        "type": "ui-page",
        "name": "Calibration - Lightness",
        "ui": "e6ae26617c24c3ea",
        "path": "/calibration_lightness",
        "icon": "target-variant",
        "layout": "grid",
        "theme": "f7770f0b818c3a67",
        "breakpoints": [
            {
                "name": "Default",
                "px": "0",
                "cols": "3"
            },
            {
                "name": "Tablet",
                "px": "576",
                "cols": "6"
            },
            {
                "name": "Small Desktop",
                "px": "768",
                "cols": "9"
            },
            {
                "name": "Desktop",
                "px": "1024",
                "cols": "12"
            }
        ],
        "order": 9,
        "className": "",
        "visible": "false",
        "disabled": "false"
    },
    {
        "id": "728c7ed3d63dfcee",
        "type": "ui-group",
        "name": "Settings",
        "page": "f22f627015431032",
        "width": "12",
        "height": "1",
        "order": 1,
        "showTitle": false,
        "className": "",
        "visible": "true",
        "disabled": "false",
        "groupType": "default"
    },
    {
        "id": "aa9ba6cedf56d2cd",
        "type": "ui-page",
        "name": "Calibration - Pixel size",
        "ui": "e6ae26617c24c3ea",
        "path": "/calibration_pixel_size",
        "icon": "target-variant",
        "layout": "grid",
        "theme": "f7770f0b818c3a67",
        "breakpoints": [
            {
                "name": "Default",
                "px": "0",
                "cols": "3"
            },
            {
                "name": "Tablet",
                "px": "576",
                "cols": "6"
            },
            {
                "name": "Small Desktop",
                "px": "768",
                "cols": "9"
            },
            {
                "name": "Desktop",
                "px": "1024",
                "cols": "12"
            }
        ],
        "order": 10,
        "className": "",
        "visible": "false",
        "disabled": "false"
    },
    {
        "id": "c966455a52d121c0",
        "type": "ui-group",
        "name": "Settings",
        "page": "aa9ba6cedf56d2cd",
        "width": "12",
        "height": "1",
        "order": 1,
        "showTitle": false,
        "className": "",
        "visible": "true",
        "disabled": "false",
        "groupType": "default"
    },
    {
        "id": "48216bc1f7c53a75",
        "type": "ui-page",
        "name": "Calibration - Pump",
        "ui": "e6ae26617c24c3ea",
        "path": "/calibration_pump",
        "icon": "target-variant",
        "layout": "grid",
        "theme": "f7770f0b818c3a67",
        "breakpoints": [
            {
                "name": "Default",
                "px": "0",
                "cols": "3"
            },
            {
                "name": "Tablet",
                "px": "576",
                "cols": "6"
            },
            {
                "name": "Small Desktop",
                "px": "768",
                "cols": "9"
            },
            {
                "name": "Desktop",
                "px": "1024",
                "cols": "12"
            }
        ],
        "order": 11,
        "className": "",
        "visible": "false",
        "disabled": "false"
    },
    {
        "id": "6039d653304537af",
        "type": "ui-group",
        "name": "Settings",
        "page": "48216bc1f7c53a75",
        "width": "12",
        "height": "1",
        "order": 1,
        "showTitle": false,
        "className": "",
        "visible": "true",
        "disabled": "false",
        "groupType": "default"
    },
    {
        "id": "803aa402d5c66b73",
        "type": "ui-page",
        "name": "Calibration - Saturation Level",
        "ui": "e6ae26617c24c3ea",
        "path": "/calibration_saturation_level",
        "icon": "target-variant",
        "layout": "grid",
        "theme": "f7770f0b818c3a67",
        "breakpoints": [
            {
                "name": "Default",
                "px": "0",
                "cols": "3"
            },
            {
                "name": "Tablet",
                "px": "576",
                "cols": "6"
            },
            {
                "name": "Small Desktop",
                "px": "768",
                "cols": "9"
            },
            {
                "name": "Desktop",
                "px": "1024",
                "cols": "12"
            }
        ],
        "order": 8,
        "className": "",
        "visible": "false",
        "disabled": "false"
    },
    {
        "id": "af8acdfe9afbad74",
        "type": "ui-group",
        "name": "Settings",
        "page": "803aa402d5c66b73",
        "width": "12",
        "height": "1",
        "order": 1,
        "showTitle": false,
        "className": "",
        "visible": "true",
        "disabled": "false",
        "groupType": "default"
    },
    {
        "id": "f8dd620721c6d70b",
        "type": "ui-page",
        "name": "Calibration",
        "ui": "e6ae26617c24c3ea",
        "path": "/calibration",
        "icon": "mdi-tune",
        "layout": "grid",
        "theme": "f7770f0b818c3a67",
        "breakpoints": [
            {
                "name": "Default",
                "px": "0",
                "cols": "3"
            },
            {
                "name": "Tablet",
                "px": "576",
                "cols": "6"
            },
            {
                "name": "Small Desktop",
                "px": "768",
                "cols": "9"
            },
            {
                "name": "Desktop",
                "px": "1024",
                "cols": "12"
            }
        ],
        "order": 7,
        "className": "",
        "visible": "true",
        "disabled": "false"
    },
    {
        "id": "c29c835a70533b69",
        "type": "ui-group",
        "name": "header",
        "page": "f8dd620721c6d70b",
        "width": "12",
        "height": 1,
        "order": 1,
        "showTitle": false,
        "className": "",
        "visible": "true",
        "disabled": "false",
        "groupType": "default"
    },
    {
        "id": "822cdc5b6ef13f39",
        "type": "ui-group",
        "name": "body",
        "page": "f8dd620721c6d70b",
        "width": "12",
        "height": 1,
        "order": 2,
        "showTitle": false,
        "className": "",
        "visible": "true",
        "disabled": "false",
        "groupType": "default"
    },
    {
        "id": "bcc78241b99ba27f",
        "type": "ui-page",
        "name": "Preview",
        "ui": "e6ae26617c24c3ea",
        "path": "/preview",
        "icon": "mdi-eye",
        "layout": "grid",
        "theme": "f7770f0b818c3a67",
        "breakpoints": [
            {
                "name": "Default",
                "px": "0",
                "cols": "3"
            },
            {
                "name": "Tablet",
                "px": "576",
                "cols": "6"
            },
            {
                "name": "Small Desktop",
                "px": "768",
                "cols": "6"
            },
            {
                "name": "Desktop",
                "px": "1024",
                "cols": "12"
            }
        ],
        "order": 2,
        "className": "",
        "visible": "true",
        "disabled": "false"
    },
    {
        "id": "58ab4d5e3dd68192",
        "type": "ui-group",
        "name": "Streaming",
        "page": "bcc78241b99ba27f",
        "width": "6",
        "height": 1,
        "order": 2,
        "showTitle": false,
        "className": "",
        "visible": "true",
        "disabled": "false",
        "groupType": "default"
    },
    {
        "id": "39cbd2658f16d608",
        "type": "ui-group",
        "name": "Settings",
        "page": "bcc78241b99ba27f",
        "width": "6",
        "height": 1,
        "order": 3,
        "showTitle": false,
        "className": "",
        "visible": "true",
        "disabled": "false",
        "groupType": "default"
    },
    {
        "id": "5c3e73c675caac42",
        "type": "ui-page",
        "name": "Acquisition",
        "ui": "e6ae26617c24c3ea",
        "path": "/acquisition",
        "icon": "video-image",
        "layout": "grid",
        "theme": "f7770f0b818c3a67",
        "breakpoints": [
            {
                "name": "Default",
                "px": "0",
                "cols": "3"
            },
            {
                "name": "Tablet",
                "px": "576",
                "cols": "6"
            },
            {
                "name": "Small Desktop",
                "px": "768",
                "cols": "6"
            },
            {
                "name": "Desktop",
                "px": "1024",
                "cols": "12"
            }
        ],
        "order": 4,
        "className": "",
        "visible": "true",
        "disabled": "false"
    },
    {
        "id": "b274327af3807b79",
        "type": "ui-group",
        "name": "Streaming",
        "page": "5c3e73c675caac42",
        "width": "6",
        "height": 1,
        "order": 2,
        "showTitle": false,
        "className": "",
        "visible": "true",
        "disabled": "false",
        "groupType": "default"
    },
    {
        "id": "d2f77573ed4317e4",
        "type": "ui-group",
        "name": "Acquisition settings",
        "page": "5c3e73c675caac42",
        "width": "6",
        "height": 1,
        "order": 3,
        "showTitle": false,
        "className": "",
        "visible": "true",
        "disabled": "false",
        "groupType": "default"
    },
    {
        "id": "632260133d581caa",
        "type": "ui-page",
        "name": "Home",
        "ui": "e6ae26617c24c3ea",
        "path": "/home",
        "icon": "home",
        "layout": "grid",
        "theme": "f7770f0b818c3a67",
        "breakpoints": [
            {
                "name": "Default",
                "px": "0",
                "cols": "3"
            },
            {
                "name": "Tablet",
                "px": "576",
                "cols": "6"
            },
            {
                "name": "Small Desktop",
                "px": "768",
                "cols": "9"
            },
            {
                "name": "Desktop",
                "px": "1024",
                "cols": "12"
            }
        ],
        "order": 1,
        "className": "",
        "visible": "true",
        "disabled": "false"
    },
    {
        "id": "5d39a98563150f22",
        "type": "ui-group",
        "name": "body",
        "page": "632260133d581caa",
        "width": "12",
        "height": 1,
        "order": 1,
        "showTitle": false,
        "className": "",
        "visible": "true",
        "disabled": "false",
        "groupType": "default"
    },
    {
        "id": "7572915171e440cd",
        "type": "ui-group",
        "name": "Navigation Top",
        "page": "bcc78241b99ba27f",
        "width": "12",
        "height": 1,
        "order": 1,
        "showTitle": false,
        "className": "",
        "visible": "true",
        "disabled": "false",
        "groupType": "default"
    },
    {
        "id": "3ae252a2e5abca89",
        "type": "ui-group",
        "name": "Navigation Top",
        "page": "5c3e73c675caac42",
        "width": "12",
        "height": 1,
        "order": 1,
        "showTitle": false,
        "className": "",
        "visible": "true",
        "disabled": "false",
        "groupType": "default"
    },
    {
        "id": "55c2fe64e681037d",
        "type": "ui-group",
        "name": "Navigation bottom",
        "page": "bcc78241b99ba27f",
        "width": "12",
        "height": 1,
        "order": 4,
        "showTitle": false,
        "className": "",
        "visible": "true",
        "disabled": "false",
        "groupType": "default"
    },
    {
        "id": "3d88a1872dbbf8a7",
        "type": "ui-group",
        "name": "Navigation bottom",
        "page": "5c3e73c675caac42",
        "width": "12",
        "height": 1,
        "order": 4,
        "showTitle": false,
        "className": "",
        "visible": "true",
        "disabled": "false",
        "groupType": "default"
    },
    {
        "id": "9b992ca6515ed058",
        "type": "ui-group",
        "name": "Navigation Top",
        "page": "7a4e042a60b734a6",
        "width": "12",
        "height": 1,
        "order": 1,
        "showTitle": false,
        "className": "",
        "visible": "true",
        "disabled": "false",
        "groupType": "default"
    },
    {
        "id": "9f00807878a32dd5",
        "type": "ui-group",
        "name": "Navigation Bottom",
        "page": "7a4e042a60b734a6",
        "width": "12",
        "height": 1,
        "order": 4,
        "showTitle": false,
        "className": "",
        "visible": "true",
        "disabled": "false",
        "groupType": "default"
    },
    {
        "id": "d129fac8e7742d5b",
        "type": "ui-page",
        "name": "Visualization",
        "ui": "e6ae26617c24c3ea",
        "path": "/visualization",
        "icon": "chart-scatter-plot",
        "layout": "tabs",
        "theme": "f7770f0b818c3a67",
        "breakpoints": [
            {
                "name": "Default",
                "px": "0",
                "cols": "3"
            },
            {
                "name": "Tablet",
                "px": "576",
                "cols": "6"
            },
            {
                "name": "Small Desktop",
                "px": "768",
                "cols": "9"
            },
            {
                "name": "Desktop",
                "px": "1024",
                "cols": "12"
            }
        ],
        "order": 6,
        "className": "",
        "visible": "true",
        "disabled": "false"
    },
    {
        "id": "b570f76ef526af45",
        "type": "ui-group",
        "d": true,
        "name": "Navigation Top",
        "page": "d129fac8e7742d5b",
        "width": "12",
        "height": 1,
        "order": 1,
        "showTitle": false,
        "className": "",
        "visible": "true",
        "disabled": "false",
        "groupType": "default"
    },
    {
        "id": "1d3abb201c51ff47",
        "type": "ui-group",
        "d": true,
        "name": "Navigation Bottom",
        "page": "d129fac8e7742d5b",
        "width": "12",
        "height": 1,
        "order": 8,
        "showTitle": false,
        "className": "",
        "visible": "true",
        "disabled": "false",
        "groupType": "default"
    },
    {
        "id": "402b3d24c87ab0d2",
        "type": "ui-group",
        "name": "Informations",
        "page": "7a4e042a60b734a6",
        "width": "12",
        "height": 1,
        "order": 2,
        "showTitle": false,
        "className": "",
        "visible": "true",
        "disabled": "false",
        "groupType": "default"
    },
    {
        "id": "fa6393a7d7e3b7d7",
        "type": "ui-group",
        "name": "List of Segmentation",
        "page": "d129fac8e7742d5b",
        "width": "12",
        "height": 1,
        "order": 2,
        "showTitle": false,
        "className": "",
        "visible": "true",
        "disabled": "false",
        "groupType": "default"
    },
    {
        "id": "44d42558adf7baf7",
        "type": "ui-group",
        "name": "ChatGPT 5.1 Pro v1",
        "page": "d129fac8e7742d5b",
        "width": "12",
        "height": 1,
        "order": 3,
        "showTitle": true,
        "className": "",
        "visible": "true",
        "disabled": "false",
        "groupType": "default"
    },
    {
        "id": "bdf41008b379e80e",
        "type": "ui-group",
        "name": "Gemini 3 Pro v1",
        "page": "d129fac8e7742d5b",
        "width": "12",
        "height": 1,
        "order": 4,
        "showTitle": true,
        "className": "",
        "visible": "true",
        "disabled": "false",
        "groupType": "default"
    },
    {
        "id": "e3bd8883700f1ab8",
        "type": "ui-group",
        "name": "ChatGPT 5.1 Pro v2",
        "page": "d129fac8e7742d5b",
        "width": "12",
        "height": 1,
        "order": 5,
        "showTitle": true,
        "className": "",
        "visible": "true",
        "disabled": "false",
        "groupType": "default"
    },
    {
        "id": "0cb96323818204ca",
        "type": "ui-group",
        "name": "Gemini 3 Pro v2",
        "page": "d129fac8e7742d5b",
        "width": 6,
        "height": 1,
        "order": 6,
        "showTitle": true,
        "className": "",
        "visible": "true",
        "disabled": "false",
        "groupType": "default"
    },
    {
        "id": "fd07716b2cd88ccd",
        "type": "ui-group",
        "name": "ChatGPT 5.1 Pro v3",
        "page": "d129fac8e7742d5b",
        "width": "12",
        "height": 1,
        "order": 7,
        "showTitle": true,
        "className": "",
        "visible": "true",
        "disabled": "false",
        "groupType": "default"
    },
    {
        "id": "82099021.9ceb08",
        "type": "file",
        "z": "4ed26b8b.253504",
        "name": "",
        "filename": "/home/pi/PlanktoScope/hardware.json",
        "appendNewline": true,
        "createDir": true,
        "overwriteFile": "true",
        "encoding": "none",
        "x": 660,
        "y": 40,
        "wires": [
            []
        ]
    },
    {
        "id": "bb0a8725.a1849",
        "type": "json",
        "z": "4ed26b8b.253504",
        "name": "Create JSON",
        "property": "payload",
        "action": "str",
        "pretty": true,
        "x": 490,
        "y": 40,
        "wires": [
            [
                "82099021.9ceb08"
            ]
        ]
    },
    {
        "id": "53d163be.47cf24",
        "type": "function",
        "z": "4ed26b8b.253504",
        "name": "Update and retrieve hardware_conf",
        "func": "// change global\nhardware_conf = global.get(\"hardware_conf\");\n\nif (msg.topic == \"process_pixel_fixed\" && msg.payload == 0){\n    delete hardware_conf[msg.topic]\n    delete msg.topic\n}\n\nif (msg.topic !== null && msg.topic !== undefined){\n    hardware_conf[msg.topic] = msg.payload;\n    global.set(\"hardware_conf\", hardware_conf);\n}\n\nreturn {\"payload\": hardware_conf};",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 240,
        "y": 40,
        "wires": [
            [
                "bb0a8725.a1849"
            ]
        ]
    },
    {
        "id": "0f16258953fae292",
        "type": "file in",
        "z": "b7861ce703215a01",
        "name": "",
        "filename": "/home/pi/PlanktoScope/hardware.json",
        "filenameType": "str",
        "format": "utf8",
        "chunk": false,
        "sendError": false,
        "encoding": "none",
        "allProps": false,
        "x": 250,
        "y": 40,
        "wires": [
            [
                "81c516291ab19acd"
            ]
        ],
        "info": "# PlanktoScope Help\nThis Node will read the content of the file named **config.txt** containing all the input placeholders.\n"
    },
    {
        "id": "81c516291ab19acd",
        "type": "json",
        "z": "b7861ce703215a01",
        "name": "Parse JSON",
        "property": "payload",
        "action": "",
        "pretty": false,
        "x": 510,
        "y": 40,
        "wires": [
            [
                "d0fbcd200cd09981"
            ]
        ]
    },
    {
        "id": "d0fbcd200cd09981",
        "type": "change",
        "z": "b7861ce703215a01",
        "name": "",
        "rules": [
            {
                "t": "set",
                "p": "hardware_conf",
                "pt": "global",
                "to": "payload",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 730,
        "y": 40,
        "wires": [
            []
        ]
    },
    {
        "id": "730b2780ac215a52",
        "type": "file in",
        "z": "63c85b96537b7355",
        "name": "",
        "filename": "/home/pi/PlanktoScope/config.json",
        "filenameType": "str",
        "format": "utf8",
        "chunk": false,
        "sendError": false,
        "encoding": "none",
        "x": 560,
        "y": 60,
        "wires": [
            [
                "e0b7238a0c5d4ed0"
            ]
        ],
        "info": "# PlanktoScope Help\nThis Node will read the content of the file named **config.txt** containing all the input placeholders.\n"
    },
    {
        "id": "e0b7238a0c5d4ed0",
        "type": "json",
        "z": "63c85b96537b7355",
        "name": "config.json",
        "property": "payload",
        "action": "",
        "pretty": false,
        "x": 730,
        "y": 60,
        "wires": [
            [
                "f1c0a882a9e3d927"
            ]
        ]
    },
    {
        "id": "b8109badf5f39d35",
        "type": "file",
        "z": "63c85b96537b7355",
        "name": "",
        "filename": "/home/pi/PlanktoScope/config.json",
        "appendNewline": true,
        "createDir": true,
        "overwriteFile": "true",
        "encoding": "none",
        "x": 990,
        "y": 160,
        "wires": [
            []
        ]
    },
    {
        "id": "31ae9b857627673c",
        "type": "json",
        "z": "63c85b96537b7355",
        "name": "config.json",
        "property": "payload",
        "action": "str",
        "pretty": true,
        "x": 730,
        "y": 160,
        "wires": [
            [
                "b8109badf5f39d35"
            ]
        ]
    },
    {
        "id": "f1c0a882a9e3d927",
        "type": "function",
        "z": "63c85b96537b7355",
        "name": "Global Set",
        "func": "global.set(\"config_keys\", Object.keys(msg.payload));\n\nfor (const key in msg.payload) {\n    global.set(key, msg.payload[key]);\n}\n\nreturn msg;",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 910,
        "y": 60,
        "wires": [
            []
        ]
    },
    {
        "id": "24ea99bb02eeffa2",
        "type": "inject",
        "z": "63c85b96537b7355",
        "name": "Load config",
        "props": [
            {
                "p": "topic",
                "vt": "str"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": true,
        "onceDelay": 0.1,
        "topic": "",
        "payloadType": "str",
        "x": 230,
        "y": 60,
        "wires": [
            [
                "730b2780ac215a52"
            ]
        ]
    },
    {
        "id": "5248e5e225d854d1",
        "type": "function",
        "z": "63c85b96537b7355",
        "name": "get config payload",
        "func": "keys = global.get(\"config_keys\")\n\nvar payload = {}\n\nkeys.forEach(function(item, index, array) {\n  payload[item] = global.get(item);\n})\n\nreturn {\"payload\": payload};",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 410,
        "y": 160,
        "wires": [
            [
                "31ae9b857627673c"
            ]
        ]
    },
    {
        "id": "97f8a94e71055782",
        "type": "ui_ui_control",
        "z": "63c85b96537b7355",
        "name": "Connect Event",
        "events": "connect",
        "x": 220,
        "y": 100,
        "wires": [
            [
                "730b2780ac215a52"
            ]
        ]
    },
    {
        "id": "1cf1b20e425ec126",
        "type": "ui-template",
        "z": "1b667c6443413ced",
        "group": "",
        "page": "",
        "ui": "e6ae26617c24c3ea",
        "name": "footer",
        "order": 1,
        "width": 0,
        "height": 0,
        "head": "",
        "format": "<template>\n  <v-footer class=\"pa-6\">\n    <v-container fluid>\n      <!-- Top Section -->\n      <v-row justify=\"space-between\" align=\"start\">\n        <!-- Branding -->\n\n          <v-col cols=\"12\" md=\"4\">\n\n            <v-row no-gutters class=\"align-center\">\n\n              <!-- Colonne logo : largeur fixe -->\n              <v-col class=\"d-flex justify-center pa-0 pr-4\" style=\"width: 40px; max-width: 40px;\">\n                <v-icon size=\"40\">\n                  <svg viewBox=\"0 0 52.916666 52.916666\" width=\"40\" height=\"40\" xmlns=\"http://www.w3.org/2000/svg\">\n                    <ellipse cx=\"26.222767\" cy=\"27.404638\" rx=\"23.859026\" ry=\"23.268091\"\n                      style=\"fill:#ffffff;stroke:#adadad;stroke-width:0.255058;stroke-dasharray:0.255058,0.510117\" />\n                    <path\n                      d=\"M 25.235172,52.886866 C 18.788363,52.603542 12.618867,49.920327 7.9862278,45.385011 5.7884865,43.233443 4.126863,40.96322 2.7783721,38.269687 -0.69951435,31.3228 -0.92413866,23.055533 2.1714608,15.932226 4.2927656,11.050887 7.8775566,6.8759872 12.379084,4.0442925 16.268483,1.5976551 20.749011,0.2041208 25.311296,0.02211622 32.912028,-0.28110313 40.068898,2.5428839 45.330004,7.921181 c 1.394211,1.4252635 2.203509,2.427764 3.254874,4.031906 3.067465,4.680258 4.533514,10.016501 4.301182,15.65584 -0.24014,5.828764 -2.396645,11.365031 -6.195763,15.90599 -0.609303,0.728286 -2.000689,2.145321 -2.779528,2.830762 -3.92791,3.456901 -8.899105,5.69775 -14.107867,6.359358 -0.842019,0.106946 -1.343409,0.141442 -3.0145,0.207349 -0.281856,0.0112 -0.980811,-3.6e-4 -1.55323,-0.02554 z m -8.730149,-9.822631 c 0.109695,-0.04173 0.154655,-0.103087 0.154655,-0.211139 0,-0.298316 -0.854772,-0.812893 -2.806491,-1.689537 C 11.53131,40.120648 10.3078,39.367878 9.3006669,38.362582 7.0517974,36.117829 5.8601816,33.216131 6.2543214,30.944446 6.3887402,30.169737 6.5434509,29.871103 6.901246,29.695768 c 0.4841667,-0.23727 0.995125,-0.338007 1.7097068,-0.337072 0.9709729,0.0014 1.5470122,0.171079 2.0152092,0.594067 0.283418,0.256043 0.560221,0.375098 0.989405,0.425544 0.510426,0.05997 0.82424,-0.0134 1.252715,-0.292743 1.01939,-0.664717 5.540491,-2.409825 6.233136,-2.405942 0.165803,6.88e-4 0.423543,-0.03619 0.57276,-0.08247 0.631382,-0.195875 2.844992,-0.422152 4.954857,-0.506488 1.239664,-0.04953 3.354525,-0.02172 8.097936,0.106687 1.127421,0.03052 3.605179,0.06097 5.506133,0.06763 1.900954,0.0064 3.745833,0.03853 4.099724,0.07075 0.353899,0.03222 1.498055,0.07329 2.542584,0.09127 1.898992,0.03272 2.911755,-0.0184 3.397943,-0.171558 0.573761,-0.180697 0.764411,-0.672624 0.353353,-0.911762 -0.248676,-0.144681 -1.481535,-0.21537 -3.82899,-0.219564 -2.488027,-0.0042 -5.224909,-0.131603 -11.075963,-0.514612 -3.222986,-0.210967 -5.937562,-0.378602 -8.802349,-0.543559 -3.976844,-0.228997 -4.985076,-0.481342 -5.999512,-1.501557 -0.167847,-0.168804 -0.600666,-0.673184 -0.961825,-1.120835 -0.92504,-1.146598 -2.832132,-3.036395 -3.740139,-3.706229 -0.397915,-0.293538 -0.804872,-0.61865 -0.904352,-0.722468 -0.09948,-0.103824 -0.333374,-0.262472 -0.519766,-0.352557 -1.28055,-0.618905 -1.618906,-1.875722 -0.853693,-3.170983 0.461938,-0.781901 1.523215,-1.660846 2.748294,-2.276117 1.13425,-0.569655 2.255356,-0.975853 4.382863,-1.587996 2.089099,-0.60109 2.927546,-0.9311702 3.077629,-1.2115953 0.08554,-0.1598279 0.0077,-0.4070348 -0.163425,-0.5191737 -0.239138,-0.1566868 -0.614968,-0.1939369 -1.316519,-0.130482 -0.852279,0.077088 -1.490305,0.2163293 -3.131411,0.6833976 -1.418582,0.403736 -1.911513,0.5888334 -3.108608,1.1672844 -2.333261,1.127465 -3.264923,1.941987 -4.698402,4.107681 -0.4611363,0.696689 -0.8715706,1.36878 -0.9120808,1.49354 -0.1059747,0.32644 -0.6208078,1.341941 -1.5210083,3.000179 -1.9466021,3.585797 -2.6241442,5.326854 -3.0597521,7.862531 -0.066004,0.384261 -0.1606715,0.902139 -0.2103378,1.150829 -0.04968,0.248696 -0.1069963,0.926964 -0.1273797,1.507254 -0.081086,2.308272 0.2512527,4.04802 1.0944559,5.729316 1.2878816,2.567957 3.2322337,4.503921 5.8597418,5.834441 2.243901,1.136279 5.019803,2.001753 5.650844,1.761829 z\"\n                      fill=\"#674ea7\" />\n                  </svg>\n                </v-icon>\n              </v-col>\n\n              <!-- Colonne texte : occupe tout l'espace restant -->\n              <v-col class=\"d-flex flex-column justify-center\" style=\"flex: 1;\">\n\n                <a href=\"https://www.planktoscope.org\" target=\"_blank\" class=\"text-decoration-none\" style=\"color: inherit;\">\n                  <h4 class=\"font-weight-bold mb-1\">PlanktoScope</h4>\n                </a>\n\n                <p class=\"mb-0\">Open and Affordable Quantitative Imaging Platform.</p>\n\n              </v-col>\n\n            </v-row>\n\n          </v-col>\n\n\n        <!-- Action Links -->\n        <v-col cols=\"12\" md=\"8\" class=\"d-flex flex-wrap justify-end\">\n          <v-chip\n            size=\"small\"\n            color=\"grey-darken-3\"\n            href=\"https://www.planktoscope.org/join\"\n            target=\"_blank\"\n            class=\"mx-2 my-1\"\n          >\n            <v-icon color=\"primary\" class=\"mr-1\">mdi-slack</v-icon>\n            Ask the community\n          </v-chip>\n          <v-chip\n            size=\"small\"\n            color=\"grey-darken-3\"\n            href=\"https://github.com/PlanktoScope/PlanktoScope/issues/new?template=software-bug-report.md\"\n            target=\"_blank\"\n            class=\"mx-2 my-1\"\n          >\n            <v-icon color=\"red\" class=\"mr-1\">mdi-bug</v-icon>\n            Report a Bug\n          </v-chip>\n\n          <v-chip\n            size=\"small\"\n            color=\"grey-darken-3\"\n            href=\"https://github.com/PlanktoScope/dashboard\"\n            target=\"_blank\"\n            class=\"mx-2 my-1\"\n          >\n            <v-icon color=\"black\" class=\"mr-1\">mdi-github</v-icon>\n            GitHub Repo\n          </v-chip>\n\n          <v-chip\n            size=\"small\"\n            color=\"grey-darken-3\"\n            href=\"https://github.com/PlanktoScope/PlanktoScope/graphs/contributors\"\n            target=\"_blank\"\n            class=\"mx-2 my-1\"\n          >\n            <v-icon color=\"green\" class=\"mr-1\">mdi-account-group</v-icon>\n            Contributors\n          </v-chip>\n        </v-col>\n      </v-row>\n\n      <v-divider class=\"my-2 opacity-50\"></v-divider>\n\n      <!-- Bottom Section -->\n      <v-row justify=\"space-between\" align=\"center\">\n        <v-col cols=\"12\" md=\"6\" class=\"text-caption\">\n\n           {{ new Date().getFullYear() }} PlanktoScope GUI  made by\n          <a href=\"https://fairscope.com\" target=\"_blank\" rel=\"noopener noreferrer\" class=\"text-decoration-none\" color=\"primary\">\n            FairScope\n          </a>\n        </v-col>\n\n      </v-row>\n    </v-container>\n  </v-footer>\n</template>\n\n<script>\nexport default {\n  name: 'AppFooter',\n}\n</script>\n",
        "storeOutMessages": true,
        "passthru": true,
        "resendOnRefresh": true,
        "templateScope": "widget:ui",
        "className": "",
        "x": 510,
        "y": 440,
        "wires": [
            []
        ]
    },
    {
        "id": "67b871e8f9c64c2b",
        "type": "switch",
        "z": "1b667c6443413ced",
        "name": "msg.payload.page.path === \"/home\"",
        "property": "payload.page.path",
        "propertyType": "msg",
        "rules": [
            {
                "t": "eq",
                "v": "/home",
                "vt": "str"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 1,
        "x": 570,
        "y": 40,
        "wires": [
            [
                "abe86c4e9dedb557",
                "605bf275a4d80952",
                "90ba8dbcce201a83"
            ]
        ]
    },
    {
        "id": "e74e4d04e4a79458",
        "type": "switch",
        "z": "1b667c6443413ced",
        "name": "msg.topic === \"$pageview\"",
        "property": "topic",
        "propertyType": "msg",
        "rules": [
            {
                "t": "eq",
                "v": "$pageview",
                "vt": "str"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 1,
        "x": 280,
        "y": 40,
        "wires": [
            [
                "67b871e8f9c64c2b"
            ]
        ]
    },
    {
        "id": "7c16cbd0b2c40ea4",
        "type": "ui-event",
        "z": "1b667c6443413ced",
        "ui": "e6ae26617c24c3ea",
        "name": "UI Event",
        "x": 80,
        "y": 40,
        "wires": [
            [
                "e74e4d04e4a79458"
            ]
        ]
    },
    {
        "id": "5d4e95854b504124",
        "type": "ui-template",
        "z": "1b667c6443413ced",
        "group": "",
        "page": "",
        "ui": "e6ae26617c24c3ea",
        "name": "CSS (All Pages)",
        "order": 0,
        "width": 0,
        "height": 0,
        "head": "",
        "format": "  .v-btn--variant-outlined.v-btn--active {\n    background-color: #1976d2 !important;\n    color: white !important;\n  }\n\n\n.v-row+.v-row {\n    margin-top: 0px !important;\n}\n\n.v-row {\n    margin: 0px !important;\n}\n\n\n    .v-field__field {\n    background: #eef3ff;\n    border-radius: 4px;\n    }\n    .v-btn-group .v-btn, .v-field__overlay {\n    background: #eef3ff;\n    }\n    \n\n    .v-container{\n          padding: 0 !important;\n    }",
        "storeOutMessages": true,
        "passthru": true,
        "resendOnRefresh": true,
        "templateScope": "site:style",
        "className": "",
        "x": 1300,
        "y": 40,
        "wires": [
            []
        ]
    },
    {
        "id": "abe86c4e9dedb557",
        "type": "get machine info",
        "z": "1b667c6443413ced",
        "name": "",
        "x": 850,
        "y": 40,
        "wires": [
            [
                "c06a59555d958a6f"
            ]
        ]
    },
    {
        "id": "605bf275a4d80952",
        "type": "storage info",
        "z": "1b667c6443413ced",
        "name": "",
        "x": 830,
        "y": 80,
        "wires": [
            [
                "ee16d4c7be3a6e3a"
            ]
        ]
    },
    {
        "id": "ee16d4c7be3a6e3a",
        "type": "function",
        "z": "1b667c6443413ced",
        "name": "set storage info",
        "func": "if (msg.topic) {\n    global.set(\"image_acquired\", msg.payload.image_acquired);\n    global.set(\"object_segmented\", msg.payload.object_segmented);\n    global.set(\"storage_percent_free\", msg.payload.storage_percent_free);\n    global.set(\"storage_percent_used\", msg.payload.storage_percent_used);\n}\nreturn msg;\n",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1000,
        "y": 80,
        "wires": [
            []
        ]
    },
    {
        "id": "c06a59555d958a6f",
        "type": "function",
        "z": "1b667c6443413ced",
        "name": "set machine info",
        "func": "if (msg.topic) {\n    global.set(\"hardware_version\", msg.payload.machine_info.hardware_version);\n    global.set(\"machine_name\", msg.payload.machine_info.machine_name);\n    global.set(\"hostname\", msg.payload.machine_info.hostname);\n    global.set(\"software_version\", msg.payload.machine_info.software_version);\n}\nreturn msg;\n",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1040,
        "y": 40,
        "wires": [
            []
        ]
    },
    {
        "id": "90ba8dbcce201a83",
        "type": "delay",
        "z": "1b667c6443413ced",
        "name": "",
        "pauseType": "delay",
        "timeout": "1",
        "timeoutUnits": "seconds",
        "rate": "1",
        "nbRateUnits": "1",
        "rateUnits": "second",
        "randomFirst": "1",
        "randomLast": "5",
        "randomUnits": "seconds",
        "drop": false,
        "allowrate": false,
        "outputs": 1,
        "x": 180,
        "y": 140,
        "wires": [
            [
                "74f8dad75cdd3c16"
            ]
        ]
    },
    {
        "id": "74f8dad75cdd3c16",
        "type": "function",
        "z": "1b667c6443413ced",
        "name": "Get Global Variables",
        "func": "const keys = global.keys(); // Get all global variable keys\nmsg.payload = {}; // Initialize the payload object\n\nkeys.forEach(key => {\n    // Ignore keys that start with \"$\"\n    if (!key.startsWith('$')) {\n        msg.payload[key] = global.get(key);\n    }\n});\n\nreturn msg;\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 200,
        "y": 280,
        "wires": [
            [
                "52902327e2363f8b",
                "cd5cd3a0277b8dba",
                "37fa78ad741d783c"
            ]
        ]
    },
    {
        "id": "52902327e2363f8b",
        "type": "ui-template",
        "z": "1b667c6443413ced",
        "group": "",
        "page": "",
        "ui": "e6ae26617c24c3ea",
        "name": "toolbar",
        "order": 2,
        "width": "12",
        "height": "6",
        "head": "",
        "format": "<style>\n    /* --- Zone Droite (Horloge + Menu) --- */\n    #pks-menu-wrapper {\n        position: relative;\n        display: flex;\n        align-items: center;\n        gap: 12px;\n        z-index: 999999 !important;\n        margin-right: 0 !important;\n    }\n\n    /* --- Zone Gauche (Badge Version) --- */\n    #pks-hw-version {\n\n\n\n        display: inline-flex;\n        align-items: center;\n        justify-content: center;\n\n        /* Apparence de badge */\n        background: #eef3ff;\n        color: #1976d2;\n        border: 1px solid #d6e4ff;\n\n        font-size: 11px;\n        font-weight: 800;\n        letter-spacing: 0.5px;\n\n        padding: 4px 8px;\n        border-radius: 4px;\n        /* Forme arrondie \"pilule\" */\n\n        /* Espace aprs \"PlanktoScope\" */\n        vertical-align: middle;\n        line-height: 1.5;\n\n        /* Masqu tant qu'il n'y a pas de donnes */\n        display: none;\n    }\n\n    /* --- Horloge --- */\n    #pks-clock {\n        font-size: 14px;\n        color: #555;\n        opacity: 0.9;\n        white-space: nowrap;\n        user-select: none;\n    }\n\n    /* --- Bouton Machine --- */\n    #pks-machine-button {\n        display: flex;\n        align-items: center;\n        gap: 6px;\n        background: #eef3ff;\n        border: 1px solid #d6e4ff;\n        margin-right: 8px;\n        padding: 6px 10px;\n        border-radius: 6px;\n        cursor: pointer;\n        font-size: 14px;\n        font-weight: 600;\n        color: #1b76d3;\n        transition: background 0.2s;\n    }\n\n    #pks-machine-button:hover {\n        background: #a6caed;\n    }\n\n    #pks-machine-button i {\n        font-size: 18px;\n        opacity: 0.8;\n    }\n\n    /* --- Dropdown Menu --- */\n    #pks-dropdown {\n        position: fixed !important;\n        top: 64px !important;\n\n        background: #ffffff;\n        border-radius: 0px 0px 6px 6px;\n        width: 250px;\n        border: 1px solid #b6b6b6;\n        display: none;\n        z-index: 999999 !important;\n        padding: 6px 0;\n        box-shadow: 0 3px 12px rgba(0, 0, 0, 0.15);\n    }\n\n    .menu-header {\n        display: flex;\n        align-items: center;\n        padding: 12px 16px 6px 16px;\n    }\n\n    .menu-separator {\n        border-top: 1px solid #cfcfcf;\n        margin: 6px 0;\n    }\n\n    .menu-item {\n        display: flex;\n        align-items: center;\n        padding: 10px 16px;\n        cursor: pointer;\n        color: #333;\n        font-size: 15px;\n    }\n\n    .menu-item:hover {\n        background: #eef3ff;\n    }\n\n    .menu-item i {\n        font-size: 20px;\n        color: #1976d2;\n        margin-right: 10px;\n        width: 22px;\n        text-align: center;\n    }\n\n    .menu-item.reboot i {\n        color: #f57c00;\n    }\n\n    .menu-item.reboot:hover {\n        background: #fef2e6;\n    }\n\n    .menu-item.shutdown i {\n        color: #d32f2f;\n    }\n\n    .menu-item.shutdown:hover {\n        background: #fbeaea;\n    }\n\n    .menu-item .ext {\n        margin-left: auto;\n        font-size: 18px;\n        color: #777;\n    }\n\n    /* --- Loader Modal --- */\n    #pks-modal {\n        display: none;\n        position: fixed;\n        top: 0;\n        right: 0;\n        width: 100%;\n        height: 100%;\n        background: rgba(0, 0, 0, 0.45);\n        z-index: 9999999;\n        backdrop-filter: blur(2px);\n        justify-content: center;\n        align-items: center;\n    }\n\n    #pks-modal-box {\n        background: white;\n        padding: 20px 30px;\n        border-radius: 10px;\n        text-align: center;\n        min-width: 260px;\n    }\n\n    #pks-loader {\n        border: 4px solid #ddd;\n        border-top: 4px solid #1976d2;\n        border-radius: 50%;\n        width: 36px;\n        height: 36px;\n        margin: 10px auto;\n        animation: spin 0.9s linear infinite;\n    }\n\n    @keyframes spin {\n        100% {\n            transform: rotate(360deg);\n        }\n    }\n\n    #app-bar-actions,\n    #pks-menu-wrapper {\n        flex-shrink: 0 !important;\n    }\n\n    #app-bar {\n        width: 100% !important;\n        max-width: 100% !important;\n    }\n</style>\n\n<script>\n    let scope = this;\n\n/* Load MDI icons if missing */\nif (!document.querySelector('link[href*=\"materialdesignicons\"]')) {\n    const mdi = document.createElement(\"link\");\n    mdi.rel = \"stylesheet\";\n    mdi.href = \"https://cdn.materialdesignicons.com/7.4.47/css/materialdesignicons.min.css\";\n    document.head.appendChild(mdi);\n}\n\n/* Clock */\nfunction updateClock() {\n    const el = document.getElementById(\"pks-clock\");\n    if (!el) return;\n    const now = new Date();\n    const days = [\"Sun.\", \"Mon.\", \"Tue.\", \"Wed.\", \"Thu.\", \"Fri.\", \"Sat.\"];\n    const months = [\"janv.\", \"fvr.\", \"mars\", \"avr.\", \"mai\", \"juin\", \"juil.\", \"aot\", \"sept.\", \"oct.\", \"nov.\", \"dc.\"];\n    const d = days[now.getUTCDay()];\n    const day = String(now.getUTCDate()).padStart(2, \"0\");\n    const month = months[now.getUTCMonth()];\n    const year = now.getUTCFullYear();\n    const hh = now.getUTCHours().toString().padStart(2, \"0\");\n    const mm = now.getUTCMinutes().toString().padStart(2, \"0\");\n    el.textContent = `${d} ${day} ${month} ${year} - ${hh}:${mm} (UTC)`;\n}\nsetInterval(updateClock, 60000);\n\n/* =========================================================\n   BUILD MENU CONTENT\n========================================================= */\nfunction buildMenu(machineName) {\n    const menu = document.getElementById(\"pks-dropdown\");\n    if (!menu) return;\n    menu.innerHTML = `\n        <div class=\"menu-item\" data-href=\"home\">\n             <svg viewBox=\"0 0 52.916666 52.916666\" width=\"20\" height=\"20\" xmlns=\"http://www.w3.org/2000/svg\" class=\"mr-3\">\n                 <ellipse cx=\"26.222767\" cy=\"27.404638\" rx=\"23.859026\" ry=\"23.268091\" style=\"fill:#ffffff;stroke:#adadad;stroke-width:0.255058;stroke-dasharray:0.255058,0.510117\" />\n                 <path d=\"M 25.235172,52.886866 C 18.788363,52.603542 12.618867,49.920327 7.9862278,45.385011 5.7884865,43.233443 4.126863,40.96322 2.7783721,38.269687 -0.69951435,31.3228 -0.92413866,23.055533 2.1714608,15.932226 4.2927656,11.050887 7.8775566,6.8759872 12.379084,4.0442925 16.268483,1.5976551 20.749011,0.2041208 25.311296,0.02211622 32.912028,-0.28110313 40.068898,2.5428839 45.330004,7.921181 c 1.394211,1.4252635 2.203509,2.427764 3.254874,4.031906 3.067465,4.680258 4.533514,10.016501 4.301182,15.65584 -0.24014,5.828764 -2.396645,11.365031 -6.195763,15.90599 -0.609303,0.728286 -2.000689,2.145321 -2.779528,2.830762 -3.92791,3.456901 -8.899105,5.69775 -14.107867,6.359358 -0.842019,0.106946 -1.343409,0.141442 -3.0145,0.207349 -0.281856,0.0112 -0.980811,-3.6e-4 -1.55323,-0.02554 z m -8.730149,-9.822631 c 0.109695,-0.04173 0.154655,-0.103087 0.154655,-0.211139 0,-0.298316 -0.854772,-0.812893 -2.806491,-1.689537 C 11.53131,40.120648 10.3078,39.367878 9.3006669,38.362582 7.0517974,36.117829 5.8601816,33.216131 6.2543214,30.944446 6.3887402,30.169737 6.5434509,29.871103 6.901246,29.695768 c 0.4841667,-0.23727 0.995125,-0.338007 1.7097068,-0.337072 0.9709729,0.0014 1.5470122,0.171079 2.0152092,0.594067 0.283418,0.256043 0.560221,0.375098 0.989405,0.425544 0.510426,0.05997 0.82424,-0.0134 1.252715,-0.292743 1.01939,-0.664717 5.540491,-2.409825 6.233136,-2.405942 0.165803,6.88e-4 0.423543,-0.03619 0.57276,-0.08247 0.631382,-0.195875 2.844992,-0.422152 4.954857,-0.506488 1.239664,-0.04953 3.354525,-0.02172 8.097936,0.106687 1.127421,0.03052 3.605179,0.06097 5.506133,0.06763 1.900954,0.0064 3.745833,0.03853 4.099724,0.07075 0.353899,0.03222 1.498055,0.07329 2.542584,0.09127 1.898992,0.03272 2.911755,-0.0184 3.397943,-0.171558 0.573761,-0.180697 0.764411,-0.672624 0.353353,-0.911762 -0.248676,-0.144681 -1.481535,-0.21537 -3.82899,-0.219564 -2.488027,-0.0042 -5.224909,-0.131603 -11.075963,-0.514612 -3.222986,-0.210967 -5.937562,-0.378602 -8.802349,-0.543559 -3.976844,-0.228997 -4.985076,-0.481342 -5.999512,-1.501557 -0.167847,-0.168804 -0.600666,-0.673184 -0.961825,-1.120835 -0.92504,-1.146598 -2.832132,-3.036395 -3.740139,-3.706229 -0.397915,-0.293538 -0.804872,-0.61865 -0.904352,-0.722468 -0.09948,-0.103824 -0.333374,-0.262472 -0.519766,-0.352557 -1.28055,-0.618905 -1.618906,-1.875722 -0.853693,-3.170983 0.461938,-0.781901 1.523215,-1.660846 2.748294,-2.276117 1.13425,-0.569655 2.255356,-0.975853 4.382863,-1.587996 2.089099,-0.60109 2.927546,-0.9311702 3.077629,-1.2115953 0.08554,-0.1598279 0.0077,-0.4070348 -0.163425,-0.5191737 -0.239138,-0.1566868 -0.614968,-0.1939369 -1.316519,-0.130482 -0.852279,0.077088 -1.490305,0.2163293 -3.131411,0.6833976 -1.418582,0.403736 -1.911513,0.5888334 -3.108608,1.1672844 -2.333261,1.127465 -3.264923,1.941987 -4.698402,4.107681 -0.4611363,0.696689 -0.8715706,1.36878 -0.9120808,1.49354 -0.1059747,0.32644 -0.6208078,1.341941 -1.5210083,3.000179 -1.9466021,3.585797 -2.6241442,5.326854 -3.0597521,7.862531 -0.066004,0.384261 -0.1606715,0.902139 -0.2103378,1.150829 -0.04968,0.248696 -0.1069963,0.926964 -0.1273797,1.507254 -0.081086,2.308272 0.2512527,4.04802 1.0944559,5.729316 1.2878816,2.567957 3.2322337,4.503921 5.8597418,5.834441 2.243901,1.136279 5.019803,2.001753 5.650844,1.761829 z\" fill=\"#076eca\" />\n             </svg>\n            <b>Home</b>\n        </div>\n        <div class=\"menu-separator\"></div>\n        <div class=\"menu-item\" data-href=\"preview\"><i class=\"mdi mdi-eye\"></i> Preview</div>\n        <div class=\"menu-item\" data-href=\"visualization\"><i class=\"mdi mdi-chart-scatter-plot-hexbin\"></i> Visualization</div>\n        <div class=\"menu-item\" data-href=\"calibration\"><i class=\"mdi mdi-crosshairs-gps\"></i> Calibration</div>\n        <div class=\"menu-item\" data-external=\"/ps/docs/\"><i class=\"mdi mdi-book-outline\"></i> Documentation <i class=\"mdi mdi-open-in-new ext\"></i></div>\n        <div class=\"menu-separator\"></div>\n        <div class=\"menu-item reboot\" data-action=\"reboot\"><i class=\"mdi mdi-refresh\"></i> Reboot</div>\n        <div class=\"menu-item shutdown\" data-action=\"shutdown\"><i class=\"mdi mdi-power\"></i> Shutdown</div>\n    `;\n}\n\n/* =========================================================\n   MODAL LOADER\n========================================================= */\nfunction showModal(message) {\n    let modal = document.getElementById(\"pks-modal\");\n    if (!modal) {\n        modal = document.createElement(\"div\");\n        modal.id = \"pks-modal\";\n        modal.innerHTML = `<div id=\"pks-modal-box\"><div id=\"pks-loader\"></div><div id=\"pks-modal-text\">${message}</div></div>`;\n        document.body.appendChild(modal);\n    }\n    document.getElementById(\"pks-modal-text\").textContent = message;\n    modal.style.display = \"flex\";\n}\nfunction hideModal() {\n    const modal = document.getElementById(\"pks-modal\");\n    if (modal) modal.style.display = \"none\";\n}\n\n/* =========================================================\n   INJECT HARDWARE VERSION (LEFT)\n========================================================= */\nfunction injectHardwareVersion() {\n    // On cherche la zone du titre. Vous avez indiqu que c'est \"app-bar-title\"\n    // qui se trouve  ct de PlanktoScope\n    const titleZone = document.getElementById(\"app-bar-title\");\n    \n    if (titleZone && !document.getElementById(\"pks-hw-version\")) {\n        const verDiv = document.createElement(\"div\");\n        verDiv.id = \"pks-hw-version\";\n        // On l'ajoute DANS la div #app-bar-title, ce qui l'affichera juste aprs PlanktoScope\n        titleZone.appendChild(verDiv);\n    }\n}\n\n/* =========================================================\n   INJECT MENU (RIGHT)\n========================================================= */\nfunction injectMenu() {\n    const zone = document.getElementById(\"app-bar-actions\");\n    if (!zone) return;\n    if (!document.getElementById(\"pks-menu-wrapper\")) {\n        const wrap = document.createElement(\"div\");\n        wrap.id = \"pks-menu-wrapper\";\n        zone.appendChild(wrap);\n    }\n    const wrapper = document.getElementById(\"pks-menu-wrapper\");\n\n    if (!document.getElementById(\"pks-dropdown\")) {\n        const dropdown = document.createElement(\"div\");\n        dropdown.id = \"pks-dropdown\";\n        document.body.appendChild(dropdown);\n    }\n\n    // Note: J'ai retir hw-version d'ici pour le mettre  gauche\n    if (!document.getElementById(\"pks-machine-button\")) {\n        wrapper.innerHTML = `\n            <div id=\"pks-clock\"></div>\n            <button id=\"pks-machine-button\">\n                <i class=\"mdi mdi-desktop-classic\"></i>\n                <span id=\"pks-machine-name\">Loading..</span>\n                <i class=\"mdi mdi-menu-down\"></i>\n            </button>\n        `;\n        updateClock();\n    }\n\n    const btn = document.getElementById(\"pks-machine-button\");\n    const menu = document.getElementById(\"pks-dropdown\");\n\n    btn.onclick = (e) => {\n        e.stopPropagation();\n        const rect = btn.getBoundingClientRect();\n        menu.style.top = rect.bottom + \"px\";\n        menu.style.right = \"0px\";\n        menu.style.left = \"auto\";\n        menu.style.display = menu.style.display === \"block\" ? \"none\" : \"block\";\n    };\n    \n    menu.onclick = (e) => {\n        const item = e.target.closest(\".menu-item\");\n        if (!item) return;\n        if (item.dataset.href) window.location.href = item.dataset.href;\n        if (item.dataset.external) window.open(item.dataset.external, \"_blank\");\n\n        if (item.dataset.action) {\n            showModal(item.dataset.action === \"reboot\" ? \"Rebooting\" : \"Shutting down\");\n            scope.send({ topic: \"action\", payload: item.dataset.action });\n            setTimeout(() => { window.location.reload(); }, 5000);\n        }\n        menu.style.display = \"none\";\n    };\n\n    document.addEventListener(\"click\", (e) => {\n        if (!wrapper.contains(e.target)) menu.style.display = \"none\";\n    });\n}\n\n/* DOM observer pour lancer les injections si la structure change */\nfunction runInjections() {\n    injectMenu();\n    injectHardwareVersion();\n}\n\nconst observer = new MutationObserver(() => runInjections());\nobserver.observe(document.body, { childList: true, subtree: true });\n\n/* =========================================================\n   DATA UPDATES\n========================================================= */\nthis.$watch(\"msg\", (msg) => {\n    if (!msg || !msg.payload) return;\n\n    // 1. Update Machine Name (Droite)\n    if (msg.payload.machine_name) {\n        const name = msg.payload.machine_name;\n        const el = document.getElementById(\"pks-machine-name\");\n        if (el) el.textContent = name;\n        buildMenu(name);\n    }\n\n    // 2. Update Hardware Version (Gauche)\n    if (msg.payload.hardware_version) {\n        // On s'assure que l'lment existe\n        injectHardwareVersion();\n        \n        const hwEl = document.getElementById(\"pks-hw-version\");\n        if (hwEl) {\n            hwEl.textContent = msg.payload.hardware_version;\n            hwEl.style.display = \"inline-flex\"; // On l'affiche maintenant qu'on a la valeur\n        }\n    }\n\n    runInjections();\n});\n\nsetTimeout(runInjections, 200);\n</script>",
        "storeOutMessages": true,
        "passthru": true,
        "resendOnRefresh": true,
        "templateScope": "widget:ui",
        "className": "",
        "x": 820,
        "y": 200,
        "wires": [
            [
                "1db1c2e3e19e85ff"
            ]
        ]
    },
    {
        "id": "8efc52e6ee9206f6",
        "type": "poweroff",
        "z": "1b667c6443413ced",
        "name": "",
        "x": 1160,
        "y": 240,
        "wires": [
            []
        ]
    },
    {
        "id": "39c7e4b018ce16cb",
        "type": "reboot",
        "z": "1b667c6443413ced",
        "name": "",
        "x": 1160,
        "y": 200,
        "wires": [
            []
        ]
    },
    {
        "id": "1db1c2e3e19e85ff",
        "type": "switch",
        "z": "1b667c6443413ced",
        "name": "",
        "property": "payload",
        "propertyType": "msg",
        "rules": [
            {
                "t": "eq",
                "v": "reboot",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "shutdown",
                "vt": "str"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 2,
        "x": 970,
        "y": 200,
        "wires": [
            [
                "39c7e4b018ce16cb",
                "1044b154a90406dc"
            ],
            [
                "8efc52e6ee9206f6"
            ]
        ]
    },
    {
        "id": "cd5cd3a0277b8dba",
        "type": "ui-template",
        "z": "1b667c6443413ced",
        "group": "5d39a98563150f22",
        "page": "",
        "ui": "",
        "name": "body",
        "order": 1,
        "width": "0",
        "height": "0",
        "head": "",
        "format": "<template>\n  <v-container fluid>\n\n    <!-- HEADER -->\n    <v-row justify=\"center\" dense class=\"py-8\">\n              <svg viewBox=\"0 0 52.916666 52.916666\" width=\"150\" height=\"150\" xmlns=\"http://www.w3.org/2000/svg\">\n                <ellipse cx=\"26.222767\" cy=\"27.404638\" rx=\"23.859026\" ry=\"23.268091\"\n                  style=\"fill:#ffffff;stroke:#adadad;stroke-width:0.255058;stroke-dasharray:0.255058,0.510117\" />\n                <path\n                  d=\"M 25.235172,52.886866 C 18.788363,52.603542 12.618867,49.920327 7.9862278,45.385011 5.7884865,43.233443 4.126863,40.96322 2.7783721,38.269687 -0.69951435,31.3228 -0.92413866,23.055533 2.1714608,15.932226 4.2927656,11.050887 7.8775566,6.8759872 12.379084,4.0442925 16.268483,1.5976551 20.749011,0.2041208 25.311296,0.02211622 32.912028,-0.28110313 40.068898,2.5428839 45.330004,7.921181 c 1.394211,1.4252635 2.203509,2.427764 3.254874,4.031906 3.067465,4.680258 4.533514,10.016501 4.301182,15.65584 -0.24014,5.828764 -2.396645,11.365031 -6.195763,15.90599 -0.609303,0.728286 -2.000689,2.145321 -2.779528,2.830762 -3.92791,3.456901 -8.899105,5.69775 -14.107867,6.359358 -0.842019,0.106946 -1.343409,0.141442 -3.0145,0.207349 -0.281856,0.0112 -0.980811,-3.6e-4 -1.55323,-0.02554 z m -8.730149,-9.822631 c 0.109695,-0.04173 0.154655,-0.103087 0.154655,-0.211139 0,-0.298316 -0.854772,-0.812893 -2.806491,-1.689537 C 11.53131,40.120648 10.3078,39.367878 9.3006669,38.362582 7.0517974,36.117829 5.8601816,33.216131 6.2543214,30.944446 6.3887402,30.169737 6.5434509,29.871103 6.901246,29.695768 c 0.4841667,-0.23727 0.995125,-0.338007 1.7097068,-0.337072 0.9709729,0.0014 1.5470122,0.171079 2.0152092,0.594067 0.283418,0.256043 0.560221,0.375098 0.989405,0.425544 0.510426,0.05997 0.82424,-0.0134 1.252715,-0.292743 1.01939,-0.664717 5.540491,-2.409825 6.233136,-2.405942 0.165803,6.88e-4 0.423543,-0.03619 0.57276,-0.08247 0.631382,-0.195875 2.844992,-0.422152 4.954857,-0.506488 1.239664,-0.04953 3.354525,-0.02172 8.097936,0.106687 1.127421,0.03052 3.605179,0.06097 5.506133,0.06763 1.900954,0.0064 3.745833,0.03853 4.099724,0.07075 0.353899,0.03222 1.498055,0.07329 2.542584,0.09127 1.898992,0.03272 2.911755,-0.0184 3.397943,-0.171558 0.573761,-0.180697 0.764411,-0.672624 0.353353,-0.911762 -0.248676,-0.144681 -1.481535,-0.21537 -3.82899,-0.219564 -2.488027,-0.0042 -5.224909,-0.131603 -11.075963,-0.514612 -3.222986,-0.210967 -5.937562,-0.378602 -8.802349,-0.543559 -3.976844,-0.228997 -4.985076,-0.481342 -5.999512,-1.501557 -0.167847,-0.168804 -0.600666,-0.673184 -0.961825,-1.120835 -0.92504,-1.146598 -2.832132,-3.036395 -3.740139,-3.706229 -0.397915,-0.293538 -0.804872,-0.61865 -0.904352,-0.722468 -0.09948,-0.103824 -0.333374,-0.262472 -0.519766,-0.352557 -1.28055,-0.618905 -1.618906,-1.875722 -0.853693,-3.170983 0.461938,-0.781901 1.523215,-1.660846 2.748294,-2.276117 1.13425,-0.569655 2.255356,-0.975853 4.382863,-1.587996 2.089099,-0.60109 2.927546,-0.9311702 3.077629,-1.2115953 0.08554,-0.1598279 0.0077,-0.4070348 -0.163425,-0.5191737 -0.239138,-0.1566868 -0.614968,-0.1939369 -1.316519,-0.130482 -0.852279,0.077088 -1.490305,0.2163293 -3.131411,0.6833976 -1.418582,0.403736 -1.911513,0.5888334 -3.108608,1.1672844 -2.333261,1.127465 -3.264923,1.941987 -4.698402,4.107681 -0.4611363,0.696689 -0.8715706,1.36878 -0.9120808,1.49354 -0.1059747,0.32644 -0.6208078,1.341941 -1.5210083,3.000179 -1.9466021,3.585797 -2.6241442,5.326854 -3.0597521,7.862531 -0.066004,0.384261 -0.1606715,0.902139 -0.2103378,1.150829 -0.04968,0.248696 -0.1069963,0.926964 -0.1273797,1.507254 -0.081086,2.308272 0.2512527,4.04802 1.0944559,5.729316 1.2878816,2.567957 3.2322337,4.503921 5.8597418,5.834441 2.243901,1.136279 5.019803,2.001753 5.650844,1.761829 z\"\n                  fill=\"#076eca\" />\n              </svg>\n    </v-row>\n    <v-row justify=\"center\" dense>\n      <v-empty-state \n      headline=\"Welcome to your PlanktoScope\" \n      title=\"What would you like to do today?\"\n    />\n    </v-row>\n\n    <!-- MAIN ACTIONS -->\n    <v-row justify=\"center\" dense>\n      <!-- Launch the Preview -->\n      <v-col cols=\"12\" md=\"4\" class=\"d-flex pa-3\">\n        <v-btn\n          href=\"preview\"\n          variant=\"flat\"\n          color=\"primary\"\n          size=\"large\"\n          stacked\n          class=\"text-none w-100 py-6 flex-column\"\n        >\n          <v-icon size=\"50\" class=\"mb-2\">mdi-eye</v-icon>\n          <span class=\"text-h6\">Launch the Preview</span>\n        </v-btn>\n      </v-col>\n\n      <!-- Explore Your Data -->\n      <v-col cols=\"12\" md=\"4\" class=\"d-flex pa-3\">\n        <v-btn\n          href=\"visualization\"\n          target=\"_blank\"\n          variant=\"outlined\"\n          color=\"primary\"\n          size=\"large\"\n          stacked\n          class=\"text-none w-100 py-6 flex-column\"\n        >\n          <v-icon size=\"50\" class=\"mb-2\">mdi-chart-scatter-plot-hexbin</v-icon>\n          <span class=\"text-h6\">Explore your data</span>\n        </v-btn>\n      </v-col>\n      \n      <v-col cols=\"12\" md=\"4\" class=\"d-flex pa-3\">\n        <v-btn\n          href=\"calibration\"\n          variant=\"flat\"\n          color=\"grey-darken-3\"\n          size=\"large\"\n          stacked\n          class=\"text-none w-100 py-6 flex-column\"\n        >\n          <v-icon size=\"50\" class=\"mb-2\">mdi-tune</v-icon>\n          <span class=\"text-h6\">Run the Calibration</span>\n        </v-btn>\n      </v-col>\n    </v-row>\n\n    <!-- SECONDARY ACTIONS -->\n    <v-row justify=\"center\" dense class=\"py-6\">\n      <!-- Learn the Basics -->\n      <v-col cols=\"12\" md=\"12\" class=\"d-flex pa-3\">\n        <v-btn\n          href=\"/ps/docs/operation/protocol-v4.pdf\"\n          target=\"_blank\"\n          color=\"primary\"\n          variant=\"tonal\"\n          size=\"large\"\n          class=\"text-none w-100 text-subtitle-1 py-3\"\n        >\n          <v-icon start size=\"30\">mdi-book-open-variant</v-icon>\n          Learn the Basics\n        </v-btn>\n      </v-col>\n\n    </v-row>\n\n<v-divider ></v-divider>\n    <!-- STAT CARDS -->\n    <v-row class=\"py-6\">\n\n      <!-- Software Version -->\n      <v-col cols=\"12\" md=\"3\">\n        <v-card variant=\"outlined\" class=\"pa-4 d-flex align-center justify-space-between\">\n          <div class=\"d-flex align-center\">\n            <v-icon size=\"32\" color=\"primary\" class=\"mr-4\">mdi-github</v-icon>\n            <span class=\"text-subtitle-3 font-weight-medium\">Software Version</span>\n          </div>\n          <div class=\"text-subtitle-3 font-weight-bold\">\n            {{ msg.payload.software_version }}\n          </div>\n        </v-card>\n      </v-col>\n\n      <!-- Images acquired -->\n      <v-col cols=\"12\" md=\"3\">\n        <v-card variant=\"outlined\" class=\"pa-4 d-flex align-center justify-space-between\">\n          <div class=\"d-flex align-center\">\n            <v-icon size=\"32\" color=\"primary\" class=\"mr-4\">mdi-image-multiple-outline</v-icon>\n            <span class=\"text-subtitle-3 font-weight-medium\">Images Acquired</span>\n          </div>\n          <div class=\"text-subtitle-3 font-weight-bold\">\n            {{ msg.payload.image_acquired }}\n          </div>\n        </v-card>\n      </v-col>\n\n      <!-- Objects segmented -->\n      <v-col cols=\"12\" md=\"3\">\n        <v-card variant=\"outlined\" class=\"pa-4 d-flex align-center justify-space-between\">\n          <div class=\"d-flex align-center\">\n            <v-icon size=\"32\" color=\"primary\" class=\"mr-4\">mdi-crop</v-icon>\n            <span class=\"text-subtitle-3 font-weight-medium\">Objects Segmented</span>\n          </div>\n          <div class=\"text-subtitle-3 font-weight-bold\">\n            {{ msg.payload.object_segmented }}\n          </div>\n        </v-card>\n      </v-col>\n\n      <!-- Storage (single-line layout: icon  progress bar  value) -->\n      <v-col cols=\"12\" md=\"3\">\n        <v-card variant=\"outlined\" class=\"pa-4 d-flex align-center justify-space-between\">\n\n          <v-icon size=\"32\" color=\"primary\" class=\"mr-4\">mdi-sd</v-icon>\n          <span class=\"text-subtitle-3 font-weight-medium\">Storage</span>\n\n          <v-progress-linear\n            :model-value=\"msg.payload.storage_percent_used\"\n            height=\"12\"\n            rounded\n            class=\"flex-grow-1 mx-3\"\n            :color=\"\n              msg.payload.storage_percent_used > 90\n                ? 'error'\n                : msg.payload.storage_percent_used > 70\n                ? 'warning'\n                : 'success'\n            \"\n          ></v-progress-linear>\n\n          <div class=\"text-subtitle-3 font-weight-bold d-flex justify-end\" style=\"min-width: 48px;\">\n            {{ msg.payload.storage_percent_used }}%\n          </div>\n\n        </v-card>\n\n      </v-col>\n    </v-row>\n\n  </v-container>\n</template>\n",
        "storeOutMessages": true,
        "passthru": true,
        "resendOnRefresh": true,
        "templateScope": "local",
        "className": "",
        "x": 510,
        "y": 180,
        "wires": [
            []
        ]
    },
    {
        "id": "1044b154a90406dc",
        "type": "exec",
        "z": "1b667c6443413ced",
        "command": "sudo reboot now",
        "addpay": "",
        "append": "",
        "useSpawn": "false",
        "timer": "",
        "winHide": false,
        "oldrc": false,
        "name": "",
        "x": 1190,
        "y": 300,
        "wires": [
            [],
            [],
            []
        ]
    },
    {
        "id": "37fa78ad741d783c",
        "type": "debug",
        "z": "1b667c6443413ced",
        "name": "debug 7",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "false",
        "statusVal": "",
        "statusType": "auto",
        "x": 420,
        "y": 320,
        "wires": []
    },
    {
        "id": "a57a165cd0ce511b",
        "type": "ui-template",
        "z": "ab58b3fd0e6bcd77",
        "group": "58ab4d5e3dd68192",
        "page": "",
        "ui": "",
        "name": "Streaming",
        "order": 1,
        "width": "0",
        "height": "0",
        "head": "",
        "format": "<div class=\"iframe-container\">\n  <iframe src=\"/preview/node-red\"></iframe>\n</div>\n\n<style>\n  /* 1. STYLES FOR THE CONTAINER (WHERE YOUR BORDER IS APPLIED) */\n  .iframe-container {\n    /* YOUR REQUESTED STYLES: Border and border-radius */\n    border: 1px solid #9c9c9c;\n    border-radius: 4px; \n    \n    /* Responsive Setup */\n    position: relative;\n    width: 100%;\n    /* Set a proportion, e.g., 4:3 (75% height relative to width) */\n    padding-top: 75%; \n    overflow: hidden; \n  }\n    \n  /* 2. STYLES FOR THE IFRAME ITSELF */\n  .iframe-container iframe {\n    position: absolute;\n    top: 0;\n    left: 0;\n    width: 100%;\n    height: 100%;\n    \n    /* Ensure the iframe itself has no border or margin, as the container provides the frame */\n    border: none;\n    margin: 0;\n  }\n</style>",
        "storeOutMessages": true,
        "passthru": true,
        "resendOnRefresh": true,
        "templateScope": "local",
        "className": "",
        "x": 1310,
        "y": 100,
        "wires": [
            []
        ]
    },
    {
        "id": "c8de0186a0a927e8",
        "type": "function",
        "z": "ab58b3fd0e6bcd77",
        "name": "Get Global Variables",
        "func": "const keys = global.keys(); // Get all global variable keys\nmsg.payload = {}; // Initialize the payload object\n\nkeys.forEach(key => {\n    // Ignore keys that start with \"$\"\n    if (!key.startsWith('$')) {\n        msg.payload[key] = global.get(key);\n    }\n});\n\nreturn msg;\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 120,
        "y": 140,
        "wires": [
            [
                "f514a138d38d3c61"
            ]
        ]
    },
    {
        "id": "927b92eee9edfcbe",
        "type": "ui-template",
        "z": "ab58b3fd0e6bcd77",
        "group": "7572915171e440cd",
        "page": "",
        "ui": "",
        "name": "Navigation Top",
        "order": 1,
        "width": 0,
        "height": 0,
        "head": "",
        "format": "<template>\n  <v-container fluid class=\"ma-0 pa-0 \">\n    <v-row align=\"center\" class=\"px-2 py-0\" no-gutters>\n\n      <v-col cols=\"3\" class=\"py-0 d-flex justify-start\">\n        <v-btn to=\"home\" color=\"primary\" rounded=\"lg\" class=\"px-4\" variant=\"text\" size=\"large\">\n          <v-icon start>mdi-chevron-left</v-icon>\n          Home\n        </v-btn>\n      </v-col>\n\n      <v-col cols=\"6\" class=\"text-center py-0\">\n        <h1 class=\"text-h5 font-weight-bold text-primary my-0 text-truncate\">\n          Preview\n        </h1>\n      </v-col>\n\n      <v-col cols=\"3\" class=\"py-0 d-flex justify-end\">\n        <v-btn to=\"metadata\" color=\"primary\" rounded=\"lg\" class=\"px-4\" variant=\"text\" size=\"large\">\n          Metadata\n          <v-icon end>mdi-chevron-right</v-icon>\n        </v-btn>\n      </v-col>\n\n    </v-row>\n  </v-container>\n</template>",
        "storeOutMessages": true,
        "passthru": true,
        "resendOnRefresh": true,
        "templateScope": "local",
        "className": "",
        "x": 1300,
        "y": 40,
        "wires": [
            []
        ]
    },
    {
        "id": "8d5eadf60a2fd54b",
        "type": "switch",
        "z": "ab58b3fd0e6bcd77",
        "name": "msg.topic === \"$pageview\"",
        "property": "topic",
        "propertyType": "msg",
        "rules": [
            {
                "t": "eq",
                "v": "$pageview",
                "vt": "str"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 1,
        "x": 280,
        "y": 40,
        "wires": [
            [
                "6074fc31218f9a74"
            ]
        ]
    },
    {
        "id": "da4fbaab826b0d62",
        "type": "ui-event",
        "z": "ab58b3fd0e6bcd77",
        "ui": "e6ae26617c24c3ea",
        "name": "UI Event",
        "x": 80,
        "y": 40,
        "wires": [
            [
                "8d5eadf60a2fd54b"
            ]
        ]
    },
    {
        "id": "6074fc31218f9a74",
        "type": "switch",
        "z": "ab58b3fd0e6bcd77",
        "name": "msg.payload.page.path === \"/preview\"",
        "property": "payload.page.path",
        "propertyType": "msg",
        "rules": [
            {
                "t": "eq",
                "v": "/preview",
                "vt": "str"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 1,
        "x": 580,
        "y": 40,
        "wires": [
            [
                "c8de0186a0a927e8"
            ]
        ]
    },
    {
        "id": "6d0408bb7ca6e5f3",
        "type": "function",
        "z": "ab58b3fd0e6bcd77",
        "name": "set pump settings",
        "func": "if (msg.topic) {\n    global.set(\"pump_flowrate\", msg.payload.pump_flowrate);\n    global.set(\"pump_manual_volume\", msg.payload.pump_manual_volume);\n}\nreturn msg;",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 810,
        "y": 140,
        "wires": [
            []
        ]
    },
    {
        "id": "4a208e0233bea4ae",
        "type": "function",
        "z": "ab58b3fd0e6bcd77",
        "name": "set focus settings",
        "func": "if (msg.topic) {\n    global.set(\"focus_distance\", msg.payload.focus_distance);\n\n}\nreturn msg;",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 810,
        "y": 180,
        "wires": [
            []
        ]
    },
    {
        "id": "ea8e81951587e46d",
        "type": "mqtt out",
        "z": "ab58b3fd0e6bcd77",
        "name": "MQTT",
        "topic": "",
        "qos": "",
        "retain": "",
        "respTopic": "",
        "contentType": "",
        "userProps": "",
        "correl": "",
        "expiry": "",
        "broker": "8dc3722c.06efa8",
        "x": 770,
        "y": 340,
        "wires": []
    },
    {
        "id": "4112a93b1b129756",
        "type": "switch",
        "z": "ab58b3fd0e6bcd77",
        "name": "",
        "property": "topic",
        "propertyType": "msg",
        "rules": [
            {
                "t": "eq",
                "v": "set_global/pump",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "actuator/pump",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "set_global/focus",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "actuator/focus",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "light",
                "vt": "str"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 5,
        "x": 550,
        "y": 160,
        "wires": [
            [
                "6d0408bb7ca6e5f3"
            ],
            [
                "ea8e81951587e46d"
            ],
            [
                "4a208e0233bea4ae"
            ],
            [
                "ea8e81951587e46d"
            ],
            [
                "ea8e81951587e46d",
                "1d591029bae11418"
            ]
        ]
    },
    {
        "id": "f514a138d38d3c61",
        "type": "ui-template",
        "z": "ab58b3fd0e6bcd77",
        "group": "39cbd2658f16d608",
        "page": "",
        "ui": "",
        "name": "Settings",
        "order": 1,
        "width": "0",
        "height": "0",
        "head": "",
        "format": "<template>\n  <v-container fluid>\n    <!-- LED CONTROL -->\n    <v-card class=\"mb-6\" variant=\"outlined\">\n      <v-card-text><!-- Label -->\n      <div class=\"text-subtitle-1 mb-2\">\n        LED Control\n      </div>\n        <v-row>\n          <v-col cols=\"12\">\n            <v-btn-toggle variant=\"outlined\" v-model=\"led_state\" color=\"primary\" mandatory divided shaped\n              class=\"d-flex justify-space-between\" @update:model-value=\"on_led_toggle\">\n              <v-btn class=\"flex-grow-1\" :value=\"'off'\">Off</v-btn>\n              <v-btn class=\"flex-grow-1\" :value=\"'on'\">On</v-btn>\n            </v-btn-toggle>\n          </v-col>\n        </v-row>\n      </v-card-text>\n    </v-card>\n\n    <!-- FOCUS CONTROL -->\n<v-card class=\"mb-6\" variant=\"outlined\">\n  <v-card-text>\n\n    <!-- Label -->\n    <div class=\"text-subtitle-1 mb-2\">\n      Focus Distance\n    </div>\n\n    <!-- Focus slider + input -->\n    <v-row align=\"center\">\n      <v-col :cols=\"isTablet ? 4 : 7\">\n        <v-slider\n          v-model.number=\"focus_distance\"\n          :max=\"maxFocus\"\n          :min=\"minFocus\"\n          :step=\"25\"\n          hide-details\n          :thumb-size=\"isTablet ? 12 : 20\"\n          :track-size=\"isTablet ? 2 : 4\"\n        />\n      </v-col>\n      <v-col :cols=\"isTablet ? 8 : 5\">\n        <v-text-field\n          v-model.number=\"focus_distance\"\n          type=\"number\"\n          variant=\"outlined\"\n          hide-details\n          suffix=\"m\"\n          :density=\"isTablet ? 'comfortable' : 'default'\"\n          :style=\"isTablet ? 'font-size: 1.3rem; width: 100%;' : ''\"\n          append-icon=\"mdi-information\"\n          @click:append=\"showInfo('focus_speed')\"\n        />\n      </v-col>\n    </v-row>\n\n    <!-- Presets -->\n    <v-row>\n      <v-col cols=\"12\">\n        <v-btn-toggle\n          variant=\"outlined\"\n          v-model=\"focus_distance_preset\"\n          divided\n          shaped\n          color=\"primary\"\n          class=\"d-flex justify-space-between\"\n          mandatory\n          @update:model-value=\"on_focus_distance_toggle\"\n        >\n          <v-btn\n            v-for=\"value in focus_distance_presets\"\n            :key=\"'distance-' + value\"\n            :value=\"value\"\n            class=\"flex-grow-1\"\n          >\n            {{ value }}\n          </v-btn>\n        </v-btn-toggle>\n      </v-col>\n    </v-row>\n\n    <!-- Focus direction -->\n    <v-row>\n      <v-col cols=\"12\">\n        <v-btn-toggle\n          variant=\"outlined\"\n          v-model=\"focus_direction\"\n          color=\"primary\"\n          mandatory\n          divided\n          shaped\n          class=\"d-flex justify-space-between\"\n          @update:model-value=\"on_focus_direction_change\"\n        >\n          <v-btn class=\"flex-grow-1\" :value=\"'UP'\">Up</v-btn>\n          <v-btn class=\"flex-grow-1\" :value=\"'stop'\">Stop</v-btn>\n          <v-btn class=\"flex-grow-1\" :value=\"'DOWN'\">Down</v-btn>\n        </v-btn-toggle>\n      </v-col>\n    </v-row>\n\n  </v-card-text>\n</v-card>\n\n    <!-- PUMP CONTROL -->\n    <v-card class=\"mb-6\" variant=\"outlined\">\n      <v-card-text>\n\n    <!-- Label -->\n    <div class=\"text-subtitle-1 mb-2\">\n      Pump Flowrate\n    </div>\n        <!-- Flowrate -->\n        <v-row align=\"center\">\n          <v-col :cols=\"isTablet ? 4 : 7\">\n            <v-slider v-model.number=\"pump_flowrate\" :min=\"minFlow\" :max=\"maxFlow\" :step=\"0.2\" hide-details\n              :thumb-size=\"isTablet ? 12 : 20\" :track-size=\"isTablet ? 2 : 4\" />\n          </v-col>\n          <v-col :cols=\"isTablet ? 8 : 5\">\n            <v-text-field v-model.number=\"pump_flowrate\" type=\"number\" variant=\"outlined\" hide-details suffix=\"ml/min\"\n              :density=\"isTablet ? 'comfortable' : 'default'\" :style=\"isTablet ? 'font-size: 1.3rem; width: 100%;' : ''\"\n              append-icon=\"mdi-information\" @click:append=\"showInfo('pump_flowrate')\" />\n          </v-col>\n        </v-row>\n\n        <!-- Flowrate presets -->\n        <v-row>\n          <v-col cols=\"12\">\n            <v-btn-toggle v-model=\"pump_flowrate_preset\" class=\"d-flex justify-space-between\" color=\"primary\"\n              variant=\"outlined\" divided shaped mandatory @update:model-value=\"onFlowrateToggle\">\n              <v-btn v-for=\"value in pump_flowrate_presets\" :key=\"'flowrate-' + value\" :value=\"value\"\n                class=\"flex-grow-1\">\n                {{ value }}\n              </v-btn>\n            </v-btn-toggle>\n          </v-col>\n        </v-row>\n\n      <!-- Label -->\n      <div class=\"text-subtitle-1 mb-2\">\n        Pump Volume\n      </div>\n\n        <!-- Volume -->\n        <v-row align=\"center\">\n          <v-col :cols=\"isTablet ? 4 : 7\">\n            <v-slider v-model.number=\"pump_manual_volume\" :min=\"minFlow\" :max=\"maxFlow\" :step=\"0.2\" hide-details\n              :thumb-size=\"isTablet ? 12 : 20\" :track-size=\"isTablet ? 2 : 4\" />\n          </v-col>\n          <v-col :cols=\"isTablet ? 8 : 5\">\n            <v-text-field v-model.number=\"pump_manual_volume\" type=\"number\" variant=\"outlined\" hide-details suffix=\"ml\"\n              :density=\"isTablet ? 'comfortable' : 'default'\" :style=\"isTablet ? 'font-size: 1.3rem; width: 100%;' : ''\"\n              append-icon=\"mdi-information\" @click:append=\"showInfo('pump_manual_volume')\" />\n          </v-col>\n        </v-row>\n\n        <!-- Volume presets -->\n        <v-row>\n          <v-col cols=\"12\">\n            <v-btn-toggle v-model=\"pump_volume_preset\" class=\"d-flex justify-space-between\" variant=\"outlined\"\n              color=\"primary\" divided shaped mandatory @update:model-value=\"onVolumeToggle\">\n              <v-btn v-for=\"value in pump_volume_presets\" :key=\"'volume-' + value\" :value=\"value\" class=\"flex-grow-1\">\n                {{ value }}\n              </v-btn>\n            </v-btn-toggle>\n          </v-col>\n        </v-row>\n\n        <!-- Pump direction -->\n        <v-row>\n          <v-col cols=\"12\">\n            <v-btn-toggle variant=\"outlined\" v-model=\"pump_direction\" color=\"primary\" mandatory divided shaped\n              class=\"d-flex justify-space-between\" @update:model-value=\"on_pump_direction_change\">\n              <v-btn class=\"flex-grow-1\" :value=\"'backward'\">Backward</v-btn>\n              <v-btn class=\"flex-grow-1\" :value=\"'stop'\">Stop</v-btn>\n              <v-btn class=\"flex-grow-1\" :value=\"'forward'\">Forward</v-btn>\n            </v-btn-toggle>\n          </v-col>\n        </v-row>\n      </v-card-text>\n    </v-card>\n\n    <!-- CALIBRATION INFO -->\n    <v-card variant=\"tonal\">\n      <v-card-title>\n        <v-icon class=\"mr-2\" color=\"primary\" size=\"large\">mdi-tune</v-icon>\n        Calibration\n      </v-card-title>\n      <v-card-text>\n        Modify your camera settings through the\n        <a href=\"calibration\" style=\"color: primary; text-decoration: underline;\">\n          calibration page\n        </a>.\n        Adjust optical parameters to ensure accurate imaging.\n      </v-card-text>\n    </v-card>\n\n    <!-- INFO DIALOG -->\n    <v-dialog v-model=\"infoDialog\" max-width=\"500\">\n      <v-card>\n        <v-card-title class=\"text-h6\">{{ infoContent.title }}</v-card-title>\n        <v-card-text>\n          <p><strong>Unit:</strong> {{ infoContent.unit }}</p>\n          <p><strong>Description:</strong> {{ infoContent.description }}</p>\n        </v-card-text>\n        <v-card-actions>\n          <v-spacer></v-spacer>\n          <v-btn color=\"primary\" text @click=\"infoDialog = false\">Close</v-btn>\n        </v-card-actions>\n      </v-card>\n    </v-dialog>\n  </v-container>\n</template>\n\n<script>\nexport default {\n  props: { msg: { type: Object, default: () => ({}) } },\n\n  data() {\n    return {\n      minFlow: 0.02,\n      maxFlow: 30,\n      pump_flowrate: 0,\n      pump_manual_volume: 0,\n      pump_flowrate_presets: [0.02, 0.2, 2, 20],\n      pump_volume_presets: [0.004, 0.2, 2, 20],\n      pump_flowrate_preset: null,\n      pump_volume_preset: null,\n      pump_direction: \"stop\",\n\n      minFocus: 25,\n      maxFocus: 5000,\n      focus_distance: 25,\n      focus_distance_presets: [25, 150, 500, 5000],\n      focus_distance_preset: null,\n      focus_direction: \"stop\",\n\n      led_state: \"off\",\n\n      infoDialog: false,\n      infoContent: { title: \"\", unit: \"\", description: \"\" },\n    };\n  },\n\n  computed: {\n    isTablet() {\n      return this.$vuetify.display.mdAndDown;\n    },\n  },\n\n  created() {\n    this.hydrateFromMsg(this.msg);\n  },\n\n  watch: {\n    msg: { handler(newMsg) { this.hydrateFromMsg(newMsg); }, deep: true },\n\n    pump_flowrate(newVal) {\n      this.pump_flowrate_preset =\n        this.pump_flowrate_presets.find((v) => v === newVal) ?? null;\n      this.sendPumpParams();\n    },\n    pump_manual_volume(newVal) {\n      this.pump_volume_preset =\n        this.pump_volume_presets.find((v) => v === newVal) ?? null;\n      this.sendPumpParams();\n    },\n    focus_distance(newVal) {\n      this.focus_distance_preset =\n        this.focus_distance_presets.find((v) => v === newVal) ?? null;\n      this.sendFocusParams();\n    },\n  },\n\n  methods: {\n    hydrateFromMsg(m) {\n      const p = m?.payload ?? {};\n\n      // --- STATUS MESSAGES (ne bloquent plus les autres updates !) ---\n      if (m.topic === \"status/pump\" && p.status === \"Done\") {\n        this.pump_direction = \"stop\";\n      }\n\n      if (m.topic === \"status/focus\" && p.status === \"Done\") {\n        this.focus_direction = \"stop\";\n      }\n\n      // --- LED STATE (ne bloque plus le reste du payload) ---\n      if (\"led_status\" in p) {\n        const s = String(p.led_status).toLowerCase().trim();\n        this.led_state = [\"on\", \"true\", \"1\"].includes(s) ? \"on\" : \"off\";\n      }\n\n      if (m.topic === \"status/light\" && \"status\" in p) {\n        const s = String(p.status).toLowerCase().trim();\n        this.led_state = [\"on\", \"true\", \"1\"].includes(s) ? \"on\" : \"off\";\n      }\n\n      // --- GLOBAL / ACTUATOR PARAMS ---\n      this.pump_flowrate =\n        p.flowrate ?? p.pump_flowrate ?? this.pump_flowrate;\n\n      this.pump_manual_volume =\n        p.volume ?? p.pump_manual_volume ?? this.pump_manual_volume;\n\n      if ([\"backward\", \"stop\", \"forward\"].includes(p.command)) {\n        this.pump_direction = p.command;\n      }\n\n      if (typeof p.focus_distance === \"number\") {\n        this.focus_distance = p.focus_distance;\n      }\n\n      if ([\"UP\", \"stop\", \"DOWN\"].includes(p.command)) {\n        this.focus_direction = p.command;\n      }\n\n      if (typeof p.ledState === \"string\") {\n        this.led_state = p.ledState;\n      }\n\n      if (typeof p.action === \"string\" && [\"on\", \"off\"].includes(p.action)) {\n        this.led_state = p.action;\n      }\n    },\n\n    // --- PUMP PARAMS ---\n    onFlowrateToggle(val) {\n      if (val != null) this.pump_flowrate = val;\n    },\n\n    onVolumeToggle(val) {\n      if (val != null) this.pump_manual_volume = val;\n    },\n\n    sendPumpParams() {\n      this.send({\n        topic: \"set_global/pump\",\n        payload: {\n          pump_flowrate: Number(this.pump_flowrate) || 0,\n          pump_manual_volume: Number(this.pump_manual_volume) || 0,\n        },\n      });\n    },\n\n    on_pump_direction_change(val) {\n      this.pump_direction = val;\n\n      if (val === \"stop\") {\n        this.send({ topic: \"actuator/pump\", payload: { action: \"stop\" } });\n      } else {\n        const dir = val === \"forward\" ? \"FORWARD\" : \"BACKWARD\";\n        this.send({\n          topic: \"actuator/pump\",\n          payload: {\n            action: \"move\",\n            direction: dir,\n            volume: Number(this.pump_manual_volume) || 0,\n            flowrate: Number(this.pump_flowrate) || 0,\n          },\n        });\n      }\n    },\n\n    // --- FOCUS PARAMS ---\n    on_focus_distance_toggle(val) {\n      if (val != null) this.focus_distance = val;\n    },\n\n    speedFromDistance(d) {\n      const x1 = 100, y1 = 1000;\n      const x2 = 1000, y2 = 2000;\n      const x3 = 5000, y3 = 5000;\n\n      if (d <= x1) return y1;\n      if (d >= x3) return y3;\n\n      if (d <= x2) {\n        const m = (y2 - y1) / (x2 - x1);\n        return Math.round(y1 + m * (d - x1));\n      }\n\n      const m = (y3 - y2) / (x3 - x2);\n      return Math.round(y2 + m * (d - x2));\n    },\n\n    sendFocusParams() {\n      const d = Number(this.focus_distance) || 25;\n      const speed = this.speedFromDistance(d);\n\n      this.send({\n        topic: \"set_global/focus\",\n        payload: {\n          focus_distance: d,\n          focus_speed: speed,\n        },\n      });\n    },\n\n    on_focus_direction_change(val) {\n      this.focus_direction = val;\n\n      if (val === \"stop\") {\n        this.send({ topic: \"actuator/focus\", payload: { action: \"stop\" } });\n      } else {\n        const d = Number(this.focus_distance) || 25;\n        const speed = this.speedFromDistance(d);\n\n        this.send({\n          topic: \"actuator/focus\",\n          payload: {\n            action: \"move\",\n            direction: val,\n            distance: d / 1000,\n            speed: speed / 1000,\n          },\n        });\n      }\n    },\n\n    // --- LED ---\n    on_led_toggle(val) {\n      if (!val) return;\n      this.led_state = val;\n      this.send({ topic: \"light\", payload: { action: val } });\n    },\n\n    // --- INFO POPUP ---\n    showInfo(type) {\n      const infoMap = {\n        pump_flowrate: {\n          title: \"Flowrate (ml/min)\",\n          unit: \"ml/min\",\n          description: \"Flowrate of the pump during manual exploration\",\n        },\n        pump_manual_volume: {\n          title: \"Volume to pass (ml)\",\n          unit: \"ml\",\n          description: \"Volume displaced by the pump during manual exploration\",\n        },\n        focus_speed: {\n          title: \"Focus Speed (m/sec)\",\n          unit: \"m/s\",\n          description: \"Speed of the displacement by the focus plate during manual exploration\",\n        },\n      };\n      this.infoContent = infoMap[type] || {};\n      this.infoDialog = true;\n    },\n  },\n};\n</script>\n\n<style scoped>\n\n  @media (max-width: 1024px) {\n    .v-text-field input {\n      font-size: 1.3rem !important;\n    }\n\n    .v-slider {\n      height: 2px !important;\n    }\n  }\n</style>",
        "storeOutMessages": true,
        "passthru": true,
        "resendOnRefresh": true,
        "templateScope": "local",
        "className": "",
        "x": 380,
        "y": 140,
        "wires": [
            [
                "4112a93b1b129756"
            ]
        ]
    },
    {
        "id": "cf663463da2a47a1",
        "type": "mqtt in",
        "z": "ab58b3fd0e6bcd77",
        "name": "",
        "topic": "status/pump",
        "qos": "0",
        "datatype": "json",
        "broker": "8dc3722c.06efa8",
        "nl": false,
        "rap": false,
        "inputs": 0,
        "x": 90,
        "y": 200,
        "wires": [
            [
                "f514a138d38d3c61"
            ]
        ]
    },
    {
        "id": "1b2c14f14bbf80c2",
        "type": "mqtt in",
        "z": "ab58b3fd0e6bcd77",
        "name": "",
        "topic": "status/focus",
        "qos": "0",
        "datatype": "json",
        "broker": "8dc3722c.06efa8",
        "nl": false,
        "rap": false,
        "inputs": 0,
        "x": 90,
        "y": 260,
        "wires": [
            [
                "f514a138d38d3c61"
            ]
        ]
    },
    {
        "id": "2321977c636b9849",
        "type": "ui-template",
        "z": "ab58b3fd0e6bcd77",
        "group": "55c2fe64e681037d",
        "page": "",
        "ui": "",
        "name": "Navigation Bottom",
        "order": 1,
        "width": 0,
        "height": 0,
        "head": "",
        "format": "<template>\n  <v-container fluid class=\"ma-0 pa-0\">\n    <v-row align=\"center\" justify=\"space-between\" class=\"px-2\">\n      <!-- Back to Home -->\n      <v-col cols=\"auto\">\n        <v-btn\n          to=\"home\"\n          color=\"primary\"\n          rounded=\"lg\"\n          class=\"px-4\" variant=\"text\" size=\"large\"\n        >\n          <v-icon start>mdi-chevron-left</v-icon>\n          Home\n        </v-btn>\n      </v-col>\n\n      <!-- Forward to Metadata -->\n      <v-col cols=\"auto\">\n        <v-btn\n          to=\"metadata\"\n          color=\"primary\"\n          rounded=\"lg\"\n          class=\"px-4\" variant=\"text\" size=\"large\"\n        >\n          Metadata\n          <v-icon end>mdi-chevron-right</v-icon>\n        </v-btn>\n      </v-col>\n    </v-row>\n  </v-container>\n</template>\n",
        "storeOutMessages": true,
        "passthru": true,
        "resendOnRefresh": true,
        "templateScope": "local",
        "className": "",
        "x": 1290,
        "y": 160,
        "wires": [
            []
        ]
    },
    {
        "id": "1d591029bae11418",
        "type": "function",
        "z": "ab58b3fd0e6bcd77",
        "name": "set light settings",
        "func": "if (msg.topic) {\n    global.set(\"led_status\", msg.payload.action);\n\n}\nreturn msg;",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 800,
        "y": 220,
        "wires": [
            []
        ]
    },
    {
        "id": "44438204d4b0d21e",
        "type": "mqtt in",
        "z": "ab58b3fd0e6bcd77",
        "name": "",
        "topic": "status/light",
        "qos": "0",
        "datatype": "json",
        "broker": "8dc3722c.06efa8",
        "nl": false,
        "rap": false,
        "inputs": 0,
        "x": 80,
        "y": 320,
        "wires": [
            [
                "f514a138d38d3c61"
            ]
        ]
    },
    {
        "id": "349d0f7644f26a62",
        "type": "ui-template",
        "z": "190b0c9aa75e8843",
        "group": "dd015fda7456b9b0",
        "page": "",
        "ui": "",
        "name": "Navigation Top",
        "order": 1,
        "width": 0,
        "height": 0,
        "head": "",
        "format": "<template>\n  <v-container fluid class=\"ma-0 pa-0\">\n    <v-row \n      align=\"center\" \n      class=\"px-2 py-0\" \n      no-gutters\n    >\n      \n      <v-col cols=\"3\" class=\"py-0 d-flex justify-start\">\n        <v-btn\n          to=\"preview\"\n          color=\"primary\"\n          rounded=\"lg\"\n          class=\"px-4\" variant=\"text\" size=\"large\"\n        >\n          <v-icon start>mdi-chevron-left</v-icon>\n          Preview\n        </v-btn>\n      </v-col>\n\n      <v-col cols=\"6\" class=\"text-center py-0\">\n        <h1 class=\"text-h5 font-weight-bold text-primary my-0 text-truncate\">\n          Metadata\n        </h1>\n      </v-col>\n\n      <v-col cols=\"3\" class=\"py-0 d-flex justify-end\">\n        <v-btn\n          to=\"acquisition\"\n          color=\"primary\"\n          rounded=\"lg\"\n          class=\"px-4\" variant=\"text\" size=\"large\"\n        >\n          Acquisition\n          <v-icon end>mdi-chevron-right</v-icon>\n        </v-btn>\n      </v-col>\n      \n    </v-row>\n  </v-container>\n</template>",
        "storeOutMessages": true,
        "passthru": true,
        "resendOnRefresh": true,
        "templateScope": "local",
        "className": "",
        "x": 1300,
        "y": 40,
        "wires": [
            []
        ]
    },
    {
        "id": "279f3ddada9cadaa",
        "type": "ui-template",
        "z": "190b0c9aa75e8843",
        "group": "69c772603e9cec0d",
        "page": "",
        "ui": "",
        "name": "Sample Information",
        "order": 1,
        "width": 0,
        "height": 0,
        "head": "",
        "format": "<template>\n  <!-- Project Metadata Inputs -->\n  <v-row class=\"mt-2\">\n    <!-- Project Name -->\n    <v-col cols=\"12\" md=\"4\">\n      <v-text-field v-model=\"sample_project\" label=\"Name of the project\" placeholder=\"ex : Tara Pacifique\"\n        variant=\"outlined\" hint=\"Enter the research project or expedition name this sample is part of.\"\n        @input=\"sendUpdate\">\n        <template #append>\n          <v-icon class=\"cursor-pointer\" @click=\"openHint(\n              'Name of the project',\n              'Enter the research project or expedition name this sample is part of.'\n            )\">\n            mdi-information\n          </v-icon>\n        </template>\n      </v-text-field>\n    </v-col>\n\n    <!-- Sample ID -->\n    <v-col cols=\"12\" md=\"4\">\n      <v-text-field \n      v-model.number=\"sample_id\"\n      type=\"number\"\n      label=\"Sample ID\"\n      prefix=\"S_\"\n      placeholder=\"ex : S001\"\n      variant=\"outlined\"\n      density=\"compact\"\n        hint=\"Provide a unique identifier for this sample (e.g., S001).\" @input=\"sendUpdate\">\n        <template #append>\n          <v-icon class=\"cursor-pointer\" @click=\"openHint(\n              'Sample ID',\n              'Provide a unique identifier for this sample (e.g., S001).'\n            )\">\n            mdi-information\n          </v-icon>\n        </template>\n      </v-text-field>\n    </v-col>\n\n    <!-- Operator Name -->\n    <v-col cols=\"12\" md=\"4\">\n      <v-text-field v-model=\"sample_operator\" label=\"Operator name\" placeholder=\"ex : Manu Prakash\" variant=\"outlined\"\n        hint=\"Name of the person who collected the sample.\" @input=\"sendUpdate\">\n        <template #append>\n          <v-icon class=\"cursor-pointer\" @click=\"openHint(\n              'Operator name',\n              'Name of the person who collected the sample.'\n            )\">\n            mdi-information\n          </v-icon>\n        </template>\n      </v-text-field>\n    </v-col>\n  </v-row>\n\n  <!-- Sampling Gear Selector -->\n  <v-row class=\"mt-4\">\n    <v-col cols=\"12\">\n      <div class=\"d-flex align-center mb-2\">\n        <label class=\"text-subtitle-2 font-weight-medium me-2\">\n          Sampling Gear\n        </label>\n        <v-icon class=\"cursor-pointer\" color=\"#666666\" @click=\"openHint(\n            'Sampling Gear',\n            'The type of gear used to collect the sample. This field describes the specific equipment used during the sampling process and provides context about the sampling method and conditions.'\n          )\">\n          mdi-information\n        </v-icon>\n      </div>\n\n      <div style=\"overflow-x: auto;\">\n        <v-btn-toggle v-model=\"sample_gear\" variant=\"outlined\" mandatory divided shaped class=\"d-flex\"\n          style=\"min-width: max-content; min-height: 100px\" @update:model-value=\"sendUpdate\">\n          <v-btn value=\"Horizontal Net\" prepend-icon=\"mdi-arrow-right-bold\" stacked>\n            Horizontal Net\n          </v-btn>\n          <v-btn value=\"Vertical Net\" prepend-icon=\"mdi-arrow-up-bold\" stacked>\n            Vertical Net\n          </v-btn>\n          <v-btn value=\"Niskin bottle\" prepend-icon=\"mdi-bottle-tonic\" stacked>\n            Niskin bottle\n          </v-btn>\n          <v-btn value=\"Lab culture\" prepend-icon=\"mdi-flask-outline\" stacked>\n            Lab culture\n          </v-btn>\n          <v-btn value=\"Demo / Test\" prepend-icon=\"mdi-beaker-outline\" stacked>\n            Demo / Test\n          </v-btn>\n        </v-btn-toggle>\n      </div>\n\n    </v-col>\n  </v-row>\n\n  <!-- Hint Popup -->\n  <v-dialog v-model=\"hintDialog\" max-width=\"400\">\n    <v-card>\n      <v-card-title class=\"text-h6\">{{ hintTitle }}</v-card-title>\n      <v-card-text>{{ hintText }}</v-card-text>\n      <v-card-actions>\n        <v-spacer></v-spacer>\n        <v-btn text color=\"primary\" @click=\"hintDialog = false\">Close</v-btn>\n      </v-card-actions>\n    </v-card>\n  </v-dialog>\n</template>\n\n<script>\n  export default {\n  props: [\"msg\"],\n  data() {\n    return {\n      sample_project: \"\",\n      sample_id: \"\",\n      sample_operator: \"\",\n      sample_gear: null,\n      hintDialog: false,\n      hintTitle: \"\",\n      hintText: \"\",\n      topic: \"sample_project_meta\", // single topic\n    };\n  },\n  watch: {\n    msg: {\n      handler(newMsg) {\n        const p = newMsg?.payload || {};\n        if (p.sample_project !== undefined) this.sample_project = p.sample_project;\n        if (p.sample_id !== undefined) {\n          // Supprime le prfixe ventuel avant d'afficher\n          this.sample_id = String(p.sample_id).replace(/^S[_-]?/, \"\");\n        }\n\n        if (p.sample_operator !== undefined)\n          this.sample_operator = p.sample_operator;\n        if (p.sample_gear !== undefined) this.sample_gear = p.sample_gear;\n      },\n      deep: true,\n    },\n  },\n  methods: {\n    /**\n     * Send grouped payload for all fields under one topic.\n     */\n    sendUpdate(extra = {}) {\n      this.send({\n        topic: this.topic,\n        payload: {\n          sample_project: this.sample_project || \"\",\n          sample_id: this.sample_id ? `S_${this.sample_id}` : \"\",\n          sample_operator: this.sample_operator || \"\",\n          sample_gear: this.sample_gear || \"\",\n          ...extra,\n        },\n      });\n    },\n\n    openHint(title, text) {\n      this.hintTitle = title;\n      this.hintText = text;\n      this.hintDialog = true;\n    },\n  },\n};\n</script>\n\n<style scoped>\n  .cursor-pointer {\n    cursor: pointer;\n  }\n</style>",
        "storeOutMessages": true,
        "passthru": true,
        "resendOnRefresh": true,
        "templateScope": "local",
        "className": "",
        "x": 410,
        "y": 140,
        "wires": [
            [
                "13f96cf49ae6d6a6"
            ]
        ]
    },
    {
        "id": "96550b272e3da513",
        "type": "ui-template",
        "z": "190b0c9aa75e8843",
        "group": "6fab47af451c6d95",
        "page": "",
        "ui": "",
        "name": "Starting point",
        "order": 1,
        "width": 0,
        "height": 0,
        "head": "",
        "format": "<template>\n  <v-container>\n    <!-- Date & Time -->\n    <v-row>\n      <v-col cols=\"12\"><strong>Date and Time</strong></v-col>\n    </v-row>\n\n    <v-row>\n      <v-col cols=\"12\" md=\"6\">\n        <v-text-field\n          v-model=\"object_date\"\n          label=\"Date (UTC)\"\n          variant=\"outlined\"\n          type=\"date\"\n          hide-details=\"auto\"\n          :density=\"isTablet ? 'comfortable' : 'default'\"\n          :style=\"isTablet ? 'font-size:1.2rem;width:100%;' : ''\"\n          @input=\"sendUpdate('object_datetime')\"\n        />\n      </v-col>\n\n      <v-col cols=\"12\" md=\"6\">\n        <v-text-field\n          v-model=\"object_time\"\n          label=\"Time (UTC)\"\n          variant=\"outlined\"\n          type=\"time\"\n          hide-details=\"auto\"\n          :density=\"isTablet ? 'comfortable' : 'default'\"\n          :style=\"isTablet ? 'font-size:1.2rem;width:100%;' : ''\"\n          @input=\"sendUpdate('object_datetime')\"\n        >\n          <template #append>\n            <v-icon class=\"cursor-pointer\" @click=\"openHint('datetime')\">\n              mdi-information\n            </v-icon>\n          </template>\n        </v-text-field>\n      </v-col>\n    </v-row>\n\n    <!-- LATITUDE SECTION -->\n    <v-row>\n      <v-col cols=\"12\"><strong>Latitude</strong></v-col>\n    </v-row>\n    <v-row class=\"mt-4\" align=\"start\">\n      <v-col :cols=\"isTablet ? 3 : 2\">\n        <v-text-field\n          v-model=\"latitude_D\"\n          label=\"\"\n          variant=\"outlined\"\n          hide-details\n          type=\"number\"\n          min=\"0\"\n          max=\"90\"\n          :density=\"isTablet ? 'comfortable' : 'default'\"\n          @input=\"syncDecimal\"\n        />\n      </v-col>\n      <v-col :cols=\"isTablet ? 3 : 2\">\n        <v-text-field\n          v-model=\"latitude_M\"\n          label=\"\"\n          variant=\"outlined\"\n          hide-details\n          type=\"number\"\n          min=\"0\"\n          max=\"59\"\n          :density=\"isTablet ? 'comfortable' : 'default'\"\n          @input=\"syncDecimal\"\n        />\n      </v-col>\n      <v-col :cols=\"isTablet ? 3 : 2\">\n        <v-text-field\n          v-model=\"latitude_S\"\n          label=\"\"\n          variant=\"outlined\"\n          hide-details\n          type=\"number\"\n          min=\"0\"\n          max=\"59\"\n          step=\"0.001\"\n          :density=\"isTablet ? 'comfortable' : 'default'\"\n          @input=\"syncDecimal\"\n        />\n      </v-col>\n      <v-col :cols=\"isTablet ? 3 : 2\">\n        <v-select\n          v-model=\"latDir\"\n          :items=\"['N','S']\"\n          label=\"Dir\"\n          variant=\"outlined\"\n          hide-details\n          :density=\"isTablet ? 'comfortable' : 'default'\"\n          @update:model-value=\"syncDecimal\"\n        />\n      </v-col>\n\n      <!-- Latitude Decimal -->\n      <v-col cols=\"12\" lg=\"4\">\n        <v-text-field\n          v-model.number=\"object_lat\"\n          label=\"Latitude (decimal)\"\n          variant=\"outlined\"\n          hide-details\n          type=\"number\"\n          min=\"-90\"\n          max=\"90\"\n          step=\"0.000001\"\n          :density=\"isTablet ? 'comfortable' : 'default'\"\n          :style=\"isTablet ? 'font-size:1.2rem;width:100%;' : ''\"\n          @input=\"updateFromDecimal('lat')\"\n        >\n          <template #append>\n            <v-icon class=\"cursor-pointer\" @click=\"openHint('latitude')\">\n              mdi-information\n            </v-icon>\n          </template>\n        </v-text-field>\n      </v-col>\n    </v-row>\n\n    <!-- LONGITUDE SECTION -->\n    <v-row>\n      <v-col cols=\"12\"><strong>Longitude</strong></v-col>\n    </v-row>\n    <v-row class=\"mt-4\" align=\"start\">\n      <v-col :cols=\"isTablet ? 3 : 2\">\n        <v-text-field\n          v-model=\"longitude_D\"\n          label=\"\"\n          variant=\"outlined\"\n          hide-details\n          type=\"number\"\n          min=\"0\"\n          max=\"180\"\n          :density=\"isTablet ? 'comfortable' : 'default'\"\n          @input=\"syncDecimal\"\n        />\n      </v-col>\n      <v-col :cols=\"isTablet ? 3 : 2\">\n        <v-text-field\n          v-model=\"longitude_M\"\n          label=\"\"\n          variant=\"outlined\"\n          hide-details\n          type=\"number\"\n          min=\"0\"\n          max=\"59\"\n          :density=\"isTablet ? 'comfortable' : 'default'\"\n          @input=\"syncDecimal\"\n        />\n      </v-col>\n      <v-col :cols=\"isTablet ? 3 : 2\">\n        <v-text-field\n          v-model=\"longitude_S\"\n          label=\"\"\n          variant=\"outlined\"\n          hide-details\n          type=\"number\"\n          min=\"0\"\n          max=\"59\"\n          step=\"0.001\"\n          :density=\"isTablet ? 'comfortable' : 'default'\"\n          @input=\"syncDecimal\"\n        />\n      </v-col>\n      <v-col :cols=\"isTablet ? 3 : 2\">\n        <v-select\n          v-model=\"lonDir\"\n          :items=\"['E','W']\"\n          label=\"Dir\"\n          variant=\"outlined\"\n          hide-details\n          :density=\"isTablet ? 'comfortable' : 'default'\"\n          @update:model-value=\"syncDecimal\"\n        />\n      </v-col>\n\n      <!-- Longitude Decimal -->\n      <v-col cols=\"12\" lg=\"4\">\n        <v-text-field\n          v-model.number=\"object_lon\"\n          label=\"Longitude (decimal)\"\n          variant=\"outlined\"\n          hide-details\n          type=\"number\"\n          min=\"-180\"\n          max=\"180\"\n          step=\"0.000001\"\n          :density=\"isTablet ? 'comfortable' : 'default'\"\n          :style=\"isTablet ? 'font-size:1.2rem;width:100%;' : ''\"\n          @input=\"updateFromDecimal('lon')\"\n        >\n          <template #append>\n            <v-icon class=\"cursor-pointer\" @click=\"openHint('longitude')\">\n              mdi-information\n            </v-icon>\n          </template>\n        </v-text-field>\n      </v-col>\n    </v-row>\n\n    <!-- Canvas Map -->\n    <v-row class=\"mt-6\" style=\"position: relative;\">\n      <v-col cols=\"12\" class=\"text-center\" style=\"position: relative;\">\n        <canvas\n          id=\"mapCanvas\"\n          width=\"800\"\n          height=\"500\"\n          style=\"width:100%;max-width:1200px;border:1px solid #999;border-radius:8px;background:#c5ecff;cursor:grab;\"\n          @wheel.prevent=\"onWheel\"\n        ></canvas>\n\n        <!-- Zoom controls -->\n        <div\n          style=\"position:absolute;bottom:25px;right:18px;display:flex;flex-direction:column;gap:6px;\"\n        >\n          <v-btn icon :size=\"isTablet ? 'large' : 'default'\" @click=\"zoomIn\"><span>+</span></v-btn>\n          <v-btn icon :size=\"isTablet ? 'large' : 'default'\" @click=\"zoomOut\"><span></span></v-btn>\n        </div>\n      </v-col>\n    </v-row>\n\n    <!-- MID-INFO POPUP -->\n    <v-dialog v-model=\"hintDialog\" max-width=\"500\">\n      <v-card>\n        <v-card-title class=\"text-h6\">{{ hintTitle }}</v-card-title>\n        <v-card-text>{{ hintText }}</v-card-text>\n        <v-card-actions>\n          <v-spacer></v-spacer>\n          <v-btn color=\"primary\" text @click=\"hintDialog = false\">Got it</v-btn>\n        </v-card-actions>\n      </v-card>\n    </v-dialog>\n  </v-container>\n</template>\n\n<script>\nexport default {\n  props: [\"msg\"],\n  data() {\n    return {\n      object_date: \"\",\n      object_time: \"\",\n      object_lat: 0,\n      object_lon: 0,\n      latitude_D: \"0\",\n      latitude_M: \"0\",\n      latitude_S: \"0\",\n      latDir: \"N\",\n      longitude_D: \"0\",\n      longitude_M: \"0\",\n      longitude_S: \"0\",\n      lonDir: \"E\",\n      ctx: null,\n      mapImage: null,\n      imageLoaded: false,\n      zoom: 1,\n      offsetX: 0,\n      offsetY: 0,\n      sample_gear: \"\", // ajout\n      hintDialog: false,\n      hintTitle: \"\",\n      hintText: \"\",\n    };\n  },\n  computed: {\n    isTablet() {\n      return this.$vuetify.display.mdAndDown;\n    },\n  },\n  watch: {\n    msg: {\n      handler(newMsg) {\n        const p = newMsg?.payload || {};\n        if (p.sample_gear !== undefined) {\n          this.sample_gear = p.sample_gear;\n\n          //  Si \"Lab culture\" ou \"Demo / Test\", remplir automatiquement date/heure et GPS\n          if ([\"Lab culture\", \"Demo / Test\"].includes(this.sample_gear)) {\n            const now = new Date();\n            this.object_date = now.toISOString().split(\"T\")[0];\n            this.object_time = now.toISOString().split(\"T\")[1].slice(0, 5);\n            this.object_lat = 0;\n            this.object_lon = 0;\n            this.updateFromDecimal(\"lat\");\n            this.updateFromDecimal(\"lon\");\n            this.sendUpdate(\"object_datetime\", {\n              object_lat: 0,\n              object_lon: 0,\n            });\n          }\n        }\n\n        if (p.object_date !== undefined) this.object_date = p.object_date;\n        if (p.object_time !== undefined) {\n          // Conversion \"HHMM\"  \"HH:MM\"\n          const t = p.object_time.toString();\n          if (t.length === 4) this.object_time = `${t.slice(0,2)}:${t.slice(2,4)}`;\n          else this.object_time = t; // fallback si format dj HH:MM\n        }\n\n        if (p.object_lat !== undefined)\n          this.object_lat = parseFloat(p.object_lat.toFixed(6));\n        if (p.object_lon !== undefined)\n          this.object_lon = parseFloat(p.object_lon.toFixed(6));\n        if (p.object_lat !== undefined || p.object_lon !== undefined) {\n          this.updateFromDecimal(\"lat\");\n          this.updateFromDecimal(\"lon\");\n        }\n        this.centerOnMarker();\n      },\n      deep: true,\n    },\n  },\n  mounted() {\n    const canvas = document.getElementById(\"mapCanvas\");\n    this.ctx = canvas.getContext(\"2d\");\n    this.mapImage = new Image();\n    this.mapImage.src = \"/world-map.svg\";\n    this.mapImage.onload = () => {\n      this.imageLoaded = true;\n      this.centerOnMarker();\n    };\n  },\n  methods: {\n    openHint(type) {\n      if (type === \"datetime\") {\n        this.hintTitle = \"Date and Time (UTC)\";\n      this.hintText =\n        \"Enter the observation timestamp in Coordinated Universal Time (UTC). \" +\n        \"Use YYYY-MM-DD for date and HH:MM (24-hour). The saved format will be HHMM (without colon).\";\n\n      } else if (type === \"latitude\") {\n        this.hintTitle = \"Latitude\";\n        this.hintText =\n          \"Latitude defines how far north or south you are from the equator.\";\n      } else if (type === \"longitude\") {\n        this.hintTitle = \"Longitude\";\n        this.hintText =\n          \"Longitude defines how far east or west you are from the Prime Meridian.\";\n      }\n      this.hintDialog = true;\n    },\n    sendUpdate(topic, extra = {}) {\n      // Conversion \"HH:MM\"  \"HHMM\"\n      const formattedTime = this.object_time ? this.object_time.replace(\":\", \"\") : \"\";\n      this.send({\n        topic,\n        payload: {\n          object_date: this.object_date,\n          object_time: formattedTime,\n          ...extra,\n        },\n      });\n    },\n    syncDecimal() {\n      this.object_lon = parseFloat(\n        this.toDecimal(this.longitude_D, this.longitude_M, this.longitude_S, this.lonDir).toFixed(6)\n      );\n      this.object_lat = parseFloat(\n        this.toDecimal(this.latitude_D, this.latitude_M, this.latitude_S, this.latDir).toFixed(6)\n      );\n      this.centerOnMarker();\n      this.sendUpdate(\"object_latlon\", {\n        object_lat: this.object_lat,\n        object_lon: this.object_lon,\n      });\n    },\n    updateFromDecimal(which) {\n      if (which === \"lon\") {\n        this.object_lon = parseFloat(this.object_lon.toFixed(6));\n        const { D, M, S, dir } = this.fromDecimal(this.object_lon, \"lon\");\n        this.longitude_D = D;\n        this.longitude_M = M;\n        this.longitude_S = S;\n        this.lonDir = dir;\n      } else {\n        this.object_lat = parseFloat(this.object_lat.toFixed(6));\n        const { D, M, S, dir } = this.fromDecimal(this.object_lat, \"lat\");\n        this.latitude_D = D;\n        this.latitude_M = M;\n        this.latitude_S = S;\n        this.latDir = dir;\n      }\n      this.centerOnMarker();\n      this.sendUpdate(\"object_latlon\", {\n        object_lat: this.object_lat,\n        object_lon: this.object_lon,\n      });\n    },\n    toDecimal(D, M, S, dir) {\n      const d = parseFloat(D) || 0;\n      const m = parseFloat(M) || 0;\n      const s = parseFloat(S) || 0;\n      let val = d + m / 60 + s / 3600;\n      if (dir === \"S\" || dir === \"W\") val *= -1;\n      return val;\n    },\n    fromDecimal(dec, type) {\n      const dirPositive = type === \"lat\" ? \"N\" : \"E\";\n      const dirNegative = type === \"lat\" ? \"S\" : \"W\";\n      const absVal = Math.abs(dec);\n      const D = Math.floor(absVal);\n      const M = Math.floor((absVal - D) * 60);\n      const S = ((absVal - D - M / 60) * 3600).toFixed(3);\n      const dir = dec >= 0 ? dirPositive : dirNegative;\n      return { D, M, S, dir };\n    },\n    onWheel(e) {\n      if (e.deltaY < 0) this.zoomIn();\n      else this.zoomOut();\n    },\n    zoomIn() {\n      this.zoom = Math.min(this.zoom * 1.25, 10);\n      this.centerOnMarker();\n    },\n    zoomOut() {\n      this.zoom = Math.max(this.zoom / 1.25, 0.5);\n      this.centerOnMarker();\n    },\n    centerOnMarker() {\n      const w = 800;\n      const h = 500;\n      const lat = this.object_lat;\n      const lon = this.object_lon;\n      const x = w / 2 + (lon / 180) * (w / 2);\n      const y = h / 2 - (lat / 90) * (h / 2);\n      this.offsetX = w / 2 - x;\n      this.offsetY = h / 2 - y;\n      this.drawPoint();\n    },\n    drawMap(w, h) {\n      const ctx = this.ctx;\n      ctx.clearRect(0, 0, w, h);\n      ctx.save();\n      ctx.translate(\n        this.offsetX * this.zoom + (w / 2) * (1 - this.zoom),\n        this.offsetY * this.zoom + (h / 2) * (1 - this.zoom)\n      );\n      ctx.scale(this.zoom, this.zoom);\n      if (this.imageLoaded) ctx.drawImage(this.mapImage, 0, 0, w, h);\n      else {\n        ctx.fillStyle = \"#000\";\n        ctx.fillRect(0, 0, w, h);\n      }\n      ctx.restore();\n    },\n    drawPoint() {\n      const w = 800;\n      const h = 500;\n      const ctx = this.ctx;\n      if (!ctx) return;\n      this.drawMap(w, h);\n      const lat = this.object_lat;\n      const lon = this.object_lon;\n      const x = w / 2 + (lon / 180) * (w / 2);\n      const y = h / 2 - (lat / 90) * (h / 2);\n      ctx.save();\n      ctx.translate(\n        this.offsetX * this.zoom + (w / 2) * (1 - this.zoom),\n        this.offsetY * this.zoom + (h / 2) * (1 - this.zoom)\n      );\n      ctx.scale(this.zoom, this.zoom);\n      ctx.fillStyle = \"blue\";\n      ctx.beginPath();\n      ctx.arc(x, y, 6 / this.zoom, 0, 2 * Math.PI);\n      ctx.fill();\n      ctx.fillStyle = \"black\";\n      ctx.font = `${13 / this.zoom}px sans-serif`;\n      ctx.fillText(`${lat.toFixed(4)}, ${lon.toFixed(4)}`, x + 10 / this.zoom, y - 10 / this.zoom);\n      ctx.restore();\n    },\n  },\n};\n</script>\n",
        "storeOutMessages": true,
        "passthru": true,
        "resendOnRefresh": true,
        "templateScope": "local",
        "className": "",
        "x": 400,
        "y": 200,
        "wires": [
            [
                "9780c3e7b1792160"
            ]
        ]
    },
    {
        "id": "1c90e219a749e53e",
        "type": "ui-template",
        "z": "190b0c9aa75e8843",
        "group": "1cfe3062a8353012",
        "page": "",
        "ui": "",
        "name": "Ending point",
        "order": 1,
        "width": 0,
        "height": 0,
        "head": "",
        "format": "<template>\n  <!-- Le conteneur principal devient dsactiv si sample_gear n'est pas \"Horizontal Net\" -->\n  <v-container\n    :disabled=\"isDisabled\"\n    :style=\"{\n      pointerEvents: isDisabled ? 'none' : 'auto',\n      opacity: isDisabled ? 0.5 : 1,\n    }\"\n  >\n    <!-- Date & Time (End) -->\n    <v-row>\n      <v-col cols=\"12\"><strong>End Date and Time</strong></v-col>\n    </v-row>\n\n    <v-row>\n      <v-col cols=\"12\" md=\"6\">\n        <v-text-field\n          v-model=\"object_date_end\"\n          label=\"Date (UTC)\"\n          variant=\"outlined\"\n          type=\"date\"\n          hide-details=\"auto\"\n          :density=\"isTablet ? 'comfortable' : 'default'\"\n          :style=\"isTablet ? 'font-size:1.2rem;width:100%;' : ''\"\n          @input=\"sendUpdateEnd('object_datetime_end')\"\n        />\n      </v-col>\n\n      <v-col cols=\"12\" md=\"6\">\n        <v-text-field\n          v-model=\"object_time_end\"\n          label=\"Time (UTC)\"\n          variant=\"outlined\"\n          type=\"time\"\n          hide-details=\"auto\"\n          :density=\"isTablet ? 'comfortable' : 'default'\"\n          :style=\"isTablet ? 'font-size:1.2rem;width:100%;' : ''\"\n          @input=\"sendUpdateEnd('object_datetime_end')\"\n        >\n          <template #append>\n            <v-icon class=\"cursor-pointer\" @click=\"openHintEnd('datetime')\">\n              mdi-information\n            </v-icon>\n          </template>\n        </v-text-field>\n      </v-col>\n    </v-row>\n\n    <!-- LATITUDE END SECTION -->\n    <v-row>\n      <v-col cols=\"12\"><strong>Latitude (End)</strong></v-col>\n    </v-row>\n    <v-row class=\"mt-4\" align=\"start\">\n      <v-col :cols=\"isTablet ? 3 : 2\">\n        <v-text-field\n          v-model=\"latitude_D_end\"\n          label=\"\"\n          variant=\"outlined\"\n          hide-details\n          type=\"number\"\n          min=\"0\"\n          max=\"90\"\n          @input=\"syncDecimalEnd\"\n        />\n      </v-col>\n      <v-col :cols=\"isTablet ? 3 : 2\">\n        <v-text-field\n          v-model=\"latitude_M_end\"\n          label=\"\"\n          variant=\"outlined\"\n          hide-details\n          type=\"number\"\n          min=\"0\"\n          max=\"59\"\n          @input=\"syncDecimalEnd\"\n        />\n      </v-col>\n      <v-col :cols=\"isTablet ? 3 : 2\">\n        <v-text-field\n          v-model=\"latitude_S_end\"\n          label=\"\"\n          variant=\"outlined\"\n          hide-details\n          type=\"number\"\n          min=\"0\"\n          max=\"59\"\n          step=\"0.001\"\n          @input=\"syncDecimalEnd\"\n        />\n      </v-col>\n      <v-col :cols=\"isTablet ? 3 : 2\">\n        <v-select\n          v-model=\"latDir_end\"\n          :items=\"['N','S']\"\n          label=\"Dir\"\n          variant=\"outlined\"\n          hide-details\n          @update:model-value=\"syncDecimalEnd\"\n        />\n      </v-col>\n\n      <!-- Latitude Decimal -->\n      <v-col cols=\"12\" lg=\"4\">\n        <v-text-field\n          v-model.number=\"object_lat_end\"\n          label=\"Latitude (decimal)\"\n          variant=\"outlined\"\n          hide-details\n          type=\"number\"\n          min=\"-90\"\n          max=\"90\"\n          step=\"0.000001\"\n          @input=\"updateFromDecimalEnd('lat')\"\n        >\n          <template #append>\n            <v-icon class=\"cursor-pointer\" @click=\"openHintEnd('latitude')\">\n              mdi-information\n            </v-icon>\n          </template>\n        </v-text-field>\n      </v-col>\n    </v-row>\n\n    <!-- LONGITUDE END SECTION -->\n    <v-row>\n      <v-col cols=\"12\"><strong>Longitude (End)</strong></v-col>\n    </v-row>\n    <v-row class=\"mt-4\" align=\"start\">\n      <v-col :cols=\"isTablet ? 3 : 2\">\n        <v-text-field\n          v-model=\"longitude_D_end\"\n          label=\"\"\n          variant=\"outlined\"\n          hide-details\n          type=\"number\"\n          min=\"0\"\n          max=\"180\"\n          @input=\"syncDecimalEnd\"\n        />\n      </v-col>\n      <v-col :cols=\"isTablet ? 3 : 2\">\n        <v-text-field\n          v-model=\"longitude_M_end\"\n          label=\"\"\n          variant=\"outlined\"\n          hide-details\n          type=\"number\"\n          min=\"0\"\n          max=\"59\"\n          @input=\"syncDecimalEnd\"\n        />\n      </v-col>\n      <v-col :cols=\"isTablet ? 3 : 2\">\n        <v-text-field\n          v-model=\"longitude_S_end\"\n          label=\"\"\n          variant=\"outlined\"\n          hide-details\n          type=\"number\"\n          min=\"0\"\n          max=\"59\"\n          step=\"0.001\"\n          @input=\"syncDecimalEnd\"\n        />\n      </v-col>\n      <v-col :cols=\"isTablet ? 3 : 2\">\n        <v-select\n          v-model=\"lonDir_end\"\n          :items=\"['E','W']\"\n          label=\"Dir\"\n          variant=\"outlined\"\n          hide-details\n          @update:model-value=\"syncDecimalEnd\"\n        />\n      </v-col>\n\n      <!-- Longitude Decimal -->\n      <v-col cols=\"12\" lg=\"4\">\n        <v-text-field\n          v-model.number=\"object_lon_end\"\n          label=\"Longitude (decimal)\"\n          variant=\"outlined\"\n          hide-details\n          type=\"number\"\n          min=\"-180\"\n          max=\"180\"\n          step=\"0.000001\"\n          @input=\"updateFromDecimalEnd('lon')\"\n        >\n          <template #append>\n            <v-icon class=\"cursor-pointer\" @click=\"openHintEnd('longitude')\">\n              mdi-information\n            </v-icon>\n          </template>\n        </v-text-field>\n      </v-col>\n    </v-row>\n\n    <!-- Canvas Map (End) -->\n    <v-row class=\"mt-6\" style=\"position: relative;\">\n      <v-col cols=\"12\" class=\"text-center\" style=\"position: relative;\">\n        <canvas\n          id=\"mapCanvas_end\"\n          width=\"800\"\n          height=\"500\"\n          style=\"width:100%;max-width:1200px;border:1px solid #999;border-radius:8px;background:#c5ecff;cursor:grab;\"\n          @wheel.prevent=\"onWheelEnd\"\n        ></canvas>\n\n        <!-- Zoom controls -->\n        <div\n          style=\"position:absolute;bottom:25px;right:18px;display:flex;flex-direction:column;gap:6px;\"\n        >\n          <v-btn icon :size=\"isTablet ? 'large' : 'default'\" @click=\"zoomInEnd\"><span>+</span></v-btn>\n          <v-btn icon :size=\"isTablet ? 'large' : 'default'\" @click=\"zoomOutEnd\"><span></span></v-btn>\n        </div>\n      </v-col>\n    </v-row>\n\n    <!-- MID-INFO POPUP -->\n    <v-dialog v-model=\"hintDialogEnd\" max-width=\"500\">\n      <v-card>\n        <v-card-title class=\"text-h6\">{{ hintTitleEnd }}</v-card-title>\n        <v-card-text>{{ hintTextEnd }}</v-card-text>\n        <v-card-actions>\n          <v-spacer></v-spacer>\n          <v-btn color=\"primary\" text @click=\"hintDialogEnd = false\">Got it</v-btn>\n        </v-card-actions>\n      </v-card>\n    </v-dialog>\n  </v-container>\n</template>\n\n<script>\nexport default {\n  props: [\"msg\"],\n  data() {\n    return {\n      object_date_end: \"\",\n      object_time_end: \"\",\n      object_lat_end: 0,\n      object_lon_end: 0,\n      latitude_D_end: \"0\",\n      latitude_M_end: \"0\",\n      latitude_S_end: \"0\",\n      latDir_end: \"N\",\n      longitude_D_end: \"0\",\n      longitude_M_end: \"0\",\n      longitude_S_end: \"0\",\n      lonDir_end: \"E\",\n      ctx_end: null,\n      mapImage_end: null,\n      imageLoaded_end: false,\n      zoom_end: 1,\n      offsetX_end: 0,\n      offsetY_end: 0,\n      sample_gear: \"\", // <-- ajout ici\n      // Popup fields\n      hintDialogEnd: false,\n      hintTitleEnd: \"\",\n      hintTextEnd: \"\",\n    };\n  },\n  computed: {\n    isTablet() {\n      return this.$vuetify.display.mdAndDown;\n    },\n    isDisabled() {\n      // Dsactive tout le formulaire si sample_gear nest pas \"Horizontal Net\"\n      return this.sample_gear !== \"Horizontal Net\";\n    },\n  },\n  watch: {\n    msg: {\n      handler(newMsg) {\n        const p = newMsg?.payload || {};\n        if (p.sample_gear !== undefined) this.sample_gear = p.sample_gear; // <-- surveille la valeur reue\n        if (p.object_date_end !== undefined) this.object_date_end = p.object_date_end;\n        if (p.object_time_end !== undefined) {\n          // Conversion \"HHMM\"  \"HH:MM\" pour affichage dans le champ <input type=\"time\">\n          const t = p.object_time_end.toString();\n          if (t.length === 4) this.object_time_end = `${t.slice(0, 2)}:${t.slice(2, 4)}`;\n          else this.object_time_end = t; // si dj au format HH:MM\n        }\n\n        if (p.object_lat_end !== undefined)\n          this.object_lat_end = parseFloat(p.object_lat_end.toFixed(6));\n        if (p.object_lon_end !== undefined)\n          this.object_lon_end = parseFloat(p.object_lon_end.toFixed(6));\n        if (p.object_lat_end !== undefined || p.object_lon_end !== undefined) {\n          this.updateFromDecimalEnd(\"lat\");\n          this.updateFromDecimalEnd(\"lon\");\n        }\n        this.centerOnMarkerEnd();\n      },\n      deep: true,\n    },\n  },\n  mounted() {\n    const canvas = document.getElementById(\"mapCanvas_end\");\n    this.ctx_end = canvas.getContext(\"2d\");\n    this.mapImage_end = new Image();\n    this.mapImage_end.src = \"/world-map.svg\";\n    this.mapImage_end.onload = () => {\n      this.imageLoaded_end = true;\n      this.centerOnMarkerEnd();\n    };\n  },\n  methods: {\n    /** Info Popup **/\n    openHintEnd(type) {\n      if (type === \"datetime\") {\n        this.hintTitleEnd = \"End Date and Time (UTC)\";\n        this.hintTextEnd =\n          \"Enter the end time of your observation in Coordinated Universal Time (UTC). \" +\n          \"Use YYYY-MM-DD for date and HH:MM (24-hour) for time.\";\n      } else if (type === \"latitude\") {\n        this.hintTitleEnd = \"End Latitude\";\n        this.hintTextEnd =\n          \"Latitude specifies how far north or south your end location is from the equator. \" +\n          \"Use degrees (), minutes (), and seconds () with N/S direction, or directly enter a decimal between -90 and +90.\";\n      } else if (type === \"longitude\") {\n        this.hintTitleEnd = \"End Longitude\";\n        this.hintTextEnd =\n          \"Longitude specifies how far east or west your end location is from the Prime Meridian. \" +\n          \"You can enter DMS (  ) with E/W direction or a decimal between -180 and +180.\";\n      }\n      this.hintDialogEnd = true;\n    },\n\n    sendUpdateEnd(topic, extra = {}) {\n      // Conversion \"HH:MM\"  \"HHMM\" avant sauvegarde\n      const formattedTimeEnd = this.object_time_end\n        ? this.object_time_end.replace(\":\", \"\")\n        : \"\";      \n      this.send({\n        topic,\n        payload: {\n          object_date_end: this.object_date_end,\n          object_time_end: formattedTimeEnd,\n          ...extra,\n        },\n      });\n    },\n    syncDecimalEnd() {\n      this.object_lon_end = parseFloat(\n        this.toDecimal(this.longitude_D_end, this.longitude_M_end, this.longitude_S_end, this.lonDir_end).toFixed(6)\n      );\n      this.object_lat_end = parseFloat(\n        this.toDecimal(this.latitude_D_end, this.latitude_M_end, this.latitude_S_end, this.latDir_end).toFixed(6)\n      );\n      this.centerOnMarkerEnd();\n      this.sendUpdateEnd(\"object_latlon_end\", {\n        object_lat_end: this.object_lat_end,\n        object_lon_end: this.object_lon_end,\n      });\n    },\n    updateFromDecimalEnd(which) {\n      if (which === \"lon\") {\n        this.object_lon_end = parseFloat(this.object_lon_end.toFixed(6));\n        const { D, M, S, dir } = this.fromDecimal(this.object_lon_end, \"lon\");\n        this.longitude_D_end = D;\n        this.longitude_M_end = M;\n        this.longitude_S_end = S;\n        this.lonDir_end = dir;\n      } else {\n        this.object_lat_end = parseFloat(this.object_lat_end.toFixed(6));\n        const { D, M, S, dir } = this.fromDecimal(this.object_lat_end, \"lat\");\n        this.latitude_D_end = D;\n        this.latitude_M_end = M;\n        this.latitude_S_end = S;\n        this.latDir_end = dir;\n      }\n      this.centerOnMarkerEnd();\n      this.sendUpdateEnd(\"object_latlon_end\", {\n        object_lat_end: this.object_lat_end,\n        object_lon_end: this.object_lon_end,\n      });\n    },\n    toDecimal(D, M, S, dir) {\n      const d = parseFloat(D) || 0;\n      const m = parseFloat(M) || 0;\n      const s = parseFloat(S) || 0;\n      let val = d + m / 60 + s / 3600;\n      if (dir === \"S\" || dir === \"W\") val *= -1;\n      return val;\n    },\n    fromDecimal(dec, type) {\n      const dirPositive = type === \"lat\" ? \"N\" : \"E\";\n      const dirNegative = type === \"lat\" ? \"S\" : \"W\";\n      const absVal = Math.abs(dec);\n      const D = Math.floor(absVal);\n      const M = Math.floor((absVal - D) * 60);\n      const S = ((absVal - D - M / 60) * 3600).toFixed(3);\n      const dir = dec >= 0 ? dirPositive : dirNegative;\n      return { D, M, S, dir };\n    },\n    onWheelEnd(e) {\n      if (e.deltaY < 0) this.zoomInEnd();\n      else this.zoomOutEnd();\n    },\n    zoomInEnd() {\n      this.zoom_end = Math.min(this.zoom_end * 1.25, 10);\n      this.centerOnMarkerEnd();\n    },\n    zoomOutEnd() {\n      this.zoom_end = Math.max(this.zoom_end / 1.25, 0.5);\n      this.centerOnMarkerEnd();\n    },\n    centerOnMarkerEnd() {\n      const w = 800;\n      const h = 500;\n      const lat = this.object_lat_end;\n      const lon = this.object_lon_end;\n      const x = w / 2 + (lon / 180) * (w / 2);\n      const y = h / 2 - (lat / 90) * (h / 2);\n      this.offsetX_end = w / 2 - x;\n      this.offsetY_end = h / 2 - y;\n      this.drawPointEnd();\n    },\n    drawMapEnd(w, h) {\n      const ctx = this.ctx_end;\n      ctx.clearRect(0, 0, w, h);\n      ctx.save();\n      ctx.translate(\n        this.offsetX_end * this.zoom_end + (w / 2) * (1 - this.zoom_end),\n        this.offsetY_end * this.zoom_end + (h / 2) * (1 - this.zoom_end)\n      );\n      ctx.scale(this.zoom_end, this.zoom_end);\n      if (this.imageLoaded_end) ctx.drawImage(this.mapImage_end, 0, 0, w, h);\n      else {\n        ctx.fillStyle = \"#000\";\n        ctx.fillRect(0, 0, w, h);\n      }\n      ctx.restore();\n    },\n    drawPointEnd() {\n      const w = 800;\n      const h = 500;\n      const ctx = this.ctx_end;\n      if (!ctx) return;\n      this.drawMapEnd(w, h);\n      const lat = this.object_lat_end;\n      const lon = this.object_lon_end;\n      const x = w / 2 + (lon / 180) * (w / 2);\n      const y = h / 2 - (lat / 90) * (h / 2);\n      ctx.save();\n      ctx.translate(\n        this.offsetX_end * this.zoom_end + (w / 2) * (1 - this.zoom_end),\n        this.offsetY_end * this.zoom_end + (h / 2) * (1 - this.zoom_end)\n      );\n      ctx.scale(this.zoom_end, this.zoom_end);\n      ctx.fillStyle = \"red\";\n      ctx.beginPath();\n      ctx.arc(x, y, 6 / this.zoom_end, 0, 2 * Math.PI);\n      ctx.fill();\n      ctx.fillStyle = \"black\";\n      ctx.font = `${13 / this.zoom_end}px sans-serif`;\n      ctx.fillText(`${lat.toFixed(4)}, ${lon.toFixed(4)}`, x + 10 / this.zoom_end, y - 10 / this.zoom_end);\n      ctx.restore();\n    },\n  },\n};\n</script>\n\n<style scoped>\n@media (max-width: 1024px) {\n  .v-text-field input,\n  .v-select input {\n    font-size: 1.2rem !important;\n  }\n}\n</style>\n",
        "storeOutMessages": true,
        "passthru": true,
        "resendOnRefresh": true,
        "templateScope": "local",
        "className": "",
        "x": 390,
        "y": 300,
        "wires": [
            [
                "1d06a5e5a5877d24"
            ]
        ]
    },
    {
        "id": "09b551fa202d8029",
        "type": "ui-template",
        "z": "190b0c9aa75e8843",
        "group": "cb3521392eb4e9ed",
        "page": "",
        "ui": "",
        "name": "Net Specificity",
        "order": 1,
        "width": 0,
        "height": 0,
        "head": "",
        "format": "<template>\n  <!-- Conteneur principal dsactiv si sample_gear n'est ni Horizontal Net ni Vertical Net -->\n    <v-container\n      fluid\n      :disabled=\"isDisabled\"\n      :style=\"{\n        pointerEvents: isDisabled ? 'none' : 'auto',\n        opacity: isDisabled ? 0.5 : 1,\n        width: '100%',\n      }\"\n    >\n\n    <v-row class=\"mt-2\">\n      <!-- Net Mouth Diameter -->\n      <v-col cols=\"12\" md=\"3\">\n        <v-text-field\n          label=\"Mouth Opening Diameter\"\n          v-model.number=\"sample_net_mouth_diameter\"\n          :min=\"0\"\n          :max=\"1000\"\n          :step=\"1\"\n          suffix=\"cm\"\n          type=\"number\"\n          variant=\"outlined\"\n          hide-details=\"auto\"\n          :density=\"isTablet ? 'comfortable' : 'default'\"\n          @input=\"sendUpdate('sample_net_params')\"\n        >\n          <template #append>\n            <v-icon class=\"cursor-pointer\" @click=\"openHint('mouth_diameter')\">\n              mdi-information\n            </v-icon>\n          </template>\n        </v-text-field>\n      </v-col>\n\n      <!-- Net Length -->\n      <v-col cols=\"12\" md=\"3\">\n        <v-text-field\n          label=\"Length of the Net\"\n          v-model.number=\"sample_net_length\"\n          :min=\"0\"\n          :max=\"1000\"\n          :step=\"1\"\n          suffix=\"cm\"\n          type=\"number\"\n          variant=\"outlined\"\n          hide-details=\"auto\"\n          :density=\"isTablet ? 'comfortable' : 'default'\"\n          @input=\"sendUpdate('sample_net_params')\"\n        >\n          <template #append>\n            <v-icon class=\"cursor-pointer\" @click=\"openHint('net_length')\">\n              mdi-information\n            </v-icon>\n          </template>\n        </v-text-field>\n      </v-col>\n\n      <!-- Mesh Size -->\n      <v-col cols=\"12\" md=\"3\">\n        <v-text-field\n          label=\"Net Mesh Size\"\n          v-model.number=\"sample_net_mesh_size\"\n          :min=\"0\"\n          :max=\"1000\"\n          :step=\"1\"\n          suffix=\"m\"\n          type=\"number\"\n          variant=\"outlined\"\n          hide-details=\"auto\"\n          :density=\"isTablet ? 'comfortable' : 'default'\"\n          @input=\"sendUpdate('sample_net_params')\"\n        >\n          <template #append>\n            <v-icon class=\"cursor-pointer\" @click=\"openHint('mesh_size')\">\n              mdi-information\n            </v-icon>\n          </template>\n        </v-text-field>\n      </v-col>\n\n      <!-- Collector Volume -->\n      <v-col cols=\"12\" md=\"3\">\n        <v-text-field\n          label=\"Volume of the Collector\"\n          v-model.number=\"sample_collected_volume\"\n          :min=\"0\"\n          :max=\"1000\"\n          :step=\"1\"\n          suffix=\"mL\"\n          type=\"number\"\n          variant=\"outlined\"\n          hide-details=\"auto\"\n          :density=\"isTablet ? 'comfortable' : 'default'\"\n          @input=\"sendUpdate('sample_net_params')\"\n        >\n          <template #append>\n            <v-icon class=\"cursor-pointer\" @click=\"openHint('collector_volume')\">\n              mdi-information\n            </v-icon>\n          </template>\n        </v-text-field>\n      </v-col>\n    </v-row>\n\n    <!-- MID-INFO POPUP -->\n    <v-dialog v-model=\"hintDialog\" max-width=\"500\">\n      <v-card>\n        <v-card-title class=\"text-h6\">{{ hintTitle }}</v-card-title>\n        <v-card-text>{{ hintText }}</v-card-text>\n        <v-card-actions>\n          <v-spacer></v-spacer>\n          <v-btn color=\"primary\" text @click=\"hintDialog = false\">Got it</v-btn>\n        </v-card-actions>\n      </v-card>\n    </v-dialog>\n  </v-container>\n</template>\n\n<script>\nexport default {\n  props: [\"msg\"],\n  data() {\n    return {\n      sample_net_mouth_diameter: \"\",\n      sample_net_length: \"\",\n      sample_net_mesh_size: \"\",\n      sample_collected_volume: \"\",\n      sample_gear: \"\",\n      hintDialog: false,\n      hintTitle: \"\",\n      hintText: \"\",\n    };\n  },\n  computed: {\n    isTablet() {\n      return this.$vuetify.display.mdAndDown;\n    },\n    isDisabled() {\n      // Dsactiver si sample_gear n'est pas \"Horizontal Net\" ou \"Vertical Net\"\n      return ![\"Horizontal Net\", \"Vertical Net\"].includes(this.sample_gear);\n    },\n  },\n  watch: {\n    msg: {\n      handler(newMsg) {\n        const p = newMsg?.payload || {};\n        if (p.sample_gear !== undefined) this.sample_gear = p.sample_gear; // <-- rcupre la valeur reue\n        if (p.sample_net_mouth_diameter !== undefined)\n          this.sample_net_mouth_diameter = Number(p.sample_net_mouth_diameter);\n        if (p.sample_net_length !== undefined)\n          this.sample_net_length = Number(p.sample_net_length);\n        if (p.sample_net_mesh_size !== undefined)\n          this.sample_net_mesh_size = Number(p.sample_net_mesh_size);\n        if (p.sample_collected_volume !== undefined)\n          this.sample_collected_volume = Number(p.sample_collected_volume);\n      },\n      deep: true,\n    },\n  },\n  methods: {\n    /**\n     * Send updates (ensures all values are numbers)\n     */\n    sendUpdate(topic, extra = {}) {\n      this.send({\n        topic,\n        payload: {\n          sample_net_mouth_diameter: Number(this.sample_net_mouth_diameter) || 0,\n          sample_net_length: Number(this.sample_net_length) || 0,\n          sample_net_mesh_size: Number(this.sample_net_mesh_size) || 0,\n          sample_collected_volume: Number(this.sample_collected_volume) || 0,\n          ...extra,\n        },\n      });\n    },\n\n    /**\n     * Info popup  consistent with previous templates\n     */\n    openHint(type) {\n      if (type === \"mouth_diameter\") {\n        this.hintTitle = \"Mouth Opening Diameter\";\n        this.hintText =\n          \"Enter the diameter of the nets mouth  the circular opening where water enters the net  measured in centimeters (cm). \" +\n          \"Typical plankton nets range from 2060 cm in diameter. Larger diameters capture more water volume.\";\n      } else if (type === \"net_length\") {\n        this.hintTitle = \"Length of the Net\";\n        this.hintText =\n          \"Specify the total length of the net from the mouth opening to the collector. \" +\n          \"Measure in centimeters (cm). This helps calculate the water volume filtered and affects flow resistance.\";\n      } else if (type === \"mesh_size\") {\n        this.hintTitle = \"Net Mesh Size\";\n        this.hintText =\n          \"Enter the mesh size of the net in micrometers (m). \" +\n          \"This defines the smallest particles or plankton that can pass through. For example, a 20 m mesh captures microplankton but not bacteria.\";\n      } else if (type === \"collector_volume\") {\n        this.hintTitle = \"Volume of the Collector\";\n        this.hintText =\n          \"Specify the amount of sample collected after towing or pumping, measured in milliliters (mL). \" +\n          \"It should correspond to the water filtered and ensures proper concentration calculations.\";\n      }\n      this.hintDialog = true;\n    },\n  },\n};\n</script>\n\n<style scoped>\n@media (max-width: 1024px) {\n  .v-text-field input,\n  .v-select input {\n    font-size: 1.2rem !important;\n  }\n}\n</style>\n",
        "storeOutMessages": true,
        "passthru": true,
        "resendOnRefresh": true,
        "templateScope": "local",
        "className": "",
        "x": 400,
        "y": 400,
        "wires": [
            [
                "2ef0ae85c43d66d6"
            ]
        ]
    },
    {
        "id": "93a68ffbce74d70d",
        "type": "ui-template",
        "z": "190b0c9aa75e8843",
        "group": "dd4d9707051041c9",
        "page": "",
        "ui": "",
        "name": "Other Informations",
        "order": 1,
        "width": 0,
        "height": 0,
        "head": "",
        "format": "<template>\n  <v-container fluid>\n    <v-row class=\"mt-2\">\n      <!-- Filtered Volume -->\n      <v-col cols=\"12\" md=\"3\">\n        <v-text-field\n          label=\"Filtered Volume\"\n          v-model.number=\"sample_filtered_volume\"\n          :min=\"0\"\n          :max=\"100000\"\n          :step=\"1\"\n          suffix=\"L\"\n          type=\"number\"\n          variant=\"outlined\"\n          hide-details=\"auto\"\n          :disabled=\"isDisabled\"\n          :density=\"isTablet ? 'comfortable' : 'default'\"\n          @input=\"sendUpdate('sample_water_params')\"\n        >\n          <template #append>\n            <v-icon class=\"cursor-pointer\" @click=\"openHint('filtered_volume')\">\n              mdi-information\n            </v-icon>\n          </template>\n        </v-text-field>\n      </v-col>\n\n      <!-- Concentration Factor -->\n      <v-col cols=\"12\" md=\"3\">\n        <v-text-field\n          label=\"Concentration Factor\"\n          v-model.number=\"sample_concentration_factor\"\n          :min=\"0\"\n          :max=\"100\"\n          :step=\"0.01\"\n          suffix=\"\"\n          type=\"number\"\n          variant=\"outlined\"\n          hide-details=\"auto\"\n          :disabled=\"isDisabled\"\n          :density=\"isTablet ? 'comfortable' : 'default'\"\n          @input=\"sendUpdate('sample_water_params')\"\n        >\n          <template #append>\n            <v-icon class=\"cursor-pointer\" @click=\"openHint('concentration_factor')\">\n              mdi-information\n            </v-icon>\n          </template>\n        </v-text-field>\n      </v-col>\n\n      <!-- Sieve Mesh Size -->\n      <v-col cols=\"12\" md=\"3\">\n        <v-text-field\n          label=\"Sieve Mesh Size\"\n          v-model.number=\"sample_sieve_mesh_size\"\n          :min=\"1\"\n          :max=\"1000\"\n          :step=\"10\"\n          suffix=\"m\"\n          type=\"number\"\n          variant=\"outlined\"\n          hide-details=\"auto\"\n          :disabled=\"isDisabled\"\n          :density=\"isTablet ? 'comfortable' : 'default'\"\n          @input=\"sendUpdate('sample_water_params')\"\n        >\n          <template #append>\n            <v-icon class=\"cursor-pointer\" @click=\"openHint('sieve_mesh_size')\">\n              mdi-information\n            </v-icon>\n          </template>\n        </v-text-field>\n      </v-col>\n\n      <!-- Sample Depth -->\n      <v-col cols=\"12\" md=\"3\">\n        <v-text-field\n          label=\"Depth of the Sample\"\n          v-model.number=\"sample_depth\"\n          :min=\"0\"\n          :max=\"10935\"\n          :step=\"1\"\n          suffix=\"m\"\n          type=\"number\"\n          variant=\"outlined\"\n          hide-details=\"auto\"\n          :disabled=\"isDisabled\"\n          :density=\"isTablet ? 'comfortable' : 'default'\"\n          @input=\"sendUpdate('sample_water_params')\"\n        >\n          <template #append>\n            <v-icon class=\"cursor-pointer\" @click=\"openHint('sample_depth')\">\n              mdi-information\n            </v-icon>\n          </template>\n        </v-text-field>\n      </v-col>\n    </v-row>\n\n    <!-- Sample Comment (Toujours actif) -->\n    <v-row>\n      <v-col cols=\"12\">\n        <v-textarea\n          label=\"Sample Comment\"\n          v-model=\"sample_comment\"\n          variant=\"outlined\"\n          rows=\"2\"\n          :density=\"isTablet ? 'comfortable' : 'default'\"\n          @input=\"sendUpdate('sample_water_params')\"\n        >\n          <template #append>\n            <v-icon class=\"cursor-pointer\" @click=\"openHint('sample_comment')\">\n              mdi-information\n            </v-icon>\n          </template>\n        </v-textarea>\n      </v-col>\n    </v-row>\n\n    <!-- MID-INFO POPUP -->\n    <v-dialog v-model=\"hintDialog\" max-width=\"500\">\n      <v-card>\n        <v-card-title class=\"text-h6\">{{ hintTitle }}</v-card-title>\n        <v-card-text>{{ hintText }}</v-card-text>\n        <v-card-actions>\n          <v-spacer></v-spacer>\n          <v-btn color=\"primary\" text @click=\"hintDialog = false\">Got it</v-btn>\n        </v-card-actions>\n      </v-card>\n    </v-dialog>\n  </v-container>\n</template>\n\n<script>\nexport default {\n  props: [\"msg\"],\n  data() {\n    return {\n      sample_filtered_volume: \"\",\n      sample_concentration_factor: \"\",\n      sample_sieve_mesh_size: \"\",\n      sample_depth: \"\",\n      sample_comment: \"\",\n      sample_gear: \"\", // <-- ajout\n      hintDialog: false,\n      hintTitle: \"\",\n      hintText: \"\",\n    };\n  },\n  computed: {\n    isTablet() {\n      return this.$vuetify.display.mdAndDown;\n    },\n    //  Disable fields if Lab culture or Demo / Test\n    isDisabled() {\n      return [\"Lab culture\", \"Demo / Test\"].includes(this.sample_gear);\n    },\n  },\n  watch: {\n    msg: {\n      handler(newMsg) {\n        const p = newMsg?.payload || {};\n        if (p.sample_gear !== undefined) this.sample_gear = p.sample_gear;\n        if (p.sample_filtered_volume !== undefined)\n          this.sample_filtered_volume = Number(p.sample_filtered_volume);\n        if (p.sample_concentration_factor !== undefined)\n          this.sample_concentration_factor = Number(p.sample_concentration_factor);\n        if (p.sample_sieve_mesh_size !== undefined)\n          this.sample_sieve_mesh_size = Number(p.sample_sieve_mesh_size);\n        if (p.sample_depth !== undefined)\n          this.sample_depth = Number(p.sample_depth);\n        if (p.sample_comment !== undefined)\n          this.sample_comment = String(p.sample_comment);\n      },\n      deep: true,\n    },\n  },\n  methods: {\n    sendUpdate(topic, extra = {}) {\n      this.send({\n        topic,\n        payload: {\n          sample_filtered_volume: Number(this.sample_filtered_volume) || 0,\n          sample_concentration_factor: Number(this.sample_concentration_factor) || 0,\n          sample_sieve_mesh_size: Number(this.sample_sieve_mesh_size) || 0,\n          sample_depth: Number(this.sample_depth) || 0,\n          sample_comment: this.sample_comment || \"\",\n          ...extra,\n        },\n      });\n    },\n\n    openHint(type) {\n      if (type === \"filtered_volume\") {\n        this.hintTitle = \"Filtered Volume\";\n        this.hintText =\n          \"Enter the total volume of water that passed through the net or filter during sampling, measured in liters (L).\";\n      } else if (type === \"concentration_factor\") {\n        this.hintTitle = \"Concentration Factor\";\n        this.hintText =\n          \"Specify the ratio by which the filtered water volume was concentrated into the final collected sample.\";\n      } else if (type === \"sieve_mesh_size\") {\n        this.hintTitle = \"Sieve Mesh Size\";\n        this.hintText =\n          \"Indicate the mesh size of the sieve used to separate particles or organisms, in micrometers (m).\";\n      } else if (type === \"sample_depth\") {\n        this.hintTitle = \"Depth of the Sample\";\n        this.hintText =\n          \"Specify the depth (in meters) at which the sample was collected.\";\n      } else if (type === \"sample_comment\") {\n        this.hintTitle = \"Sample Comment\";\n        this.hintText =\n          \"Add any notes or context about the sample (e.g., weather, color, debris, issues).\";\n      }\n      this.hintDialog = true;\n    },\n  },\n};\n</script>\n\n<style scoped>\n@media (max-width: 1024px) {\n  .v-text-field input,\n  .v-textarea textarea {\n    font-size: 1.2rem !important;\n  }\n}\n</style>\n",
        "storeOutMessages": true,
        "passthru": true,
        "resendOnRefresh": true,
        "templateScope": "local",
        "className": "",
        "x": 410,
        "y": 460,
        "wires": [
            [
                "d216b35a8b521fe5"
            ]
        ]
    },
    {
        "id": "8e3eed5be42ad41f",
        "type": "ui-template",
        "z": "190b0c9aa75e8843",
        "group": "59ce6abfbb7f8683",
        "page": "",
        "ui": "",
        "name": "Navigation Bottom",
        "order": 1,
        "width": 0,
        "height": 0,
        "head": "",
        "format": "\n<template>\n  <v-container fluid class=\"ma-0 pa-0\">\n    <v-row align=\"center\" justify=\"space-between\" class=\"px-2\">\n      <!-- Back to Preview -->\n      <v-col cols=\"auto\">\n        <v-btn\n          to=\"preview\"\n          color=\"primary\"\n          rounded=\"lg\"\n          class=\"px-4\" variant=\"text\" size=\"large\"\n        >\n          <v-icon start>mdi-chevron-left</v-icon>\n          Preview\n        </v-btn>\n      </v-col>\n\n      <!-- Forward to Acquisition -->\n      <v-col cols=\"auto\">\n        <v-btn\n          to=\"acquisition\"\n          color=\"primary\"\n          rounded=\"lg\"\n          class=\"px-4\" variant=\"text\" size=\"large\"\n        >\n          Acquisition\n          <v-icon end>mdi-chevron-right</v-icon>\n        </v-btn>\n      </v-col>\n    </v-row>\n  </v-container>\n</template>\n",
        "storeOutMessages": true,
        "passthru": true,
        "resendOnRefresh": true,
        "templateScope": "local",
        "className": "",
        "x": 1290,
        "y": 160,
        "wires": [
            []
        ]
    },
    {
        "id": "a6bc59e4c830d424",
        "type": "function",
        "z": "190b0c9aa75e8843",
        "name": "Get Global Variables",
        "func": "const keys = global.keys(); // Get all global variable keys\nmsg.payload = {}; // Initialize the payload object\n\nkeys.forEach(key => {\n    // Ignore keys that start with \"$\"\n    if (!key.startsWith('$')) {\n        msg.payload[key] = global.get(key);\n    }\n});\n\nreturn msg;\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 120,
        "y": 140,
        "wires": [
            [
                "279f3ddada9cadaa",
                "96550b272e3da513",
                "1c90e219a749e53e",
                "09b551fa202d8029",
                "93a68ffbce74d70d"
            ]
        ]
    },
    {
        "id": "0931106adf64b43d",
        "type": "ui-event",
        "z": "190b0c9aa75e8843",
        "ui": "e6ae26617c24c3ea",
        "name": "UI Event",
        "x": 80,
        "y": 40,
        "wires": [
            [
                "a68e52177173f690"
            ]
        ]
    },
    {
        "id": "a68e52177173f690",
        "type": "switch",
        "z": "190b0c9aa75e8843",
        "name": "msg.topic === \"$pageview\"",
        "property": "topic",
        "propertyType": "msg",
        "rules": [
            {
                "t": "eq",
                "v": "$pageview",
                "vt": "str"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 1,
        "x": 280,
        "y": 40,
        "wires": [
            [
                "b1a74fe5569d418a"
            ]
        ]
    },
    {
        "id": "b1a74fe5569d418a",
        "type": "switch",
        "z": "190b0c9aa75e8843",
        "name": "msg.payload.page.path === \"/metadata\"",
        "property": "payload.page.path",
        "propertyType": "msg",
        "rules": [
            {
                "t": "eq",
                "v": "/metadata",
                "vt": "str"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 1,
        "x": 580,
        "y": 40,
        "wires": [
            [
                "a6bc59e4c830d424"
            ]
        ]
    },
    {
        "id": "9780c3e7b1792160",
        "type": "switch",
        "z": "190b0c9aa75e8843",
        "name": "",
        "property": "topic",
        "propertyType": "msg",
        "rules": [
            {
                "t": "eq",
                "v": "object_datetime",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "object_latlon",
                "vt": "str"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 2,
        "x": 570,
        "y": 200,
        "wires": [
            [
                "ae90b33dfda74614"
            ],
            [
                "875b74e16870159d"
            ]
        ]
    },
    {
        "id": "875b74e16870159d",
        "type": "function",
        "z": "190b0c9aa75e8843",
        "name": "set object_latlon",
        "func": "if (msg.topic) {\n    global.set(\"object_lat\", msg.payload.object_lat);\n    global.set(\"object_lon\", msg.payload.object_lon);\n}\nreturn msg;\n",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 760,
        "y": 240,
        "wires": [
            []
        ]
    },
    {
        "id": "ae90b33dfda74614",
        "type": "function",
        "z": "190b0c9aa75e8843",
        "name": "set object_datetime",
        "func": "if (msg.topic) {\n    global.set(\"object_date\", msg.payload.object_date);\n    global.set(\"object_time\", msg.payload.object_time);\n}\nreturn msg;\n",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 770,
        "y": 200,
        "wires": [
            []
        ]
    },
    {
        "id": "1d06a5e5a5877d24",
        "type": "switch",
        "z": "190b0c9aa75e8843",
        "name": "",
        "property": "topic",
        "propertyType": "msg",
        "rules": [
            {
                "t": "eq",
                "v": "object_datetime_end",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "object_latlon_end",
                "vt": "str"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 2,
        "x": 570,
        "y": 300,
        "wires": [
            [
                "42d27ae01c6fd201"
            ],
            [
                "23f3059257ce93f6"
            ]
        ]
    },
    {
        "id": "23f3059257ce93f6",
        "type": "function",
        "z": "190b0c9aa75e8843",
        "name": "set object_latlon_end",
        "func": "if (msg.topic) {\n    global.set(\"object_lat_end\", msg.payload.object_lat_end);\n    global.set(\"object_lon_end\", msg.payload.object_lon_end);\n}\nreturn msg;\n",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 780,
        "y": 340,
        "wires": [
            []
        ]
    },
    {
        "id": "42d27ae01c6fd201",
        "type": "function",
        "z": "190b0c9aa75e8843",
        "name": "set object_datetime_end",
        "func": "if (msg.topic) {\n    global.set(\"object_date_end\", msg.payload.object_date_end);\n    global.set(\"object_time_end\", msg.payload.object_time_end);\n}\nreturn msg;\n",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 790,
        "y": 300,
        "wires": [
            []
        ]
    },
    {
        "id": "2ef0ae85c43d66d6",
        "type": "switch",
        "z": "190b0c9aa75e8843",
        "name": "",
        "property": "topic",
        "propertyType": "msg",
        "rules": [
            {
                "t": "eq",
                "v": "sample_net_params",
                "vt": "str"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 1,
        "x": 570,
        "y": 400,
        "wires": [
            [
                "e32fbe7bc4987b3c"
            ]
        ]
    },
    {
        "id": "e32fbe7bc4987b3c",
        "type": "function",
        "z": "190b0c9aa75e8843",
        "name": "set sample_net_params",
        "func": "if (msg.topic) {\n    global.set(\"sample_net_mouth_diameter\", msg.payload.sample_net_mouth_diameter);\n    global.set(\"sample_net_length\", msg.payload.sample_net_length);\n    global.set(\"sample_net_mesh_size\", msg.payload.sample_net_mesh_size);\n    global.set(\"sample_collected_volume\", msg.payload.sample_collected_volume);\n}\nreturn msg;\n",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 790,
        "y": 400,
        "wires": [
            []
        ]
    },
    {
        "id": "d216b35a8b521fe5",
        "type": "switch",
        "z": "190b0c9aa75e8843",
        "name": "",
        "property": "topic",
        "propertyType": "msg",
        "rules": [
            {
                "t": "eq",
                "v": "sample_water_params",
                "vt": "str"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 1,
        "x": 570,
        "y": 460,
        "wires": [
            [
                "419e682def601ef5"
            ]
        ]
    },
    {
        "id": "419e682def601ef5",
        "type": "function",
        "z": "190b0c9aa75e8843",
        "name": "set sample_water_params",
        "func": "if (msg.topic) {\n    global.set(\"sample_filtered_volume\", msg.payload.sample_filtered_volume);\n    global.set(\"sample_concentration_factor\", msg.payload.sample_concentration_factor);\n    global.set(\"sample_sieve_mesh_size\", msg.payload.sample_sieve_mesh_size);\n    global.set(\"sample_depth\", msg.payload.sample_depth);\n    global.set(\"sample_comment\", msg.payload.sample_comment);\n}\nreturn msg;\n",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 800,
        "y": 460,
        "wires": [
            []
        ]
    },
    {
        "id": "13f96cf49ae6d6a6",
        "type": "switch",
        "z": "190b0c9aa75e8843",
        "name": "",
        "property": "topic",
        "propertyType": "msg",
        "rules": [
            {
                "t": "eq",
                "v": "sample_project_meta",
                "vt": "str"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 1,
        "x": 570,
        "y": 140,
        "wires": [
            [
                "da13300e5bcb0c26",
                "1c90e219a749e53e",
                "09b551fa202d8029",
                "96550b272e3da513",
                "93a68ffbce74d70d"
            ]
        ]
    },
    {
        "id": "da13300e5bcb0c26",
        "type": "function",
        "z": "190b0c9aa75e8843",
        "name": "set sample_project_meta",
        "func": "if (msg.topic) {\n    global.set(\"sample_project\", msg.payload.sample_project);\n    global.set(\"sample_operator\", msg.payload.sample_operator);\n    global.set(\"sample_id\", msg.payload.sample_id);\n    global.set(\"sample_gear\", msg.payload.sample_gear);\n}\nreturn msg;\n",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 790,
        "y": 140,
        "wires": [
            []
        ]
    },
    {
        "id": "ffe728d961068c62",
        "type": "ui-template",
        "z": "35d7387466dd0bc0",
        "group": "b274327af3807b79",
        "page": "",
        "ui": "",
        "name": "Streaming",
        "order": 1,
        "width": "7",
        "height": "18",
        "head": "",
        "format": "  <iframe \n    src=\"/preview/node-red\" \n    >\n  </iframe>\n  <style>\n    iframe {\n      width: 100%;\n      height: 100%;\n      margin: 0;\n      border: none;\n    }\n  </style>",
        "storeOutMessages": true,
        "passthru": true,
        "resendOnRefresh": true,
        "templateScope": "local",
        "className": "",
        "x": 1310,
        "y": 100,
        "wires": [
            []
        ]
    },
    {
        "id": "aa6924c7e0aff26c",
        "type": "ui-template",
        "z": "35d7387466dd0bc0",
        "group": "d2f77573ed4317e4",
        "page": "",
        "ui": "",
        "name": "Acquisition settings",
        "order": 1,
        "width": 0,
        "height": 0,
        "head": "",
        "format": "<template>\n  <v-container fluid>\n    <!-- Acquisition ID -->\n    <v-row>\n      <v-col cols=\"12\">\n        <v-text-field\n          v-model.number=\"acq_id\"\n          type=\"number\"\n          label=\"Acquisition ID\"\n          variant=\"outlined\"\n          placeholder=\"ex : 001\"\n          @input=\"sendUpdate()\" \n          prefix=\"A_\"\n          density=\"compact\"\n\n        >\n          <template #append>\n            <v-icon color=\"primary\" class=\"cursor-pointer\"\n              @click=\"openHint('Acquisition ID','Unique identifier for each acquisition run.')\">\n              mdi-information\n            </v-icon>\n          </template>\n        </v-text-field>\n      </v-col>\n    </v-row>\n\n    <!-- Number of Images -->\n    <v-row>\n      <v-col cols=\"12\" sm=\"8\">\n        <v-slider\n          v-model.number=\"acq_nb_frame\"\n          :max=\"10000\"\n          :min=\"1\"\n          :step=\"1\"\n          label=\"Number of Images\"\n          hide-details\n          @update:model-value=\"autoCalculateVolumes\"\n        />\n      </v-col>\n      <v-col cols=\"12\" sm=\"4\">\n        <v-text-field\n          v-model.number=\"acq_nb_frame\"\n          type=\"number\"\n          variant=\"outlined\"\n          hide-details\n          suffix=\"img\"\n          class=\"aligned-input\"\n          @input=\"autoCalculateVolumes\"\n        >\n          <template #append>\n            <v-icon color=\"primary\" class=\"cursor-pointer\"\n              @click=\"openHint('Number of Images','Total number of images captured during acquisition.')\">\n              mdi-information\n            </v-icon>\n          </template>\n        </v-text-field>\n      </v-col>\n    </v-row>\n\n    <!-- Interimage Volume -->\n    <v-row>\n      <v-col cols=\"12\" sm=\"8\">\n        <v-slider\n          :model-value=\"acq_interframe_volume * 1000\"\n@update:model-value=\"v => { acq_interframe_volume = v / 1000; autoCalculateVolumes(); }\"\n\n          :max=\"100\"\n          :min=\"0\"\n          :step=\"1\"\n          label=\"Volume between images\"\n          hide-details\n          @update:model-value=\"autoCalculateVolumes\"\n        />\n      </v-col>\n      <v-col cols=\"12\" sm=\"4\">\n        <v-text-field\n          :model-value=\"acq_interframe_volume * 1000\"\n@update:model-value=\"v => { acq_interframe_volume = v / 1000; autoCalculateVolumes(); }\"\n\n          type=\"number\"\n          variant=\"outlined\"\n          hide-details\n          suffix=\"L\"\n          class=\"aligned-input\"\n          @input=\"autoCalculateVolumes\"\n        >\n          <template #append>\n            <v-icon color=\"primary\" class=\"cursor-pointer\"\n              @click=\"openHint('Volume between images','Sample volume displaced between consecutive images (L).')\">\n              mdi-information\n            </v-icon>\n          </template>\n        </v-text-field>\n      </v-col>\n    </v-row>\n\n    <!-- Volume Imaged -->\n    <v-row class=\"aligned-row\">\n      <v-col cols=\"12\" sm=\"8\" class=\"d-flex align-center\">\n        <span class=\"text-subtitle-1 text-medium-emphasis ma-2\">Volume Imaged :</span>\n      </v-col>\n      <v-col cols=\"12\" sm=\"4\" class=\"d-flex align-center\">\n        <v-text-field\n          :model-value=\"fmt(acq_imaged_volume)\"\n          suffix=\"mL\"\n          variant=\"outlined\"\n          hide-details\n          readonly\n          class=\"aligned-input mr-1\"\n        >\n          <template #append>\n            <v-icon color=\"primary\" class=\"cursor-pointer\" @click=\"showVolumeImagedHint()\">\n              mdi-information\n            </v-icon>\n          </template>\n        </v-text-field>\n      </v-col>\n    </v-row>\n\n    <!-- Total Volume Displaced -->\n    <v-row class=\"aligned-row\">\n      <v-col cols=\"12\" sm=\"8\" class=\"d-flex align-center\">\n        <span class=\"text-subtitle-1 text-medium-emphasis ma-2\">Total Volume Displaced :</span>\n      </v-col>\n      <v-col cols=\"12\" sm=\"4\" class=\"d-flex align-center\">\n        <v-text-field\n          :model-value=\"fmt(acq_pumped_volume)\"\n          suffix=\"mL\"\n          variant=\"outlined\"\n          hide-details\n          readonly\n          class=\"aligned-input mr-1\"\n        >\n          <template #append>\n            <v-icon color=\"primary\" class=\"cursor-pointer\" @click=\"showVolumeDisplacedHint()\">\n              mdi-information\n            </v-icon>\n          </template>\n        </v-text-field>\n      </v-col>\n    </v-row>\n\n    <!-- Comment -->\n    <v-row>\n      <v-col cols=\"12\">\n        <v-textarea\n          v-model=\"acq_comment\"\n          label=\"Acquisition Comment\"\n          variant=\"outlined\"\n          rows=\"2\"\n          @input=\"sendUpdate()\"\n        >\n          <template #append>\n            <v-icon color=\"primary\" class=\"cursor-pointer\"\n              @click=\"openHint('Acquisition Comment','Notes or remarks about this acquisition.')\">\n              mdi-information\n            </v-icon>\n          </template>\n        </v-textarea>\n      </v-col>\n    </v-row>\n\n    <!-- Progress Bar -->\n    <v-row>\n      <v-col cols=\"12\">\n        <v-progress-linear\n          :model-value=\"progression\"\n          color=\"primary\"\n          height=\"24\"\n          rounded\n          striped\n          class=\"mt-2 mb-2\"\n        >\n          <template #default=\"{ value }\">\n            <strong>{{ Math.min(100, Math.ceil(value || 0)) }}%</strong>\n          </template>\n        </v-progress-linear>\n      </v-col>\n    </v-row>\n\n    <!-- Estimated Duration -->\n    <v-row class=\"aligned-row\">\n      <v-col cols=\"12\" sm=\"8\" class=\"d-flex align-center\">\n        <span class=\"text-subtitle-1 text-medium-emphasis ma-2\">Estimated duration left :</span>\n      </v-col>\n      <v-col cols=\"12\" sm=\"4\" class=\"d-flex align-center\">\n        <v-text-field\n          :model-value=\"formatDuration(duration_left)\"\n          variant=\"plain\"\n          hide-details\n          readonly\n          class=\"aligned-input\"\n        />\n      </v-col>\n    </v-row>\n\n    <!-- Status Alert -->\n    <v-row>\n      <v-col cols=\"12\">\n        <v-alert\n          v-if=\"acq_status_message\"\n          :type=\"statusType\"\n          :color=\"statusColor\"\n          border=\"start\"\n          variant=\"tonal\"\n          class=\"text-subtitle-1\"\n          prominent\n        >\n          {{ formattedStatus }}\n        </v-alert>\n      </v-col>\n    </v-row>\n\n    <!-- Start / Stop Toggle -->\n    <v-row>\n      <v-col cols=\"12\">\n        <v-btn-toggle\n          v-model=\"acq_status\"\n          variant=\"outlined\"\n          mandatory\n          divided\n          shaped\n          class=\"d-flex justify-space-between mt-4\"\n          @update:model-value=\"handleAcqStatusChange\"\n        >\n          <v-btn class=\"flex-grow-1\" value=\"off\" color=\"red\">Stop</v-btn>\n          <v-btn class=\"flex-grow-1\" value=\"on\" color=\"green\">Start</v-btn>\n        </v-btn-toggle>\n      </v-col>\n    </v-row>\n\n    <!-- Hint Dialog -->\n    <v-dialog v-model=\"hintDialog\" max-width=\"600\">\n      <v-card>\n        <v-card-title class=\"text-h6\">{{ hintTitle }}</v-card-title>\n        <v-card-text v-html=\"hintText\" class=\"text-body-2\"></v-card-text>\n        <v-card-actions>\n          <v-spacer></v-spacer>\n          <v-btn text color=\"primary\" @click=\"hintDialog = false\">Close</v-btn>\n        </v-card-actions>\n      </v-card>\n    </v-dialog>\n  </v-container>\n</template>\n<script>\nexport default {\n  props: [\"msg\"],\n  data() {\n    return {\n      acq_id: \"\",\n      acq_nb_frame: \"\",\n      acq_interframe_volume: 0,\n      acq_imaged_volume: 0,\n      acq_pumped_volume: 0,\n      acq_comment: \"\",   //  Champ sensible : protg dans le watcher\n      progression: 0,\n      duration_left: 0,\n      acq_status: \"off\",\n      acq_status_message: \"\",\n      calibration_pixel_size: 0,\n      calibration_sensor_width: 0,\n      calibration_sensor_height: 0,\n      acq_flowcell_thickness: 0,\n      frame_volume_um3: 0,\n      topic: \"acq_params\",\n      hintDialog: false,\n      hintTitle: \"\",\n      hintText: \"\",\n      lastUpdateTime: null,\n\n      acq_start_timestamp: null,\n    };\n  },\n\n  computed: {\n    sensor_width_um() { return (this.calibration_sensor_width || 0) * (this.calibration_pixel_size || 0); },\n    sensor_height_um() { return (this.calibration_sensor_height || 0) * (this.calibration_pixel_size || 0); },\n    frame_volume_ml() { return this.frame_volume_um3 / 1e12; },\n\n    formattedStatus() {\n      const s = this.acq_status_message;\n      if (s === \"Started\") return \"Image capture process has started successfully.\";\n      if (s === \"Done\") return \"Acquisition completed successfully.\";\n      return s;\n    },\n\n    statusColor() {\n      const s = this.acq_status_message || \"\";\n      if (!s) return \"grey\";\n      if (s.startsWith(\"Error\")) return \"red\";\n      if (s.startsWith(\"Configuration update error\")) return \"orange\";\n      if (s.includes(\"WAS NOT CAPTURED\")) return \"red\";\n      if ([\"Started\", \"Done\"].includes(s)) return \"green\";\n      return \"grey\";\n    },\n\n    statusType() {\n      if (this.statusColor === \"green\") return \"success\";\n      if (this.statusColor === \"orange\") return \"warning\";\n      if (this.statusColor === \"red\") return \"error\";\n      return \"info\";\n    },\n  },\n\n  watch: {\n    msg: {\n      handler(newMsg) {\n        const p = newMsg?.payload || {};\n        const topic = newMsg?.topic;\n\n        if (p.acq_id !== undefined)\n          this.acq_id = String(p.acq_id).replace(/^A[_-]?/, \"\");\n\n        // --------------------------------\n        //  PROTECTION du acq_comment\n        //  On NE l'crase que si prsent dans le payload\n        // --------------------------------\n        if (\"acq_comment\" in p) {\n          this.acq_comment = p.acq_comment ?? \"\";\n        }\n\n        if (p.acq_nb_frame !== undefined)\n          this.acq_nb_frame = Number(p.acq_nb_frame);\n\n        if (p.acq_interframe_volume !== undefined)\n          this.acq_interframe_volume = Number(p.acq_interframe_volume);\n\n        if (p.calibration_pixel_size !== undefined)\n          this.calibration_pixel_size = Number(p.calibration_pixel_size);\n\n        if (p.calibration_sensor_width !== undefined)\n          this.calibration_sensor_width = Number(p.calibration_sensor_width);\n\n        if (p.calibration_sensor_height !== undefined)\n          this.calibration_sensor_height = Number(p.calibration_sensor_height);\n\n        if (p.acq_flowcell_thickness !== undefined)\n          this.acq_flowcell_thickness = Number(p.acq_flowcell_thickness);\n\n        if (p.acq_start_timestamp !== undefined && p.acq_start_timestamp !== null) {\n          this.acq_start_timestamp = Number(p.acq_start_timestamp);\n        }\n\n        // PRIORIT Image X/Y = acquisition en cours\n        if (p.status && /Image\\s+\\d+\\s*\\/\\s*\\d+/i.test(p.status))\n          this.acq_status = \"on\";\n\n        if (p.status !== undefined) {\n          this.acq_status_message = p.status;\n          const s = String(p.status).toLowerCase();\n\n          if (!/Image\\s+\\d+\\s*\\/\\s*\\d+/i.test(p.status)) {\n            if (s.includes(\"capturing\") || s.includes(\"running\") || s.includes(\"started\"))\n              this.acq_status = \"on\";\n          }\n\n          if (s.includes(\"done\") || s.includes(\"idle\") || s.includes(\"stopped\") || s.includes(\"error\"))\n            this.acq_status = \"off\";\n\n          this.extractProgressFromMessage();\n        }\n\n        if (topic === \"status/imager\" && p.status === \"Done\") {\n          this.incrementAcqId();\n          this.resetProgress();\n        }\n\n        this.autoCalculateVolumes();\n      },\n      deep: true,\n    },\n  },\n\n  methods: {\n    fmt(v) { return Number(v || 0).toFixed(3); },\n\n    formatDuration(mins) {\n      const totalSeconds = Math.max(0, Math.round(mins * 60));\n      const h = String(Math.floor(totalSeconds / 3600)).padStart(2, \"0\");\n      const m = String(Math.floor((totalSeconds % 3600) / 60)).padStart(2, \"0\");\n      const s = String(totalSeconds % 60).padStart(2, \"0\");\n      return `${h}:${m}:${s}`;\n    },\n\n    resetProgress() {\n      this.progression = 0;\n      this.duration_left = 0;\n      this.lastUpdateTime = Date.now();\n    },\n\n    incrementAcqId() {\n      const next = String(Number(this.acq_id || 0) + 1).padStart(1, \"0\");\n      this.acq_id = next;\n      this.sendUpdate();\n    },\n\n    autoCalculateVolumes() {\n      if (this.calibration_sensor_width > 0 && this.calibration_sensor_height > 0 &&\n          this.calibration_pixel_size > 0 && this.acq_flowcell_thickness > 0) {\n        \n        const w = this.calibration_sensor_width * this.calibration_pixel_size;\n        const h = this.calibration_sensor_height * this.calibration_pixel_size;\n        const t = this.acq_flowcell_thickness;\n\n        this.frame_volume_um3 = w * h * t;\n        const frame_ml = this.frame_volume_um3 / 1e12;\n        this.acq_imaged_volume = frame_ml * (this.acq_nb_frame || 0);\n      }\n\n      const interimage_total_ml = (this.acq_interframe_volume || 0) * (this.acq_nb_frame || 0);\n\n      this.acq_pumped_volume = this.acq_imaged_volume + interimage_total_ml;\n\n      this.updateProgress();\n      this.sendUpdate();\n    },\n\n    extractProgressFromMessage() {\n      const s = this.acq_status_message || \"\";\n      const match = s.match(/Image\\s+(\\d+)\\s*\\/\\s*(\\d+)/i);\n      if (!match) return;\n\n      const current = Number(match[1]);\n      const total = Number(match[2]);\n      this.progression = Math.min(100, (current / total) * 100);\n\n      if (!this.acq_start_timestamp) return;\n\n      const now = Date.now();\n      const elapsedSec = (now - this.acq_start_timestamp) / 1000;\n      if (elapsedSec <= 0 || current === 0) return;\n\n      const avgPerFrameSec = elapsedSec / current;\n      this.duration_left = ((total - current) * avgPerFrameSec) / 60;\n    },\n\n    updateProgress() {\n      if (this.acq_status === \"on\" && this.acq_nb_frame > 0) {\n        const elapsed = (Date.now() - (this.lastUpdateTime || Date.now())) / 1000;\n        if (elapsed > 0) {\n          this.progression = Math.min(100, this.progression + (elapsed / this.acq_nb_frame) * 100);\n          this.duration_left = ((100 - this.progression) / 100) * (this.acq_nb_frame / 60);\n        }\n        this.lastUpdateTime = Date.now();\n      }\n    },\n\n    handleAcqStatusChange(value) {\n      this.acq_status = value;\n\n      if (value === \"on\") {\n        this.resetProgress();\n        this.acq_start_timestamp = Date.now();\n      }\n\n      if (value === \"off\") {\n        this.incrementAcqId();\n      }\n\n      if (typeof this.send === \"function\") {\n        this.send({\n          topic: \"imager/image\",\n          payload: { status: value }\n        });\n      }\n\n      this.sendUpdate();\n    },\n\nshowVolumeImagedHint() {\n  const area = this.sensor_width_um * this.sensor_height_um;\n\n  const html = `<div class=\"text-body-2\">\n    <p class=\"mb-2\">\n      <strong>Volume Imaged</strong> represents the total fluid volume optically captured.\n    </p>\n\n    <v-divider class=\"my-3\"></v-divider>\n\n    <ul class=\"ml-4\">\n      <li>\n        <strong>Sensor width:</strong>\n        ${Math.round(this.calibration_sensor_width)} px  ${Math.round(this.sensor_width_um)} m\n      </li>\n      <li>\n        <strong>Sensor height:</strong>\n        ${Math.round(this.calibration_sensor_height)} px  ${Math.round(this.sensor_height_um)} m\n      </li>\n      <li>\n        <strong>Flowcell thickness:</strong>\n        ${Math.round(this.acq_flowcell_thickness)} m\n        <a href=\"hardware\" target=\"_blank\" class=\"text-primary ms-1\">\n          (Check or modify in hardware settings)\n        </a>\n      </li>\n    </ul>\n\n    <p class=\"mt-4 mb-2\">\n      <strong>Step-by-step calculation:</strong>\n    </p>\n\n    <ol class=\"ml-4\">\n      <li>\n        Area per image = width  height =\n        ${Math.round(this.sensor_width_um)}  ${Math.round(this.sensor_height_um)} =\n        ${Math.round(area)} m\n      </li>\n      <li>\n        Volume per image = area  thickness =\n        ${Math.round(area)}  ${Math.round(this.acq_flowcell_thickness)} =\n        ${Math.round(area * this.acq_flowcell_thickness)} m\n      </li>\n      <li>\n        Convert m  mL: divide by 1e12 \n        ${this.fmt(this.frame_volume_ml)} mL per image\n      </li>\n      <li>\n        Total = ${this.acq_nb_frame}  ${this.fmt(this.frame_volume_ml)} mL =\n        <strong>${this.fmt(this.acq_imaged_volume)} mL</strong>\n      </li>\n    </ol>\n  </div>`;\n\n  this.openHint(\"Volume Imaged\", html);\n},\n\nshowVolumeDisplacedHint() {\n  const inter_ml = (this.acq_nb_frame * this.acq_interframe_volume) / 1000;\n\n  const html = `\n    <p><b>Total Volume Displaced</b> includes both the imaged volume and the extra fluid moved between images.</p>\n    <hr>\n    <ul>\n      <li><b>Interimage displacement:</b> ${this.acq_nb_frame}  ${this.fmt(this.acq_interframe_volume)} L = ${this.fmt(inter_ml)} mL</li>\n      <li><b>Imaged volume:</b> ${this.fmt(this.acq_imaged_volume)} mL</li>\n    </ul>\n    <p><b>Total:</b> ${this.fmt(this.acq_imaged_volume)} + ${this.fmt(inter_ml)} = \n    <b>${this.fmt(this.acq_pumped_volume)} mL</b></p>\n  `;\n\n  this.openHint(\"Total Volume Displaced\", html);\n},\n\n    openHint(title, text) {\n      this.hintDialog = true;\n      this.hintTitle = title;\n      this.hintText = text;\n    },\n\n    // --------------------------------\n    // ENVOI MAITRIS\n    // --------------------------------\n    sendUpdate(extra = {}) {\n      if (typeof this.send !== \"function\") return;\n\n      this.send({\n        topic: this.topic,\n        payload: {\n          acq_id: `A_${this.acq_id}`,\n          acq_nb_frame: this.acq_nb_frame,\n          acq_interframe_volume: this.acq_interframe_volume,\n          acq_imaged_volume: Number(this.acq_imaged_volume.toFixed(2)),\n          acq_pumped_volume: Number(this.acq_pumped_volume.toFixed(2)),\n          acq_comment: this.acq_comment,        //  toujours envoy\n          progression: this.progression,\n          duration_left: this.duration_left,\n          status: this.acq_status_message,\n          calibration_pixel_size: this.calibration_pixel_size,\n          calibration_sensor_width: this.calibration_sensor_width,\n          calibration_sensor_height: this.calibration_sensor_height,\n          acq_flowcell_thickness: this.acq_flowcell_thickness,\n          acq_start_timestamp: this.acq_start_timestamp,\n          ...extra,\n        },\n      });\n    },\n  },\n};\n</script>\n\n<style scoped>\n.cursor-pointer { cursor: pointer; }\n</style>\n",
        "storeOutMessages": true,
        "passthru": true,
        "resendOnRefresh": true,
        "templateScope": "local",
        "className": "",
        "x": 370,
        "y": 140,
        "wires": [
            [
                "56b3c60c6d4ffd87"
            ]
        ]
    },
    {
        "id": "a39e07fd1a86ac84",
        "type": "ui-template",
        "z": "35d7387466dd0bc0",
        "group": "3ae252a2e5abca89",
        "page": "",
        "ui": "",
        "name": "Navigation Top",
        "order": 1,
        "width": 0,
        "height": 0,
        "head": "",
        "format": "<template>\n  <v-container fluid class=\"ma-0 pa-0\">\n    <v-row \n      align=\"center\" \n      class=\"px-2 py-0\" \n      no-gutters\n    >\n      \n      <v-col cols=\"3\" class=\"py-0 d-flex justify-start\">\n        <v-btn\n          to=\"metadata\"\n          color=\"primary\"\n          rounded=\"lg\"\n          class=\"px-4\" variant=\"text\" size=\"large\"\n        >\n          <v-icon start>mdi-chevron-left</v-icon>\n          Metadata\n        </v-btn>\n      </v-col>\n\n      <v-col cols=\"6\" class=\"text-center py-0\">\n        <h1 class=\"text-h5 font-weight-bold text-primary my-0 text-truncate\">\n          Acquisition\n        </h1>\n      </v-col>\n\n      <v-col cols=\"3\" class=\"py-0 d-flex justify-end\">\n        <v-btn\n          to=\"segmentation\"\n          color=\"primary\"\n          rounded=\"lg\"\n          class=\"px-4\" variant=\"text\" size=\"large\"\n        >\n          Segmentation\n          <v-icon end>mdi-chevron-right</v-icon>\n        </v-btn>\n      </v-col>\n      \n    </v-row>\n  </v-container>\n</template>",
        "storeOutMessages": true,
        "passthru": true,
        "resendOnRefresh": true,
        "templateScope": "local",
        "className": "",
        "x": 1300,
        "y": 40,
        "wires": [
            []
        ]
    },
    {
        "id": "56b3c60c6d4ffd87",
        "type": "switch",
        "z": "35d7387466dd0bc0",
        "name": "",
        "property": "topic",
        "propertyType": "msg",
        "rules": [
            {
                "t": "eq",
                "v": "acq_params",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "imager/image",
                "vt": "str"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 2,
        "x": 570,
        "y": 140,
        "wires": [
            [
                "f841ebf999dd8cb3"
            ],
            [
                "09ecc922fe2214a8"
            ]
        ]
    },
    {
        "id": "f841ebf999dd8cb3",
        "type": "function",
        "z": "35d7387466dd0bc0",
        "name": "set acq_params",
        "func": "if (msg.topic) {\n    global.set(\"acq_id\", msg.payload.acq_id);\n    global.set(\"acq_nb_frame\", msg.payload.acq_nb_frame);\n    global.set(\"acq_interframe_volume\", msg.payload.acq_interframe_volume);\n    global.set(\"acq_imaged_volume\", msg.payload.acq_imaged_volume);\n    global.set(\"acq_pumped_volume\", msg.payload.acq_pumped_volume);\n    global.set(\"acq_comment\", msg.payload.acq_comment);\n    global.set(\"acq_progression\", msg.payload.acq_progression);\n    global.set(\"acq_duration_left\", msg.payload.acq_duration_left);\n    global.set(\"acq_start_timestamp\", msg.payload.acq_start_timestamp);\n    \n}\nreturn msg;\n",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 760,
        "y": 140,
        "wires": [
            []
        ]
    },
    {
        "id": "e3c084164002f23f",
        "type": "ui-event",
        "z": "35d7387466dd0bc0",
        "ui": "e6ae26617c24c3ea",
        "name": "UI Event",
        "x": 80,
        "y": 40,
        "wires": [
            [
                "5bea829ec02ded61"
            ]
        ]
    },
    {
        "id": "5bea829ec02ded61",
        "type": "switch",
        "z": "35d7387466dd0bc0",
        "name": "msg.topic === \"$pageview\"",
        "property": "topic",
        "propertyType": "msg",
        "rules": [
            {
                "t": "eq",
                "v": "$pageview",
                "vt": "str"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 1,
        "x": 280,
        "y": 40,
        "wires": [
            [
                "54ae95ca6088f307"
            ]
        ]
    },
    {
        "id": "54ae95ca6088f307",
        "type": "switch",
        "z": "35d7387466dd0bc0",
        "name": "msg.payload.page.path === \"/acquisition\"",
        "property": "payload.page.path",
        "propertyType": "msg",
        "rules": [
            {
                "t": "eq",
                "v": "/acquisition",
                "vt": "str"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 1,
        "x": 590,
        "y": 40,
        "wires": [
            [
                "113085f8dd63df0c"
            ]
        ]
    },
    {
        "id": "113085f8dd63df0c",
        "type": "function",
        "z": "35d7387466dd0bc0",
        "name": "Get Global Variables",
        "func": "const keys = global.keys(); // Get all global variable keys\nmsg.payload = {}; // Initialize the payload object\n\nkeys.forEach(key => {\n    // Ignore keys that start with \"$\"\n    if (!key.startsWith('$')) {\n        msg.payload[key] = global.get(key);\n    }\n});\n\nreturn msg;\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 120,
        "y": 140,
        "wires": [
            [
                "aa6924c7e0aff26c"
            ]
        ]
    },
    {
        "id": "8ceee00f68df186c",
        "type": "mqtt in",
        "z": "35d7387466dd0bc0",
        "name": "",
        "topic": "status/imager",
        "qos": "0",
        "datatype": "json",
        "broker": "8dc3722c.06efa8",
        "nl": false,
        "rap": false,
        "inputs": 0,
        "x": 90,
        "y": 200,
        "wires": [
            [
                "aa6924c7e0aff26c"
            ]
        ]
    },
    {
        "id": "425d72ed91ea264e",
        "type": "ui-template",
        "z": "35d7387466dd0bc0",
        "group": "3d88a1872dbbf8a7",
        "page": "",
        "ui": "",
        "name": "Navigation Bottom",
        "order": 1,
        "width": 0,
        "height": 0,
        "head": "",
        "format": "\n<template>\n  <v-container fluid class=\"ma-0 pa-0\">\n    <v-row align=\"center\" justify=\"space-between\" class=\"px-2\">\n      <!-- Back to Preview -->\n      <v-col cols=\"auto\">\n        <v-btn\n          to=\"metadata\"\n          color=\"primary\"\n          rounded=\"lg\"\n          class=\"px-4\" variant=\"text\" size=\"large\"\n        >\n          <v-icon start>mdi-chevron-left</v-icon>\n          Metadata\n        </v-btn>\n      </v-col>\n\n      <!-- Forward to Acquisition -->\n      <v-col cols=\"auto\">\n        <v-btn\n          to=\"segmentation\"\n          color=\"primary\"\n          rounded=\"lg\"\n          class=\"px-4\" variant=\"text\" size=\"large\"\n        >\n          Segmentation\n          <v-icon end>mdi-chevron-right</v-icon>\n        </v-btn>\n      </v-col>\n    </v-row>\n  </v-container>\n</template>\n",
        "storeOutMessages": true,
        "passthru": true,
        "resendOnRefresh": true,
        "templateScope": "local",
        "className": "",
        "x": 1290,
        "y": 160,
        "wires": [
            []
        ]
    },
    {
        "id": "46b98c54eb680c2e",
        "type": "mqtt out",
        "z": "35d7387466dd0bc0",
        "name": "MQTT",
        "topic": "",
        "qos": "",
        "retain": "",
        "respTopic": "",
        "contentType": "",
        "userProps": "",
        "correl": "",
        "expiry": "",
        "broker": "8dc3722c.06efa8",
        "x": 1070,
        "y": 200,
        "wires": []
    },
    {
        "id": "7d28a539738ca73a",
        "type": "function",
        "z": "35d7387466dd0bc0",
        "name": "update_config",
        "func": "const keys = global.keys(); // Rcupre toutes les cls des variables globales\nlet config = {}; // Objet pour stocker la configuration\n\nkeys.forEach(key => {\n    // Ignore les cls qui commencent par \"$\"\n    if (!key.startsWith('$')) {\n        // Ne garde que celles qui commencent par les prfixes demands\n        if (\n            key.startsWith('sample_') ||\n            key.startsWith('acq_') ||\n            key.startsWith('object_') ||\n            key.startsWith('process_') ||\n            key.startsWith('img_')\n        ) {\n            config[key] = global.get(key);\n        }\n    }\n});\n\n// Cre le payload final\nmsg.payload = {\n    action: \"update_config\",\n    config: config\n};\n\nreturn msg;\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 760,
        "y": 200,
        "wires": [
            [
                "46b98c54eb680c2e"
            ]
        ]
    },
    {
        "id": "09ecc922fe2214a8",
        "type": "switch",
        "z": "35d7387466dd0bc0",
        "name": "",
        "property": "payload.status",
        "propertyType": "msg",
        "rules": [
            {
                "t": "eq",
                "v": "on",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "off",
                "vt": "str"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 2,
        "x": 570,
        "y": 200,
        "wires": [
            [
                "7d28a539738ca73a",
                "bb2825f419cc6526"
            ],
            [
                "44c8ea6299e13784"
            ]
        ]
    },
    {
        "id": "44c8ea6299e13784",
        "type": "function",
        "z": "35d7387466dd0bc0",
        "name": "stop acquisition",
        "func": "\nmsg.payload = {\n    action: \"stop\"\n};\n\nreturn msg;\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 760,
        "y": 240,
        "wires": [
            [
                "46b98c54eb680c2e"
            ]
        ]
    },
    {
        "id": "bb2825f419cc6526",
        "type": "function",
        "z": "35d7387466dd0bc0",
        "name": "start acquisition",
        "func": "const acq_interframe_volume = global.get(\"acq_interframe_volume\") || 0;\nconst acq_nb_frame = global.get(\"acq_nb_frame\") || 0;\n\n\n// Cre le payload final\nmsg.payload = {\n    action: \"image\",\n    pump_direction: \"FORWARD\",\n    volume: acq_interframe_volume,\n    nb_frame: acq_nb_frame,\n    sleep: 0.1\n};\n\nreturn msg;\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 760,
        "y": 280,
        "wires": [
            [
                "ce5cca3b8fe34379"
            ]
        ]
    },
    {
        "id": "ce5cca3b8fe34379",
        "type": "delay",
        "z": "35d7387466dd0bc0",
        "name": "",
        "pauseType": "delay",
        "timeout": "1",
        "timeoutUnits": "seconds",
        "rate": "1",
        "nbRateUnits": "1",
        "rateUnits": "second",
        "randomFirst": "1",
        "randomLast": "5",
        "randomUnits": "seconds",
        "drop": false,
        "allowrate": false,
        "outputs": 1,
        "x": 920,
        "y": 280,
        "wires": [
            [
                "46b98c54eb680c2e"
            ]
        ]
    },
    {
        "id": "250979b4672d81b6",
        "type": "ui-event",
        "z": "0fd76ac156d78937",
        "ui": "e6ae26617c24c3ea",
        "name": "UI Event",
        "x": 80,
        "y": 40,
        "wires": [
            [
                "72421c36bb0418bc"
            ]
        ]
    },
    {
        "id": "72421c36bb0418bc",
        "type": "switch",
        "z": "0fd76ac156d78937",
        "name": "msg.topic === \"$pageview\"",
        "property": "topic",
        "propertyType": "msg",
        "rules": [
            {
                "t": "eq",
                "v": "$pageview",
                "vt": "str"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 1,
        "x": 280,
        "y": 40,
        "wires": [
            [
                "66d295cc27d69cec"
            ]
        ]
    },
    {
        "id": "66d295cc27d69cec",
        "type": "switch",
        "z": "0fd76ac156d78937",
        "name": "msg.payload.page.path === \"/segmentation\"",
        "property": "payload.page.path",
        "propertyType": "msg",
        "rules": [
            {
                "t": "eq",
                "v": "/segmentation",
                "vt": "str"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 1,
        "x": 590,
        "y": 40,
        "wires": [
            [
                "d4129bf3f5622aa6",
                "921be0438de344ac"
            ]
        ]
    },
    {
        "id": "61c2c281b1c6e055",
        "type": "ui-table",
        "z": "0fd76ac156d78937",
        "group": "bfd4acb7b243514f",
        "name": "List of acq",
        "label": "",
        "order": 1,
        "width": 0,
        "height": 0,
        "maxrows": "100",
        "passthru": false,
        "autocols": false,
        "showSearch": false,
        "deselect": true,
        "selectionType": "click",
        "columns": [
            {
                "title": "Project name",
                "key": "project_name",
                "keyType": "key",
                "type": "text",
                "width": "",
                "align": "start"
            },
            {
                "title": "Sample ID",
                "key": "sample_id",
                "keyType": "key",
                "type": "text",
                "width": "",
                "align": "start"
            },
            {
                "title": "Acquisition ID",
                "key": "acquisition_id",
                "keyType": "key",
                "type": "text",
                "width": "",
                "align": "start"
            },
            {
                "title": "Operator Name",
                "key": "operator_name",
                "keyType": "key",
                "type": "text",
                "width": "",
                "align": "start"
            },
            {
                "title": "Number of images",
                "key": "image_acquired_count",
                "keyType": "key",
                "type": "text",
                "width": "",
                "align": "start"
            },
            {
                "title": "Path",
                "key": "path",
                "keyType": "key",
                "type": "text",
                "width": "",
                "align": "start"
            },
            {
                "title": "Segmented",
                "key": "is_segmented",
                "keyType": "key",
                "type": "tickcross",
                "width": "",
                "align": "start"
            }
        ],
        "mobileBreakpoint": "sm",
        "mobileBreakpointType": "defaults",
        "action": "replace",
        "x": 330,
        "y": 140,
        "wires": [
            [
                "cdb586337f186494"
            ]
        ]
    },
    {
        "id": "d4129bf3f5622aa6",
        "type": "list acquisitions",
        "z": "0fd76ac156d78937",
        "name": "",
        "x": 100,
        "y": 140,
        "wires": [
            [
                "61c2c281b1c6e055"
            ]
        ]
    },
    {
        "id": "9e44bf9a44615e20",
        "type": "ui-template",
        "z": "0fd76ac156d78937",
        "group": "9f00807878a32dd5",
        "page": "",
        "ui": "",
        "name": "Navigation Bottom",
        "order": 1,
        "width": 0,
        "height": 0,
        "head": "",
        "format": "\n<template>\n  <v-container fluid class=\"ma-0 pa-0\">\n    <v-row align=\"center\" justify=\"space-between\" class=\"px-2\">\n      <!-- Back to Preview -->\n      <v-col cols=\"auto\">\n        <v-btn\n          to=\"acquisition\"\n          color=\"primary\"\n          rounded=\"lg\"\n          class=\"px-4\" variant=\"text\" size=\"large\"\n        >\n          <v-icon start>mdi-chevron-left</v-icon>\n          Acquisition\n        </v-btn>\n      </v-col>\n\n      <!-- Forward to Acquisition -->\n      <v-col cols=\"auto\">\n        <v-btn\n          to=\"visualization\"\n          color=\"primary\"\n          rounded=\"lg\"\n          class=\"px-4\" variant=\"text\" size=\"large\"\n        >\n          Visualization\n          <v-icon end>mdi-chevron-right</v-icon>\n        </v-btn>\n      </v-col>\n    </v-row>\n  </v-container>\n</template>\n",
        "storeOutMessages": true,
        "passthru": true,
        "resendOnRefresh": true,
        "templateScope": "local",
        "className": "",
        "x": 1510,
        "y": 160,
        "wires": [
            []
        ]
    },
    {
        "id": "d11906e048438931",
        "type": "ui-template",
        "z": "0fd76ac156d78937",
        "group": "9b992ca6515ed058",
        "page": "",
        "ui": "",
        "name": "Navigation Top",
        "order": 1,
        "width": 0,
        "height": 0,
        "head": "",
        "format": "<template>\n  <v-container fluid class=\"ma-0 pa-0\">\n    <v-row \n      align=\"center\" \n      class=\"px-2 py-0\" \n      no-gutters\n    >\n      \n      <v-col cols=\"3\" class=\"py-0 d-flex justify-start\">\n        <v-btn\n          to=\"acquisition\"\n          color=\"primary\"\n          rounded=\"lg\"\n          class=\"px-4\" variant=\"text\" size=\"large\"\n        >\n          <v-icon start>mdi-chevron-left</v-icon>\n          Acquisition\n        </v-btn>\n      </v-col>\n\n      <v-col cols=\"6\" class=\"text-center py-0\">\n        <h1 class=\"text-h5 font-weight-bold text-primary my-0 text-truncate\">\n          Segmentation\n        </h1>\n      </v-col>\n\n      <v-col cols=\"3\" class=\"py-0 d-flex justify-end\">\n        <v-btn\n          to=\"visualization\"\n          color=\"primary\"\n          rounded=\"lg\"\n          class=\"px-4\" variant=\"text\" size=\"large\"\n        >\n          Vizualisation\n          <v-icon end>mdi-chevron-right</v-icon>\n        </v-btn>\n      </v-col>\n      \n    </v-row>\n  </v-container>\n</template>",
        "storeOutMessages": true,
        "passthru": true,
        "resendOnRefresh": true,
        "templateScope": "local",
        "className": "",
        "x": 1520,
        "y": 40,
        "wires": [
            []
        ]
    },
    {
        "id": "4bdd8a4afcdb704b",
        "type": "mqtt out",
        "z": "0fd76ac156d78937",
        "name": "MQTT",
        "topic": "",
        "qos": "",
        "retain": "",
        "respTopic": "",
        "contentType": "",
        "userProps": "",
        "correl": "",
        "expiry": "",
        "broker": "8dc3722c.06efa8",
        "x": 1150,
        "y": 140,
        "wires": []
    },
    {
        "id": "24c71b69e60e41bd",
        "type": "switch",
        "z": "0fd76ac156d78937",
        "name": "",
        "property": "topic",
        "propertyType": "msg",
        "rules": [
            {
                "t": "eq",
                "v": "segmenter/segment",
                "vt": "str"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 1,
        "x": 1030,
        "y": 140,
        "wires": [
            [
                "4bdd8a4afcdb704b",
                "f8f4b34842d35713"
            ]
        ]
    },
    {
        "id": "34f6f23f1a46da67",
        "type": "mqtt in",
        "z": "0fd76ac156d78937",
        "name": "",
        "topic": "status/segmenter",
        "qos": "0",
        "datatype": "json",
        "broker": "8dc3722c.06efa8",
        "nl": false,
        "rap": false,
        "inputs": 0,
        "x": 100,
        "y": 260,
        "wires": [
            [
                "33c0d1b8251b5d00"
            ]
        ]
    },
    {
        "id": "33c0d1b8251b5d00",
        "type": "ui-template",
        "z": "0fd76ac156d78937",
        "group": "402b3d24c87ab0d2",
        "page": "",
        "ui": "",
        "name": "Details of Segmentation",
        "order": 1,
        "width": "0",
        "height": "0",
        "head": "",
        "format": "<template>\n  <!-- Dataset Info: shown only when segmentation is currently active -->\n  <v-list density=\"compact\" v-if=\"isSegmenting && segment.dataset.project_name\">\n    <v-list-item>\n      <v-list-item-title>\n        <b>Project:</b> {{ segment.dataset.project_name }}\n      </v-list-item-title>\n    </v-list-item>\n    <v-list-item>\n      <v-list-item-title>\n        <b>Sample:</b> {{ segment.dataset.sample_id }}\n      </v-list-item-title>\n    </v-list-item>\n    <v-list-item>\n      <v-list-item-title>\n        <b>Acquisition:</b> {{ segment.dataset.acquisition_id }}\n      </v-list-item-title>\n    </v-list-item>\n    <v-list-item>\n      <v-list-item-title>\n        <b>Path:</b> {{ segment.dataset.path }}\n      </v-list-item-title>\n    </v-list-item>\n  </v-list>\n\n  <v-divider class=\"my-4\" v-if=\"isSegmenting && segment.dataset.project_name\"></v-divider>\n\n  <!-- Error Message -->\n  <v-alert v-if=\"errorMessage\" type=\"error\" variant=\"outlined\" border=\"start\" prominent class=\"mb-4\">\n    <strong>Error:</strong> {{ errorMessage }}\n  </v-alert>\n\n  <!-- Generic Info / Other Messages -->\n  <v-alert v-else-if=\"infoMessage\" type=\"info\" variant=\"outlined\" border=\"start\" class=\"mb-4\">\n    {{ infoMessage }}\n  </v-alert>\n\n  <!-- Progress Info -->\n  <div v-if=\"statusText && !errorMessage\">\n    <div class=\"d-flex justify-space-between align-center mb-2\">\n      <span class=\"text-subtitle-1 font-weight-medium\">Progress</span>\n      <span class=\"text-caption\">{{ progressText }}</span>\n    </div>\n\n    <v-progress-linear :model-value=\"progressPercent\" height=\"10\" color=\"primary\" rounded striped></v-progress-linear>\n\n    <p class=\"mt-3 mb-0 text-body-2\" v-if=\"currentImage\">\n      Currently segmenting:\n      <strong>{{ currentImage }}</strong>\n    </p>\n  </div>\n\n  <div v-else-if=\"!errorMessage\" class=\"text-disabled mt-4\">\n    Awaiting segmentation status...\n  </div>\n</template>\n\n<script>\n  export default {\n  props: {\n    msg: Object,\n  },\n  data() {\n    return {\n      segment: {\n        dataset: {\n          project_name: \"\",\n          sample_id: \"\",\n          acquisition_id: \"\",\n          path: \"\",\n        },\n      },\n      statusText: \"\",\n      currentImage: \"\",\n      currentIndex: 0,\n      totalImages: 0,\n      progressPercent: 0,\n      progressText: \"\",\n      errorMessage: \"\",\n      infoMessage: \"\",\n    };\n  },\n  computed: {\n    // Active segmentation means: we have a status and it isn't \"Done\"\n    isSegmenting() {\n      return (\n        this.statusText &&\n        !this.statusText.toLowerCase().includes(\"done\") &&\n        !this.statusText.toLowerCase().includes(\"idle\") &&\n        !this.errorMessage\n      );\n    },\n  },\n  watch: {\n    msg: {\n      immediate: true,\n      handler(msg) {\n        if (!msg || !msg.topic || !msg.payload) return;\n\n        const p = msg.payload;\n\n        // Reset message fields\n        this.errorMessage = \"\";\n        this.infoMessage = \"\";\n        this.statusText = \"\";\n\n        // 1 Load dataset info from message payload if available\n        if (\n          p.seg_project_name ||\n          p.seg_sample_id ||\n          p.seg_acquisition_id ||\n          p.seg_path\n        ) {\n          this.segment.dataset = {\n            project_name: p.seg_project_name || \"\",\n            sample_id: p.seg_sample_id || \"\",\n            acquisition_id: p.seg_acquisition_id || \"\",\n            path: p.seg_path || \"\",\n          };\n        }\n\n        // 2 Handle status/segmenter messages\n        if (msg.topic === \"status/segmenter\") {\n          const status = p.status || \"\";\n\n          // Detect error messages\n          if (status.toLowerCase().includes(\"exception\")) {\n            this.errorMessage = status;\n            this.statusText = \"\";\n            this.progressPercent = 0;\n            this.progressText = \"\";\n            return;\n          }\n\n          // Detect \"done\" or \"idle\"\n          if (status.toLowerCase().includes(\"done\") || status.toLowerCase().includes(\"idle\")) {\n            this.statusText = status;\n            this.segment.dataset = {\n              project_name: \"\",\n              sample_id: \"\",\n              acquisition_id: \"\",\n              path: \"\",\n            };\n            this.currentImage = \"\";\n            this.progressPercent = 0;\n            this.progressText = \"\";\n            return;\n          }\n\n          // Handle other status or info messages\n          if (!status.toLowerCase().includes(\"image\")) {\n            this.infoMessage = status;\n            return;\n          }\n\n          // 3 Extract progress info if available\n          this.statusText = status;\n\n          const imgMatch = this.statusText.match(/image ([\\w\\-\\_\\.]+),/);\n          this.currentImage = imgMatch ? imgMatch[1] : \"\";\n\n          const progressMatch = this.statusText.match(/image (\\d+)\\/(\\d+)/);\n          if (progressMatch) {\n            this.currentIndex = Number(progressMatch[1]);\n            this.totalImages = Number(progressMatch[2]);\n            this.progressPercent = Math.round(\n              (this.currentIndex / this.totalImages) * 100\n            );\n            this.progressText = `${this.currentIndex} / ${this.totalImages} (${this.progressPercent}%)`;\n          } else {\n            this.progressPercent = 0;\n            this.progressText = \"\";\n          }\n        }\n      },\n    },\n  },\n};\n</script>\n\n<style scoped>\n  .text-disabled {\n    color: rgba(0, 0, 0, 0.4);\n  }\n</style>",
        "storeOutMessages": true,
        "passthru": true,
        "resendOnRefresh": true,
        "templateScope": "local",
        "className": "",
        "x": 610,
        "y": 240,
        "wires": [
            []
        ]
    },
    {
        "id": "cdb586337f186494",
        "type": "switch",
        "z": "0fd76ac156d78937",
        "name": "",
        "property": "payload.is_segmented",
        "propertyType": "msg",
        "rules": [
            {
                "t": "true"
            },
            {
                "t": "false"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 2,
        "x": 510,
        "y": 140,
        "wires": [
            [],
            [
                "89d1bfb7839c2077"
            ]
        ]
    },
    {
        "id": "f8f4b34842d35713",
        "type": "function",
        "z": "0fd76ac156d78937",
        "name": "set seg_params",
        "func": "if (msg.topic) {\n    global.set(\"seg_project_name\", msg.payload.dataset.project_name);\n    global.set(\"seg_sample_id\", msg.payload.dataset.sample_id);\n    global.set(\"seg_acquisition_id\", msg.payload.dataset.acquisition_id);\n    global.set(\"seg_path\", msg.payload.dataset.path);\n    global.set(\"process_min_ESD\", msg.payload.settings.process_min_ESD);\n}\nreturn msg;\n",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1180,
        "y": 100,
        "wires": [
            []
        ]
    },
    {
        "id": "921be0438de344ac",
        "type": "function",
        "z": "0fd76ac156d78937",
        "name": "Get Global Variables",
        "func": "const keys = global.keys(); // Get all global variable keys\nmsg.payload = {}; // Initialize the payload object\n\nkeys.forEach(key => {\n    // Ignore keys that start with \"$\"\n    if (!key.startsWith('$')) {\n        msg.payload[key] = global.get(key);\n    }\n});\n\nreturn msg;\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 120,
        "y": 200,
        "wires": [
            [
                "33c0d1b8251b5d00"
            ]
        ]
    },
    {
        "id": "89d1bfb7839c2077",
        "type": "function",
        "z": "0fd76ac156d78937",
        "name": "add process_min_ESD",
        "func": "// Ensure msg.payload and msg.payload.settings exist\nmsg.payload = msg.payload || {};\n\n// Read the variable from global context\nconst process_min_ESD = global.get(\"process_min_ESD\");\n\n// Add it to the payload settings\nmsg.payload.process_min_ESD = process_min_ESD;\nmsg.payload.open_dialog = true;\n\n// Return the modified message\nreturn msg;\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 680,
        "y": 140,
        "wires": [
            [
                "7fde0897e436c334"
            ]
        ]
    },
    {
        "id": "7fde0897e436c334",
        "type": "ui-template",
        "z": "0fd76ac156d78937",
        "group": "",
        "page": "7a4e042a60b734a6",
        "ui": "",
        "name": "Dialog",
        "order": 2,
        "width": 0,
        "height": 0,
        "head": "",
        "format": "<template>\n  <!-- Dialog only -->\n  <v-dialog v-model=\"showDialog\" max-width=\"500\">\n    <v-card>\n      <v-card-title class=\"font-weight-bold\">\n        Segmentation Required\n      </v-card-title>\n\n      <v-card-text>\n        <p>\n          The selected sample has not been segmented yet.<br>\n          Do you want to start segmentation now?\n        </p>\n\n        <v-divider class=\"my-3\"></v-divider>\n\n        <v-list density=\"compact\">\n          <v-list-item>\n            <v-list-item-title><b>Project:</b> {{ payload.project_name }}</v-list-item-title>\n          </v-list-item>\n          <v-list-item>\n            <v-list-item-title><b>Sample:</b> {{ payload.sample_id }}</v-list-item-title>\n          </v-list-item>\n          <v-list-item>\n            <v-list-item-title><b>Acquisition:</b> {{ payload.acquisition_id }}</v-list-item-title>\n          </v-list-item>\n          <v-list-item>\n            <v-list-item-title><b>Operator:</b> {{ payload.operator_name }}</v-list-item-title>\n          </v-list-item>\n          <v-list-item>\n            <v-list-item-title><b>Images acquired:</b> {{ payload.image_acquired_count }}</v-list-item-title>\n          </v-list-item>\n          <v-list-item>\n            <v-list-item-title><b>Path:</b> {{ payload.path }}</v-list-item-title>\n          </v-list-item>\n        </v-list>\n\n        <v-divider class=\"my-3\"></v-divider>\n\n        <!-- Number input for process_min_ESD -->\n        <v-text-field\n          v-model.number=\"process_min_ESD\"\n          label=\"Minimum ESD (m)\"\n          type=\"number\"\n          min=\"0\"\n          step=\"1\"\n          hint=\"Set minimum Equivalent Spherical Diameter in microns\"\n          persistent-hint\n        ></v-text-field>\n      </v-card-text>\n\n      <v-card-actions>\n        <v-spacer></v-spacer>\n        <v-btn color=\"grey\" variant=\"tonal\" @click=\"showDialog = false\">\n          Cancel\n        </v-btn>\n        <v-btn color=\"primary\" variant=\"flat\" @click=\"sendSegment\">\n          Segment\n        </v-btn>\n      </v-card-actions>\n    </v-card>\n  </v-dialog>\n</template>\n\n<script>\nexport default {\n  //  no props / no lifecycle hooks in ui-template\n  data() {\n    return {\n      payload: {},\n      showDialog: false,\n      process_min_ESD: 0,\n      hasSeenFirstMsg: false, //  ignore the first msg (replayed by Dashboard)\n    };\n  },\n\nwatch: {\n  msg: {\n    immediate: true,\n    deep: true,\n    handler(msg) {\n\n      // Always force dialog closed unless explicitly opened\n      this.showDialog = false;\n\n      // Ignore the first replayed message\n      if (!this.hasSeenFirstMsg) {\n        this.hasSeenFirstMsg = true;\n        return;\n      }\n\n      //  No message or empty payload -> abort immediately\n      if (!msg || !msg.payload || typeof msg.payload !== \"object\") {\n        return;\n      }\n\n      // Now we know there is a real payload\n      this.payload = msg.payload;\n\n      // Sync ESD if provided\n      this.process_min_ESD =\n        typeof msg.payload.process_min_ESD !== \"undefined\"\n          ? msg.payload.process_min_ESD\n          : 0;\n\n      //  Require ALL keys  otherwise NO dialog\n      const shouldOpen =\n        msg.payload.open_dialog === true &&\n        msg.payload.is_segmented === false &&\n        typeof msg.payload.path === \"string\" &&\n        msg.payload.path.length > 0;\n\n      this.showDialog = shouldOpen;\n    },\n  },\n},\n\n\n  methods: {\n    sendSegment() {\n      const outMsg = {\n        topic: \"segmenter/segment\",\n        payload: {\n          action: \"segment\",\n          path: [this.payload.path],\n          settings: {\n            force: false,\n            recursive: true,\n            ecotaxa: true,\n            keep: true,\n            process_id: 1,\n            process_min_ESD: this.process_min_ESD,\n          },\n          dataset: {\n            project_name: this.payload.project_name,\n            sample_id: this.payload.sample_id,\n            acquisition_id: this.payload.acquisition_id,\n            operator_name: this.payload.operator_name,\n            image_acquired_count: this.payload.image_acquired_count,\n            path: this.payload.path,\n          },\n        },\n      };\n\n      this.send(outMsg);\n      this.showDialog = false;\n    },\n  },\n};\n</script>\n",
        "storeOutMessages": true,
        "passthru": true,
        "resendOnRefresh": true,
        "templateScope": "widget:page",
        "className": "",
        "x": 850,
        "y": 140,
        "wires": [
            [
                "24c71b69e60e41bd"
            ]
        ]
    },
    {
        "id": "77bb783e65c3ffd6",
        "type": "ui-event",
        "z": "14f8c9b5ce1235cc",
        "ui": "e6ae26617c24c3ea",
        "name": "UI Event",
        "x": 80,
        "y": 40,
        "wires": [
            [
                "55814595d9207e95"
            ]
        ]
    },
    {
        "id": "55814595d9207e95",
        "type": "switch",
        "z": "14f8c9b5ce1235cc",
        "name": "msg.topic === \"$pageview\"",
        "property": "topic",
        "propertyType": "msg",
        "rules": [
            {
                "t": "eq",
                "v": "$pageview",
                "vt": "str"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 1,
        "x": 280,
        "y": 40,
        "wires": [
            [
                "90c920ecdab16908"
            ]
        ]
    },
    {
        "id": "90c920ecdab16908",
        "type": "switch",
        "z": "14f8c9b5ce1235cc",
        "name": "msg.payload.page.path === \"/visualization\"",
        "property": "payload.page.path",
        "propertyType": "msg",
        "rules": [
            {
                "t": "eq",
                "v": "/visualization",
                "vt": "str"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 1,
        "x": 590,
        "y": 40,
        "wires": [
            [
                "164baa371893de7a"
            ]
        ]
    },
    {
        "id": "75b694eff7cf6747",
        "type": "ui-template",
        "z": "14f8c9b5ce1235cc",
        "group": "1d3abb201c51ff47",
        "page": "",
        "ui": "",
        "name": "Navigation Bottom",
        "order": 1,
        "width": 0,
        "height": 0,
        "head": "",
        "format": "\n<template>\n  <v-container fluid class=\"ma-0 pa-0\">\n    <v-row align=\"center\" justify=\"space-between\" class=\"px-2\">\n      <!-- Back to Preview -->\n      <v-col cols=\"auto\">\n        <v-btn\n          to=\"segmentation\"\n          color=\"primary\"\n          rounded=\"lg\"\n          class=\"px-4\" variant=\"text\" size=\"large\"\n        >\n          <v-icon start>mdi-chevron-left</v-icon>\n          Segmentation\n        </v-btn>\n      </v-col>\n    </v-row>\n  </v-container>\n</template>\n",
        "storeOutMessages": true,
        "passthru": true,
        "resendOnRefresh": true,
        "templateScope": "local",
        "className": "",
        "x": 1290,
        "y": 180,
        "wires": [
            []
        ]
    },
    {
        "id": "fe2e976833fd41a9",
        "type": "ui-template",
        "z": "14f8c9b5ce1235cc",
        "group": "b570f76ef526af45",
        "page": "",
        "ui": "",
        "name": "Navigation Top",
        "order": 1,
        "width": 0,
        "height": 0,
        "head": "",
        "format": "<template>\n  <v-container fluid class=\"ma-0 pa-0\">\n    <v-row \n      align=\"center\" \n      class=\"px-2 py-0\" \n      no-gutters\n    >\n      \n      <v-col cols=\"3\" class=\"py-0 d-flex justify-start\">\n        <v-btn\n          to=\"segmentation\"\n          color=\"primary\"\n          rounded=\"lg\"\n          class=\"px-4\" variant=\"text\" size=\"large\"\n        >\n          <v-icon start>mdi-chevron-left</v-icon>\n          Segmentation\n        </v-btn>\n      </v-col>\n\n      <v-col cols=\"6\" class=\"text-center py-0\">\n        <h1 class=\"text-h5 font-weight-bold text-primary my-0 text-truncate\">\n          Visualization\n        </h1>\n      </v-col>\n\n      <v-col cols=\"3\" class=\"py-0 d-flex justify-end\">\n      </v-col>\n      \n    </v-row>\n  </v-container>\n</template>",
        "storeOutMessages": true,
        "passthru": true,
        "resendOnRefresh": true,
        "templateScope": "local",
        "className": "",
        "x": 1300,
        "y": 40,
        "wires": [
            []
        ]
    },
    {
        "id": "164baa371893de7a",
        "type": "list segmentations",
        "z": "14f8c9b5ce1235cc",
        "name": "",
        "x": 170,
        "y": 180,
        "wires": [
            [
                "18a10804663dbaa1"
            ]
        ]
    },
    {
        "id": "6532974092861ef7",
        "type": "ui-table",
        "z": "14f8c9b5ce1235cc",
        "group": "fa6393a7d7e3b7d7",
        "name": "List of acq",
        "label": "",
        "order": 1,
        "width": 0,
        "height": 0,
        "maxrows": "10",
        "passthru": false,
        "autocols": false,
        "showSearch": false,
        "deselect": true,
        "selectionType": "click",
        "columns": [
            {
                "title": "Project name",
                "key": "project_name",
                "keyType": "key",
                "type": "text",
                "width": "",
                "align": "start"
            },
            {
                "title": "Sample ID",
                "key": "sample_id",
                "keyType": "key",
                "type": "text",
                "width": "",
                "align": "start"
            },
            {
                "title": "Acquisition ID",
                "key": "acquisition_id",
                "keyType": "key",
                "type": "text",
                "width": "",
                "align": "start"
            },
            {
                "title": "Number of objects",
                "key": "image_acquired_count",
                "keyType": "key",
                "type": "text",
                "width": "",
                "align": "start"
            },
            {
                "title": "Gallery",
                "key": "gallery",
                "keyType": "key",
                "type": "link",
                "width": "",
                "align": "start"
            },
            {
                "title": "Download",
                "key": "export",
                "keyType": "key",
                "type": "link",
                "width": "",
                "align": "start"
            }
        ],
        "mobileBreakpoint": "sm",
        "mobileBreakpointType": "defaults",
        "action": "replace",
        "x": 570,
        "y": 180,
        "wires": [
            [
                "aefbf6f96248c398"
            ]
        ]
    },
    {
        "id": "18a10804663dbaa1",
        "type": "function",
        "z": "14f8c9b5ce1235cc",
        "name": "Insert export column",
        "func": "msg.payload = msg.payload.map(item => {\n    // extraction de l'acquisition_id\n    const acq = item.acquisition_id;   // ex: \"A_2\"\n\n    // cration du chemin export\n    item.export = `/ps/data/browse/api/raw/export/ecotaxa/ecotaxa_${acq}.zip`;\n\n    return item;\n});\n\nreturn msg;\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 380,
        "y": 180,
        "wires": [
            [
                "6532974092861ef7"
            ]
        ]
    },
    {
        "id": "5ec998719a884cfe",
        "type": "file in",
        "z": "14f8c9b5ce1235cc",
        "name": "",
        "filename": "payload.path",
        "filenameType": "msg",
        "format": "utf8",
        "chunk": false,
        "sendError": false,
        "encoding": "none",
        "allProps": false,
        "x": 880,
        "y": 180,
        "wires": [
            [
                "70ec28e6b50bec41"
            ]
        ]
    },
    {
        "id": "aefbf6f96248c398",
        "type": "function",
        "z": "14f8c9b5ce1235cc",
        "name": "Get tsv path",
        "func": "// 1. On s'assure que le path existe\nif (msg.payload.path) {\n    \n    // 2. On rcupre le path actuel\n    // ex: \"/home/pi/data/objects/2025-11-19/S_1/A_2\"\n    const currentPath = msg.payload.path;\n\n    // 3. On extrait l'identifiant (le dernier lment aprs le /)\n    // Si le path finit par un /, on le retire d'abord pour viter un ID vide\n    const cleanPath = currentPath.endsWith('/') ? currentPath.slice(0, -1) : currentPath;\n    const acqId = cleanPath.split('/').pop(); \n\n    // 4. On modifie le path dans l'objet\n    // Rsultat: .../A_2/ecotaxa_A_2.tsv\n    msg.payload.path = `${cleanPath}/ecotaxa_${acqId}.tsv`;\n}\n\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 730,
        "y": 180,
        "wires": [
            [
                "5ec998719a884cfe"
            ]
        ]
    },
    {
        "id": "70ec28e6b50bec41",
        "type": "csv",
        "z": "14f8c9b5ce1235cc",
        "name": "",
        "spec": "rfc",
        "sep": "\\t",
        "hdrin": true,
        "hdrout": "none",
        "multi": "mult",
        "ret": "\\r\\n",
        "temp": "",
        "skip": "0",
        "strings": true,
        "include_empty_strings": "",
        "include_null_values": "",
        "x": 1010,
        "y": 180,
        "wires": [
            [
                "8dc194f764cd61ef"
            ]
        ]
    },
    {
        "id": "e8fbb01b7a38c29a",
        "type": "ui-template",
        "z": "14f8c9b5ce1235cc",
        "group": "bdf41008b379e80e",
        "page": "",
        "ui": "",
        "name": "Gemini 3 Pro v1",
        "order": 1,
        "width": 0,
        "height": 0,
        "head": "",
        "format": "<script src=\"https://cdn.jsdelivr.net/npm/chart.js\"></script>\n\n<template>\n  <v-container fluid class=\"pa-4 grey lighten-5\" style=\"min-height: 100vh; color:#333;\">\n\n    <v-row v-if=\"!hasData\" align=\"center\" justify=\"center\" style=\"height:80vh;\">\n      <div class=\"text-center\">\n        <v-progress-circular indeterminate color=\"primary\" size=\"64\"></v-progress-circular>\n        <div class=\"mt-4 text-h6 grey--text text--darken-2 font-weight-light\">\n          Analyzing PlanktoScope Data...\n        </div>\n        <div class=\"caption grey--text\">Waiting for JSON payload</div>\n      </div>\n    </v-row>\n\n    <div v-else>\n\n      <v-row dense class=\"mb-3\">\n        <v-col cols=\"12\">\n          <v-card outlined class=\"pa-0 overflow-hidden\">\n            <v-sheet color=\"primary\" class=\"pa-2 pl-4 d-flex align-center dark white--text\">\n              <v-icon left color=\"white\">mdi-chart-scatter-plot-hexbin</v-icon>\n              <div class=\"text-subtitle-1 font-weight-bold text-uppercase\">\n                PlanktoScope Analytics\n              </div>\n              <v-spacer></v-spacer>\n              <div class=\"caption mr-4 hidden-sm-and-down\">\n                <span class=\"white--text text--lighten-3\">Project:</span> {{ safeHeader.sample_project }}\n                <span class=\"mx-2\">|</span>\n                <span class=\"white--text text--lighten-3\">Sample:</span> {{ safeHeader.sample_id }}\n              </div>\n            </v-sheet>\n            \n            <div class=\"pa-2 d-flex align-center flex-wrap grey lighten-5\">\n              <v-chip small outlined class=\"mr-2 my-1\" color=\"blue-grey\">\n                <v-icon left x-small>mdi-ruler-square</v-icon>\n                {{ formatNum(safeHeader.process_pixel, 3) }} m/px\n              </v-chip>\n              <v-chip small outlined class=\"mr-2 my-1\" color=\"blue-grey\">\n                 <v-icon left x-small>mdi-water</v-icon>\n                 Vol: {{ formatNum(safeHeader.volume_used, 2) }} mL\n              </v-chip>\n              \n              <v-spacer></v-spacer>\n\n              <v-btn small text color=\"primary\" :href=\"ecotaxaLink\" target=\"_blank\" v-if=\"safeHeader.acq_id !== 'N/A'\">\n                <v-icon left small>mdi-cloud-download-outline</v-icon> EcoTaxa\n              </v-btn>\n              <v-btn small text color=\"grey darken-2\" @click=\"downloadCSV\">\n                <v-icon left small>mdi-file-delimited-outline</v-icon> CSV\n              </v-btn>\n              <v-btn small text color=\"deep-orange\" @click=\"resetFilters\">\n                <v-icon left small>mdi-refresh</v-icon> Reset\n              </v-btn>\n            </div>\n          </v-card>\n        </v-col>\n      </v-row>\n\n      <v-row dense class=\"mb-3\">\n        <v-col cols=\"6\" md=\"3\">\n          <v-card outlined class=\"pa-3 fill-height d-flex flex-column justify-center border-left-primary\">\n             <div class=\"caption grey--text text-uppercase font-weight-bold\">Total Objects</div>\n             <div class=\"d-flex align-baseline\">\n               <span class=\"text-h4 font-weight-bold mr-2\">{{ filteredObjects.length }}</span>\n               <span class=\"caption grey--text\">/ {{ cleanObjects.length }}</span>\n             </div>\n          </v-card>\n        </v-col>\n        \n        <v-col cols=\"6\" md=\"3\">\n          <v-card outlined class=\"pa-3 fill-height d-flex flex-column justify-center border-left-info\">\n             <div class=\"caption blue--text text--darken-2 text-uppercase font-weight-bold\">Abundance</div>\n             <div class=\"d-flex align-baseline\">\n               <span class=\"text-h4 font-weight-bold blue--text text--darken-2 mr-2\">{{ formatNum(abundance, 1) }}</span>\n               <span class=\"caption blue--text\">ind./mL</span>\n             </div>\n          </v-card>\n        </v-col>\n\n        <v-col cols=\"12\" md=\"6\">\n          <v-card outlined class=\"fill-height pa-0\">\n            <v-row no-gutters class=\"fill-height\">\n              <v-col cols=\"3\" class=\"pa-2 text-center border-right\">\n                <div class=\"caption green--text font-weight-bold\">Filaments</div>\n                <div class=\"text-h6\">{{ counts.filament }}</div>\n              </v-col>\n              <v-col cols=\"3\" class=\"pa-2 text-center border-right\">\n                <div class=\"caption brown--text font-weight-bold\">Detritus</div>\n                <div class=\"text-h6\">{{ counts.detritus }}</div>\n              </v-col>\n              <v-col cols=\"3\" class=\"pa-2 text-center border-right\">\n                <div class=\"caption red--text font-weight-bold\">Dense</div>\n                <div class=\"text-h6\">{{ counts.dense }}</div>\n              </v-col>\n              <v-col cols=\"3\" class=\"pa-2 text-center\">\n                <div class=\"caption grey--text font-weight-bold\">Bubbles</div>\n                <div class=\"text-h6\">{{ counts.bubble }}</div>\n              </v-col>\n            </v-row>\n          </v-card>\n        </v-col>\n      </v-row>\n\n      <v-row>\n        <v-col cols=\"12\" md=\"3\" lg=\"2\">\n          <v-card outlined class=\"sticky-top\">\n            <v-subheader class=\"font-weight-bold text-uppercase caption grey--text\">Filters & Clusters</v-subheader>\n            \n            <v-card-text class=\"pt-0\">\n              <v-select\n                v-model=\"filters.cluster\"\n                :items=\"clusterOptions\"\n                label=\"Filter by Cluster\"\n                dense outlined\n                class=\"mb-4 caption\"\n                hide-details\n              ></v-select>\n\n              <div class=\"d-flex justify-space-between caption font-weight-bold mt-2\">\n                <span>Size (ESD)</span><span>{{ Math.round(filters.esd[0]) }}-{{ Math.round(filters.esd[1]) }}</span>\n              </div>\n              <v-range-slider v-model=\"filters.esd\" :min=\"sliderStats.min\" :max=\"sliderStats.max\" dense hide-details class=\"mt-1 mb-4\"></v-range-slider>\n\n              <div class=\"d-flex justify-space-between caption font-weight-bold\">\n                <span>Circularity</span><span>{{ filters.circ[0] }}-{{ filters.circ[1] }}</span>\n              </div>\n              <v-range-slider v-model=\"filters.circ\" :min=\"0\" :max=\"1\" :step=\"0.05\" dense hide-details class=\"mt-1 mb-4\"></v-range-slider>\n\n              <div class=\"d-flex justify-space-between caption font-weight-bold\">\n                <span>Density (Gray Val)</span>\n              </div>\n              <v-range-slider v-model=\"filters.val\" :min=\"0\" :max=\"255\" :step=\"5\" dense hide-details class=\"mt-1 mb-4\"></v-range-slider>\n            </v-card-text>\n            \n            <v-divider></v-divider>\n            \n            <div class=\"pa-2\">\n              <div class=\"caption text-center mb-1 grey--text\">Cluster Distribution</div>\n              <div style=\"height: 140px; width: 100%;\">\n                <canvas ref=\"chartPie\"></canvas>\n              </div>\n            </div>\n          </v-card>\n        </v-col>\n\n        <v-col cols=\"12\" md=\"6\" lg=\"7\">\n          \n          <v-card outlined class=\"mb-3\">\n            <v-card-title class=\"subtitle-2 py-2\">\n              Morpho-Clustering Map\n              <v-spacer></v-spacer>\n              <v-icon small color=\"grey\" title=\"X=Circularity, Y=Elongation (Log Scale)\">mdi-information-outline</v-icon>\n            </v-card-title>\n            <v-card-text>\n              <div style=\"height: 280px; width: 100%;\">\n                <canvas ref=\"chartCluster\"></canvas>\n              </div>\n            </v-card-text>\n          </v-card>\n\n          <v-card outlined>\n             <v-toolbar flat dense color=\"grey lighten-4\">\n               <v-toolbar-title class=\"subtitle-2\">\n                 Gallery ({{ filteredObjects.length }})\n               </v-toolbar-title>\n               <v-spacer></v-spacer>\n               <v-select\n                v-model=\"gallerySort\"\n                :items=\"sortOptions\"\n                item-text=\"text\" item-value=\"value\"\n                dense outlined hide-details\n                style=\"max-width: 180px;\"\n                class=\"caption bg-white\"\n                label=\"Sort by\"\n              ></v-select>\n             </v-toolbar>\n            \n            <v-card-text class=\"pa-2\" style=\"min-height: 200px;\">\n              <div v-if=\"!filteredObjects.length\" class=\"d-flex flex-column align-center justify-center py-5 grey--text\">\n                <v-icon large color=\"grey lighten-2\">mdi-image-off-outline</v-icon>\n                <div class=\"mt-2 caption\">No objects match current gates.</div>\n              </div>\n              \n              <div class=\"gallery-grid\">\n                <div v-for=\"obj in paginatedObjects\" :key=\"obj.object_id\" \n                     class=\"gallery-item\" \n                     :class=\"{'selected': selectedId === obj.object_id, 'g-filament': obj.group === 'Filament', 'g-bubble': obj.group === 'Bubble', 'g-dense': obj.group === 'Dense'}\" \n                     @click=\"selectedId = obj.object_id\">\n                  <v-img :src=\"getImageUrl(obj)\" aspect-ratio=\"1\" contain class=\"white rounded elevation-1\">\n                    <template v-slot:placeholder><v-row class=\"fill-height ma-0\" align=\"center\" justify=\"center\"><v-progress-circular indeterminate size=\"20\" width=\"2\" color=\"grey lighten-3\"></v-progress-circular></v-row></template>\n                  </v-img>\n                </div>\n              </div>\n              <div v-if=\"filteredObjects.length > 200\" class=\"text-center caption mt-2 grey--text\">\n                + {{ filteredObjects.length - 200 }} more objects...\n              </div>\n            </v-card-text>\n          </v-card>\n        </v-col>\n\n        <v-col cols=\"12\" md=\"3\" lg=\"3\">\n          <v-card outlined class=\"sticky-top\">\n            <v-card-title class=\"subtitle-2 grey lighten-4 py-2\">\n              Identity Card\n            </v-card-title>\n            \n            <div v-if=\"selectedObject\">\n              <div class=\"pa-3 text-center grey lighten-5 border-bottom\">\n                <v-chip x-small class=\"mb-2 font-weight-bold white--text\" :color=\"getGroupColor(selectedObject.group)\">\n                  {{ selectedObject.group.toUpperCase() }}\n                </v-chip>\n                <v-img :src=\"getImageUrl(selectedObject)\" max-height=\"180\" contain class=\"mx-auto mb-2 rounded\"></v-img>\n                <div class=\"caption text-truncate font-weight-medium\">{{ selectedObject.object_id }}</div>\n              </div>\n              \n              <v-list dense class=\"pa-0\">\n                <v-list-item>\n                  <v-list-item-icon class=\"mr-2\"><v-icon small>mdi-arrow-expand-all</v-icon></v-list-item-icon>\n                  <v-list-item-content>\n                    <v-list-item-title class=\"caption grey--text\">Size (ESD)</v-list-item-title>\n                    <v-list-item-subtitle class=\"font-weight-bold text--primary\">{{ formatNum(selectedObject.esd_um, 1) }} m</v-list-item-subtitle>\n                  </v-list-item-content>\n                </v-list-item>\n                <v-divider></v-divider>\n\n                <v-list-item>\n                  <v-list-item-content>\n                    <div class=\"d-flex justify-space-between caption mb-1\">\n                      <span class=\"grey--text\">Circularity</span>\n                      <span class=\"font-weight-bold\">{{ formatNum(selectedObject.circ, 3) }}</span>\n                    </div>\n                    <v-progress-linear :value=\"selectedObject.circ * 100\" height=\"6\" rounded color=\"blue\"></v-progress-linear>\n                  </v-list-item-content>\n                </v-list-item>\n\n                <v-list-item>\n                  <v-list-item-content>\n                    <div class=\"d-flex justify-space-between caption mb-1\">\n                      <span class=\"grey--text\">Solidity</span>\n                      <span class=\"font-weight-bold\">{{ formatNum(selectedObject.solidity, 2) }}</span>\n                    </div>\n                    <v-progress-linear :value=\"selectedObject.solidity * 100\" height=\"6\" rounded color=\"orange\"></v-progress-linear>\n                  </v-list-item-content>\n                </v-list-item>\n\n                <v-list-item class=\"d-block\">\n                   <v-row dense class=\"caption mt-1\">\n                     <v-col cols=\"6\">\n                       <div class=\"grey--text\">Elongation</div>\n                       <div class=\"font-weight-bold\">{{ formatNum(selectedObject.elongation, 1) }}</div>\n                     </v-col>\n                     <v-col cols=\"6\">\n                       <div class=\"grey--text\">Density (Gray)</div>\n                       <div class=\"font-weight-bold\">{{ formatNum(selectedObject.val, 0) }}</div>\n                     </v-col>\n                     <v-col cols=\"6\">\n                       <div class=\"grey--text\">Width</div>\n                       <div class=\"font-weight-bold\">{{ formatNum(selectedObject.width_um, 0) }} m</div>\n                     </v-col>\n                     <v-col cols=\"6\">\n                       <div class=\"grey--text\">Height</div>\n                       <div class=\"font-weight-bold\">{{ formatNum(selectedObject.height_um, 0) }} m</div>\n                     </v-col>\n                   </v-row>\n                </v-list-item>\n              </v-list>\n            </div>\n            \n            <div v-else class=\"pa-5 text-center grey--text caption\">\n              <v-icon large class=\"mb-2 text--disabled\">mdi-cursor-default-click-outline</v-icon>\n              <br>Select an object in the gallery to view details.\n            </div>\n          </v-card>\n        </v-col>\n      </v-row>\n\n    </div>\n  </v-container>\n</template>\n\n<script>\nexport default {\n  data() {\n    return {\n      filters: { esd: [0, 2000], circ: [0, 1], val: [0, 255], cluster: 'All' },\n      clusterOptions: ['All', 'Filament', 'Bubble', 'Detritus', 'Dense', 'Other'],\n      sortOptions: [\n        { text: 'Size (Desc)', value: 'esd_desc' }, \n        { text: 'Solidity (Asc)', value: 'sol_asc' },\n        { text: 'Darkest (Val)', value: 'val_asc' }\n      ],\n      gallerySort: 'esd_desc',\n      selectedId: null,\n      charts: { cluster: null, pie: null }\n    }\n  },\n\n  computed: {\n    hasData() { return this.msg && Array.isArray(this.msg.payload) && this.msg.payload.length > 1; },\n    \n    // === DATA CLEANING & CLUSTERING ENGINE ===\n    cleanObjects() {\n      if (!this.hasData) return [];\n      \n      // Filter out metadata rows\n      return this.msg.payload\n        .filter(o => o.object_id !== '[t]' && o.acq_id !== '[t]' && !String(o.object_equivalent_diameter).includes('[f]'))\n        .map(o => {\n          // 1. Unit conversion\n          const px = Number(o.process_pixel || this.msg.process_pixel) || 1;\n          \n          const obj = {\n            ...o,\n            esd_um: (Number(o.object_equivalent_diameter) || 0) * px,\n            width_um: (Number(o.object_width) || 0) * px,\n            height_um: (Number(o.object_height) || 0) * px,\n            circ: Number(o['object_circ.']) || 0,\n            val: Number(o.object_MeanValue) || 0,\n            solidity: Number(o.object_solidity) || 0,\n            elongation: Number(o.object_elongation) || 1,\n          };\n\n          // 2. CLUSTERING LOGIC\n          obj.group = this.determineGroup(obj);\n          return obj;\n        })\n        .filter(o => o.esd_um > 0);\n    },\n\n    // Dynamic counters for Header\n    counts() {\n      const c = { filament:0, bubble:0, detritus:0, dense:0, other:0 };\n      this.cleanObjects.forEach(o => {\n        const key = o.group.toLowerCase();\n        if(c[key] !== undefined) c[key]++;\n        else c.other++;\n      });\n      return c;\n    },\n\n    safeHeader() {\n      if (!this.cleanObjects.length) return { sample_id:'?', volume_used:1, process_pixel:1 };\n      const obj = this.cleanObjects[0];\n      const imgVol = Number(obj.acq_imaged_volume) || 0;\n      const pumpVol = Number(obj.acq_pumped_volume) || 0;\n      return {\n        sample_project: obj.sample_project || 'Unknown',\n        sample_id: obj.sample_id || 'Unknown',\n        acq_id: obj.acq_id || 'N/A',\n        volume_used: imgVol > 0 ? imgVol : (pumpVol > 0 ? pumpVol : 1),\n        process_pixel: Number(obj.process_pixel || 1)\n      };\n    },\n\n    ecotaxaLink() {\n      return this.safeHeader.acq_id !== 'N/A' ? `/ps/data/browse/api/raw/export/ecotaxa/ecotaxa_${this.safeHeader.acq_id}.zip` : '#';\n    },\n\n    sliderStats() {\n      if (!this.cleanObjects.length) return { min:0, max:100 };\n      const vals = this.cleanObjects.map(o => o.esd_um);\n      let min = Math.floor(Math.min(...vals));\n      let max = Math.ceil(Math.max(...vals));\n      if(min>=max) max=min+10;\n      return { min, max };\n    },\n\n    filteredObjects() {\n      const f = this.filters;\n      return this.cleanObjects.filter(o => {\n        const sizeOk = o.esd_um >= f.esd[0] && o.esd_um <= f.esd[1];\n        const circOk = o.circ >= f.circ[0] && o.circ <= f.circ[1];\n        const valOk = o.val >= f.val[0] && o.val <= f.val[1];\n        const clusterOk = f.cluster === 'All' || o.group === f.cluster;\n        return sizeOk && circOk && valOk && clusterOk;\n      });\n    },\n\n    paginatedObjects() {\n      let arr = [...this.filteredObjects];\n      arr.sort((a, b) => {\n        if(this.gallerySort === 'esd_desc') return b.esd_um - a.esd_um;\n        if(this.gallerySort === 'sol_asc') return a.solidity - b.solidity;\n        if(this.gallerySort === 'val_asc') return a.val - b.val;\n        return b.esd_um - a.esd_um;\n      });\n      return arr.slice(0, 200);\n    },\n\n    selectedObject() { return this.filteredObjects.find(o => o.object_id === this.selectedId) || null; },\n    abundance() { return this.filteredObjects.length / this.safeHeader.volume_used; }\n  },\n\n  watch: {\n    msg: { \n      handler() { this.init(); }, \n      deep: true \n    },\n    filteredObjects() { this.updateCharts(); }\n  },\n\n  mounted() { this.init(); },\n\n  methods: {\n    init() {\n      if(this.hasData) {\n        this.filters.esd = [this.sliderStats.min, this.sliderStats.max];\n        this.updateCharts();\n      }\n    },\n    \n    formatNum(v, d) { return (Number(v)||0).toFixed(d); },\n    getImageUrl(o) { return o ? `/ps/data/browse/api/preview/big/objects/${o.object_date || 'date'}/${o.sample_id || 'sample'}/${o.acq_id || 'acq'}/${o.img_file_name}` : ''; },\n\n    // === CLUSTERING LOGIC ===\n    determineGroup(o) {\n      if (o.elongation > 3.5) return 'Filament';\n      if (o.circ > 0.85 && o.solidity > 0.95) return 'Bubble';\n      if (o.solidity < 0.75) return 'Detritus';\n      if (o.val < 100 && o.solidity > 0.85) return 'Dense';\n      return 'Other';\n    },\n\n    getGroupColor(g) {\n      const colors = { 'Filament':'#4CAF50', 'Bubble':'#9E9E9E', 'Detritus':'#795548', 'Dense':'#F44336', 'Other':'#2196F3' };\n      return colors[g] || '#000';\n    },\n\n    resetFilters() {\n      this.filters.esd = [this.sliderStats.min, this.sliderStats.max];\n      this.filters.cluster = 'All';\n      this.filters.circ = [0, 1];\n      this.filters.val = [0, 255];\n    },\n    \n    downloadCSV() {\n       if (!this.filteredObjects.length) return;\n       const headers = Object.keys(this.filteredObjects[0]);\n       const csv = [\n         headers.join(','),\n         ...this.filteredObjects.map(r => headers.map(c => JSON.stringify(r[c]||'')).join(','))\n       ].join('\\n');\n       const blob = new Blob([csv], { type: 'text/csv' });\n       const url = URL.createObjectURL(blob);\n       const a = document.createElement('a');\n       a.href = url; a.download = `${this.safeHeader.acq_id}_export.csv`;\n       a.click();\n    },\n\n    updateCharts() { setTimeout(() => { this.$nextTick(this.renderCharts); }, 250); },\n\n    renderCharts() {\n      this.renderClusterMap();\n      this.renderPie();\n    },\n\n    renderPie() {\n      const ctx = this.$refs.chartPie;\n      if(!ctx) return;\n      if(this.charts.pie) this.charts.pie.destroy();\n\n      const c = this.counts;\n      this.charts.pie = new Chart(ctx, {\n        type: 'doughnut',\n        data: {\n          labels: ['Filament', 'Dense', 'Detritus', 'Bubble', 'Other'],\n          datasets: [{\n            data: [c.filament, c.dense, c.detritus, c.bubble, c.other],\n            backgroundColor: ['#4CAF50', '#F44336', '#795548', '#9E9E9E', '#2196F3'],\n            borderWidth: 1\n          }]\n        },\n        options: { \n          responsive: true, maintainAspectRatio: false,\n          plugins: { legend: { display: false } },\n          cutout: '65%'\n        }\n      });\n    },\n\n    renderClusterMap() {\n      const ctx = this.$refs.chartCluster;\n      if(!ctx) return;\n      if(this.charts.cluster) this.charts.cluster.destroy();\n\n      // PREPARE SEPARATE DATASETS (For auto-legend)\n      const groups = {\n        Filament: [], Dense: [], Detritus: [], Bubble: [], Other: []\n      };\n      \n      this.filteredObjects.forEach(o => {\n        if(groups[o.group]) groups[o.group].push({ x: o.circ, y: o.elongation });\n        else groups['Other'].push({ x: o.circ, y: o.elongation });\n      });\n\n      this.charts.cluster = new Chart(ctx, {\n        type: 'scatter',\n        data: {\n          datasets: [\n            { label:'Filament', data: groups.Filament, backgroundColor: '#4CAF50', pointRadius: 3 },\n            { label:'Dense', data: groups.Dense, backgroundColor: '#F44336', pointRadius: 3 },\n            { label:'Detritus', data: groups.Detritus, backgroundColor: '#795548', pointRadius: 2 },\n            { label:'Bubbles', data: groups.Bubble, backgroundColor: '#9E9E9E', pointRadius: 2 },\n            { label:'Other', data: groups.Other, backgroundColor: '#2196F3', pointRadius: 2 }\n          ]\n        },\n        options: {\n          responsive: true, maintainAspectRatio: false,\n          plugins: { \n            legend: { display: true, position: 'bottom', labels: { usePointStyle: true, padding: 15 } } \n          },\n          scales: {\n            x: { title: {display: true, text:'Circularity'}, min:0, max:1.1 },\n            y: { title: {display: true, text:'Elongation (Log)'}, type: 'logarithmic', min: 1 } \n          }\n        }\n      });\n    }\n  }\n}\n</script>\n\n<style scoped>\n/* BORDER ACCENTS FOR CARDS */\n.border-left-primary { border-left: 4px solid #1976D2 !important; }\n.border-left-info { border-left: 4px solid #03A9F4 !important; }\n.border-right { border-right: 1px solid #eee; }\n.border-bottom { border-bottom: 1px solid #eee; }\n\n/* GALLERY STYLES */\n.gallery-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(70px, 1fr)); gap: 6px; }\n.gallery-item { cursor: pointer; border: 2px solid transparent; transition: all 0.2s; opacity: 0.9; }\n.gallery-item:hover { transform: scale(1.1); z-index: 10; opacity: 1; box-shadow: 0 4px 10px rgba(0,0,0,0.15); }\n.gallery-item.selected { border-color: #1976D2; box-shadow: 0 0 0 3px rgba(25, 118, 210, 0.2); }\n\n/* Color hints under gallery items */\n.g-filament { border-bottom: 3px solid #4CAF50; }\n.g-bubble { border-bottom: 3px solid #9E9E9E; }\n.g-dense { border-bottom: 3px solid #F44336; }\n\n.sticky-top { position: sticky; top: 12px; z-index: 5; }\n</style>",
        "storeOutMessages": true,
        "passthru": true,
        "resendOnRefresh": true,
        "templateScope": "local",
        "className": "",
        "x": 1280,
        "y": 320,
        "wires": [
            []
        ]
    },
    {
        "id": "86bff301d6790945",
        "type": "ui-template",
        "z": "14f8c9b5ce1235cc",
        "group": "44d42558adf7baf7",
        "page": "",
        "ui": "",
        "name": "ChatGPT 5.1 Pro v1",
        "order": 1,
        "width": 0,
        "height": 0,
        "head": "",
        "format": "<script src=\"https://cdn.jsdelivr.net/npm/chart.js\"></script>\n\n<template>\n  <v-container fluid class=\"pa-4 white\" style=\"min-height: 100vh; color:#333;\">\n\n    <!-- NO DATA STATE -->\n    <v-row v-if=\"!hasData\" align=\"center\" justify=\"center\" style=\"height:80vh;\">\n      <div class=\"text-center\">\n        <v-progress-circular indeterminate color=\"primary\" size=\"64\"></v-progress-circular>\n        <div class=\"mt-4 text-h6 grey--text text--darken-1\">\n          Waiting for PlanktoScope segmentation results...\n        </div>\n        <div class=\"caption grey--text\">\n          Send an array of segmented objects as <code>msg.payload</code>.\n        </div>\n      </div>\n    </v-row>\n\n    <!-- MAIN VIEW -->\n    <div v-else>\n\n      <!-- HEADER / CONTEXT -->\n      <v-row dense class=\"mb-3\">\n        <v-col cols=\"12\">\n          <v-card outlined class=\"pa-3 d-flex align-center\">\n            <v-icon color=\"primary\" large class=\"mr-3\">mdi-microscope</v-icon>\n            <div>\n              <div class=\"text-h6 font-weight-bold text-uppercase primary--text\">\n                PlanktoScope Segmentation QA\n              </div>\n              <div class=\"caption grey--text\">\n                Project: <strong>{{ header.sample_project }}</strong> \n                Sample: <strong>{{ header.sample_id }}</strong> \n                Acquisition: <strong>{{ header.acq_id }}</strong>\n              </div>\n              <div class=\"caption grey--text mt-1\">\n                {{ acquisitionLabel }}\n              </div>\n            </div>\n            <v-spacer></v-spacer>\n\n            <v-btn\n              color=\"primary\"\n              outlined\n              class=\"mr-2\"\n              :href=\"ecotaxaLink\"\n              target=\"_blank\"\n              v-if=\"header.acq_id !== 'N/A'\"\n            >\n              <v-icon left small>mdi-folder-zip-outline</v-icon>\n              EcoTaxa (.zip)\n            </v-btn>\n\n            <v-btn color=\"grey darken-2\" outlined class=\"mr-2\" @click=\"downloadCSV\">\n              <v-icon left small>mdi-table-arrow-down</v-icon>\n              CSV export\n            </v-btn>\n\n            <v-btn color=\"primary\" text small @click=\"resetFilters\">\n              <v-icon left small>mdi-filter-remove-outline</v-icon>\n              Reset gates\n            </v-btn>\n          </v-card>\n        </v-col>\n      </v-row>\n\n      <!-- TOP KPIs -->\n      <v-row dense class=\"mb-3\">\n        <v-col cols=\"6\" md=\"3\">\n          <v-card outlined class=\"pa-3 text-center fill-height\">\n            <div class=\"caption grey--text\">Imaged volume</div>\n            <div class=\"text-h5 font-weight-medium\">\n              {{ formatNum(header.acq_imaged_volume, 2) }}\n              <span class=\"caption\">mL</span>\n            </div>\n          </v-card>\n        </v-col>\n\n        <v-col cols=\"6\" md=\"3\">\n          <v-card outlined class=\"pa-3 text-center fill-height\">\n            <div class=\"caption grey--text\">Segmented objects</div>\n            <div class=\"text-h5 font-weight-medium\">\n              {{ filteredObjects.length }}\n              <span class=\"caption grey--text\">/ {{ cleanObjects.length }}</span>\n            </div>\n          </v-card>\n        </v-col>\n\n        <v-col cols=\"6\" md=\"3\">\n          <v-card\n            outlined\n            class=\"pa-3 text-center fill-height\"\n            style=\"border-color:#2196F3;border-width:2px;\"\n          >\n            <div class=\"caption blue--text text--darken-1 font-weight-bold\">\n              Abundance\n            </div>\n            <div class=\"text-h5 font-weight-bold blue--text text--darken-1\">\n              {{ formatNum(abundance, 1) }}\n              <span class=\"caption\">ind./mL</span>\n            </div>\n          </v-card>\n        </v-col>\n\n        <v-col cols=\"6\" md=\"3\">\n          <v-card outlined class=\"pa-3 text-center fill-height\">\n            <div class=\"caption grey--text\">Total biovolume</div>\n            <div class=\"text-h5 font-weight-medium orange--text text--darken-1\">\n              {{ formatNum(totalBiovolume, 3) }}\n              <span class=\"caption\">mm</span>\n            </div>\n          </v-card>\n        </v-col>\n      </v-row>\n\n      <!-- SECOND ROW: QA / ACQ PARAMS / PIPELINE -->\n      <v-row dense class=\"mb-4\">\n        <!-- Segmentation QA -->\n        <v-col cols=\"12\" md=\"4\">\n          <v-card outlined class=\"pa-3\">\n            <div class=\"subtitle-2 font-weight-bold mb-2\">Segmentation quality</div>\n\n            <v-row dense class=\"caption\">\n              <v-col cols=\"7\" class=\"grey--text\">Mean ESD</v-col>\n              <v-col cols=\"5\" class=\"text-right font-weight-bold\">\n                {{ formatNum(segStats.meanEsd, 1) }} m\n              </v-col>\n\n              <v-col cols=\"7\" class=\"grey--text\">Median ESD</v-col>\n              <v-col cols=\"5\" class=\"text-right\">\n                {{ formatNum(segStats.medianEsd, 1) }} m\n              </v-col>\n\n              <v-col cols=\"7\" class=\"grey--text\">Objects &lt; min ESD</v-col>\n              <v-col cols=\"5\" class=\"text-right\">\n                {{ segStats.numSmall }} ({{ formatNum(segStats.fracSmall*100, 0) }}%)\n              </v-col>\n\n              <v-col cols=\"7\" class=\"grey--text\">Objects with holes (Euler &lt; 0)</v-col>\n              <v-col cols=\"5\" class=\"text-right\">\n                {{ segStats.nHoles }} ({{ formatNum(segStats.fracHoles*100, 0) }}%)\n              </v-col>\n\n              <v-col cols=\"7\" class=\"grey--text\">Mean circularity</v-col>\n              <v-col cols=\"5\" class=\"text-right\">\n                {{ formatNum(segStats.meanCirc, 3) }}\n              </v-col>\n\n              <v-col cols=\"7\" class=\"grey--text\">Mean gray (MeanValue)</v-col>\n              <v-col cols=\"5\" class=\"text-right\">\n                {{ formatNum(segStats.meanVal, 0) }}\n              </v-col>\n            </v-row>\n\n            <v-divider class=\"my-2\"></v-divider>\n\n            <div class=\"caption mb-1 font-weight-bold\">Automatic alerts</div>\n            <div v-if=\"!qcAlerts.length\" class=\"caption green--text text--darken-2\">\n              No strong segmentation issues detected.\n            </div>\n            <div v-else>\n              <v-chip\n                v-for=\"(a,i) in qcAlerts\"\n                :key=\"i\"\n                small\n                class=\"ma-1\"\n                color=\"deep-orange lighten-4\"\n                text-color=\"deep-orange darken-3\"\n              >\n                <v-icon left x-small>mdi-alert</v-icon>{{ a }}\n              </v-chip>\n            </div>\n          </v-card>\n        </v-col>\n\n        <!-- Acquisition parameters -->\n        <v-col cols=\"12\" md=\"4\">\n          <v-card outlined class=\"pa-3\">\n            <div class=\"subtitle-2 font-weight-bold mb-2\">Acquisition parameters</div>\n            <v-row dense class=\"caption\">\n              <v-col cols=\"7\" class=\"grey--text\">Pumped volume</v-col>\n              <v-col cols=\"5\" class=\"text-right\">\n                {{ formatNum(header.acq_pumped_volume, 2) }} mL\n              </v-col>\n\n              <v-col cols=\"7\" class=\"grey--text\">Filtered volume</v-col>\n              <v-col cols=\"5\" class=\"text-right\">\n                {{ formatNum(header.sample_filtered_volume, 0) }} mL\n              </v-col>\n\n              <v-col cols=\"7\" class=\"grey--text\">Concentration factor</v-col>\n              <v-col cols=\"5\" class=\"text-right\">\n                {{ formatNum(header.sample_concentration_factor, 1) }}\n              </v-col>\n\n              <v-col cols=\"7\" class=\"grey--text\">Flowcell thickness</v-col>\n              <v-col cols=\"5\" class=\"text-right\">\n                {{ formatNum(header.acq_flowcell_thickness, 0) }} m\n              </v-col>\n\n              <v-col cols=\"7\" class=\"grey--text\">Min ESD (process_min_ESD)</v-col>\n              <v-col cols=\"5\" class=\"text-right\">\n                {{ formatNum(segStats.smallThreshold, 0) }} m\n              </v-col>\n\n              <v-col cols=\"7\" class=\"grey--text\">Pixel size</v-col>\n              <v-col cols=\"5\" class=\"text-right\">\n                {{ formatNum(header.process_pixel, 3) }} m/px\n              </v-col>\n\n              <v-col cols=\"7\" class=\"grey--text\">Camera resolution</v-col>\n              <v-col cols=\"5\" class=\"text-right\">\n                {{ header.acq_camera_resolution || '-' }}\n              </v-col>\n            </v-row>\n          </v-card>\n        </v-col>\n\n        <!-- Segmentation pipeline -->\n        <v-col cols=\"12\" md=\"4\">\n        </v-col>\n      </v-row>\n\n      <!-- MAIN LAYOUT: GATES / CHARTS+GALLERY / INSPECTOR -->\n      <v-row>\n        <!-- GATING PANEL -->\n        <v-col cols=\"12\" md=\"3\" lg=\"2\">\n          <v-card outlined class=\"sticky-top\">\n            <v-card-title class=\"subtitle-2 grey lighten-4 py-2\">\n              Morphological gates\n            </v-card-title>\n            <v-card-text class=\"pt-4\">\n\n              <div class=\"d-flex justify-space-between caption font-weight-bold\">\n                <span>Size (ESD, m)</span>\n                <span>{{ filters.esd[0] }}{{ filters.esd[1] }}</span>\n              </div>\n              <v-range-slider\n                v-model=\"filters.esd\"\n                :min=\"sliderStats.min\"\n                :max=\"sliderStats.max\"\n                dense\n                hide-details\n                class=\"mt-1 mb-4\"\n              ></v-range-slider>\n\n              <div class=\"d-flex justify-space-between caption font-weight-bold\">\n                <span>Circularity</span>\n                <span>{{ filters.circ[0].toFixed(2) }}{{ filters.circ[1].toFixed(2) }}</span>\n              </div>\n              <v-range-slider\n                v-model=\"filters.circ\"\n                :min=\"0\"\n                :max=\"1\"\n                :step=\"0.05\"\n                dense\n                hide-details\n                class=\"mt-1 mb-4\"\n              ></v-range-slider>\n\n              <div class=\"d-flex justify-space-between caption font-weight-bold\">\n                <span>Mean gray (Value)</span>\n              </div>\n              <div class=\"caption text-right grey--text\">\n                {{ filters.val[0] }}{{ filters.val[1] }}\n              </div>\n              <v-range-slider\n                v-model=\"filters.val\"\n                :min=\"0\"\n                :max=\"255\"\n                :step=\"5\"\n                dense\n                hide-details\n                class=\"mt-1 mb-4\"\n              ></v-range-slider>\n\n              <v-btn block text small color=\"grey\" @click=\"resetFilters\">\n                Reset gates\n              </v-btn>\n            </v-card-text>\n          </v-card>\n        </v-col>\n\n        <!-- CHARTS + GALLERY -->\n        <v-col cols=\"12\" md=\"6\" lg=\"7\">\n          <v-row dense>\n            <v-col cols=\"12\" md=\"6\">\n              <v-card outlined class=\"pa-2\">\n                <div class=\"caption font-weight-bold text-center\">\n                  Size spectrum (ESD)\n                </div>\n                <div style=\"height:220px;width:100%;\">\n                  <canvas ref=\"chartSize\"></canvas>\n                </div>\n              </v-card>\n            </v-col>\n\n            <v-col cols=\"12\" md=\"6\">\n              <v-card outlined class=\"pa-2\">\n                <div class=\"caption font-weight-bold text-center\">\n                  Gray-level histogram (MeanValue)\n                </div>\n                <div style=\"height:220px;width:100%;\">\n                  <canvas ref=\"chartGray\"></canvas>\n                </div>\n              </v-card>\n            </v-col>\n\n            <v-col cols=\"12\" md=\"6\">\n              <v-card outlined class=\"pa-2\">\n                <div class=\"caption font-weight-bold text-center\">\n                  Morphospace (ESD vs circularity)\n                </div>\n                <div style=\"height:220px;width:100%;\">\n                  <canvas ref=\"chartMorpho\"></canvas>\n                </div>\n              </v-card>\n            </v-col>\n\n            <v-col cols=\"12\" md=\"6\">\n              <v-card outlined class=\"pa-2\">\n                <div class=\"caption font-weight-bold text-center\">\n                  Structural complexity (elongation vs solidity)\n                </div>\n                <div style=\"height:220px;width:100%;\">\n                  <canvas ref=\"chartStructure\"></canvas>\n                </div>\n              </v-card>\n            </v-col>\n          </v-row>\n\n          <!-- OBJECT GALLERY -->\n          <v-card outlined class=\"mt-3\">\n            <v-card-title class=\"subtitle-2 py-2 grey lighten-5\">\n              Object gallery ({{ filteredObjects.length }})\n              <v-spacer></v-spacer>\n              <v-select\n                v-model=\"gallerySort\"\n                :items=\"sortOptions\"\n                item-text=\"text\"\n                item-value=\"value\"\n                dense\n                outlined\n                hide-details\n                style=\"max-width:210px;\"\n                class=\"caption\"\n              ></v-select>\n            </v-card-title>\n            <v-card-text class=\"pa-2\">\n              <div v-if=\"!filteredObjects.length\" class=\"text-center pa-5 caption\">\n                No objects within current gates.\n              </div>\n              <div class=\"gallery-grid\">\n                <div\n                  v-for=\"obj in paginatedObjects\"\n                  :key=\"obj.object_id\"\n                  class=\"gallery-item\"\n                  :class=\"{selected: selectedId === obj.object_id}\"\n                  @click=\"selectedId = obj.object_id\"\n                >\n                  <v-img\n                    :src=\"getImageUrl(obj)\"\n                    aspect-ratio=\"1\"\n                    contain\n                    class=\"white rounded\"\n                  ></v-img>\n                </div>\n              </div>\n            </v-card-text>\n          </v-card>\n        </v-col>\n\n        <!-- OBJECT INSPECTOR -->\n        <v-col cols=\"12\" md=\"3\" lg=\"3\">\n          <v-card outlined class=\"sticky-top\">\n            <v-card-title class=\"subtitle-2 grey lighten-4 py-2\">\n              Object inspector\n            </v-card-title>\n\n            <div v-if=\"selectedObject\" class=\"pa-3\">\n              <v-img\n                :src=\"getImageUrl(selectedObject)\"\n                max-height=\"220\"\n                contain\n                class=\"mx-auto mb-2\"\n              ></v-img>\n              <div class=\"caption text-center mb-3 font-weight-bold\">\n                {{ selectedObject.object_id }}\n              </div>\n\n              <v-row dense class=\"caption\">\n                <v-col cols=\"7\" class=\"grey--text\">ESD</v-col>\n                <v-col cols=\"5\" class=\"text-right font-weight-bold\">\n                  {{ formatNum(selectedObject.esd_um, 1) }} m\n                </v-col>\n\n                <v-col cols=\"7\" class=\"grey--text\">Width  height</v-col>\n                <v-col cols=\"5\" class=\"text-right\">\n                  {{ formatNum(selectedObject.width_um,1) }}{{ formatNum(selectedObject.height_um,1) }} m\n                </v-col>\n\n                <v-col cols=\"7\" class=\"grey--text\">Circularity</v-col>\n                <v-col cols=\"5\" class=\"text-right\">\n                  {{ formatNum(selectedObject.circ, 3) }}\n                </v-col>\n\n                <v-col cols=\"7\" class=\"grey--text\">Mean gray</v-col>\n                <v-col cols=\"5\" class=\"text-right\">\n                  {{ formatNum(selectedObject.val, 0) }}\n                </v-col>\n\n                <v-col cols=\"7\" class=\"grey--text\">Elongation</v-col>\n                <v-col cols=\"5\" class=\"text-right\">\n                  {{ formatNum(selectedObject.elongation, 1) }}\n                </v-col>\n\n                <v-col cols=\"7\" class=\"grey--text\">Solidity</v-col>\n                <v-col cols=\"5\" class=\"text-right\">\n                  {{ formatNum(selectedObject.solidity, 3) }}\n                </v-col>\n\n                <v-col cols=\"7\" class=\"grey--text\">Eccentricity</v-col>\n                <v-col cols=\"5\" class=\"text-right\">\n                  {{ formatNum(selectedObject.ecc, 3) }}\n                </v-col>\n\n                <v-col cols=\"7\" class=\"grey--text\">Euler number</v-col>\n                <v-col cols=\"5\" class=\"text-right\">\n                  {{ selectedObject.euler }}\n                </v-col>\n\n                <v-col cols=\"7\" class=\"grey--text\">Area (px)</v-col>\n                <v-col cols=\"5\" class=\"text-right\">\n                  {{ formatNum(selectedObject.area_px2, 0) }}\n                </v-col>\n\n                <v-col cols=\"7\" class=\"grey--text\">Area (m)</v-col>\n                <v-col cols=\"5\" class=\"text-right\">\n                  {{ formatNum(selectedObject.area_um2, 1) }}\n                </v-col>\n              </v-row>\n            </div>\n\n            <div v-else class=\"pa-4 caption grey--text text-center\">\n              Select an object in the gallery to inspect its segmentation.\n            </div>\n          </v-card>\n        </v-col>\n      </v-row>\n\n    </div>\n  </v-container>\n</template>\n\n<script>\nexport default {\n  data() {\n    return {\n      filters: {\n        esd: [0, 2000],\n        circ: [0, 1],\n        val: [0, 255]\n      },\n      sortOptions: [\n        { text: 'ESD (descending)', value: 'esd_desc' },\n        { text: 'ESD (ascending)', value: 'esd_asc' },\n        { text: 'Darkest (MeanValue)', value: 'val_asc' },\n        { text: 'Roundest (circularity)', value: 'circ_desc' }\n      ],\n      gallerySort: 'esd_desc',\n      selectedId: null,\n      charts: {\n        chartSize: null,\n        chartGray: null,\n        chartMorpho: null,\n        chartStructure: null\n      }\n    };\n  },\n\n  computed: {\n    hasData() {\n      return (\n        this.msg &&\n        Array.isArray(this.msg.payload) &&\n        this.msg.payload.length > 1\n      );\n    },\n\n    cleanObjects() {\n      if (!this.hasData) return [];\n\n      // First row can be a template row with \"[f]\" / \"[t]\" markers  skip it\n      const items = this.msg.payload.filter(o => o && o.object_id && o.object_id !== '[t]');\n\n      return items\n        .map(o => {\n          const pixelSize =\n            Number(o.process_pixel || this.msg.process_pixel || this.msg.calibration_pixel_size) || 1; // m/px\n\n          const esd_px = Number(o.object_equivalent_diameter) || 0;\n          const width_px = Number(o.object_width) || 0;\n          const height_px = Number(o.object_height) || 0;\n          const area_px2 = Number(o.object_area) || 0;\n\n          return {\n            ...o,\n            pixelSize,\n            esd_px,\n            esd_um: esd_px * pixelSize,\n            width_px,\n            height_px,\n            width_um: width_px * pixelSize,\n            height_um: height_px * pixelSize,\n            circ: Number(o['object_circ.']) || 0,\n            val: Number(o.object_MeanValue) || 0,\n            hue: Number(o.object_MeanHue) || 0,\n            solidity: Number(o.object_solidity) || 0,\n            elongation: Number(o.object_elongation) || 1,\n            ecc: Number(o.object_eccentricity) || 0,\n            euler: Number(o.object_euler_number) || 0,\n            area_px2,\n            area_um2: area_px2 * pixelSize * pixelSize\n          };\n        })\n        .filter(o => o.esd_um > 0);\n    },\n\n    header() {\n      if (!this.cleanObjects.length) {\n        return {\n          sample_project: '?',\n          sample_id: '?',\n          acq_id: 'N/A',\n          acq_imaged_volume: 0,\n          acq_pumped_volume: 0,\n          sample_filtered_volume: 0,\n          sample_concentration_factor: 1,\n          acq_flowcell_thickness: 0,\n          process_min_ESD: 0,\n          process_pixel: 0,\n          acq_camera_resolution: '',\n          acq_local_datetime: '',\n          object_date: '',\n          object_lat: null,\n          object_lon: null\n        };\n      }\n      const obj =\n        this.cleanObjects.find(o => Number(o.acq_imaged_volume) > 0) ||\n        this.cleanObjects[0];\n\n      return {\n        sample_project: obj.sample_project || 'Unknown',\n        sample_id: obj.sample_id || 'Unknown',\n        acq_id: obj.acq_id || 'N/A',\n        acq_imaged_volume: Number(obj.acq_imaged_volume) || 0,\n        acq_pumped_volume: Number(obj.acq_pumped_volume) || 0,\n        sample_filtered_volume: Number(obj.sample_filtered_volume) || 0,\n        sample_concentration_factor: Number(obj.sample_concentration_factor) || 1,\n        acq_flowcell_thickness: Number(obj.acq_flowcell_thickness) || 0,\n        process_min_ESD: Number(obj.process_min_ESD) || 0,\n        process_pixel:\n          Number(obj.process_pixel || this.msg.process_pixel || this.msg.calibration_pixel_size) || 0,\n        acq_camera_resolution: obj.acq_camera_resolution || '',\n        acq_local_datetime: obj.acq_local_datetime || '',\n        object_date: obj.object_date || '',\n        object_lat: Number(obj.object_lat) || null,\n        object_lon: Number(obj.object_lon) || null\n      };\n    },\n\n    acquisitionLabel() {\n      const h = this.header;\n      const parts = [];\n      if (h.object_date) parts.push(`Date: ${h.object_date}`);\n      if (h.acq_local_datetime) parts.push(`Local: ${h.acq_local_datetime}`);\n      if (h.object_lat !== null && h.object_lon !== null) {\n        parts.push(`Lat/Lon: ${h.object_lat.toFixed(3)}, ${h.object_lon.toFixed(3)}`);\n      }\n      return parts.join('  ') || 'Acquisition context not available in payload.';\n    },\n\n    ecotaxaLink() {\n      const acq = this.header.acq_id;\n      if (!acq || acq === 'N/A') return '#';\n      return `/ps/data/browse/api/raw/export/ecotaxa/ecotaxa_${acq}.zip`;\n    },\n\n    sliderStats() {\n      if (!this.cleanObjects.length) return { min: 0, max: 100 };\n      const vals = this.cleanObjects.map(o => o.esd_um);\n      let min = Math.floor(Math.min(...vals));\n      let max = Math.ceil(Math.max(...vals));\n      if (min >= max) max = min + 10;\n      return { min, max };\n    },\n\n    filteredObjects() {\n      const f = this.filters;\n      return this.cleanObjects.filter(o => {\n        return (\n          o.esd_um >= f.esd[0] &&\n          o.esd_um <= f.esd[1] &&\n          o.circ >= f.circ[0] &&\n          o.circ <= f.circ[1] &&\n          o.val >= f.val[0] &&\n          o.val <= f.val[1]\n        );\n      });\n    },\n\n    paginatedObjects() {\n      let arr = [...this.filteredObjects];\n      arr.sort((a, b) => {\n        switch (this.gallerySort) {\n          case 'esd_asc':\n            return a.esd_um - b.esd_um;\n          case 'val_asc':\n            return a.val - b.val;\n          case 'circ_desc':\n            return b.circ - a.circ;\n          case 'esd_desc':\n          default:\n            return b.esd_um - a.esd_um;\n        }\n      });\n      return arr.slice(0, 200);\n    },\n\n    selectedObject() {\n      return (\n        this.filteredObjects.find(o => o.object_id === this.selectedId) ||\n        this.filteredObjects[0] ||\n        null\n      );\n    },\n\n    abundance() {\n      const v = this.header.acq_imaged_volume;\n      return v > 0 ? this.filteredObjects.length / v : 0;\n    },\n\n    totalBiovolume() {\n      const sumUm3 = this.filteredObjects.reduce((acc, o) => {\n        const r = o.esd_um / 2;\n        return acc + (4 / 3) * Math.PI * Math.pow(r, 3);\n      }, 0);\n      return sumUm3 / 1e9; // m  mm\n    },\n\n    processingSteps() {\n      if (!this.cleanObjects.length) return [];\n\n      const o = this.cleanObjects[0];\n      const keys = [\n        'process_1st_operation',\n        'process_2nd_operation',\n        'process_3rd_operation',\n        'process_4th_operation',\n        'process_5th_operation',\n        'process_6th_operation',\n        'process_7th_operation'\n      ];\n\n      const steps = [];\n\n      keys.forEach((k, idx) => {\n        const raw = o[k];\n        if (!raw) return;\n\n        const str = String(raw);\n\n        // Type\n        let label = `Step ${idx + 1}`;\n        const mType = str.match(/'type'\\s*:\\s*'([^']+)'/);\n        if (mType && mType[1]) {\n          label = mType[1];\n        }\n\n        // Compact parameters summary\n        const parts = [];\n\n        const mAlg = str.match(/'algorithm'\\s*:\\s*'([^']+)'/);\n        if (mAlg && mAlg[1]) parts.push(mAlg[1]);\n\n        const mTypeParam = str.match(/'parameters'\\s*:\\s*\\{[^}]*'type'\\s*:\\s*'([^']+)'/);\n        if (mTypeParam && mTypeParam[1]) parts.push(mTypeParam[1]);\n\n        const mKernel = str.match(/'kernel_size'\\s*:\\s*([0-9.]+)/);\n        if (mKernel && mKernel[1]) parts.push(`k=${mKernel[1]}`);\n\n        const mShape = str.match(/'kernel_shape'\\s*:\\s*'([^']+)'/);\n        if (mShape && mShape[1]) parts.push(mShape[1]);\n\n        const params = parts.join(', ');\n\n        steps.push({\n          order: idx + 1,\n          label,\n          params\n        });\n      });\n\n      return steps;\n    },\n\n    segStats() {\n      const N = this.cleanObjects.length;\n      if (!N) {\n        return {\n          meanEsd: 0,\n          medianEsd: 0,\n          sdEsd: 0,\n          numSmall: 0,\n          fracSmall: 0,\n          nHoles: 0,\n          fracHoles: 0,\n          meanCirc: 0,\n          meanVal: 0,\n          smallThreshold: 0\n        };\n      }\n\n      const esdVals = this.cleanObjects.map(o => o.esd_um).filter(v => v > 0);\n      const circVals = this.cleanObjects.map(o => o.circ).filter(v => v >= 0);\n      const valVals = this.cleanObjects.map(o => o.val).filter(v => v >= 0);\n\n      const smallThreshold = Number(this.header.process_min_ESD) || 0;\n      const numSmall =\n        smallThreshold > 0\n          ? this.cleanObjects.filter(o => o.esd_um > 0 && o.esd_um < smallThreshold).length\n          : 0;\n      const nHoles = this.cleanObjects.filter(o => o.euler < 0).length;\n\n      const esdStats = this.basicStats(esdVals);\n      const circStats = this.basicStats(circVals);\n      const valStats = this.basicStats(valVals);\n\n      return {\n        meanEsd: esdStats.mean,\n        medianEsd: esdStats.median,\n        sdEsd: esdStats.sd,\n        numSmall,\n        fracSmall: N ? numSmall / N : 0,\n        nHoles,\n        fracHoles: N ? nHoles / N : 0,\n        meanCirc: circStats.mean,\n        meanVal: valStats.mean,\n        smallThreshold\n      };\n    },\n\n    qcAlerts() {\n      const alerts = [];\n      const s = this.segStats;\n\n      if (s.smallThreshold > 0 && s.fracSmall > 0.4) {\n        alerts.push('High fraction of objects below min ESD  possible over-segmentation or noise.');\n      }\n      if (s.fracHoles > 0.3) {\n        alerts.push('Many objects with Euler < 0 (holes)  hollow objects or thresholding artefacts.');\n      }\n      if (s.meanVal < 40) {\n        alerts.push('Very low gray levels  segmentation on dark background / threshold may be too low.');\n      }\n      if (s.meanCirc < 0.2) {\n        alerts.push('Very low mean circularity  many elongated objects (filaments/fragments?).');\n      }\n\n      return alerts;\n    }\n  },\n\n  watch: {\n    msg: {\n      handler(val) {\n        if (val && Array.isArray(val.payload)) {\n          this.filters.esd = [this.sliderStats.min, this.sliderStats.max];\n          this.updateCharts();\n        }\n      },\n      deep: true\n    },\n    filteredObjects() {\n      this.updateCharts();\n    }\n  },\n\n  mounted() {\n    if (this.hasData) {\n      this.filters.esd = [this.sliderStats.min, this.sliderStats.max];\n      this.updateCharts();\n    }\n  },\n\n  beforeUnmount() {\n    Object.keys(this.charts).forEach(k => {\n      if (this.charts[k]) {\n        this.charts[k].destroy();\n        this.charts[k] = null;\n      }\n    });\n  },\n\n  methods: {\n    formatNum(v, d) {\n      return typeof v === 'number' && !isNaN(v) ? v.toFixed(d) : '-';\n    },\n\n    basicStats(arr) {\n      if (!arr || !arr.length) {\n        return { mean: 0, median: 0, sd: 0 };\n      }\n      const n = arr.length;\n      const sum = arr.reduce((a, b) => a + b, 0);\n      const mean = sum / n;\n      const sorted = [...arr].sort((a, b) => a - b);\n      const median =\n        n % 2\n          ? sorted[(n - 1) / 2]\n          : (sorted[n / 2 - 1] + sorted[n / 2]) / 2;\n      const sd = Math.sqrt(\n        arr.reduce((acc, v) => acc + Math.pow(v - mean, 2), 0) / n\n      );\n      return { mean, median, sd };\n    },\n\n    getImageUrl(o) {\n      if (!o) return '';\n      const date = o.object_date || this.header.object_date || 'date';\n      const sample = o.sample_id || this.header.sample_id || 'sample';\n      const acq = o.acq_id || this.header.acq_id || 'acq';\n      return `/ps/data/browse/api/preview/big/objects/${date}/${sample}/${acq}/${o.img_file_name}`;\n    },\n\n    downloadCSV() {\n      if (!this.filteredObjects.length) return;\n      const headers = Object.keys(this.filteredObjects[0]);\n      const csv = [\n        headers.join(','),\n        ...this.filteredObjects.map(r =>\n          headers.map(c => JSON.stringify(r[c] != null ? r[c] : '')).join(',')\n        )\n      ].join('\\n');\n      const blob = new Blob([csv], { type: 'text/csv' });\n      const url = URL.createObjectURL(blob);\n      const a = document.createElement('a');\n      a.href = url;\n      a.download = `${this.header.acq_id || 'segmentation'}_export.csv`;\n      a.click();\n      URL.revokeObjectURL(url);\n    },\n\n    resetFilters() {\n      this.filters.esd = [this.sliderStats.min, this.sliderStats.max];\n      this.filters.circ = [0, 1];\n      this.filters.val = [0, 255];\n    },\n\n    updateCharts() {\n      setTimeout(() => {\n        this.$nextTick(() => {\n          this.renderAllCharts();\n        });\n      }, 200);\n    },\n\n    renderAllCharts() {\n      this.drawChart('chartSize', 'bar', this.getSizeHistData(), {\n        x: { title: { display: true, text: 'ESD (m)' } },\n        y: { beginAtZero: true, title: { display: true, text: 'Count' } }\n      });\n\n      this.drawChart('chartGray', 'bar', this.getGrayHistData(), {\n        x: { title: { display: true, text: 'MeanValue (0255)' } },\n        y: { beginAtZero: true, title: { display: true, text: 'Count' } }\n      });\n\n      this.drawChart('chartMorpho', 'scatter', this.getScatterData('esd_um', 'circ'), {\n        x: { title: { display: true, text: 'ESD (m)' } },\n        y: { min: 0, max: 1.1, title: { display: true, text: 'Circularity' } }\n      });\n\n      this.drawChart('chartStructure', 'scatter', this.getScatterData('elongation', 'solidity'), {\n        x: { title: { display: true, text: 'Elongation' }, min: 1 },\n        y: { min: 0, max: 1.1, title: { display: true, text: 'Solidity' } }\n      });\n    },\n\n    drawChart(refName, type, data, scales) {\n      const canvas = this.$refs[refName];\n      if (!canvas || !data || !data.datasets || !data.datasets.length) {\n        if (this.charts[refName]) {\n          this.charts[refName].destroy();\n          this.charts[refName] = null;\n        }\n        return;\n      }\n\n      if (this.charts[refName]) {\n        this.charts[refName].destroy();\n        this.charts[refName] = null;\n      }\n\n      this.charts[refName] = new Chart(canvas, {\n        type,\n        data,\n        options: {\n          responsive: true,\n          maintainAspectRatio: false,\n          animation: false,\n          plugins: { legend: { display: false } },\n          scales\n        }\n      });\n    },\n\n    getSizeHistData() {\n      const vals = this.filteredObjects.map(o => o.esd_um).filter(v => v > 0);\n      if (!vals.length) return { labels: [], datasets: [] };\n\n      const bins = 15;\n      const min = Math.min(...vals);\n      const max = Math.max(...vals);\n      const step = (max - min) / bins || 1;\n      const hist = new Array(bins).fill(0);\n      const labels = [];\n\n      for (let i = 0; i < bins; i++) {\n        const edge = min + i * step;\n        labels.push(edge.toFixed(0));\n      }\n      vals.forEach(v => {\n        let idx = Math.floor((v - min) / step);\n        if (idx >= bins) idx = bins - 1;\n        if (idx < 0) idx = 0;\n        hist[idx]++;\n      });\n\n      return {\n        labels,\n        datasets: [\n          {\n            data: hist,\n            backgroundColor: '#2196F3'\n          }\n        ]\n      };\n    },\n\n    getGrayHistData() {\n      const vals = this.filteredObjects.map(o => o.val).filter(v => v >= 0);\n      if (!vals.length) return { labels: [], datasets: [] };\n\n      const bins = 16;\n      const min = 0;\n      const max = 255;\n      const step = (max - min) / bins;\n      const hist = new Array(bins).fill(0);\n      const labels = [];\n\n      for (let i = 0; i < bins; i++) {\n        const start = min + i * step;\n        labels.push(start.toFixed(0));\n      }\n      vals.forEach(v => {\n        let idx = Math.floor((v - min) / step);\n        if (idx >= bins) idx = bins - 1;\n        if (idx < 0) idx = 0;\n        hist[idx]++;\n      });\n\n      return {\n        labels,\n        datasets: [\n          {\n            data: hist,\n            backgroundColor: '#9C27B0'\n          }\n        ]\n      };\n    },\n\n    getScatterData(xKey, yKey) {\n      const data = this.filteredObjects.map(o => ({\n        x: Number(o[xKey]) || 0,\n        y: Number(o[yKey]) || 0\n      }));\n      if (!data.length) return { datasets: [] };\n\n      return {\n        datasets: [\n          {\n            data,\n            backgroundColor: 'rgba(33,150,243,0.5)',\n            pointRadius: 2\n          }\n        ]\n      };\n    }\n  }\n};\n</script>\n\n<style scoped>\n.v-card {\n  border: 1px solid #ddd !important;\n}\n\n.sticky-top {\n  position: sticky;\n  top: 12px;\n  z-index: 5;\n}\n\n/* Gallery */\n.gallery-grid {\n  display: grid;\n  grid-template-columns: repeat(auto-fill, minmax(60px, 1fr));\n  gap: 4px;\n}\n\n.gallery-item {\n  cursor: pointer;\n  border: 2px solid transparent;\n  transition: transform 0.1s, box-shadow 0.1s, border-color 0.1s;\n}\n\n.gallery-item:hover {\n  transform: scale(1.08);\n  z-index: 2;\n  box-shadow: 0 2px 8px rgba(0,0,0,0.2);\n}\n\n.gallery-item.selected {\n  border-color: #2196F3;\n}\n</style>\n",
        "storeOutMessages": true,
        "passthru": true,
        "resendOnRefresh": true,
        "templateScope": "local",
        "className": "",
        "x": 1300,
        "y": 240,
        "wires": [
            []
        ]
    },
    {
        "id": "c42d0eb4a7bc6eb4",
        "type": "ui-template",
        "z": "14f8c9b5ce1235cc",
        "group": "e3bd8883700f1ab8",
        "page": "",
        "ui": "",
        "name": "ChatGPT 5.1 Pro v2",
        "order": 1,
        "width": 0,
        "height": 0,
        "head": "",
        "format": "<script src=\"https://cdn.jsdelivr.net/npm/chart.js\"></script>\n\n<template>\n  <v-container fluid class=\"pa-2 dashboard-root\">\n    <v-row dense>\n      <v-col cols=\"12\">\n        <v-card class=\"mb-2\" outlined>\n          <v-card-text>\n            <v-row align=\"center\" justify=\"space-between\" no-gutters>\n              <v-col cols=\"12\" md=\"4\">\n                <div class=\"text-h6 font-weight-medium\">\n                  {{ headerProjectName || 'No project' }}\n                </div>\n                <div class=\"caption grey--text\">\n                  Sample:\n                  <span class=\"font-weight-medium\">{{ headerSampleId || 'N/A' }}</span>\n                  <span v-if=\"headerLocalDateTime\">  {{ headerLocalDateTime }}</span>\n                </div>\n              </v-col>\n              <v-col cols=\"12\" md=\"4\">\n                <div class=\"d-flex flex-wrap\">\n                  <v-chip small class=\"mr-2 mb-1\" color=\"primary\" text-color=\"white\">\n                    {{ pixelSizeDisplay }}\n                  </v-chip>\n                  <v-chip small class=\"mr-2 mb-1\" color=\"teal\" text-color=\"white\">\n                    {{ volumeDisplay }}\n                  </v-chip>\n                  <v-chip small class=\"mr-2 mb-1\" color=\"indigo\" text-color=\"white\" v-if=\"cameraDisplay\">\n                    {{ cameraDisplay }}\n                  </v-chip>\n                </div>\n              </v-col>\n              <v-col cols=\"12\" md=\"4\">\n                <div class=\"d-flex justify-end flex-wrap mt-2 mt-md-0\">\n                  <v-btn\n                    small\n                    class=\"mr-2 mb-1\"\n                    :href=\"ecoTaxaUrl\"\n                    target=\"_blank\"\n                    :disabled=\"!ecoTaxaUrl\"\n                    color=\"primary\"\n                    outlined\n                  >\n                    <v-icon left small>mdi-zip-box</v-icon>\n                    EcoTaxa ZIP\n                  </v-btn>\n                  <v-btn\n                    small\n                    class=\"mr-2 mb-1\"\n                    @click=\"exportCsv\"\n                    color=\"primary\"\n                    outlined\n                  >\n                    <v-icon left small>mdi-download</v-icon>\n                    CSV\n                  </v-btn>\n                  <v-btn\n                    small\n                    class=\"mb-1\"\n                    @click=\"resetFilters\"\n                    color=\"secondary\"\n                    text\n                  >\n                    <v-icon left small>mdi-restore</v-icon>\n                    Reset\n                  </v-btn>\n                </div>\n              </v-col>\n            </v-row>\n          </v-card-text>\n        </v-card>\n      </v-col>\n\n```\n  <v-col cols=\"12\">\n    <v-row dense>\n      <v-col cols=\"12\" sm=\"4\" md=\"2\" v-for=\"kpi in kpiCards\" :key=\"kpi.key\">\n        <v-card class=\"kpi-card\" outlined>\n          <div class=\"kpi-border\" :class=\"'kpi-border--' + kpi.key\"></div>\n          <v-card-text class=\"py-2\">\n            <div class=\"caption text-uppercase grey--text text--darken-1\">\n              {{ kpi.label }}\n            </div>\n            <div class=\"d-flex align-center justify-space-between\">\n              <div class=\"text-h5 font-weight-medium\">{{ kpi.value }}</div>\n              <div class=\"caption grey--text\" v-if=\"kpi.sub\">{{ kpi.sub }}</div>\n            </div>\n          </v-card-text>\n        </v-card>\n      </v-col>\n    </v-row>\n  </v-col>\n</v-row>\n\n<v-row dense>\n  <v-col cols=\"12\" md=\"3\" lg=\"2\">\n    <v-card class=\"sticky-card\" outlined>\n      <v-card-title class=\"py-2\">\n        <span class=\"subtitle-2 font-weight-medium\">Filters</span>\n      </v-card-title>\n      <v-divider></v-divider>\n      <v-card-text class=\"py-2\">\n        <div class=\"mb-3\">\n          <div class=\"caption grey--text text--darken-1 d-flex justify-space-between\">\n            <span>ESD (m)</span>\n            <span>{{ formatNumber(esdRange[0]) }}  {{ formatNumber(esdRange[1]) }}</span>\n          </div>\n          <v-range-slider\n            v-model=\"esdRange\"\n            :min=\"minEsd\"\n            :max=\"maxEsd\"\n            :step=\"(maxEsd - minEsd) / 50 || 1\"\n            hide-details\n            dense\n          ></v-range-slider>\n        </div>\n\n        <div class=\"mb-3\">\n          <div class=\"caption grey--text text--darken-1 d-flex justify-space-between\">\n            <span>Circularity</span>\n            <span>{{ formatNumber(circularityRange[0]) }}  {{ formatNumber(circularityRange[1]) }}</span>\n          </div>\n          <v-range-slider\n            v-model=\"circularityRange\"\n            :min=\"minCircularity\"\n            :max=\"maxCircularity\"\n            :step=\"0.01\"\n            hide-details\n            dense\n          ></v-range-slider>\n        </div>\n\n        <div class=\"mb-3\">\n          <div class=\"caption grey--text text--darken-1 mb-1\">\n            Cluster\n          </div>\n          <v-select\n            dense\n            outlined\n            hide-details\n            :items=\"clusterOptions\"\n            v-model=\"selectedCluster\"\n          ></v-select>\n        </div>\n\n        <div class=\"mt-3\">\n          <div class=\"caption mb-1 grey--text text--darken-1\">\n            Cluster distribution\n          </div>\n          <div class=\"cluster-pie-wrapper\">\n            <canvas ref=\"clusterPieCanvas\"></canvas>\n          </div>\n        </div>\n      </v-card-text>\n    </v-card>\n  </v-col>\n\n  <v-col cols=\"12\" md=\"6\" lg=\"7\">\n    <v-card class=\"mb-2\" outlined>\n      <v-card-title class=\"py-2\">\n        <span class=\"subtitle-2 font-weight-medium\">Morphology descriptors</span>\n      </v-card-title>\n      <v-divider></v-divider>\n      <v-card-text class=\"py-2\">\n        <div class=\"mb-3\">\n          <div class=\"caption mb-1 grey--text text--darken-1\">\n            Circularity vs Elongation\n          </div>\n          <div class=\"chart-container scatter-container\">\n            <canvas ref=\"scatterCanvas\"></canvas>\n          </div>\n        </div>\n\n        <v-divider class=\"my-3\"></v-divider>\n\n        <div>\n          <div class=\"caption mb-1 grey--text text--darken-1\">\n            ESD distribution (m)\n          </div>\n          <div class=\"chart-container\">\n            <canvas ref=\"esdHistCanvas\"></canvas>\n          </div>\n        </div>\n      </v-card-text>\n    </v-card>\n  </v-col>\n\n  <v-col cols=\"12\" md=\"3\" lg=\"3\">\n    <v-card class=\"sticky-card mb-2\" outlined>\n      <v-card-title class=\"py-2\">\n        <span class=\"subtitle-2 font-weight-medium\">Object inspector</span>\n      </v-card-title>\n      <v-divider></v-divider>\n      <v-card-text class=\"py-2\">\n        <div v-if=\"selectedObject\">\n          <div class=\"mb-2 d-flex align-center justify-space-between\">\n            <div>\n              <div class=\"subtitle-2 font-weight-medium\">\n                ID {{ selectedObject.object_id || selectedObject._uid }}\n              </div>\n              <div class=\"caption grey--text text--darken-1\">\n                {{ selectedObject.sample_id || headerSampleId || 'N/A' }}\n                \n                {{ selectedObject.acq_id || headerAcqId || 'N/A' }}\n              </div>\n            </div>\n            <v-chip\n              small\n              :color=\"clusterColor(selectedObject.clusterCanonical)\"\n              text-color=\"white\"\n            >\n              {{ selectedObject.clusterCanonical }}\n            </v-chip>\n          </div>\n\n          <div v-if=\"getObjectImageUrl(selectedObject)\" class=\"inspector-image-wrapper mb-2\">\n            <v-img\n              :src=\"getObjectImageUrl(selectedObject)\"\n              :aspect-ratio=\"1\"\n              contain\n              class=\"inspector-img\"\n              ref=\"inspectorImage\"\n              @load=\"onInspectorImageLoad\"\n            ></v-img>\n            <div v-if=\"scaleBarVisible\" class=\"scale-bar\">\n              <div class=\"scale-bar-line\" :style=\"{ width: scaleBarCssWidth + 'px' }\"></div>\n              <div class=\"scale-bar-label\">{{ scaleBarMicronsLabel }}</div>\n            </div>\n          </div>\n          <div\n            v-else\n            class=\"inspector-placeholder mb-2 d-flex align-center justify-center caption grey--text\"\n          >\n            No preview available\n          </div>\n\n          <div v-if=\"getObjectImageUrl(selectedObject)\" class=\"mb-2 d-flex justify-end\">\n            <v-btn\n              small\n              outlined\n              color=\"primary\"\n              :href=\"getObjectImageUrl(selectedObject)\"\n              :download=\"downloadFileName(selectedObject)\"\n              target=\"_blank\"\n            >\n              <v-icon left small>mdi-download</v-icon>\n              Tlcharger l'image\n            </v-btn>\n          </div>\n\n          <v-row dense class=\"mb-2\">\n            <v-col cols=\"6\">\n              <div class=\"caption grey--text text--darken-1\">ESD</div>\n              <div class=\"subtitle-2\">\n                {{ formatNumber(selectedObject.esd_um) }} m\n              </div>\n            </v-col>\n            <v-col cols=\"6\">\n              <div class=\"caption grey--text text--darken-1\">Area</div>\n              <div class=\"subtitle-2\">\n                <span v-if=\"selectedObject.area_um2\">\n                  {{ formatNumber(selectedObject.area_um2) }} m\n                </span>\n                <span v-else>N/A</span>\n              </div>\n            </v-col>\n          </v-row>\n\n          <v-row dense class=\"mb-2\">\n            <v-col cols=\"6\">\n              <div class=\"caption grey--text text--darken-1\">Circularity</div>\n              <div class=\"subtitle-2 mb-1\">\n                {{ formatNumber(selectedObject.circularity) }}\n              </div>\n              <v-progress-linear\n                :value=\"metricToPercent(selectedObject.circularity)\"\n                height=\"5\"\n              ></v-progress-linear>\n            </v-col>\n            <v-col cols=\"6\">\n              <div class=\"caption grey--text text--darken-1\">Solidity</div>\n              <div class=\"subtitle-2 mb-1\">\n                {{ formatNumber(selectedObject.solidity) }}\n              </div>\n              <v-progress-linear\n                :value=\"metricToPercent(selectedObject.solidity)\"\n                height=\"5\"\n                color=\"deep-purple\"\n              ></v-progress-linear>\n            </v-col>\n          </v-row>\n\n          <v-row dense class=\"mb-2\">\n            <v-col cols=\"4\">\n              <div class=\"caption grey--text text--darken-1\">Elongation</div>\n              <div class=\"subtitle-2\">\n                {{ formatNumber(selectedObject.elongation) }}\n              </div>\n            </v-col>\n            <v-col cols=\"4\">\n              <div class=\"caption grey--text text--darken-1\">Width</div>\n              <div class=\"subtitle-2\">\n                {{ formatNumber(selectedObject.width_um) }} m\n              </div>\n            </v-col>\n            <v-col cols=\"4\">\n              <div class=\"caption grey--text text--darken-1\">Height</div>\n              <div class=\"subtitle-2\">\n                {{ formatNumber(selectedObject.height_um) }} m\n              </div>\n            </v-col>\n          </v-row>\n        </div>\n        <div v-else class=\"text-center caption grey--text py-6\">\n          Select an object from the gallery to inspect its details.\n        </div>\n      </v-card-text>\n    </v-card>\n  </v-col>\n</v-row>\n\n<v-row dense class=\"mt-2\">\n  <v-col cols=\"12\">\n    <v-card outlined>\n      <v-card-title class=\"py-2\">\n        <div class=\"d-flex align-center justify-space-between flex-wrap w-100\">\n          <div class=\"subtitle-2 font-weight-medium\">\n            Objects gallery\n          </div>\n          <div class=\"d-flex align-center\">\n            <v-select\n              dense\n              outlined\n              hide-details\n              class=\"mr-2 gallery-sort-select\"\n              style=\"max-width: 220px;\"\n              :items=\"gallerySortOptions\"\n              v-model=\"gallerySortKey\"\n            ></v-select>\n            <div class=\"caption grey--text\">\n              {{ visibleObjects.length }} / {{ filteredObjects.length }} visible\n            </div>\n          </div>\n        </div>\n      </v-card-title>\n      <v-divider></v-divider>\n      <v-card-text class=\"py-2\">\n        <div v-if=\"visibleObjects.length\" class=\"gallery-grid\">\n          <div\n            v-for=\"obj in visibleObjects\"\n            :key=\"obj._uid\"\n            class=\"gallery-item\"\n            :class=\"['cluster-' + obj.clusterCanonical, { 'gallery-item--selected': selectedObject && selectedObject._uid === obj._uid }]\"\n            @click=\"selectObject(obj)\"\n          >\n            <v-img\n              v-if=\"getObjectImageUrl(obj)\"\n              :src=\"getObjectImageUrl(obj)\"\n              :aspect-ratio=\"1\"\n              contain\n              class=\"gallery-img\"\n            ></v-img>\n            <div\n              v-else\n              class=\"gallery-placeholder d-flex align-center justify-center caption grey--text\"\n            >\n              No image\n            </div>\n            <div class=\"gallery-meta\">\n              <div class=\"caption\">{{ formatNumber(obj.esd_um) }} m</div>\n              <div class=\"caption grey--text text--darken-1\">\n                {{ obj.clusterCanonical }}\n              </div>\n            </div>\n          </div>\n        </div>\n        <div v-else class=\"text-center caption grey--text py-4\">\n          No objects match current filters.\n        </div>\n      </v-card-text>\n    </v-card>\n  </v-col>\n</v-row>\n```\n\n  </v-container>\n</template>\n\n<script>\nexport default {\n  props: {\n    msg: {\n      type: Object,\n      default: function () {\n        return {};\n      }\n    }\n  },\n  data: function () {\n    return {\n      esdRange: [0, 0],\n      circularityRange: [0, 1],\n      selectedCluster: 'All',\n      gallerySortKey: 'ESD  (largest first)',\n      charts: {\n        clusterPie: null,\n        scatter: null,\n        esdHist: null\n      },\n      selectedUid: null,\n      maxGalleryItems: 200,\n      chartReady: false,\n      chartInitInterval: null,\n      chartUpdateTimeout: null,\n      inspectorImageWidth: null,\n      inspectorImageNaturalWidth: null,\n      maxScatterPoints: 2000\n    };\n  },\n  computed: {\n    payload: function () {\n      var p = this.msg && this.msg.payload;\n      return Array.isArray(p) ? p : [];\n    },\n    cleanObjects: function () {\n      var rows = this.payload || [];\n      var result = [];\n      for (var i = 0; i < rows.length; i++) {\n        var row = rows[i];\n        if (!row || typeof row !== 'object') continue;\n        if (this.isTemplateRow(row)) continue;\n        var o = Object.assign({}, row);\n        o.object_id = o.object_id || o.id || (i + 1);\n        var pixelSize = this.toNumber(o.process_pixel) || this.toNumber(o.calibration_pixel_size) || 1;\n        o._pixelSize = pixelSize;\n\n        var esdPx = this.toNumber(o.object_equivalent_diameter);\n        if (esdPx === null) continue;\n        o.object_equivalent_diameter = esdPx;\n        o.esd_um = esdPx * pixelSize;\n\n        var widthPx = this.toNumber(o.object_width);\n        var heightPx = this.toNumber(o.object_height);\n        if (widthPx !== null) {\n          o.object_width = widthPx;\n          o.width_um = widthPx * pixelSize;\n        }\n        if (heightPx !== null) {\n          o.object_height = heightPx;\n          o.height_um = heightPx * pixelSize;\n        }\n\n        var areaPx2 = this.toNumber(o.object_area);\n        if (areaPx2 !== null) {\n          o.object_area = areaPx2;\n          o.area_um2 = areaPx2 * pixelSize * pixelSize;\n        }\n\n        o.circularity = this.toNumber(o.circularity);\n        o.elongation = this.toNumber(o.elongation);\n        o.solidity = this.toNumber(o.solidity || o.Solidity);\n        o.object_MeanValue = this.toNumber(o.object_MeanValue || o.gray_mean || o.mean_gray);\n\n        var clusterLabel = this.getClusterLabel(o);\n        o.clusterCanonical = clusterLabel;\n\n        o._uid = String(o.object_id) + '-' + i + '-' + clusterLabel;\n        result.push(o);\n      }\n      return result;\n    },\n    headerObject: function () {\n      if (this.cleanObjects.length) return this.cleanObjects[0];\n      if (this.payload && this.payload.length) return this.payload[0];\n      return null;\n    },\n    headerProjectName: function () {\n      if (!this.headerObject) return this.msg && this.msg.sample_project;\n      return (\n        this.headerObject.sample_project ||\n        this.headerObject.project_name ||\n        this.headerObject.project ||\n        (this.msg && this.msg.sample_project) ||\n        null\n      );\n    },\n    headerSampleId: function () {\n      if (!this.headerObject) return this.msg && this.msg.sample_id;\n      return (\n        this.headerObject.sample_id ||\n        this.headerObject.sampleID ||\n        (this.msg && this.msg.sample_id) ||\n        null\n      );\n    },\n    headerLocalDateTime: function () {\n      if (!this.headerObject) return null;\n      return this.headerObject.acq_local_datetime || this.headerObject.local_datetime || null;\n    },\n    headerAcqId: function () {\n      if (!this.headerObject) return null;\n      return this.headerObject.acq_id || this.headerObject.acqID || null;\n    },\n    pixelSizeValue: function () {\n      if (!this.headerObject) return null;\n      return (\n        this.headerObject._pixelSize ||\n        this.toNumber(this.headerObject.process_pixel) ||\n        this.toNumber(this.headerObject.calibration_pixel_size) ||\n        null\n      );\n    },\n    pixelSizeDisplay: function () {\n      return this.pixelSizeValue ? this.formatNumber(this.pixelSizeValue) + ' m/px' : 'Pixel size: N/A';\n    },\n    volumeInfo: function () {\n      var h = this.headerObject;\n      if (!h) return { label: null, value: null };\n      var vol = this.toNumber(h.sample_filtered_volume);\n      if (vol !== null) return { label: 'Filtered volume', value: vol };\n      vol = this.toNumber(h.acq_pumped_volume);\n      if (vol !== null) return { label: 'Pumped volume', value: vol };\n      vol = this.toNumber(h.acq_imaged_volume);\n      if (vol !== null) return { label: 'Imaged volume', value: vol };\n      return { label: null, value: null };\n    },\n    volumeDisplay: function () {\n      var info = this.volumeInfo;\n      if (!info.value) return 'Volume: N/A';\n      return info.label + ': ' + this.formatNumber(info.value) + ' mL';\n    },\n    cameraDisplay: function () {\n      var h = this.headerObject;\n      if (!h) return null;\n      var res = h.acq_camera_resolution || h.camera_resolution;\n      var iso = h.acq_camera_iso || h.camera_iso;\n      var shutter = h.acq_camera_shutter_speed || h.camera_shutter;\n      var bits = [];\n      if (res) bits.push(res);\n      if (iso) bits.push('ISO ' + iso);\n      if (shutter) bits.push('1/' + shutter);\n      return bits.join('  ');\n    },\n    ecoTaxaUrl: function () {\n      if (this.msg && this.msg.ecotaxa_zip_url) return this.msg.ecotaxa_zip_url;\n      if (this.headerObject && this.headerObject.ecotaxa_zip_url) return this.headerObject.ecotaxa_zip_url;\n      if (this.headerSampleId) {\n        return '/ps/data/browse/api/raw/export/ecotaxa/ecotaxa_' + this.headerSampleId + '.zip';\n      }\n      return null;\n    },\n    minEsd: function () {\n      if (!this.cleanObjects.length) return 0;\n      var values = [];\n      for (var i = 0; i < this.cleanObjects.length; i++) {\n        var v = this.cleanObjects[i].esd_um;\n        if (v !== null && !isNaN(v)) values.push(v);\n      }\n      if (!values.length) return 0;\n      return Math.min.apply(null, values);\n    },\n    maxEsd: function () {\n      if (!this.cleanObjects.length) return 0;\n      var values = [];\n      for (var i = 0; i < this.cleanObjects.length; i++) {\n        var v = this.cleanObjects[i].esd_um;\n        if (v !== null && !isNaN(v)) values.push(v);\n      }\n      if (!values.length) return 0;\n      return Math.max.apply(null, values);\n    },\n    minCircularity: function () {\n      var values = [];\n      for (var i = 0; i < this.cleanObjects.length; i++) {\n        var v = this.cleanObjects[i].circularity;\n        if (v !== null && !isNaN(v)) values.push(v);\n      }\n      return values.length ? Math.min.apply(null, values) : 0;\n    },\n    maxCircularity: function () {\n      var values = [];\n      for (var i = 0; i < this.cleanObjects.length; i++) {\n        var v = this.cleanObjects[i].circularity;\n        if (v !== null && !isNaN(v)) values.push(v);\n      }\n      return values.length ? Math.max.apply(null, values) : 1;\n    },\n    filteredObjects: function () {\n      var esdMin = this.esdRange[0];\n      var esdMax = this.esdRange[1];\n      var circMin = this.circularityRange[0];\n      var circMax = this.circularityRange[1];\n      var cluster = this.selectedCluster;\n\n      var out = [];\n      for (var i = 0; i < this.cleanObjects.length; i++) {\n        var o = this.cleanObjects[i];\n\n        var esd = o.esd_um;\n        if (esd === null || isNaN(esd) || esd < esdMin || esd > esdMax) continue;\n\n        var circ = o.circularity;\n        if (circ !== null && !isNaN(circ)) {\n          if (circ < circMin || circ > circMax) continue;\n        }\n\n        if (cluster && cluster !== 'All') {\n          if (o.clusterCanonical !== cluster) continue;\n        }\n        out.push(o);\n      }\n      return out;\n    },\n    sortedObjects: function () {\n      var arr = this.filteredObjects.slice();\n      var key = this.gallerySortKey || '';\n      var lower = key.toLowerCase();\n      if (lower.indexOf('solidity') !== -1) {\n        arr.sort(function (a, b) {\n          return (a.solidity || 0) - (b.solidity || 0);\n        });\n      } else {\n        arr.sort(function (a, b) {\n          return (b.esd_um || 0) - (a.esd_um || 0);\n        });\n      }\n      return arr;\n    },\n    visibleObjects: function () {\n      return this.sortedObjects.slice(0, this.maxGalleryItems);\n    },\n    selectedObject: function () {\n      if (!this.selectedUid || !this.filteredObjects.length) return null;\n      for (var i = 0; i < this.filteredObjects.length; i++) {\n        if (this.filteredObjects[i]._uid === this.selectedUid) return this.filteredObjects[i];\n      }\n      return null;\n    },\n    clusterCounts: function () {\n      var counts = {\n        Filament: 0,\n        Dense: 0,\n        Detritus: 0,\n        Bubble: 0,\n        Other: 0\n      };\n      for (var i = 0; i < this.cleanObjects.length; i++) {\n        var o = this.cleanObjects[i];\n        var c = o.clusterCanonical || 'Other';\n        if (counts[c] === undefined) counts[c] = 0;\n        counts[c]++;\n      }\n      return counts;\n    },\n    filteredClusterCounts: function () {\n      var counts = {\n        Filament: 0,\n        Dense: 0,\n        Detritus: 0,\n        Bubble: 0,\n        Other: 0\n      };\n      for (var i = 0; i < this.filteredObjects.length; i++) {\n        var o = this.filteredObjects[i];\n        var c = o.clusterCanonical || 'Other';\n        if (counts[c] === undefined) counts[c] = 0;\n        counts[c]++;\n      }\n      return counts;\n    },\n    kpiCards: function () {\n      var totalRaw = this.cleanObjects.length;\n      var totalFiltered = this.filteredObjects.length;\n      var volume = this.volumeInfo.value;\n      var abundance = volume ? totalFiltered / volume : null;\n\n      return [\n        {\n          key: 'objects',\n          label: 'Total objects',\n          value: this.formatNumber(totalFiltered, 0),\n          sub: totalRaw ? this.formatNumber(totalRaw, 0) + ' raw' : ''\n        },\n        {\n          key: 'abundance',\n          label: 'Abundance',\n          value: abundance !== null ? this.formatNumber(abundance, 1) : 'N/A',\n          sub: 'ind./mL'\n        },\n        {\n          key: 'filament',\n          label: 'Filament',\n          value: this.formatNumber(this.filteredClusterCounts.Filament || 0, 0),\n          sub: this.formatNumber(this.clusterCounts.Filament || 0, 0) + ' raw'\n        },\n        {\n          key: 'dense',\n          label: 'Dense',\n          value: this.formatNumber(this.filteredClusterCounts.Dense || 0, 0),\n          sub: this.formatNumber(this.clusterCounts.Dense || 0, 0) + ' raw'\n        },\n        {\n          key: 'detritus',\n          label: 'Detritus',\n          value: this.formatNumber(this.filteredClusterCounts.Detritus || 0, 0),\n          sub: this.formatNumber(this.clusterCounts.Detritus || 0, 0) + ' raw'\n        },\n        {\n          key: 'bubble',\n          label: 'Bubble',\n          value: this.formatNumber(this.filteredClusterCounts.Bubble || 0, 0),\n          sub: this.formatNumber(this.clusterCounts.Bubble || 0, 0) + ' raw'\n        }\n      ];\n    },\n    gallerySortOptions: function () {\n      return ['ESD  (largest first)', 'Solidity '];\n    },\n    clusterOptions: function () {\n      return ['All', 'Filament', 'Dense', 'Detritus', 'Bubble', 'Other'];\n    },\n    scaleBarMicronsValue: function () {\n      var obj = this.selectedObject;\n      if (!obj || !this.pixelSizeValue) return null;\n      var esd = obj.esd_um || 0;\n      if (esd <= 20) return 5;\n      if (esd <= 50) return 10;\n      if (esd <= 200) return 50;\n      if (esd <= 500) return 100;\n      return 200;\n    },\n    scaleBarCssWidth: function () {\n      var microns = this.scaleBarMicronsValue;\n      if (!microns || !this.pixelSizeValue || !this.inspectorImageWidth || !this.inspectorImageNaturalWidth) {\n        return 40;\n      }\n      var micronsPerPixel = this.pixelSizeValue;\n      var imagePixelsForScale = microns / micronsPerPixel;\n      var scale = this.inspectorImageWidth / this.inspectorImageNaturalWidth;\n      var widthPx = imagePixelsForScale * scale;\n      var maxWidth = this.inspectorImageWidth * 0.8;\n      if (widthPx > maxWidth) widthPx = maxWidth;\n      if (widthPx < 20) widthPx = 20;\n      return widthPx;\n    },\n    scaleBarVisible: function () {\n      return !!(this.scaleBarMicronsValue && this.pixelSizeValue && this.selectedObject);\n    },\n    scaleBarMicronsLabel: function () {\n      return this.scaleBarMicronsValue ? this.scaleBarMicronsValue + ' m' : '';\n    }\n  },\n  watch: {\n    payload: {\n      handler: function () {\n        this.onPayloadChanged();\n      },\n      deep: false,\n      immediate: true\n    },\n    esdRange: function () {\n      this.scheduleChartUpdate();\n    },\n    circularityRange: function () {\n      this.scheduleChartUpdate();\n    },\n    selectedCluster: function () {\n      this.scheduleChartUpdate();\n    },\n    filteredObjects: {\n      handler: function (newList) {\n        if (!newList || !newList.length) return;\n        var found = false;\n        for (var i = 0; i < newList.length; i++) {\n          if (newList[i]._uid === this.selectedUid) {\n            found = true;\n            break;\n          }\n        }\n        if (!found) {\n          this.selectedUid = newList[0]._uid;\n        }\n      },\n      deep: false\n    }\n  },\n  mounted: function () {\n    this.ensureChartJsReady();\n  },\n  beforeDestroy: function () {\n    this.destroyCharts();\n    if (this.chartInitInterval) {\n      clearInterval(this.chartInitInterval);\n      this.chartInitInterval = null;\n    }\n    if (this.chartUpdateTimeout) {\n      clearTimeout(this.chartUpdateTimeout);\n      this.chartUpdateTimeout = null;\n    }\n  },\n  methods: {\n    onPayloadChanged: function () {\n      this.resetRangesFromData();\n      if (this.cleanObjects.length) {\n        var keep = false;\n        if (this.selectedUid) {\n          for (var i = 0; i < this.cleanObjects.length; i++) {\n            if (this.cleanObjects[i]._uid === this.selectedUid) {\n              keep = true;\n              break;\n            }\n          }\n        }\n        if (!keep) {\n          this.selectedUid = this.cleanObjects[0]._uid;\n        }\n      } else {\n        this.selectedUid = null;\n      }\n      this.scheduleChartUpdate();\n    },\n    toNumber: function (value) {\n      if (value === null || value === undefined) return null;\n      if (typeof value === 'number') {\n        if (isNaN(value)) return null;\n        return value;\n      }\n      if (typeof value === 'string') {\n        var trimmed = value.trim();\n        if (!trimmed) return null;\n        var normalized = trimmed.replace(',', '.');\n        var num = parseFloat(normalized);\n        return isNaN(num) ? null : num;\n      }\n      return null;\n    },\n    isTemplateRow: function (row) {\n      if (!row || typeof row !== 'object') return false;\n      if (row.templateRow) return true;\n      var values = Object.values(row);\n      var templateMarkers = 0;\n      for (var i = 0; i < values.length; i++) {\n        var v = values[i];\n        if (typeof v === 'string' && /^\\[[fti]\\]$/i.test(v.trim())) {\n          templateMarkers++;\n        }\n      }\n      return templateMarkers >= 3;\n    },\n    resetRangesFromData: function () {\n      var esdMin = this.minEsd;\n      var esdMax = this.maxEsd;\n      if (esdMax >= esdMin) {\n        this.esdRange = [esdMin, esdMax];\n      } else {\n        this.esdRange = [0, 0];\n      }\n\n      var circMin = this.minCircularity;\n      var circMax = this.maxCircularity;\n      if (circMax >= circMin) {\n        this.circularityRange = [circMin, circMax];\n      } else {\n        this.circularityRange = [0, 1];\n      }\n    },\n    resetFilters: function () {\n      this.resetRangesFromData();\n      this.selectedCluster = 'All';\n      this.gallerySortKey = 'ESD  (largest first)';\n      this.scheduleChartUpdate();\n    },\n    formatNumber: function (value, decimals) {\n      if (value === null || value === undefined || isNaN(value)) return 'N/A';\n      var d = typeof decimals === 'number' ? decimals : 2;\n      return Number(value).toLocaleString(undefined, {\n        maximumFractionDigits: d,\n        minimumFractionDigits: 0\n      });\n    },\n    metricToPercent: function (value) {\n      var num = this.toNumber(value);\n      if (num === null) return 0;\n      var v = num;\n      if (v > 1) v = 1;\n      if (v < 0) v = 0;\n      return v * 100;\n    },\n    getClusterLabel: function (obj) {\n      var cand = (\n        obj.cluster ||\n        obj.object_cluster ||\n        obj.group ||\n        obj.object_group ||\n        obj.final_cluster ||\n        ''\n      ).toString();\n      var lower = cand.toLowerCase();\n      if (lower.indexOf('filament') !== -1) return 'Filament';\n      if (lower.indexOf('bubble') !== -1) return 'Bubble';\n      if (lower.indexOf('detrit') !== -1) return 'Detritus';\n      if (lower.indexOf('dense') !== -1 || lower.indexOf('cluster') !== -1) return 'Dense';\n      return 'Other';\n    },\n    clusterColor: function (cluster) {\n      var name = (cluster || '').toString();\n      if (name === 'Filament') return 'deep-orange darken-2';\n      if (name === 'Dense') return 'purple darken-2';\n      if (name === 'Detritus') return 'brown darken-2';\n      if (name === 'Bubble') return 'cyan darken-2';\n      return 'grey darken-1';\n    },\n    getObjectImageUrl: function (obj) {\n      if (!obj) return null;\n      var date = obj.object_date || obj.date || (this.headerObject && this.headerObject.object_date);\n      var sampleId = obj.sample_id || this.headerSampleId;\n      var acqId = obj.acq_id || this.headerAcqId;\n      var file = obj.img_file_name || obj.image_name || obj.filename;\n      if (!date || !sampleId || !acqId || !file) return null;\n      return '/ps/data/browse/api/preview/big/objects/' + date + '/' + sampleId + '/' + acqId + '/' + file;\n    },\n    selectObject: function (obj) {\n      this.selectedUid = obj && obj._uid;\n    },\n    buildHistogram: function (objects, field, binCount) {\n      var values = [];\n      for (var i = 0; i < objects.length; i++) {\n        var v = this.toNumber(objects[i][field]);\n        if (v !== null && !isNaN(v)) values.push(v);\n      }\n      if (!values.length) {\n        return { labels: [], counts: [] };\n      }\n      var min = Math.min.apply(null, values);\n      var max = Math.max.apply(null, values);\n      if (min === max) {\n        return { labels: [this.formatNumber(min)], counts: [values.length] };\n      }\n      var count = binCount || 15;\n      var step = (max - min) / count;\n      var bins = new Array(count);\n      for (var i2 = 0; i2 < count; i2++) bins[i2] = 0;\n\n      for (var j = 0; j < values.length; j++) {\n        var v2 = values[j];\n        var idx = Math.floor((v2 - min) / step);\n        if (idx < 0) idx = 0;\n        if (idx >= count) idx = count - 1;\n        bins[idx]++;\n      }\n\n      var labels = [];\n      for (var k = 0; k < count; k++) {\n        var start = min + step * k;\n        var end = start + step;\n        labels.push(this.formatNumber(start) + '' + this.formatNumber(end));\n      }\n      return { labels: labels, counts: bins };\n    },\n    destroyCharts: function () {\n      if (this.charts.clusterPie) {\n        this.charts.clusterPie.destroy();\n        this.charts.clusterPie = null;\n      }\n      if (this.charts.scatter) {\n        this.charts.scatter.destroy();\n        this.charts.scatter = null;\n      }\n      if (this.charts.esdHist) {\n        this.charts.esdHist.destroy();\n        this.charts.esdHist = null;\n      }\n    },\n    ensureChartJsReady: function () {\n      if (typeof Chart !== 'undefined') {\n        this.chartReady = true;\n        this.scheduleChartUpdate(true);\n        return;\n      }\n      var self = this;\n      var attempts = 0;\n      var maxAttempts = 40;\n      this.chartInitInterval = setInterval(function () {\n        attempts++;\n        if (typeof Chart !== 'undefined') {\n          clearInterval(self.chartInitInterval);\n          self.chartInitInterval = null;\n          self.chartReady = true;\n          self.scheduleChartUpdate(true);\n        } else if (attempts >= maxAttempts) {\n          clearInterval(self.chartInitInterval);\n          self.chartInitInterval = null;\n        }\n      }, 200);\n    },\n    scheduleChartUpdate: function (force) {\n      if (!force && !this.chartReady) return;\n      var self = this;\n      if (this.chartUpdateTimeout) {\n        clearTimeout(this.chartUpdateTimeout);\n      }\n      this.chartUpdateTimeout = setTimeout(function () {\n        self.updateCharts();\n        self.chartUpdateTimeout = null;\n      }, 120);\n    },\n    updateCharts: function () {\n      if (!this.chartReady || typeof Chart === 'undefined') return;\n\n      var pieCanvas = this.$refs.clusterPieCanvas;\n      var scatterCanvas = this.$refs.scatterCanvas;\n      var esdCanvas = this.$refs.esdHistCanvas;\n\n      if (!pieCanvas || !scatterCanvas || !esdCanvas) return;\n\n      this.destroyCharts();\n\n      var clusters = ['Filament', 'Dense', 'Detritus', 'Bubble', 'Other'];\n      var colors = ['#fb8c00', '#8e24aa', '#6d4c41', '#00acc1', '#9e9e9e'];\n\n      var counts = [];\n      for (var i = 0; i < clusters.length; i++) {\n        var c = clusters[i];\n        counts.push(this.filteredClusterCounts[c] || 0);\n      }\n\n      this.charts.clusterPie = new Chart(pieCanvas.getContext('2d'), {\n        type: 'pie',\n        data: {\n          labels: clusters,\n          datasets: [\n            {\n              data: counts,\n              backgroundColor: colors\n            }\n          ]\n        },\n        options: {\n          responsive: true,\n          maintainAspectRatio: false,\n          plugins: {\n            legend: {\n              display: true,\n              position: 'bottom'\n            }\n          }\n        }\n      });\n\n      var allFiltered = this.filteredObjects || [];\n      var sample = [];\n      if (allFiltered.length <= this.maxScatterPoints) {\n        sample = allFiltered;\n      } else {\n        var step = Math.ceil(allFiltered.length / this.maxScatterPoints);\n        for (var j = 0; j < allFiltered.length; j += step) {\n          sample.push(allFiltered[j]);\n        }\n      }\n\n      var pointsByCluster = {\n        Filament: [],\n        Dense: [],\n        Detritus: [],\n        Bubble: [],\n        Other: []\n      };\n      var yValues = [];\n\n      for (var s = 0; s < sample.length; s++) {\n        var o = sample[s];\n        var cl = o.clusterCanonical || 'Other';\n        if (!pointsByCluster[cl]) pointsByCluster[cl] = [];\n        var x = o.circularity !== null && !isNaN(o.circularity) ? o.circularity : 0;\n        var y = o.elongation !== null && !isNaN(o.elongation) && o.elongation > 0 ? o.elongation : 1;\n        pointsByCluster[cl].push({ x: x, y: y });\n        yValues.push(y);\n      }\n\n      var datasets = [];\n      for (var idx = 0; idx < clusters.length; idx++) {\n        var clName = clusters[idx];\n        datasets.push({\n          label: clName,\n          data: pointsByCluster[clName],\n          backgroundColor: colors[idx],\n          pointRadius: 2,\n          pointHoverRadius: 3\n        });\n      }\n\n      var yMin = yValues.length ? Math.min.apply(null, yValues) : 1;\n      var yMax = yValues.length ? Math.max.apply(null, yValues) : 10;\n\n      this.charts.scatter = new Chart(scatterCanvas.getContext('2d'), {\n        type: 'scatter',\n        data: { datasets: datasets },\n        options: {\n          responsive: true,\n          maintainAspectRatio: false,\n          scales: {\n            x: {\n              title: { display: true, text: 'Circularity' },\n              min: 0,\n              max: 1\n            },\n            y: {\n              type: 'logarithmic',\n              title: { display: true, text: 'Elongation' },\n              min: Math.max(0.1, yMin * 0.9),\n              max: yMax * 1.1,\n              ticks: {\n                callback: function (value) {\n                  return Number(value).toString();\n                }\n              }\n            }\n          },\n          plugins: {\n            legend: {\n              display: true,\n              position: 'bottom'\n            }\n          }\n        }\n      });\n\n      var esdHist = this.buildHistogram(this.filteredObjects, 'esd_um', 18);\n      this.charts.esdHist = new Chart(esdCanvas.getContext('2d'), {\n        type: 'bar',\n        data: {\n          labels: esdHist.labels,\n          datasets: [\n            {\n              label: 'Count',\n              data: esdHist.counts,\n              backgroundColor: '#42a5f5'\n            }\n          ]\n        },\n        options: {\n          responsive: true,\n          maintainAspectRatio: false,\n          scales: {\n            x: {\n              display: false\n            },\n            y: {\n              beginAtZero: true\n            }\n          },\n          plugins: {\n            legend: { display: false }\n          }\n        }\n      });\n    },\n    exportCsv: function () {\n      var rows = this.filteredObjects;\n      if (!rows.length) return;\n\n      var headers = [\n        'object_id',\n        'cluster',\n        'esd_um',\n        'circularity',\n        'elongation',\n        'solidity',\n        'width_um',\n        'height_um',\n        'area_um2',\n        'object_MeanValue',\n        'object_date',\n        'sample_id',\n        'acq_id',\n        'img_file_name'\n      ];\n\n      var lines = [];\n      lines.push(headers.join(','));\n\n      for (var i = 0; i < rows.length; i++) {\n        var o = rows[i];\n        var rowValues = headers.map(function (h) {\n          var v;\n          if (h === 'cluster') {\n            v = o.clusterCanonical;\n          } else {\n            v = o[h];\n          }\n          if (v === null || v === undefined) return '';\n          var str = String(v).replace(/\"/g, '\"\"');\n          if (str.indexOf(',') !== -1 || str.indexOf('\"') !== -1) {\n            return '\"' + str + '\"';\n          }\n          return str;\n        });\n        lines.push(rowValues.join(','));\n      }\n\n      var csv = lines.join('\\n');\n      var blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });\n      var url = URL.createObjectURL(blob);\n      var a = document.createElement('a');\n      var sampleId = this.headerSampleId || 'export';\n      a.href = url;\n      a.download = sampleId + '_objects.csv';\n      document.body.appendChild(a);\n      a.click();\n      document.body.removeChild(a);\n      URL.revokeObjectURL(url);\n    },\n    downloadFileName: function (obj) {\n      if (!obj) return 'object_image.jpg';\n      var sample = obj.sample_id || this.headerSampleId || 'sample';\n      var id = obj.object_id || obj._uid || 'object';\n      var name = obj.img_file_name || obj.image_name || 'image';\n      return sample + '_' + id + '_' + name;\n    },\n    onInspectorImageLoad: function (e) {\n      if (e && e.target) {\n        this.inspectorImageNaturalWidth = e.target.naturalWidth || null;\n      }\n      var self = this;\n      this.$nextTick(function () {\n        var ref = self.$refs.inspectorImage;\n        var imgEl = ref && ref.$el ? ref.$el.querySelector('img') : null;\n        self.inspectorImageWidth = imgEl ? imgEl.clientWidth : null;\n      });\n    }\n  }\n};\n</script>\n\n<style scoped>\n.dashboard-root {\n  font-size: 13px;\n}\n\n.kpi-card {\n  position: relative;\n  overflow: hidden;\n}\n\n.kpi-border {\n  position: absolute;\n  left: 0;\n  top: 0;\n  bottom: 0;\n  width: 4px;\n}\n\n.kpi-border--objects {\n  background-color: #1976d2;\n}\n\n.kpi-border--abundance {\n  background-color: #00897b;\n}\n\n.kpi-border--filament {\n  background-color: #fb8c00;\n}\n\n.kpi-border--dense {\n  background-color: #8e24aa;\n}\n\n.kpi-border--detritus {\n  background-color: #6d4c41;\n}\n\n.kpi-border--bubble {\n  background-color: #00acc1;\n}\n\n.sticky-card {\n  position: sticky;\n  top: 12px;\n  z-index: 1;\n}\n\n.gallery-grid {\n  display: grid;\n  grid-template-columns: repeat(auto-fill, minmax(70px, 1fr));\n  grid-gap: 6px;\n}\n\n.gallery-item {\n  border-radius: 4px;\n  overflow: hidden;\n  border: 1px solid rgba(0, 0, 0, 0.12);\n  cursor: pointer;\n  transition: transform 0.12s ease, box-shadow 0.12s ease, border-color 0.12s ease;\n  display: flex;\n  flex-direction: column;\n}\n\n.gallery-img {\n  flex: 1;\n}\n\n.gallery-meta {\n  padding: 2px 4px 4px 4px;\n}\n\n.gallery-item:hover {\n  transform: scale(1.03);\n  box-shadow: 0 2px 6px rgba(0, 0, 0, 0.25);\n}\n\n.gallery-item--selected {\n  transform: scale(1.05);\n  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.4);\n  border-color: #1976d2;\n}\n\n.gallery-placeholder {\n  height: 100%;\n  min-height: 60px;\n  background: rgba(0, 0, 0, 0.02);\n}\n\n.gallery-sort-select {\n  min-width: 160px;\n}\n\n.cluster-Filament {\n  border-bottom: 3px solid #fb8c00;\n}\n\n.cluster-Dense {\n  border-bottom: 3px solid #8e24aa;\n}\n\n.cluster-Detritus {\n  border-bottom: 3px solid #6d4c41;\n}\n\n.cluster-Bubble {\n  border-bottom: 3px solid #00acc1;\n}\n\n.cluster-Other {\n  border-bottom: 3px solid #9e9e9e;\n}\n\n.inspector-img {\n  border-radius: 4px;\n  border: 1px solid rgba(0, 0, 0, 0.12);\n}\n\n.inspector-placeholder {\n  border-radius: 4px;\n  border: 1px dashed rgba(0, 0, 0, 0.2);\n  min-height: 120px;\n}\n\n.cluster-pie-wrapper {\n  width: 100%;\n  height: 170px;\n}\n\n.cluster-pie-wrapper canvas {\n  width: 100% !important;\n  height: 100% !important;\n}\n\n.chart-container {\n  width: 100%;\n  height: 190px;\n}\n\n.scatter-container {\n  height: 230px;\n}\n\n.chart-container canvas {\n  width: 100% !important;\n  height: 100% !important;\n}\n\n.inspector-image-wrapper {\n  position: relative;\n}\n\n.scale-bar {\n  position: absolute;\n  left: 8px;\n  bottom: 8px;\n  padding: 2px 4px;\n  background: rgba(0, 0, 0, 0.55);\n  border-radius: 2px;\n  display: inline-flex;\n  flex-direction: column;\n  align-items: flex-start;\n}\n\n.scale-bar-line {\n  height: 2px;\n  background: #ffffff;\n  margin-bottom: 2px;\n}\n\n.scale-bar-label {\n  font-size: 10px;\n  color: #ffffff;\n  line-height: 1;\n}\n\n@media (max-width: 959px) {\n  .sticky-card {\n    position: static;\n  }\n}\n</style>\n",
        "storeOutMessages": true,
        "passthru": true,
        "resendOnRefresh": true,
        "templateScope": "local",
        "className": "",
        "x": 1300,
        "y": 380,
        "wires": [
            []
        ]
    },
    {
        "id": "687050b30c8d78f3",
        "type": "debug",
        "z": "14f8c9b5ce1235cc",
        "name": "debug 6",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "targetType": "full",
        "statusVal": "",
        "statusType": "auto",
        "x": 1260,
        "y": 580,
        "wires": []
    },
    {
        "id": "8dc194f764cd61ef",
        "type": "function",
        "z": "14f8c9b5ce1235cc",
        "name": "function 1",
        "func": "// Vrifie que payload est un tableau\nif (Array.isArray(msg.payload)) {\n    // Supprime la premire entre du tableau\n    msg.payload = msg.payload.slice(1);\n}\n\nreturn msg;\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1000,
        "y": 400,
        "wires": [
            [
                "687050b30c8d78f3",
                "c42d0eb4a7bc6eb4",
                "86bff301d6790945",
                "ddac1dedf1ed0bb3",
                "39ab3eeb12643cc6",
                "e8fbb01b7a38c29a"
            ]
        ]
    },
    {
        "id": "ddac1dedf1ed0bb3",
        "type": "ui-template",
        "z": "14f8c9b5ce1235cc",
        "group": "0cb96323818204ca",
        "page": "",
        "ui": "",
        "name": "Gemini 3 Pro v2",
        "order": 1,
        "width": 0,
        "height": 0,
        "head": "",
        "format": "<script src=\"https://cdn.jsdelivr.net/npm/chart.js\"></script>\n\n<template>\n  <v-container fluid class=\"pa-4 grey lighten-5\" style=\"min-height: 100vh; color:#333;\">\n\n    <v-row v-if=\"!hasData\" align=\"center\" justify=\"center\" style=\"height:80vh;\">\n      <div class=\"text-center\">\n        <v-progress-circular indeterminate color=\"primary\" size=\"64\"></v-progress-circular>\n        <div class=\"mt-4 text-h6 grey--text text--darken-2\">Analyse en cours...</div>\n      </div>\n    </v-row>\n\n    <div v-else>\n      \n      <div class=\"mb-4\">\n        <div class=\"text-overline grey--text ml-1\">1. SUMMARY METRICS</div>\n        <v-card outlined>\n          <v-row no-gutters>\n            <v-col cols=\"12\" md=\"3\" class=\"pa-4 border-right\">\n              <div class=\"caption grey--text text-uppercase\">Sample Identity</div>\n              <div class=\"font-weight-bold text-h6 primary--text\">{{ safeHeader.sample_id }}</div>\n              <div class=\"caption grey--text mt-1\">Project: {{ safeHeader.sample_project }}</div>\n              <div class=\"caption grey--text\">Acq ID: {{ safeHeader.acq_id }}</div>\n            </v-col>\n\n            <v-col cols=\"12\" md=\"3\" class=\"pa-4 border-right grey lighten-5\">\n              <div class=\"caption grey--text text-uppercase\">Abundance</div>\n              <div class=\"d-flex align-baseline\">\n                <span class=\"text-h4 font-weight-black deep-purple--text mr-1\">{{ formatNum(abundance, 0) }}</span>\n                <span class=\"caption font-weight-bold deep-purple--text text--lighten-2\">ind./mL</span>\n              </div>\n              <div class=\"caption grey--text mt-2\">\n                Total Objects: {{ filteredObjects.length }} / {{ cleanObjects.length }}\n              </div>\n            </v-col>\n\n            <v-col cols=\"12\" md=\"3\" class=\"pa-4 border-right\">\n              <div class=\"caption grey--text text-uppercase\">Est. Biovolume</div>\n              <div class=\"d-flex align-baseline\">\n                <span class=\"text-h5 font-weight-bold blue-grey--text mr-1\">{{ formatBigNum(totalBiovolume) }}</span>\n                <span class=\"caption blue-grey--text\">m/mL</span>\n              </div>\n               <div class=\"caption grey--text mt-2\">\n                <v-icon x-small>mdi-water-percent</v-icon> Vol. Imaged: {{ formatNum(safeHeader.volume_used, 2) }} mL\n              </div>\n            </v-col>\n\n            <v-col cols=\"12\" md=\"3\" class=\"pa-4 d-flex flex-column justify-space-between\">\n              <div>\n                <div class=\"caption grey--text text-uppercase\">Resolution</div>\n                <div class=\"font-weight-medium\">{{ formatNum(safeHeader.process_pixel, 3) }} m/px</div>\n              </div>\n              <div class=\"d-flex mt-3\">\n                <v-btn x-small outlined color=\"primary\" class=\"mr-2\" @click=\"downloadCSV\">\n                  <v-icon left x-small>mdi-download</v-icon> CSV\n                </v-btn>\n                <v-btn x-small text color=\"grey\" :href=\"ecotaxaLink\" target=\"_blank\" v-if=\"safeHeader.acq_id !== 'N/A'\">\n                   EcoTaxa\n                </v-btn>\n              </div>\n            </v-col>\n          </v-row>\n        </v-card>\n      </div>\n\n      <div class=\"mb-4\">\n        <div class=\"text-overline grey--text ml-1\">2. QUALITY CONTROL (QC)</div>\n        <v-row dense>\n          <v-col cols=\"12\" md=\"4\">\n            <v-card outlined class=\"fill-height\">\n              <v-card-title class=\"caption font-weight-bold py-2 grey lighten-4 border-bottom\">\n                Flowcell Distribution\n                <v-spacer></v-spacer>\n                <v-chip x-small color=\"red lighten-4\" text-color=\"red darken-2\" v-if=\"stickyCount > 0\">\n                  {{ stickyCount }} Sticky Objs\n                </v-chip>\n              </v-card-title>\n              <v-card-text class=\"pa-2 relative\">\n                <div style=\"height: 200px; width: 100%;\">\n                   <canvas ref=\"chartFlowcell\"></canvas>\n                </div>\n                <div v-if=\"!hasCoords\" class=\"overlay-message caption\">\n                  No X/Y coordinates found.\n                </div>\n              </v-card-text>\n            </v-card>\n          </v-col>\n\n          <v-col cols=\"12\" md=\"4\">\n            <v-card outlined class=\"fill-height\">\n              <v-card-title class=\"caption font-weight-bold py-2 grey lighten-4 border-bottom\">\n                Segmentation Report\n              </v-card-title>\n              <v-card-text class=\"pa-4\">\n                 <div class=\"d-flex justify-space-between caption mb-1\">\n                   <span>Valid Objects</span>\n                   <span class=\"green--text font-weight-bold\">{{ counts.other + counts.dense }}</span>\n                 </div>\n                 <v-progress-linear :value=\"(counts.other + counts.dense)/cleanObjects.length*100\" color=\"green\" height=\"8\" rounded class=\"mb-3\"></v-progress-linear>\n\n                 <div class=\"d-flex justify-space-between caption mb-1\">\n                   <span>Multiple/Filaments</span>\n                   <span class=\"orange--text font-weight-bold\">{{ counts.filament }}</span>\n                 </div>\n                 <v-progress-linear :value=\"counts.filament/cleanObjects.length*100\" color=\"orange\" height=\"6\" rounded class=\"mb-3\"></v-progress-linear>\n                 \n                 <div class=\"d-flex justify-space-between caption mb-1\">\n                   <span>Detritus/Noise</span>\n                   <span class=\"brown--text font-weight-bold\">{{ counts.detritus }}</span>\n                 </div>\n                 <v-progress-linear :value=\"counts.detritus/cleanObjects.length*100\" color=\"brown\" height=\"6\" rounded></v-progress-linear>\n              </v-card-text>\n            </v-card>\n          </v-col>\n          \n           <v-col cols=\"12\" md=\"4\">\n            <v-card outlined class=\"fill-height\">\n              <v-card-title class=\"caption font-weight-bold py-2 grey lighten-4 border-bottom\">\n                Acquisition Stats\n              </v-card-title>\n              <div class=\"pa-4 d-flex align-center justify-center fill-height\">\n                 <div class=\"text-center\">\n                    <div class=\"text-h5 font-weight-light\">{{ Math.round(safeHeader.process_pixel * 2048) }} x {{ Math.round(safeHeader.process_pixel * 1536) }}</div>\n                    <div class=\"caption grey--text\">Field of View (m estimate)</div>\n                    <v-divider class=\"my-3\"></v-divider>\n                    <div class=\"caption\">\n                      Processing Date: <br>\n                      <b>{{ cleanObjects[0] ? cleanObjects[0].object_date : 'N/A' }}</b>\n                    </div>\n                 </div>\n              </div>\n            </v-card>\n          </v-col>\n        </v-row>\n      </div>\n\n\n      <div>\n        <div class=\"text-overline grey--text ml-1\">3. GALLERY & DETAILS</div>\n        <v-row>\n          <v-col cols=\"12\" md=\"8\" lg=\"9\">\n            <v-card outlined>\n              <v-toolbar flat dense color=\"grey lighten-4\">\n                <v-toolbar-title class=\"subtitle-2\">Object Gallery ({{ filteredObjects.length }})</v-toolbar-title>\n                <v-spacer></v-spacer>\n                <v-select\n                  v-model=\"gallerySort\" :items=\"sortOptions\" item-text=\"text\" item-value=\"value\"\n                  dense outlined hide-details style=\"max-width: 180px;\" class=\"caption bg-white\"\n                ></v-select>\n              </v-toolbar>\n              \n              <v-card-text class=\"pa-2\" style=\"min-height: 300px;\">\n                <div v-if=\"!filteredObjects.length\" class=\"text-center py-10 grey--text\">\n                  No objects found.\n                </div>\n                \n                <div class=\"gallery-grid\">\n                  <div v-for=\"obj in paginatedObjects\" :key=\"obj.object_id\" \n                       class=\"gallery-item rounded elevation-1\"\n                       :class=\"{'selected': selectedId === obj.object_id, 'g-filament': obj.group === 'Filament'}\" \n                       @click=\"selectObject(obj)\">\n                    <v-img :src=\"getImageUrl(obj)\" aspect-ratio=\"1\" contain class=\"white\">\n                       <template v-slot:placeholder><v-row class=\"fill-height ma-0\" align=\"center\" justify=\"center\"><v-progress-circular indeterminate size=\"20\" width=\"2\"></v-progress-circular></v-row></template>\n                    </v-img>\n                    <div class=\"gallery-label\">{{ Math.round(obj.esd_um) }}m</div>\n                  </div>\n                </div>\n                <div v-if=\"filteredObjects.length > 100\" class=\"text-center mt-2 caption grey--text\">Showing top 100 objects</div>\n              </v-card-text>\n            </v-card>\n          </v-col>\n\n          <v-col cols=\"12\" md=\"4\" lg=\"3\">\n             <v-card outlined class=\"sticky-top\">\n                <v-card-title class=\"subtitle-2 grey lighten-3 py-2\">Details</v-card-title>\n                <div v-if=\"selectedObject\">\n                   <div class=\"pa-3 text-center white border-bottom\">\n                      <div class=\"image-container d-inline-block relative elevation-2 rounded pa-1 mb-2\">\n                        <img :src=\"getImageUrl(selectedObject)\" style=\"max-width: 100%; max-height: 200px; display:block;\">\n                        <div class=\"scale-bar-container\">\n                           <div class=\"scale-line\" :style=\"{ width: scaleBarWidth + 'px' }\"></div>\n                           <div class=\"scale-text\">{{ scaleBarValue }} m</div>\n                        </div>\n                      </div>\n                      <div>\n                        <v-chip x-small color=\"primary\" dark>{{ selectedObject.group }}</v-chip>\n                        <div class=\"caption mt-1 text-truncate\">{{ selectedObject.object_id }}</div>\n                      </div>\n                   </div>\n                   <v-list dense class=\"pa-0\">\n                      <v-list-item>\n                        <v-list-item-content><v-list-item-title class=\"caption\">ESD</v-list-item-title></v-list-item-content>\n                        <v-list-item-action class=\"caption font-weight-bold\">{{ formatNum(selectedObject.esd_um, 1) }} m</v-list-item-action>\n                      </v-list-item>\n                      <v-divider></v-divider>\n                      <v-list-item>\n                        <v-list-item-content><v-list-item-title class=\"caption\">Circularity</v-list-item-title></v-list-item-content>\n                        <v-list-item-action class=\"caption font-weight-bold\">{{ formatNum(selectedObject.circ, 3) }}</v-list-item-action>\n                      </v-list-item>\n                      <v-divider></v-divider>\n                      <v-list-item>\n                         <v-list-item-content><v-list-item-title class=\"caption\">Biovolume</v-list-item-title></v-list-item-content>\n                         <v-list-item-action class=\"caption font-weight-bold\">{{ formatBigNum((Math.PI * Math.pow(selectedObject.esd_um,3))/6) }} m</v-list-item-action>\n                      </v-list-item>\n                   </v-list>\n                </div>\n                <div v-else class=\"pa-4 text-center caption grey--text\">Select an object.</div>\n             </v-card>\n          </v-col>\n        </v-row>\n      </div>\n\n    </div>\n  </v-container>\n</template>\n\n<script>\nexport default {\n  data() {\n    return {\n      filters: { esd: [0, 2000], circ: [0, 1], cluster: 'All' },\n      clusterOptions: ['All', 'Filament', 'Bubble', 'Detritus', 'Dense', 'Other'],\n      sortOptions: [{ text: 'Size (Desc)', value: 'esd_desc' }, { text: 'Size (Asc)', value: 'esd_asc' }],\n      gallerySort: 'esd_desc',\n      selectedId: null,\n      charts: { cluster: null, flow: null, hist: null },\n      scaleBarValue: 100,\n      stickyCount: 0\n    }\n  },\n\n  computed: {\n    hasData() { return this.msg && Array.isArray(this.msg.payload) && this.msg.payload.length > 1; },\n    \n    cleanObjects() {\n      if (!this.hasData) return [];\n      return this.msg.payload\n        .filter(o => o.object_id !== '[t]' && o.acq_id !== '[t]' && !String(o.object_equivalent_diameter).includes('[f]'))\n        .map(o => {\n          const px = Number(o.process_pixel || this.msg.process_pixel) || 1;\n          const esd = (Number(o.object_equivalent_diameter) || 0) * px;\n          \n          let grp = 'Other';\n          const el = Number(o.object_elongation) || 1;\n          const circ = Number(o['object_circ.']) || 0;\n          const sol = Number(o.object_solidity) || 0;\n          const val = Number(o.object_MeanValue) || 0;\n\n          if (el > 3.5) grp = 'Filament';\n          else if (circ > 0.85 && sol > 0.95) grp = 'Bubble';\n          else if (sol < 0.75) grp = 'Detritus';\n          else if (val < 100 && sol > 0.85) grp = 'Dense';\n\n          return {\n            ...o,\n            esd_um: esd,\n            major: (Number(o.object_major) || 0) * px,\n            minor: (Number(o.object_minor) || 0) * px,\n            x: Number(o.object_x) || 0,\n            y: Number(o.object_y) || 0,\n            circ, val, solidity: sol, elongation: el,\n            group: grp\n          };\n        })\n        .filter(o => o.esd_um > 0);\n    },\n\n    filteredObjects() {\n      const f = this.filters;\n      return this.cleanObjects.filter(o => {\n        return o.esd_um >= f.esd[0] && o.esd_um <= f.esd[1] &&\n               o.circ >= f.circ[0] && o.circ <= f.circ[1] &&\n               (f.cluster === 'All' || o.group === f.cluster);\n      });\n    },\n\n    hasCoords() {\n       return this.cleanObjects.some(o => o.x > 0 || o.y > 0);\n    },\n\n    paginatedObjects() {\n      let arr = [...this.filteredObjects];\n      arr.sort((a, b) => this.gallerySort === 'esd_desc' ? b.esd_um - a.esd_um : a.esd_um - b.esd_um);\n      return arr.slice(0, 100);\n    },\n\n    selectedObject() { return this.cleanObjects.find(o => o.object_id === this.selectedId) || null; },\n    \n    safeHeader() {\n      if (!this.cleanObjects.length) return { sample_id:'?', volume_used:1, process_pixel:1 };\n      const obj = this.cleanObjects[0];\n      return {\n        sample_project: obj.sample_project || 'Unknown',\n        sample_id: obj.sample_id || 'Unknown',\n        acq_id: obj.acq_id || 'N/A',\n        volume_used: Number(obj.acq_imaged_volume) || 1,\n        process_pixel: Number(obj.process_pixel || 1)\n      };\n    },\n\n    abundance() { return this.filteredObjects.length / this.safeHeader.volume_used; },\n    \n    totalBiovolume() {\n      const totalVolUm3 = this.filteredObjects.reduce((acc, o) => {\n        return acc + (Math.PI * Math.pow(o.esd_um, 3)) / 6;\n      }, 0);\n      return totalVolUm3 / this.safeHeader.volume_used;\n    },\n\n    counts() {\n      const c = { filament:0, bubble:0, detritus:0, dense:0, other:0 };\n      this.cleanObjects.forEach(o => {\n        const key = o.group.toLowerCase();\n        if(c[key]!==undefined) c[key]++; else c.other++;\n      });\n      return c;\n    },\n\n    sliderStats() {\n      if (!this.cleanObjects.length) return { min:0, max:100 };\n      const vals = this.cleanObjects.map(o => o.esd_um);\n      return { min: Math.floor(Math.min(...vals)), max: Math.ceil(Math.max(...vals)) };\n    },\n\n    scaleBarWidth() {\n      if(!this.safeHeader.process_pixel || !this.selectedObject) return 0;\n      if(this.selectedObject.esd_um < 50) this.scaleBarValue = 10;\n      else if(this.selectedObject.esd_um < 200) this.scaleBarValue = 50;\n      else this.scaleBarValue = 100;\n      return this.scaleBarValue / this.safeHeader.process_pixel;\n    },\n\n    ecotaxaLink() { return this.safeHeader.acq_id !== 'N/A' ? `/ps/data/browse/api/raw/export/ecotaxa/ecotaxa_${this.safeHeader.acq_id}.zip` : '#'; }\n  },\n\n  watch: {\n    filteredObjects() { this.updateCharts(); },\n    msg: { deep: true, handler() { this.init(); } }\n  },\n\n  mounted() { this.init(); },\n\n  methods: {\n    init() {\n      if(this.hasData) {\n        this.filters.esd = [this.sliderStats.min, this.sliderStats.max];\n        this.updateCharts();\n      }\n    },\n    \n    formatNum(v, d) { return (Number(v)||0).toFixed(d); },\n    formatBigNum(v) {\n       if(v > 1000000) return (v/1000000).toFixed(2) + 'M';\n       if(v > 1000) return (v/1000).toFixed(0) + 'k';\n       return Math.round(v);\n    },\n    \n    getImageUrl(o) { return o ? `/ps/data/browse/api/preview/big/objects/${o.object_date}/${o.sample_id}/${o.acq_id}/${o.img_file_name}` : ''; },\n    \n    selectObject(obj) { this.selectedId = obj.object_id; },\n    resetFilters() { this.filters.esd = [this.sliderStats.min, this.sliderStats.max]; this.filters.cluster = 'All'; },\n    \n    downloadCSV() {\n       if (!this.filteredObjects.length) return;\n       const headers = Object.keys(this.filteredObjects[0]);\n       const csv = [headers.join(','), ...this.filteredObjects.map(r => headers.map(c => JSON.stringify(r[c]||'')).join(','))].join('\\n');\n       const blob = new Blob([csv], { type: 'text/csv' });\n       const a = document.createElement('a');\n       a.href = URL.createObjectURL(blob); a.download = 'export.csv'; a.click();\n    },\n\n    updateCharts() { setTimeout(() => { this.$nextTick(this.renderCharts); }, 250); },\n\n    renderCharts() {\n      if(this.filteredObjects.length === 0) return;\n      this.renderFlowcellChart();\n      this.renderHistChart();\n      this.renderClusterChart();\n    },\n\n    // --- FIXED FLOWCELL CHART ---\n    renderFlowcellChart() {\n      const ctx = this.$refs.chartFlowcell;\n      if(!ctx) return;\n      if(this.charts.flow) this.charts.flow.destroy();\n      \n      // FIX: DEEP COPY to remove Vue Observers\n      const objects = JSON.parse(JSON.stringify(this.filteredObjects));\n\n      const xs = objects.map(o => o.x);\n      const ys = objects.map(o => o.y);\n      const maxX = Math.max(...xs, 100);\n      const maxY = Math.max(...ys, 100);\n      \n      const binStep = Math.max(maxX, maxY) / 20; \n      const bins = {};\n      \n      objects.forEach(o => {\n        const bx = Math.floor(o.x / binStep);\n        const by = Math.floor(o.y / binStep);\n        const k = `${bx}_${by}`;\n        bins[k] = (bins[k] || 0) + 1;\n      });\n\n      const normal = [];\n      const sticky = [];\n      this.stickyCount = 0;\n\n      objects.forEach(o => {\n        const bx = Math.floor(o.x / binStep);\n        const by = Math.floor(o.y / binStep);\n        if(bins[`${bx}_${by}`] > 5) {\n           sticky.push({x: o.x, y: o.y});\n           this.stickyCount++;\n        } else {\n           normal.push({x: o.x, y: o.y});\n        }\n      });\n\n      const finalNormal = sticky.length === 0 ? objects.map(o => ({x:o.x, y:o.y})) : normal;\n\n      this.charts.flow = new Chart(ctx, {\n        type: 'scatter',\n        data: {\n          datasets: [\n            { label: 'Objects', data: finalNormal, backgroundColor: '#90CAF9', pointRadius: 2 },\n            { label: 'Sticky/Clump', data: sticky, backgroundColor: '#E57373', pointRadius: 3 }\n          ]\n        },\n        options: {\n          responsive: true, maintainAspectRatio: false,\n          scales: { x: { display:false }, y: { display:false, reverse: true } },\n          plugins: { legend: { display: false } }\n        }\n      });\n    },\n\n    // --- FIXED HISTOGRAM ---\n    renderHistChart() {\n      const ctx = this.$refs.chartHist;\n      if(!ctx) return;\n      if(this.charts.hist) this.charts.hist.destroy();\n\n      // FIX: DEEP COPY\n      const objects = JSON.parse(JSON.stringify(this.filteredObjects));\n      const vals = objects.map(o => o.esd_um);\n      \n      if(vals.length === 0) return;\n\n      const maxVal = Math.max(...vals);\n      const binCount = 15;\n      const step = (maxVal / binCount) || 1; \n      \n      const bins = new Array(binCount).fill(0);\n      const labels = new Array(binCount).fill(0).map((_, i) => Math.round(i * step));\n\n      vals.forEach(v => {\n        const idx = Math.min(Math.floor(v / step), binCount - 1);\n        if(idx >= 0) bins[idx]++;\n      });\n\n      this.charts.hist = new Chart(ctx, {\n        type: 'bar',\n        data: {\n          labels: labels,\n          datasets: [{ label: 'Count', data: bins, backgroundColor: '#5C6BC0' }]\n        },\n        options: {\n          responsive: true, maintainAspectRatio: false,\n          plugins: { legend: { display: false } },\n          scales: { x: { title: { display: true, text: 'ESD (m)' } }, y: { display:false } }\n        }\n      });\n    },\n\n    // --- FIXED CLUSTER CHART ---\n    renderClusterChart() {\n      const ctx = this.$refs.chartCluster;\n      if(!ctx) return;\n      if(this.charts.cluster) this.charts.cluster.destroy();\n      \n      // FIX: DEEP COPY\n      const objects = JSON.parse(JSON.stringify(this.filteredObjects));\n      const data = objects.slice(0, 1000).map(o => ({ x: o.circ, y: o.elongation }));\n\n      this.charts.cluster = new Chart(ctx, {\n        type: 'scatter',\n        data: {\n          datasets: [{ label: 'Obj', data: data, backgroundColor: 'rgba(0, 150, 136, 0.6)', pointRadius: 2 }]\n        },\n        options: {\n          responsive: true, maintainAspectRatio: false,\n          scales: {\n            x: { title: {display: true, text:'Circular.'}, min: 0, max: 1.1 },\n            y: { title: {display: true, text:'Elong. (Log)'}, type: 'logarithmic', min:1 }\n          },\n          plugins: { legend: { display: false } }\n        }\n      });\n    }\n  }\n}\n</script>\n\n<style scoped>\n.border-right { border-right: 1px solid #e0e0e0; }\n.border-left { border-left: 1px solid #e0e0e0; }\n.border-bottom { border-bottom: 1px solid #e0e0e0; }\n.relative { position: relative; }\n\n.gallery-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(70px, 1fr)); gap: 6px; }\n.gallery-item { cursor: pointer; position: relative; overflow: hidden; border: 2px solid transparent; }\n.gallery-item:hover { transform: scale(1.1); z-index: 2; box-shadow: 0 4px 10px rgba(0,0,0,0.2); }\n.gallery-item.selected { border-color: #1976D2; }\n.g-filament { border-bottom: 3px solid #4CAF50; }\n\n.gallery-label { \n  position: absolute; bottom: 0; left: 0; right: 0; \n  background: rgba(255,255,255,0.7); font-size: 9px; text-align: center; \n}\n\n.sticky-top { position: sticky; top: 10px; z-index: 4; }\n\n.scale-bar-container {\n  position: absolute; bottom: 6px; right: 6px;\n  display: flex; flex-direction: column; align-items: flex-end;\n}\n.scale-line { height: 3px; background: white; border: 1px solid rgba(0,0,0,0.4); margin-bottom: 1px; }\n.scale-text { font-size: 9px; font-weight: bold; color: white; text-shadow: 0 1px 2px black; line-height: 1; }\n\n.overlay-message {\n  position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);\n  background: rgba(255,255,255,0.9); padding: 4px 8px; border-radius: 4px;\n}\n</style>",
        "storeOutMessages": true,
        "passthru": true,
        "resendOnRefresh": true,
        "templateScope": "local",
        "className": "",
        "x": 1280,
        "y": 460,
        "wires": [
            []
        ]
    },
    {
        "id": "39ab3eeb12643cc6",
        "type": "ui-template",
        "z": "14f8c9b5ce1235cc",
        "group": "fd07716b2cd88ccd",
        "page": "",
        "ui": "",
        "name": "ChatGPT 5.1 Pro v3",
        "order": 1,
        "width": 0,
        "height": 0,
        "head": "",
        "format": "<template>\n  <div class=\"plankto-dashboard\">\n    <div v-if=\"!objects.length\" class=\"no-data\">\n      Aucune donne reue (msg.payload ou msg.payload.payload doit tre un tableau d'objets).\n    </div>\n\n    <div v-else class=\"plankto-layout\">\n      <!-- COLONNE GAUCHE : stats + QC + charts -->\n      <div class=\"left-panel\">\n        <!-- Bandeau infos chantillon / acquisition -->\n        <div class=\"info-row\">\n          <div class=\"info-block\">\n            <div class=\"info-title\">chantillon</div>\n            <div class=\"info-body\">\n              <div><strong>Projet :</strong> {{ meta.sample_project }}</div>\n              <div><strong>Sample ID :</strong> {{ meta.sample_id }}</div>\n              <div><strong>Oprateur :</strong> {{ meta.sample_operator }}</div>\n              <div><strong>Gear :</strong> {{ meta.sample_gear }}</div>\n            </div>\n          </div>\n          <div class=\"info-block\">\n            <div class=\"info-title\">Acquisition</div>\n            <div class=\"info-body\">\n              <div><strong>Acq ID :</strong> {{ meta.acq_id }}</div>\n              <div><strong>Date :</strong> {{ meta.object_date }} {{ timeString }}</div>\n              <div><strong>Camra :</strong> {{ meta.acq_camera_resolution }}</div>\n              <div><strong>pixel :</strong> {{ pixelSizeUm.toFixed(3) }} m/px</div>\n            </div>\n          </div>\n        </div>\n\n        <!-- Statistiques principales -->\n        <div class=\"stat-row\">\n          <div class=\"stat-card\">\n            <div class=\"stat-label\">Total objets</div>\n            <div class=\"stat-value big\">{{ stats.totalObjects }}</div>\n          </div>\n          <div class=\"stat-card\">\n            <div class=\"stat-label\">ESD moyen</div>\n            <div class=\"stat-value\">{{ formatNumber(stats.meanEsdUm, 1) }} m</div>\n            <div class=\"stat-sub\">mdiane {{ formatNumber(stats.medianEsdUm, 1) }} m</div>\n          </div>\n          <div class=\"stat-card\">\n            <div class=\"stat-label\">Biovolume total</div>\n            <div class=\"stat-value\">{{ formatNumber(stats.totalBiovolumeMm3, 3) }} mm</div>\n            <div class=\"stat-sub\">(approx. sphrique)</div>\n          </div>\n          <div class=\"stat-card\">\n            <div class=\"stat-label\">Densit brute</div>\n            <div class=\"stat-value\">\n              <span v-if=\"stats.imagedVolume\">\n                {{ formatNumber(stats.objectsPerVolume, 1) }} obj / unit vol\n              </span>\n              <span v-else>n/a</span>\n            </div>\n            <div class=\"stat-sub\" v-if=\"stats.concentrationIndex\">\n              Indice conc. {{ formatNumber(stats.concentrationIndex, 1) }}\n            </div>\n          </div>\n        </div>\n\n        <!-- QC cards -->\n        <div class=\"qc-row\">\n          <div class=\"qc-card\">\n            <div class=\"qc-label\">Objets au bord</div>\n            <div :class=\"qcClass(qc.borderFraction)\">\n              {{ percent(qc.borderFraction) }}\n            </div>\n          </div>\n          <div class=\"qc-card\">\n            <div class=\"qc-label\">Positions doublons</div>\n            <div :class=\"qcClass(qc.duplicateFraction)\">\n              {{ percent(qc.duplicateFraction) }}\n            </div>\n          </div>\n          <div class=\"qc-card\">\n            <div class=\"qc-label\">Sous ESD min ({{ formatNumber(minEsdUm,0) }} m)</div>\n            <div :class=\"qcClass(qc.tinyFraction)\">\n              {{ percent(qc.tinyFraction) }}\n            </div>\n          </div>\n          <div class=\"qc-card\">\n            <div class=\"qc-label\">Artefacts morpho.</div>\n            <div :class=\"qcClass(qc.artifactFraction)\">\n              {{ percent(qc.artifactFraction) }}\n            </div>\n          </div>\n          <div class=\"qc-card\">\n            <div class=\"qc-label\">Saturs / trs sombres</div>\n            <div :class=\"qcClass(qc.saturatedFraction)\">\n              {{ percent(qc.saturatedFraction) }}\n            </div>\n          </div>\n        </div>\n\n        <!-- Graphiques -->\n        <div class=\"charts\">\n          <div class=\"chart-block\">\n            <div class=\"chart-title\">Distribution de taille (ESD, m)</div>\n            <canvas :id=\"id + '-esd-hist'\"></canvas>\n          </div>\n\n          <div class=\"chart-block\">\n            <div class=\"chart-title\">Positions dans la flowcell</div>\n            <canvas :id=\"id + '-xy-scatter'\"></canvas>\n          </div>\n\n          <div class=\"chart-block\">\n            <div class=\"chart-title\">Morphologie (solidity vs longation)</div>\n            <canvas :id=\"id + '-shape-qc'\"></canvas>\n          </div>\n\n          <div class=\"chart-block\">\n            <div class=\"chart-title\">\n              Clusters (UMAP / features)\n              <span class=\"chart-subtitle\">\n                (fallback vers 2 features si UMAP n'est pas charge)\n              </span>\n            </div>\n            <canvas :id=\"id + '-umap'\"></canvas>\n          </div>\n        </div>\n      </div>\n\n      <!-- COLONNE DROITE : galerie d'images + dtails -->\n      <div class=\"right-panel\">\n        <div class=\"gallery-title\">\n          Galerie d'objets ({{ galleryObjects.length }} / {{ stats.totalObjects }})\n        </div>\n\n        <div class=\"gallery\">\n          <div\n            v-for=\"obj in galleryObjects\"\n            :key=\"obj.object_id\"\n            class=\"thumb\"\n            :class=\"{ selected: selected && selected.object_id === obj.object_id }\"\n            @click=\"selectObject(obj)\"\n          >\n            <div class=\"thumb-image-wrapper\">\n              <img :src=\"imageUrl(obj)\" :alt=\"obj.object_id\" />\n              <div class=\"scale-bar-overlay\" v-if=\"scaleBarPx > 0\">\n                <div class=\"scale-bar\" :style=\"{ width: scaleBarPx + 'px' }\"></div>\n                <span>{{ scaleBarUm }} m</span>\n              </div>\n            </div>\n            <div class=\"thumb-caption\">\n              <div class=\"thumb-id\">{{ obj.object_id }}</div>\n              <div class=\"thumb-meta\">\n                ESD ~ {{ formatNumber(esdUm(obj), 0) }} m<br>\n                area {{ obj.object_area }} px\n              </div>\n            </div>\n          </div>\n        </div>\n\n        <div v-if=\"selected\" class=\"selected-details\">\n          <div class=\"details-title\">Dtails de l'objet slectionn</div>\n          <div class=\"details-body\">\n            <div class=\"details-image\">\n              <img :src=\"imageUrl(selected)\" :alt=\"selected.object_id\" />\n              <div class=\"scale-bar-overlay\" v-if=\"scaleBarPx > 0\">\n                <div class=\"scale-bar\" :style=\"{ width: scaleBarPx + 'px' }\"></div>\n                <span>{{ scaleBarUm }} m</span>\n              </div>\n            </div>\n            <div class=\"details-text\">\n              <p><strong>ID :</strong> {{ selected.object_id }}</p>\n              <p><strong>ESD :</strong> {{ formatNumber(esdUm(selected), 1) }} m</p>\n              <p><strong>Aire :</strong> {{ selected.object_area }} px</p>\n              <p><strong>Solidity :</strong> {{ formatNumber(selected.object_solidity, 3) }}</p>\n              <p><strong>longation :</strong> {{ formatNumber(selected.object_elongation, 3) }}</p>\n              <p><strong>Hue/Sat/Value :</strong>\n                {{ formatNumber(selected.object_MeanHue, 1) }} /\n                {{ formatNumber(selected.object_MeanSaturation, 1) }} /\n                {{ formatNumber(selected.object_MeanValue, 1) }}\n              </p>\n              <p>\n                <a :href=\"imageUrl(selected)\" download>Tlcharger l'image</a>\n              </p>\n            </div>\n          </div>\n          <div class=\"details-json\">\n            <div class=\"details-json-title\">Mtadonnes brutes</div>\n            <pre>{{ pretty(selected) }}</pre>\n          </div>\n        </div>\n      </div>\n    </div>\n  </div>\n</template>\n\n<!-- Chart.js -->\n<script src=\"https://cdn.jsdelivr.net/npm/chart.js\"></script>\n\n<!-- (Optionnel) UMAP-js :  ajuster selon ton choix de lib / CDN -->\n<!-- <script src=\"https://cdn.jsdelivr.net/npm/umap-js\"></script> -->\n\n<script>\nexport default {\n  data () {\n    return {\n      objects: [],\n      meta: {},\n      stats: {\n        totalObjects: 0,\n        meanEsdUm: 0,\n        medianEsdUm: 0,\n        totalBiovolumeMm3: 0,\n        imagedVolume: 0,\n        objectsPerVolume: 0,\n        concentrationIndex: 0\n      },\n      qc: {\n        borderFraction: 0,\n        duplicateFraction: 0,\n        tinyFraction: 0,\n        artifactFraction: 0,\n        saturatedFraction: 0\n      },\n      esdValues: [],\n      xyPoints: [],\n      shapePoints: [],\n      pixelSizeUm: 1,\n      minEsdUm: 0,\n      charts: {},\n      selected: null,\n      config: {\n        nEsdBins: 20,\n        maxGallery: 48,\n        scaleBarUm: 100,\n        duplicateGridSizePx: 20\n      }\n    }\n  },\n\n  computed: {\n    galleryObjects () {\n      return this.objects.slice(0, this.config.maxGallery)\n    },\n\n    scaleBarUm () {\n      return this.config.scaleBarUm\n    },\n\n    scaleBarPx () {\n      return this.pixelSizeUm > 0\n        ? this.scaleBarUm / this.pixelSizeUm\n        : 0\n    },\n\n    timeString () {\n      const t = this.meta.object_time\n      if (!t && t !== 0) return ''\n      const s = String(t).padStart(4, '0')\n      return s.slice(0, 2) + ':' + s.slice(2)\n    }\n  },\n\n  watch: {\n    // On surveille msg pour reconstruire ds qu'un nouveau message arrive\n    msg: {\n      immediate: true,\n      deep: true,\n      handler (newMsg) {\n        const objs = this.extractObjectsFromMsg(newMsg)\n        if (!Array.isArray(objs) || !objs.length) {\n          this.objects = []\n          return\n        }\n        this.objects = objs\n        this.meta = { ...objs[0] }\n        this.computeStatsAndQc()\n        this.buildChartsWhenReady()\n        if (!this.selected) {\n          this.selected = objs[0]\n        }\n      }\n    }\n  },\n\n  methods: {\n    extractObjectsFromMsg (msg) {\n      if (!msg) return []\n      if (Array.isArray(msg.payload)) return msg.payload\n      if (Array.isArray(msg.payload?.payload)) return msg.payload.payload\n      return []\n    },\n\n    computeStatsAndQc () {\n      const objs = this.objects\n      if (!objs.length) return\n\n      const first = objs[0]\n      const pixelSizeUm = first.process_pixel || 1\n      const minEsdUm = first.process_min_ESD || 0\n\n      this.pixelSizeUm = pixelSizeUm\n      this.minEsdUm = minEsdUm\n\n      // Rsolution de la camra\n      const res = (first.acq_camera_resolution || '0x0').split('x')\n      const camW = parseInt(res[0]) || 0\n      const camH = parseInt(res[1]) || 0\n\n      const esdValues = []\n      const volumesUm3 = []\n      const xyPoints = []\n      const shapePoints = []\n\n      let borderCount = 0\n      let tinyCount = 0\n      let artifactCount = 0\n      let saturatedCount = 0\n\n      const grid = {}\n      const gridSize = this.config.duplicateGridSizePx\n\n      for (const o of objs) {\n        // ESD en m\n        let esdPx = o.object_equivalent_diameter\n        if ((!esdPx || !isFinite(esdPx)) && o.object_area) {\n          esdPx = 2 * Math.sqrt(o.object_area / Math.PI)\n        }\n        const esdUm = esdPx && pixelSizeUm ? esdPx * pixelSizeUm : 0\n\n        if (esdUm > 0 && isFinite(esdUm)) {\n          esdValues.push(esdUm)\n          const vUm3 = (Math.PI / 6) * Math.pow(esdUm, 3)\n          volumesUm3.push(vUm3)\n          if (minEsdUm && esdUm < minEsdUm) {\n            tinyCount++\n          }\n        }\n\n        // Objets au bord\n        if (camW && camH) {\n          const bx = o.object_bx || 0\n          const by = o.object_by || 0\n          const w = o.object_width || 0\n          const h = o.object_height || 0\n          if (\n            bx <= 1 ||\n            by <= 1 ||\n            bx + w >= camW - 1 ||\n            by + h >= camH - 1\n          ) {\n            borderCount++\n          }\n        }\n\n        // Artefacts morpho\n        if (\n          (o.object_area && o.object_area < 30) ||\n          (o.object_solidity && o.object_solidity < 0.4) ||\n          (o.object_elongation && o.object_elongation > 10)\n        ) {\n          artifactCount++\n        }\n\n        // Saturation / trs sombre\n        const meanVal = o.object_MeanValue || 0\n        const stdVal = o.object_StdValue || 0\n        if ((meanVal >= 250 && stdVal < 8) || meanVal <= 5) {\n          saturatedCount++\n        }\n\n        // Points XY\n        if (o.object_x != null && o.object_y != null) {\n          xyPoints.push({ x: o.object_x, y: o.object_y })\n          const gx = Math.round(o.object_x / gridSize)\n          const gy = Math.round(o.object_y / gridSize)\n          const key = gx + ':' + gy\n          grid[key] = (grid[key] || 0) + 1\n        }\n\n        // Points morphologiques (solidity vs longation)\n        if (o.object_solidity != null && o.object_elongation != null) {\n          shapePoints.push({\n            x: o.object_solidity,\n            y: o.object_elongation\n          })\n        }\n      }\n\n      // Doublons (positions rcurrentes)\n      let duplicateCount = 0\n      Object.values(grid).forEach(count => {\n        if (count > 1) duplicateCount += count\n      })\n\n      const totalObjects = objs.length\n      const totalBiovolumeUm3 = volumesUm3.reduce((a, b) => a + b, 0)\n      const totalBiovolumeMm3 = totalBiovolumeUm3 / 1e9\n\n      const meanEsdUm = esdValues.length\n        ? esdValues.reduce((a, b) => a + b, 0) / esdValues.length\n        : 0\n\n      const sorted = [...esdValues].sort((a, b) => a - b)\n      const medianEsdUm = sorted.length\n        ? sorted[Math.floor(sorted.length / 2)]\n        : 0\n\n      // Volume image approximatif\n      let imagedVolume = first.acq_imaged_volume\n      if (!imagedVolume || imagedVolume <= 0) {\n        if (first.acq_nb_frame && first.acq_interframe_volume) {\n          imagedVolume = first.acq_nb_frame * first.acq_interframe_volume\n        }\n      }\n\n      const objectsPerVolume = imagedVolume\n        ? totalObjects / imagedVolume\n        : 0\n\n      const concentrationIndex =\n        imagedVolume &&\n        first.sample_filtered_volume &&\n        first.sample_collected_volume\n          ? (totalObjects / imagedVolume) *\n            (first.sample_filtered_volume / first.sample_collected_volume)\n          : 0\n\n      this.stats = {\n        totalObjects,\n        meanEsdUm,\n        medianEsdUm,\n        totalBiovolumeMm3,\n        imagedVolume,\n        objectsPerVolume,\n        concentrationIndex\n      }\n\n      this.qc = {\n        borderFraction: totalObjects ? borderCount / totalObjects : 0,\n        duplicateFraction: totalObjects ? duplicateCount / totalObjects : 0,\n        tinyFraction: totalObjects ? tinyCount / totalObjects : 0,\n        artifactFraction: totalObjects ? artifactCount / totalObjects : 0,\n        saturatedFraction: totalObjects ? saturatedCount / totalObjects : 0\n      }\n\n      this.esdValues = esdValues\n      this.xyPoints = xyPoints\n      this.shapePoints = shapePoints\n    },\n\n    buildChartsWhenReady () {\n      const build = () => {\n        this.renderEsdHistogram()\n        this.renderXYScatter()\n        this.renderShapeQC()\n        this.renderUmapScatter()\n      }\n\n      if (!window.Chart) {\n        const interval = setInterval(() => {\n          if (window.Chart) {\n            clearInterval(interval)\n            build()\n          }\n        }, 100)\n      } else {\n        build()\n      }\n    },\n\n    createOrUpdateChart (id, config) {\n      const canvas = document.getElementById(id)\n      if (!canvas || !window.Chart) return\n\n      if (this.charts[id]) {\n        const chart = this.charts[id]\n        chart.data = config.data\n        chart.options = config.options || {}\n        chart.update()\n      } else {\n        const ctx = canvas.getContext('2d')\n        this.charts[id] = new window.Chart(ctx, config)\n      }\n    },\n\n    renderEsdHistogram () {\n      if (!this.esdValues || !this.esdValues.length) return\n\n      const values = this.esdValues\n      const nBins = this.config.nEsdBins\n      const min = Math.min(...values)\n      const max = Math.max(...values)\n      if (!isFinite(min) || !isFinite(max) || max === min) return\n\n      const binSize = (max - min) / nBins\n      const counts = new Array(nBins).fill(0)\n      const labels = []\n\n      for (let i = 0; i < nBins; i++) {\n        const start = min + i * binSize\n        const end = start + binSize\n        labels.push(`${Math.round(start)}-${Math.round(end)}`)\n      }\n\n      for (const v of values) {\n        let idx = Math.floor((v - min) / binSize)\n        if (idx >= nBins) idx = nBins - 1\n        if (idx < 0) idx = 0\n        counts[idx]++\n      }\n\n      this.createOrUpdateChart(this.id + '-esd-hist', {\n        type: 'bar',\n        data: {\n          labels,\n          datasets: [\n            {\n              label: 'ESD (m)',\n              data: counts\n            }\n          ]\n        },\n        options: {\n          responsive: true,\n          scales: {\n            x: {\n              title: { display: true, text: 'Classe de taille (m)' }\n            },\n            y: {\n              title: { display: true, text: 'Nombre d\\'objets' },\n              type: 'logarithmic',\n              min: 1\n            }\n          },\n          plugins: {\n            legend: { display: false }\n          }\n        }\n      })\n    },\n\n    renderXYScatter () {\n      if (!this.xyPoints || !this.xyPoints.length) return\n\n      const data = this.xyPoints.map(p => ({ x: p.x, y: p.y }))\n\n      this.createOrUpdateChart(this.id + '-xy-scatter', {\n        type: 'scatter',\n        data: {\n          datasets: [\n            {\n              label: 'Objets',\n              data\n            }\n          ]\n        },\n        options: {\n          responsive: true,\n          scales: {\n            x: { title: { display: true, text: 'x (px)' } },\n            y: {\n              title: { display: true, text: 'y (px)' },\n              reverse: true\n            }\n          },\n          plugins: {\n            legend: { display: false }\n          }\n        }\n      })\n    },\n\n    renderShapeQC () {\n      if (!this.shapePoints || !this.shapePoints.length) return\n\n      const data = this.shapePoints.map(p => ({ x: p.x, y: p.y }))\n\n      this.createOrUpdateChart(this.id + '-shape-qc', {\n        type: 'scatter',\n        data: {\n          datasets: [\n            {\n              label: 'Objets',\n              data\n            }\n          ]\n        },\n        options: {\n          responsive: true,\n          scales: {\n            x: {\n              title: { display: true, text: 'Solidity' },\n              min: 0,\n              max: 1\n            },\n            y: {\n              title: { display: true, text: 'longation' }\n            }\n          },\n          plugins: {\n            legend: { display: false }\n          }\n        }\n      })\n    },\n\n    async renderUmapScatter () {\n      if (!this.objects || !this.objects.length) return\n\n      // Features pour UMAP\n      const features = []\n      for (const o of this.objects) {\n        const esd = this.esdUm(o) || 0\n        const logEsd = esd > 0 ? Math.log10(esd) : 0\n        const circ = o['object_circ.'] || o.object_circ || 0\n        const elong = o.object_elongation || 0\n        const solid = o.object_solidity || 0\n        const hue = (o.object_MeanHue || 0) / 255\n        const sat = (o.object_MeanSaturation || 0) / 100\n        features.push([logEsd, circ, elong, solid, hue, sat])\n      }\n\n      let points = null\n\n      // Si une lib UMAP globale est dispo, on tente de l'utiliser.\n      // NOTE : selon la lib, le nom global peut tre diffrent.\n      if (window.UMAP && typeof window.UMAP === 'function') {\n        try {\n          const umap = new window.UMAP({\n            nComponents: 2,\n            nNeighbors: 15,\n            minDist: 0.1\n          })\n          // fitAsync est expos par umap-js selon la doc npm\n          const embedding = await umap.fitAsync(features)\n          points = embedding.map(e => ({ x: e[0], y: e[1] }))\n        } catch (e) {\n          console.warn('Erreur UMAP, fallback features simples', e)\n        }\n      }\n\n      // Fallback : premire feature = log10(ESD), deuxime = circularit\n      if (!points) {\n        points = features.map(f => ({ x: f[0], y: f[1] }))\n      }\n\n      this.createOrUpdateChart(this.id + '-umap', {\n        type: 'scatter',\n        data: {\n          datasets: [\n            {\n              label: 'Projection',\n              data: points\n            }\n          ]\n        },\n        options: {\n          responsive: true,\n          scales: {\n            x: { title: { display: true, text: 'dim 1' } },\n            y: { title: { display: true, text: 'dim 2' } }\n          },\n          plugins: {\n            legend: { display: false }\n          }\n        }\n      })\n    },\n\n    esdUm (o) {\n      if (!o) return 0\n      const pxSize = this.pixelSizeUm || 1\n      let esdPx = o.object_equivalent_diameter\n      if ((!esdPx || !isFinite(esdPx)) && o.object_area) {\n        esdPx = 2 * Math.sqrt(o.object_area / Math.PI)\n      }\n      return esdPx && isFinite(esdPx) ? esdPx * pxSize : 0\n    },\n\n    imageUrl (o) {\n      if (!o) return ''\n      const date = o.object_date || 'unknown-date'\n      const sampleId = o.sample_id || this.meta.sample_id || 'unknown_sample'\n      const acqId = o.acq_id || this.meta.acq_id || 'unknown_acq'\n      const file = o.img_file_name || (o.object_id ? o.object_id + '.jpg' : '')\n      // Adapt  la forme que tu as donne :\n      // ps/data/browse/api/preview/big/objects/2025-11-19/S_1/A_4/2025-11-20_09-39-25-057700_0.jpg\n      return `ps/data/browse/api/preview/big/objects/${date}/${sampleId}/${acqId}/${file}`\n    },\n\n    selectObject (obj) {\n      this.selected = obj\n      // Tu peux aussi renvoyer un msg dans le flow si tu veux :\n      // this.send({ payload: obj })\n    },\n\n    formatNumber (v, digits = 2) {\n      const x = Number(v)\n      if (!isFinite(x)) return 'n/a'\n      return x.toFixed(digits)\n    },\n\n    percent (f) {\n      if (!isFinite(f)) return '0 %'\n      return (f * 100).toFixed(1) + ' %'\n    },\n\n    qcClass (frac) {\n      if (!isFinite(frac)) return 'qc-neutral'\n      if (frac < 0.05) return 'qc-good'\n      if (frac < 0.15) return 'qc-medium'\n      return 'qc-bad'\n    },\n\n    pretty (obj) {\n      return JSON.stringify(obj, null, 2)\n    }\n  }\n}\n</script>\n\n<style>\n.plankto-dashboard {\n  font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;\n  font-size: 13px;\n  padding: 6px;\n  box-sizing: border-box;\n}\n\n.no-data {\n  padding: 12px;\n  text-align: center;\n  opacity: 0.7;\n}\n\n.plankto-layout {\n  display: flex;\n  gap: 10px;\n  align-items: flex-start;\n}\n\n.left-panel {\n  flex: 2;\n  min-width: 0;\n}\n\n.right-panel {\n  flex: 1.5;\n  min-width: 0;\n  max-height: 80vh;\n  overflow: auto;\n}\n\n/* Infos chantillon */\n.info-row {\n  display: flex;\n  flex-wrap: wrap;\n  gap: 6px;\n  margin-bottom: 6px;\n}\n\n.info-block {\n  flex: 1;\n  min-width: 180px;\n  background: rgba(0, 0, 0, 0.03);\n  border-radius: 6px;\n  padding: 6px 8px;\n}\n\n.info-title {\n  font-weight: 600;\n  margin-bottom: 4px;\n}\n\n.info-body div {\n  margin-bottom: 2px;\n}\n\n/* Stats */\n.stat-row {\n  display: flex;\n  flex-wrap: wrap;\n  gap: 6px;\n  margin-bottom: 6px;\n}\n\n.stat-card {\n  flex: 1;\n  min-width: 160px;\n  background: rgba(0, 0, 0, 0.03);\n  border-radius: 6px;\n  padding: 6px 8px;\n}\n\n.stat-label {\n  font-size: 11px;\n  text-transform: uppercase;\n  letter-spacing: 0.04em;\n  opacity: 0.8;\n}\n\n.stat-value {\n  font-size: 14px;\n  font-weight: 600;\n}\n\n.stat-value.big {\n  font-size: 18px;\n}\n\n.stat-sub {\n  font-size: 11px;\n  opacity: 0.8;\n}\n\n/* QC */\n.qc-row {\n  display: flex;\n  flex-wrap: wrap;\n  gap: 6px;\n  margin-bottom: 8px;\n}\n\n.qc-card {\n  flex: 1;\n  min-width: 130px;\n  background: rgba(0, 0, 0, 0.02);\n  border-radius: 6px;\n  padding: 4px 6px;\n}\n\n.qc-label {\n  font-size: 11px;\n  opacity: 0.8;\n  margin-bottom: 2px;\n}\n\n.qc-good {\n  color: #2e7d32;\n  font-weight: 600;\n}\n\n.qc-medium {\n  color: #f9a825;\n  font-weight: 600;\n}\n\n.qc-bad {\n  color: #c62828;\n  font-weight: 600;\n}\n\n.qc-neutral {\n  opacity: 0.6;\n}\n\n/* Charts */\n.charts {\n  display: grid;\n  grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));\n  gap: 8px;\n}\n\n.chart-block {\n  background: rgba(0, 0, 0, 0.02);\n  border-radius: 6px;\n  padding: 6px;\n}\n\n.chart-title {\n  font-size: 12px;\n  font-weight: 600;\n  margin-bottom: 4px;\n}\n\n.chart-subtitle {\n  font-size: 11px;\n  font-weight: 400;\n  opacity: 0.7;\n}\n\n.chart-block canvas {\n  width: 100%;\n  max-height: 260px;\n}\n\n/* Galerie */\n.gallery-title {\n  font-weight: 600;\n  margin-bottom: 4px;\n}\n\n.gallery {\n  display: grid;\n  grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));\n  gap: 6px;\n}\n\n.thumb {\n  border-radius: 6px;\n  overflow: hidden;\n  background: rgba(0, 0, 0, 0.02);\n  cursor: pointer;\n  border: 1px solid transparent;\n}\n\n.thumb.selected {\n  border-color: #1976d2;\n}\n\n.thumb-image-wrapper {\n  position: relative;\n  overflow: hidden;\n}\n\n.thumb img {\n  display: block;\n  width: 100%;\n}\n\n.scale-bar-overlay {\n  position: absolute;\n  left: 4px;\n  right: 4px;\n  bottom: 4px;\n  display: flex;\n  align-items: center;\n  gap: 4px;\n  background: rgba(0, 0, 0, 0.55);\n  padding: 2px 4px;\n  border-radius: 3px;\n  color: #fff;\n  font-size: 10px;\n}\n\n.scale-bar {\n  height: 2px;\n  background: #fff;\n}\n\n.thumb-caption {\n  padding: 3px 4px 4px;\n  font-size: 11px;\n}\n\n.thumb-id {\n  font-weight: 600;\n  margin-bottom: 2px;\n}\n\n.thumb-meta {\n  opacity: 0.8;\n}\n\n/* Dtails objet slectionn */\n.selected-details {\n  margin-top: 10px;\n}\n\n.details-title {\n  font-weight: 600;\n  margin-bottom: 4px;\n}\n\n.details-body {\n  display: flex;\n  gap: 8px;\n  align-items: flex-start;\n}\n\n.details-image {\n  position: relative;\n  flex: 1;\n  min-width: 120px;\n}\n\n.details-image img {\n  display: block;\n  width: 100%;\n  border-radius: 6px;\n}\n\n.details-text {\n  flex: 1.2;\n  font-size: 12px;\n}\n\n.details-text p {\n  margin: 0 0 4px;\n}\n\n.details-json {\n  margin-top: 6px;\n}\n\n.details-json-title {\n  font-size: 11px;\n  font-weight: 600;\n  margin-bottom: 2px;\n}\n\n.details-json pre {\n  font-size: 10px;\n  background: #f5f5f5;\n  border-radius: 4px;\n  padding: 4px;\n  max-height: 180px;\n  overflow: auto;\n}\n</style>\n",
        "storeOutMessages": true,
        "passthru": true,
        "resendOnRefresh": true,
        "templateScope": "local",
        "className": "",
        "x": 1300,
        "y": 520,
        "wires": [
            []
        ]
    },
    {
        "id": "64ae825a687fb054",
        "type": "ecotaxa",
        "z": "8555b76c53e789e0",
        "name": "Import to Ecotaxa Project",
        "api_url": "https://ecotaxa.obs-vlfr.fr/api/",
        "project_id": "9366",
        "x": 830,
        "y": 300,
        "wires": [
            [
                "c21f20a7a9902ee4"
            ]
        ]
    },
    {
        "id": "af1ec6323cc00231",
        "type": "inject",
        "z": "8555b76c53e789e0",
        "name": "Lancer import",
        "props": [],
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": "0",
        "topic": "",
        "x": 310,
        "y": 300,
        "wires": [
            [
                "28f8eb0318735246"
            ]
        ]
    },
    {
        "id": "c21f20a7a9902ee4",
        "type": "debug",
        "z": "8555b76c53e789e0",
        "name": "Show import result",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "payload",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "auto",
        "x": 1110,
        "y": 300,
        "wires": []
    },
    {
        "id": "28f8eb0318735246",
        "type": "function",
        "z": "8555b76c53e789e0",
        "name": "Set file_path",
        "func": "msg.payload = {}\nmsg.payload.file_path = \"/home/pi/data/export/ecotaxa/ecotaxa_A_2.zip\"\n\n\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 570,
        "y": 300,
        "wires": [
            [
                "64ae825a687fb054",
                "1457a0786f787415"
            ]
        ]
    },
    {
        "id": "1457a0786f787415",
        "type": "debug",
        "z": "8555b76c53e789e0",
        "name": "debug 9",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "targetType": "full",
        "statusVal": "",
        "statusType": "auto",
        "x": 820,
        "y": 200,
        "wires": []
    },
    {
        "id": "8e11bb014b9664be",
        "type": "ui-template",
        "z": "8018bd5586fd4054",
        "group": "822cdc5b6ef13f39",
        "page": "",
        "ui": "",
        "name": "body",
        "order": 1,
        "width": "12",
        "height": "6",
        "head": "",
        "format": "<template>\n  <v-container>\n    <v-row>\n      <!-- Step 1: White Balance -->\n      <v-col cols=\"12\" md=\"3\">\n        <v-card\n          href=\"calibration_saturation_level\"\n          class=\"text-center py-2\"\n        >\n          <v-icon size=\"64\" color=\"primary\">mdi-eyedropper-variant</v-icon>\n          <v-card-title class=\"text-h6\">White Balance</v-card-title>\n          <v-card-text>\n            Use the color picker to measure the current color values and adjust the white balance accordingly.\n          </v-card-text>\n        </v-card>\n      </v-col>\n\n      <!-- Step 2: Lightness -->\n      <v-col cols=\"12\" md=\"3\">\n        <v-card\n          href=\"calibration_lightness\"\n          class=\"text-center py-2\"\n        >\n          <v-icon size=\"64\" color=\"primary\">mdi-brightness-6</v-icon>\n          <v-card-title class=\"text-h6\">Lightness</v-card-title>\n          <v-card-text>\n            Measure the current lightness value and update the LED intensity or ISO if below optimal levels.\n          </v-card-text>\n        </v-card>\n      </v-col>\n\n      <!-- Step 3: Pixel Size -->\n      <v-col cols=\"12\" md=\"3\">\n        <v-card\n          href=\"calibration_pixel_size\"\n          class=\"text-center py-2\"\n        >\n          <v-icon size=\"64\" color=\"primary\">mdi-ruler</v-icon>\n          <v-card-title class=\"text-h6\">Pixel Size</v-card-title>\n          <v-card-text>\n            Place markers on the micrometric ruler image to calculate the pixel size in microns per pixel.\n          </v-card-text>\n        </v-card>\n      </v-col>\n\n      <!-- Step 4: Pump Calibration -->\n      <v-col cols=\"12\" md=\"3\">\n        <v-card\n          href=\"calibration_pump\"\n          class=\"text-center py-2\"\n        >\n          <v-icon size=\"64\" color=\"primary\">mdi-water-pump</v-icon>\n          <v-card-title class=\"text-h6\">Pump Calibration</v-card-title>\n          <v-card-text>\n            Measure the transferred volume and adjust pump steps to improve accuracy in fluid handling.\n          </v-card-text>\n        </v-card>\n      </v-col>\n    </v-row>\n  </v-container>\n</template>\n",
        "storeOutMessages": true,
        "passthru": true,
        "resendOnRefresh": true,
        "templateScope": "local",
        "className": "",
        "x": 490,
        "y": 220,
        "wires": [
            []
        ]
    },
    {
        "id": "35d8e8e4b1e0ef7d",
        "type": "ui-template",
        "z": "8018bd5586fd4054",
        "group": "c29c835a70533b69",
        "page": "",
        "ui": "",
        "name": "header",
        "order": 1,
        "width": "12",
        "height": "6",
        "head": "",
        "format": "<template>\n  <v-empty-state\n    headline=\"Calibration steps\"\n    icon=\"mdi-crosshairs-gps\"\n    title=\"Follow these steps to ensure optimal image quality and measurement accuracy\"\n  >\n  </v-empty-state>\n</template>\n",
        "storeOutMessages": true,
        "passthru": true,
        "resendOnRefresh": true,
        "templateScope": "local",
        "className": "",
        "x": 490,
        "y": 180,
        "wires": [
            []
        ]
    },
    {
        "id": "062a3af5e12e8445",
        "type": "ui-template",
        "z": "6426e7bea6900426",
        "g": "f591255fbfc6c466",
        "group": "af8acdfe9afbad74",
        "page": "",
        "ui": "",
        "name": "Step Bar",
        "order": 1,
        "width": 0,
        "height": 0,
        "head": "",
        "format": "<template>\n  <div>\n    <v-stepper class=\"my-stepper\" model-value=\"1\" non-linear>\n      <v-stepper-header>\n        <v-stepper-item value=\"1\" editable @click=\"stepClicked(1)\" class=\"selected-step\" color=\"primary\">Saturation Level</v-stepper-item>\n        <v-divider></v-divider>\n        <v-stepper-item value=\"2\" editable @click=\"stepClicked(2)\" color=\"grey\">Lightness</v-stepper-item>\n        <v-divider></v-divider>\n        <v-stepper-item value=\"3\" editable @click=\"stepClicked(3)\" color=\"grey\">Pixel size</v-stepper-item>\n        <v-divider></v-divider>\n        <v-stepper-item value=\"4\" editable @click=\"stepClicked(4)\" color=\"grey\">Pump</v-stepper-item>\n      </v-stepper-header>\n    </v-stepper>\n  </div>\n</template>\n\n<script>\n  export default {\n    name: 'StepperComponent',\n    methods: {\n      stepClicked(step) {\n        const stepMapping = {\n          1: { page: 'Calibration - Saturation Level' },\n          2: { page: 'Calibration - Lightness' },\n          3: { page: 'Calibration - Pixel size' },\n          4: { page: 'Calibration - Pump' }\n        };\n\n        const msgPayload = stepMapping[step] || {};\n        \n        this.send({ payload: msgPayload });\n      }\n    }\n  }\n</script>\n",
        "storeOutMessages": true,
        "passthru": true,
        "resendOnRefresh": true,
        "templateScope": "local",
        "className": "",
        "x": 1080,
        "y": 60,
        "wires": [
            [
                "e5da27b9abdcb156"
            ]
        ]
    },
    {
        "id": "e5da27b9abdcb156",
        "type": "ui-control",
        "z": "6426e7bea6900426",
        "g": "f591255fbfc6c466",
        "name": "",
        "ui": "e6ae26617c24c3ea",
        "events": "all",
        "x": 1280,
        "y": 60,
        "wires": [
            []
        ]
    },
    {
        "id": "5350c095034ba5c6",
        "type": "ui-event",
        "z": "6426e7bea6900426",
        "ui": "e6ae26617c24c3ea",
        "name": "UI Event",
        "x": 80,
        "y": 40,
        "wires": [
            [
                "a0df077ddbb184e3"
            ]
        ]
    },
    {
        "id": "a0df077ddbb184e3",
        "type": "switch",
        "z": "6426e7bea6900426",
        "name": "msg.topic === \"$pageview\"",
        "property": "topic",
        "propertyType": "msg",
        "rules": [
            {
                "t": "eq",
                "v": "$pageview",
                "vt": "str"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 1,
        "x": 280,
        "y": 40,
        "wires": [
            [
                "874fd69a5398300e"
            ]
        ]
    },
    {
        "id": "874fd69a5398300e",
        "type": "switch",
        "z": "6426e7bea6900426",
        "name": "msg.payload.page.path === \"/calibration_saturation_level\"",
        "property": "payload.page.path",
        "propertyType": "msg",
        "rules": [
            {
                "t": "eq",
                "v": "/calibration_saturation_level",
                "vt": "str"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 1,
        "x": 640,
        "y": 40,
        "wires": [
            [
                "65a5f93fc6decaac"
            ]
        ]
    },
    {
        "id": "65a5f93fc6decaac",
        "type": "function",
        "z": "6426e7bea6900426",
        "name": "Get Global Variables",
        "func": "const keys = global.keys(); // Get all global variable keys\nmsg.payload = {}; // Initialize the payload object\n\nkeys.forEach(key => {\n    // Ignore keys that start with \"$\"\n    if (!key.startsWith('$')) {\n        msg.payload[key] = global.get(key);\n    }\n});\n\nreturn msg;\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 120,
        "y": 140,
        "wires": [
            [
                "94a287dea58faa4d"
            ]
        ]
    },
    {
        "id": "94a287dea58faa4d",
        "type": "ui-template",
        "z": "6426e7bea6900426",
        "group": "af8acdfe9afbad74",
        "page": "",
        "ui": "",
        "name": "Calibration - WB",
        "order": 2,
        "width": "0",
        "height": "0",
        "head": "",
        "format": "\n<template>\n  <v-container fluid>\n    <v-row>\n      <!-- PREVIEW : 8 colonnes -->\n      <v-col cols=\"12\" md=\"8\">\n        <v-card class=\"calibration-container\" style=\"width:100%; height:750px; position:relative; overflow:hidden;\">\n          <iframe src=\"/preview/node-red\" class=\"calibration-iframe\"></iframe>\n        </v-card>\n      </v-col>\n\n      <!-- CONTROL PANEL : 4 colonnes -->\n      <v-col cols=\"12\" md=\"4\">\n        <v-card class=\"px-4\">\n          <v-card-title class=\"text-left text-primary\">\n            White Balance Calibration\n          </v-card-title>\n\n          <v-divider class=\"mb-4\"></v-divider>\n\n          <!-- Step 1 -->\n          <section class=\"mb-6\">\n            <h3 class=\"text-subtitle-1 mb-2\">1. Refresh</h3>\n            <p class=\"text-caption mb-3\">\n              Click <b>Refresh the value of the gains</b> to start.\n            </p>\n            <v-btn block color=\"error\" class=\"mb-4\" @click=\"refreshGain\">\n              Refresh\n            </v-btn>\n          </section>\n\n          <v-divider class=\"mb-4\"></v-divider>\n\n          <!-- Step 2 -->\n          <section class=\"mb-6\">\n            <h3 class=\"text-subtitle-1 mb-2\">2. Pick a Pixel</h3>\n            <p class=\"text-caption mb-3\">Pick a pixel from the live stream.</p>\n\n            <div class=\"text-center mb-3\">\n              Pick a pixel from the stream :\n              <input class=\"colorpicker\" type=\"color\" v-model=\"selectedColor\" @input=\"onColorInput\"/>\n            </div>\n          </section>\n\n          <v-divider class=\"mb-4\"></v-divider>\n\n          <!-- Step 3 -->\n          <section class=\"mb-6\">\n            <h3 class=\"text-subtitle-1 mb-2\">3. Apply Suggested Gains</h3>\n\n            <v-data-table :items=\"rows\" density=\"comfortable\" hide-default-footer class=\"gain-table mb-6\">\n              <template #item.current=\"{ item }\">\n                <div class=\"text-center font-mono\">{{ item.current }}</div>\n              </template>\n              <template #item.suggested=\"{ item }\">\n                <v-text-field v-model.number=\"item.suggested\" type=\"number\" min=\"0\" hide-details density=\"compact\"\n                  variant=\"underlined\" class=\"text-primary text-center suggested-input\"\n                  @change=\"onManualEdit(item.channel,item.suggested)\" />\n              </template>\n            </v-data-table>\n\n            <p class=\"text-caption mb-3\">\n              Click <b>Apply Suggested Gains</b> after selecting your pixel.\n            </p>\n\n            <v-btn block color=\"primary\" class=\"mt-auto\" :disabled=\"!suggested.red && !suggested.blue\"\n              @click=\"applySuggested\">\n              Apply Suggested Gains\n            </v-btn>\n          </section>\n\n          <v-divider class=\"mb-4\"></v-divider>\n\n          <!-- Step 4 -->\n          <section>\n            <h3 class=\"text-subtitle-1 mb-2\">4. Repeat Until Saturation  0%</h3>\n            <p class=\"text-caption\">\n              Repeat steps 10 times until the saturation value approaches <b>0%</b>.\n            </p>\n\n            <div class=\"mb-2\" :style=\"{ color: hsl.s < 10 ? 'green' : hsl.s < 30 ? 'orange' : 'red' }\">\n              Current saturation: <b>{{ hsl.s }} %</b>\n            </div>\n\n            <div class=\"mb-4 text-center text-caption\">\n              <v-progress-linear :model-value=\"(loopCount / totalLoops) * 100\" color=\"primary\" height=\"40\"\n                class=\"rounded mb-1\" />\n\n              <div>\n                <template v-if=\"loopCount === 0\">\n                  Start calibration  click <b>Refresh</b>.\n                </template>\n                <template v-else-if=\"loopCount < totalLoops\">\n                  Iteration {{ loopCount }} / {{ totalLoops }}  sample & apply.\n                </template>\n                <template v-else>\n                   Calibration complete! Saturation should be near <b>0%</b>.\n                </template>\n              </div>\n            </div>\n          </section>\n        </v-card>\n      </v-col>\n    </v-row>\n  </v-container>\n</template>\n<script>\nexport default {\n  props: [\"msg\"],\n  data() {\n    return {\n      current: { red: 150, blue: 130 },\n      suggested: { red: null, blue: null },\n      selectedColor: \"#ffffff\",\n      hsl: { h: 0, s: 0, l: 0 },\n      loopCount: 0,\n      totalLoops: 10,\n      headers: [\n        { text: \"Channel\", value: \"channel\", align: \"start\" },\n        { text: \"Current\", value: \"current\", align: \"center\" },\n        { text: \"Suggested\", value: \"suggested\", align: \"center\" },\n      ],\n    };\n  },\n  computed: {\n    rows() {\n      return [\n        { channel: \"AWRed\", current: this.current.red, suggested: this.suggested.red },\n        { channel: \"AWBlue\", current: this.current.blue, suggested: this.suggested.blue },\n      ];\n    },\n  },\n  watch: {\n    msg: {\n      handler(n) {\n        const p = n?.payload || {};\n        if (p.calibration_wbg_red !== undefined)\n          this.current.red = Number(p.calibration_wbg_red);\n        if (p.calibration_wbg_blue !== undefined)\n          this.current.blue = Number(p.calibration_wbg_blue);\n      },\n      deep: true,\n    },\n  },\n  methods: {\n    refreshGain() {\n      this.loopCount = 0;\n      this.current = { red: 100, blue: 100 };\n      this.suggested = { red: null, blue: null };\n      this.sendUpdate(\"imager/image\", {\n        action: \"settings\",\n        settings: { white_balance_gain: this.current },\n      });\n    },\n    sendUpdate(topic, extra = {}) {\n      if (typeof this.send === \"function\") this.send({ topic, payload: { ...extra } });\n    },\n    onColorInput(e) {\n      const hex = e.target.value;\n      this.selectedColor = hex;\n      this.hsl = this.hexToHsl(hex);\n      const { r, g, b } = this.hexToRgb(hex);\n      const redAdj = g - r + this.current.red;\n      const blueAdj = g - b + this.current.blue;\n      this.suggested.red = Math.max(0, Math.min(255, Math.round(redAdj)));\n      this.suggested.blue = Math.max(0, Math.min(255, Math.round(blueAdj)));\n    },\n    onManualEdit(ch, v) {\n      if (ch === \"AWRed\") this.suggested.red = v;\n      if (ch === \"AWBlue\") this.suggested.blue = v;\n    },\n    applySuggested() {\n      if (!this.suggested.red && !this.suggested.blue) return;\n      const p = {\n        action: \"settings\",\n        settings: {\n          white_balance_gain: {\n            red: parseInt(this.suggested.red, 10),\n            blue: parseInt(this.suggested.blue, 10),\n          },\n        },\n      };\n      this.sendUpdate(\"imager/image\", p);\n      this.current = { ...this.suggested };\n      if (this.loopCount < this.totalLoops) this.loopCount++;\n    },\n    hexToRgb(h) {\n      return {\n        r: parseInt(h.substr(1, 2), 16),\n        g: parseInt(h.substr(3, 2), 16),\n        b: parseInt(h.substr(5, 2), 16),\n      };\n    },\n    hexToHsl(hex) {\n      const { r, g, b } = this.hexToRgb(hex);\n      const rn = r / 255, gn = g / 255, bn = b / 255;\n      const max = Math.max(rn, gn, bn), min = Math.min(rn, gn, bn);\n      const l = (max + min) / 2;\n      let h = 0, s = 0;\n      if (max !== min) {\n        const d = max - min;\n        s = d / (1 - Math.abs(2 * l - 1));\n        switch (max) {\n          case rn: h = ((gn - bn) / d) % 6; break;\n          case gn: h = (bn - rn) / d + 2; break;\n          case bn: h = (rn - gn) / d + 4; break;\n        }\n        h *= 60;\n      }\n      return { h: Math.round(h), s: Math.round(s * 100), l: Math.round(l * 100) };\n    },\n  },\n};\n</script>\n\n<style scoped>\n.calibration-iframe { position: absolute; top: 0; left: 0; width: 1000px; height: 750px; border: none; pointer-events: none; }\n.gain-table { border-radius: 8px; background: #fafafa; border: 1px solid #cfd8dc; }\n.table-header-title { background: #e3f2fd; font-weight: 600; font-size: 15px; }\n.suggested-input { max-width: 80px; margin: auto; }\n.colorpicker { height: 28px; width: 60px; margin-left: 8px; border: 1px solid #999; border-radius: 4px; cursor: pointer; vertical-align: middle; }\n</style>\n",
        "storeOutMessages": true,
        "passthru": true,
        "resendOnRefresh": true,
        "templateScope": "local",
        "className": "",
        "x": 400,
        "y": 140,
        "wires": [
            [
                "615edad94a4f77e7"
            ]
        ]
    },
    {
        "id": "e52cb70984e0d25d",
        "type": "mqtt out",
        "z": "6426e7bea6900426",
        "name": "",
        "topic": "",
        "qos": "",
        "retain": "",
        "broker": "8dc3722c.06efa8",
        "x": 850,
        "y": 100,
        "wires": []
    },
    {
        "id": "d8f732f8fe251222",
        "type": "function",
        "z": "6426e7bea6900426",
        "name": "set pump settings",
        "func": "if (msg.topic) {\n    global.set(\"calibration_wbg_red\", msg.payload.settings.white_balance_gain.red);\n    global.set(\"calibration_wbg_blue\", msg.payload.settings.white_balance_gain.blue);\n}\nreturn msg;",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 990,
        "y": 180,
        "wires": [
            []
        ]
    },
    {
        "id": "615edad94a4f77e7",
        "type": "switch",
        "z": "6426e7bea6900426",
        "name": "",
        "property": "topic",
        "propertyType": "msg",
        "rules": [
            {
                "t": "eq",
                "v": "imager/image",
                "vt": "str"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 1,
        "x": 590,
        "y": 140,
        "wires": [
            [
                "d8f732f8fe251222",
                "e52cb70984e0d25d"
            ]
        ]
    },
    {
        "id": "5fbdba7e61973f9a",
        "type": "ui-template",
        "z": "14c685bd04db8be5",
        "g": "426f6cef77fbb290",
        "group": "728c7ed3d63dfcee",
        "page": "",
        "ui": "",
        "name": "Step Bar",
        "order": 1,
        "width": 0,
        "height": 0,
        "head": "",
        "format": "<template>\n  <div>\n    <v-stepper class=\"my-stepper\" model-value=\"2\" non-linear>\n      <v-stepper-header>\n        <v-stepper-item value=\"1\" editable @click=\"stepClicked(1)\" color=\"grey\">Saturation Level</v-stepper-item>\n        <v-divider></v-divider>\n        <v-stepper-item value=\"2\" editable @click=\"stepClicked(2)\" class=\"selected-step\" color=\"primary\">Lightness</v-stepper-item>\n        <v-divider></v-divider>\n        <v-stepper-item value=\"3\" editable @click=\"stepClicked(3)\" color=\"grey\">Pixel size</v-stepper-item>\n        <v-divider></v-divider>\n        <v-stepper-item value=\"4\" editable @click=\"stepClicked(4)\" color=\"grey\">Pump</v-stepper-item>\n      </v-stepper-header>\n    </v-stepper>\n  </div>\n</template>\n\n<script>\n  export default {\n    name: 'StepperComponent',\n    methods: {\n      stepClicked(step) {\n        const stepMapping = {\n          1: { page: 'Calibration - Saturation Level' },\n          2: { page: 'Calibration - Lightness' },\n          3: { page: 'Calibration - Pixel size' },\n          4: { page: 'Calibration - Pump' }\n        };\n\n        const msgPayload = stepMapping[step] || {};\n        \n        this.send({ payload: msgPayload });\n      }\n    }\n  }\n</script>\n",
        "storeOutMessages": true,
        "passthru": true,
        "resendOnRefresh": true,
        "templateScope": "local",
        "className": "",
        "x": 1080,
        "y": 60,
        "wires": [
            [
                "25cb0163587aee15"
            ]
        ]
    },
    {
        "id": "25cb0163587aee15",
        "type": "ui-control",
        "z": "14c685bd04db8be5",
        "g": "426f6cef77fbb290",
        "name": "",
        "ui": "e6ae26617c24c3ea",
        "events": "all",
        "x": 1280,
        "y": 60,
        "wires": [
            []
        ]
    },
    {
        "id": "547bbdea834e849c",
        "type": "ui-event",
        "z": "14c685bd04db8be5",
        "ui": "e6ae26617c24c3ea",
        "name": "UI Event",
        "x": 80,
        "y": 40,
        "wires": [
            [
                "068b250f8668e3ea"
            ]
        ]
    },
    {
        "id": "068b250f8668e3ea",
        "type": "switch",
        "z": "14c685bd04db8be5",
        "name": "msg.topic === \"$pageview\"",
        "property": "topic",
        "propertyType": "msg",
        "rules": [
            {
                "t": "eq",
                "v": "$pageview",
                "vt": "str"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 1,
        "x": 280,
        "y": 40,
        "wires": [
            [
                "72dd2876e74c3ef2"
            ]
        ]
    },
    {
        "id": "72dd2876e74c3ef2",
        "type": "switch",
        "z": "14c685bd04db8be5",
        "name": "msg.payload.page.path === \"/calibration_lightness\"",
        "property": "payload.page.path",
        "propertyType": "msg",
        "rules": [
            {
                "t": "eq",
                "v": "/calibration_lightness",
                "vt": "str"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 1,
        "x": 620,
        "y": 40,
        "wires": [
            [
                "7245cda05ff489a3"
            ]
        ]
    },
    {
        "id": "7245cda05ff489a3",
        "type": "function",
        "z": "14c685bd04db8be5",
        "name": "Get Global Variables",
        "func": "const keys = global.keys(); // Get all global variable keys\nmsg.payload = {}; // Initialize the payload object\n\nkeys.forEach(key => {\n    // Ignore keys that start with \"$\"\n    if (!key.startsWith('$')) {\n        msg.payload[key] = global.get(key);\n    }\n});\n\nreturn msg;\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 120,
        "y": 140,
        "wires": [
            [
                "740188ac42d17f44"
            ]
        ]
    },
    {
        "id": "740188ac42d17f44",
        "type": "ui-template",
        "z": "14c685bd04db8be5",
        "group": "728c7ed3d63dfcee",
        "page": "",
        "ui": "",
        "name": "Calibration - Lightness",
        "order": 2,
        "width": "0",
        "height": "0",
        "head": "",
        "format": "<template>\n  <v-container fluid>\n    <v-row>\n      <v-col cols=\"12\" md=\"8\">\n        <v-card class=\"calibration-container\" style=\"width:100%; height:750px; position:relative; overflow:hidden;\">\n          <iframe src=\"/preview/node-red\" class=\"calibration-iframe\"></iframe>\n          \n          <div class=\"target-overlay\">\n             <v-icon color=\"white\" size=\"large\">mdi-crosshairs</v-icon>\n          </div>\n        </v-card>\n      </v-col>\n\n      <v-col cols=\"12\" md=\"4\">\n        <v-card class=\"px-4 pb-4 h-100\">\n          <v-card-title class=\"text-left text-primary\">\n            Luminance Calibration\n            <v-chip size=\"x-small\" color=\"grey\" class=\"ml-2\" variant=\"outlined\">\n               Target: {{ targetLuminance }}\n            </v-chip>\n          </v-card-title>\n\n          <v-divider class=\"mb-4\"></v-divider>\n\n          <section class=\"mb-6\">\n            <h3 class=\"text-subtitle-1 mb-2\">1. Current State</h3>\n            <div class=\"d-flex align-center justify-space-between bg-grey-lighten-4 pa-2 rounded\">\n                <span>LED Intensity:</span>\n                <strong class=\"text-primary font-mono\">{{ currentLedValue.toFixed(4) }}</strong>\n            </div>\n            <v-btn block color=\"grey-darken-1\" variant=\"text\" size=\"small\" class=\"mt-1\" @click=\"refreshState\">\n              Refresh Data\n            </v-btn>\n          </section>\n\n          <v-divider class=\"mb-4\"></v-divider>\n\n          <section class=\"mb-6\">\n            <h3 class=\"text-subtitle-1 mb-2\">2. Measure</h3>\n            \n            <div class=\"d-flex align-center justify-center mb-4\">\n               <input class=\"colorpicker\" type=\"color\" v-model=\"selectedColor\" @input=\"onColorInput\"/>\n            </div>\n\n            <div class=\"text-center mb-2\">\n                <div class=\"text-h3 font-weight-bold\" :class=\"luminanceColor\">\n                    {{ currentLuminance.toFixed(0) }}\n                </div>\n                <div class=\"text-caption text-grey\">Target: {{ targetLuminance }}</div>\n            </div>\n\n            <v-progress-linear\n                :model-value=\"Math.min(Math.max((currentLuminance / 255) * 100, 0), 100)\"\n                :color=\"getProgressColor(currentLuminance)\"\n                height=\"20\"\n                rounded\n            >\n                <template v-slot:default=\"{ value }\">\n                    <strong style=\"color:white; text-shadow: 0 0 2px black;\">{{ Math.round(currentLuminance) }}</strong>\n                </template>\n            </v-progress-linear>\n          </section>\n\n          <v-divider class=\"mb-4\"></v-divider>\n\n          <section>\n            <h3 class=\"text-subtitle-1 mb-2\">3. Action</h3>\n            \n            <v-alert v-if=\"suggestedLedValue !== null\" :type=\"isTargetReached ? 'success' : 'info'\" variant=\"tonal\" density=\"compact\" class=\"mb-3\">\n                <div v-if=\"isTargetReached\">\n                    Target reached ({{targetLuminance}}  {{tolerance}}).\n                </div>\n                <div v-else>\n                    New LED Value: <b>{{ suggestedLedValue.toFixed(4) }}</b>\n                </div>\n            </v-alert>\n\n            <v-btn \n                block \n                size=\"large\"\n                :color=\"isTargetReached ? 'success' : 'primary'\" \n                :disabled=\"suggestedLedValue === null\"\n                @click=\"applyCorrection\"\n            >\n                {{ isTargetReached ? 'Done' : 'Apply Correction' }}\n            </v-btn>\n          </section>\n        </v-card>\n      </v-col>\n    </v-row>\n  </v-container>\n</template>\n\n<script>\nexport default {\n  props: [\"msg\"],\n  data() {\n    return {\n      currentLedValue: 0.5, \n      suggestedLedValue: null,\n      selectedColor: \"#000000\",\n      currentLuminance: 0,\n      targetLuminance: 230,\n      tolerance: 2,\n      \n      // SINGLE CURVE DATA (Based on your V3 dataset)\n      // Format: { lum: Measured Luminance (0-255), val: LED Intensity (0-1) }\n      curveData: [\n        { lum: 170.00, val: 0.2744 }, \n        { lum: 180.00, val: 0.4633 }, \n        { lum: 194.00, val: 0.6027 },\n        { lum: 210.00, val: 0.6994 }, \n        { lum: 229.00, val: 0.8992 }, \n        { lum: 232.00, val: 0.9087 },\n        { lum: 234.00, val: 0.9176 }, \n        { lum: 238.00, val: 0.9345 }, \n        { lum: 253.00, val: 0.9937 },\n        { lum: 255.00, val: 1.0000 }\n      ]\n    };\n  },\n  computed: {\n    isTargetReached() {\n        return Math.abs(this.currentLuminance - this.targetLuminance) <= this.tolerance;\n    },\n    luminanceColor() {\n        const diff = Math.abs(this.currentLuminance - this.targetLuminance);\n        if (diff <= this.tolerance) return 'text-success';\n        if (diff <= 10) return 'text-warning';\n        return 'text-error';\n    }\n  },\n  watch: {\n    msg: {\n      handler(n) {\n        const p = n?.payload || {};\n        // Update LED Intensity from incoming message\n        if (p.settings && p.settings.led_intensity !== undefined) {\n            this.currentLedValue = Number(p.settings.led_intensity);\n        }\n      },\n      deep: true,\n    },\n  },\n  methods: {\n    refreshState() {\n        this.sendUpdate(\"imager/request_settings\", {}); \n    },\n    sendUpdate(topic, payload) {\n      if (typeof this.send === \"function\") this.send({ topic, payload });\n    },\n    onColorInput(e) {\n      const hex = e.target.value;\n      this.selectedColor = hex;\n      this.currentLuminance = this.getLuminanceFromHex(hex);\n      this.calculateNextStep();\n    },\n    getLuminanceFromHex(hex) {\n        const r = parseInt(hex.substr(1, 2), 16);\n        const g = parseInt(hex.substr(3, 2), 16);\n        const b = parseInt(hex.substr(5, 2), 16);\n        // Simple average luminance\n        return (r + g + b) / 3;\n    },\n    getProgressColor(lum) {\n        if (Math.abs(lum - this.targetLuminance) < 5) return 'success';\n        if (lum > this.targetLuminance) return 'deep-orange';\n        return 'blue-grey';\n    },\n    getTheoreticalLedValue(lum) {\n        const data = this.curveData;\n        \n        // Handle out of bounds\n        if (lum <= data[0].lum) return data[0].val;\n        if (lum >= data[data.length - 1].lum) return data[data.length - 1].val;\n\n        // Interpolation\n        for (let i = 0; i < data.length - 1; i++) {\n            const p1 = data[i];\n            const p2 = data[i+1];\n            if (lum >= p1.lum && lum <= p2.lum) {\n                const ratio = (lum - p1.lum) / (p2.lum - p1.lum);\n                return p1.val + ratio * (p2.val - p1.val);\n            }\n        }\n        return 0.5;\n    },\n    calculateNextStep() {\n        // 1. Theoretical LED for current reading\n        const theoreticalCurrent = this.getTheoreticalLedValue(this.currentLuminance);\n        // 2. Theoretical LED for target (230)\n        const theoreticalTarget = this.getTheoreticalLedValue(this.targetLuminance);\n        \n        // 3. Calculate Delta\n        const delta = theoreticalTarget - theoreticalCurrent;\n        \n        // 4. Apply Delta to Real Value\n        let nextVal = this.currentLedValue + delta;\n        nextVal = Math.max(0, Math.min(1, nextVal));\n        \n        this.suggestedLedValue = nextVal;\n    },\n    applyCorrection() {\n        if (this.suggestedLedValue === null) return;\n        this.sendUpdate(\"imager/image\", {\n            action: \"settings\",\n            settings: {\n                led_intensity: Number(this.suggestedLedValue.toFixed(5))\n            }\n        });\n        this.currentLedValue = this.suggestedLedValue;\n    }\n  }\n};\n</script>\n\n<style scoped>\n.calibration-iframe { width: 100%; height: 100%; border: none; }\n.target-overlay { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); pointer-events: none; opacity: 0.5; }\n.colorpicker { height: 40px; width: 100%; border: 2px solid #ddd; border-radius: 4px; cursor: pointer; }\n.font-mono { font-family: 'Roboto Mono', monospace; }\n</style>",
        "storeOutMessages": true,
        "passthru": true,
        "resendOnRefresh": true,
        "templateScope": "local",
        "className": "",
        "x": 420,
        "y": 140,
        "wires": [
            [
                "959de9b1292e047d"
            ]
        ]
    },
    {
        "id": "785c59c553d71326",
        "type": "mqtt out",
        "z": "14c685bd04db8be5",
        "name": "",
        "topic": "",
        "qos": "",
        "retain": "",
        "broker": "8dc3722c.06efa8",
        "x": 850,
        "y": 100,
        "wires": []
    },
    {
        "id": "0283e992ff5da0f6",
        "type": "function",
        "z": "14c685bd04db8be5",
        "name": "set led_intensity",
        "func": "if (msg.topic) {\n    global.set(\"led_intensity\", msg.payload.settings.led_intensity);}\nreturn msg;",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 980,
        "y": 180,
        "wires": [
            []
        ]
    },
    {
        "id": "959de9b1292e047d",
        "type": "switch",
        "z": "14c685bd04db8be5",
        "name": "",
        "property": "topic",
        "propertyType": "msg",
        "rules": [
            {
                "t": "eq",
                "v": "imager/image",
                "vt": "str"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 1,
        "x": 590,
        "y": 140,
        "wires": [
            [
                "0283e992ff5da0f6"
            ]
        ]
    },
    {
        "id": "05a5a9c4530d07ea",
        "type": "ui-template",
        "z": "3afb1d2b21be9114",
        "g": "da1cb3ed0c90bb56",
        "group": "c966455a52d121c0",
        "page": "",
        "ui": "",
        "name": "Step Bar",
        "order": 1,
        "width": 0,
        "height": 0,
        "head": "",
        "format": "<template>\n  <div>\n    <v-stepper class=\"my-stepper\" model-value=\"3\" non-linear>\n      <v-stepper-header>\n        <v-stepper-item value=\"1\" editable @click=\"stepClicked(1)\" color=\"grey\">Saturation Level</v-stepper-item>\n        <v-divider></v-divider>\n        <v-stepper-item value=\"2\" editable @click=\"stepClicked(2)\" color=\"grey\">Lightness</v-stepper-item>\n        <v-divider></v-divider>\n        <v-stepper-item value=\"3\" editable @click=\"stepClicked(3)\" class=\"selected-step\" color=\"primary\">Pixel size</v-stepper-item>\n        <v-divider></v-divider>\n        <v-stepper-item value=\"4\" editable @click=\"stepClicked(4)\" color=\"grey\">Pump</v-stepper-item>\n      </v-stepper-header>\n    </v-stepper>\n  </div>\n</template>\n\n<script>\n  export default {\n    name: 'StepperComponent',\n    methods: {\n      stepClicked(step) {\n        const stepMapping = {\n          1: { page: 'Calibration - Saturation Level' },\n          2: { page: 'Calibration - Lightness' },\n          3: { page: 'Calibration - Pixel size' },\n          4: { page: 'Calibration - Pump' }\n        };\n\n        const msgPayload = stepMapping[step] || {};\n        \n        this.send({ payload: msgPayload });\n      }\n    }\n  }\n</script>\n",
        "storeOutMessages": true,
        "passthru": true,
        "resendOnRefresh": true,
        "templateScope": "local",
        "className": "",
        "x": 1080,
        "y": 60,
        "wires": [
            [
                "419cccaf23eb2548"
            ]
        ]
    },
    {
        "id": "419cccaf23eb2548",
        "type": "ui-control",
        "z": "3afb1d2b21be9114",
        "g": "da1cb3ed0c90bb56",
        "name": "",
        "ui": "e6ae26617c24c3ea",
        "events": "all",
        "x": 1280,
        "y": 60,
        "wires": [
            []
        ]
    },
    {
        "id": "2352be52ae097a08",
        "type": "ui-template",
        "z": "3afb1d2b21be9114",
        "group": "c966455a52d121c0",
        "page": "",
        "ui": "",
        "name": "Calibration - Pixel Size",
        "order": 2,
        "width": "0",
        "height": "0",
        "head": "",
        "format": "<template>\n  <v-container fluid>\n    <v-row>\n\n      <!-- Streaming Preview (colonne 6/12) -->\n      <v-col cols=\"12\" md=\"8\">\n        <v-card\n          class=\"calibration-container\"\n          style=\"width:1000px;height:750px;position:relative;overflow:hidden\"\n          @pointermove=\"onPointerMove\"\n          @pointerup=\"stopDrag\"\n          @pointercancel=\"stopDrag\"\n          @pointerleave=\"stopDrag\"\n        >\n          <iframe src=\"/preview/node-red\" class=\"calibration-iframe\"></iframe>\n\n          <svg class=\"overlay-line\">\n            <line\n              :x1=\"markerA.x\"\n              :y1=\"markerA.y\"\n              :x2=\"markerB.x\"\n              :y2=\"markerB.y\"\n              stroke=\"red\"\n              stroke-width=\"2\"\n            />\n          </svg>\n\n          <!-- draggable markers -->\n          <div\n            class=\"marker\"\n            :style=\"{ left: markerA.x + 'px', top: markerA.y + 'px' }\"\n            @pointerdown=\"startDrag('A', $event)\"\n          ></div>\n\n          <div\n            class=\"marker\"\n            :style=\"{ left: markerB.x + 'px', top: markerB.y + 'px' }\"\n            @pointerdown=\"startDrag('B', $event)\"\n          ></div>\n\n          <!-- floating label -->\n          <div\n            class=\"distance-label\"\n            :style=\"{ left: midPoint.x + 'px', top: midPoint.y - 10 + 'px' }\"\n          >\n            {{ displayLabel }}\n          </div>\n        </v-card>\n      </v-col>\n\n      <!-- Control Panel (colonne 6/12) -->\n      <v-col cols=\"12\" md=\"4\">\n        <v-card class=\"px-4\">\n          <v-card-title class=\"text-left text-primary\">\n            Pixel Calibration\n          </v-card-title>\n\n          <v-divider class=\"mb-4\"></v-divider>\n\n          <section class=\"mb-6\">\n            <h3 class=\"text-subtitle-1 mb-2\">1. Place a ruler</h3>\n            <p class=\"text-caption mb-3\">\n              Place a ruler  beneath your <b>PlanktoScope</b> and reset the marker.\n            </p>\n            <v-btn color=\"error\" block class=\"mt-3\" @click=\"reset\">\n              Reset the positions of the markers\n            </v-btn>\n          </section>\n\n          <v-divider class=\"mb-4\"></v-divider>\n\n          <section class=\"mb-2\">\n            <h3 class=\"text-subtitle-1 mb-2\">2. Define the positions</h3>\n            <p class=\"text-caption mb-3\">\n              Drag the red line ends to match a known distance on the ruler.\n            </p>\n\n            <v-text-field\n              v-model=\"pixelDistanceDisplay\"\n              label=\"Measured distance (px)\"\n              variant=\"outlined\"\n              density=\"comfortable\"\n              readonly\n              :style=\"{ pointerEvents: 'none', userSelect: 'none', opacity: 0.7 }\"\n            ></v-text-field>\n          </section>\n\n          <v-divider class=\"mb-4\"></v-divider>\n\n          <section class=\"mb-2\">\n            <h3 class=\"text-subtitle-1 mb-2\">3. Enter known distance</h3>\n            <p class=\"text-caption mb-3\">\n              Enter the known distance in micrometers (m).\n            </p>\n\n            <v-text-field\n              v-model.number=\"knownDistance\"\n              label=\"Known distance (m)\"\n              type=\"number\"\n              variant=\"outlined\"\n              density=\"comfortable\"\n              class=\"highlight\"\n              @input=\"sendUpdate('calibration/update')\"\n            ></v-text-field>\n          </section>\n\n          <v-divider class=\"mb-4\"></v-divider>\n\n          <!-- Step 4 with dialog -->\n          <section class=\"mb-6\">\n            <h3 class=\"text-subtitle-1 mb-2\">4. Save your calibration</h3>\n            <p class=\"text-caption mb-3\">Click Save to store your calibration.</p>\n\n            <v-row dense align=\"center\">\n              <v-col cols=\"12\">\n                <v-text-field\n                  v-model=\"pixelSizeDisplay\"\n                  label=\"Real pixel size (m/pixel)\"\n                  readonly\n                  variant=\"outlined\"\n                  density=\"comfortable\"\n                  class=\"highlight\"\n                >\n                  <template #append>\n                    <v-icon\n                      class=\"cursor-pointer\"\n                      color=\"primary\"\n                      @click=\"showFormula = true\"\n                    >\n                      mdi-information\n                    </v-icon>\n                  </template>\n                </v-text-field>\n\n                <!-- Dialogue -->\n                <v-dialog v-model=\"showFormula\" max-width=\"500\">\n                  <v-card>\n                    <v-card-title class=\"text-h6\">Pixel Size Calculation</v-card-title>\n                    <v-card-text class=\"text-body-2\">\n                      <div><strong>Formula:</strong></div>\n                      <div>\n                        pixel_size = known_distance / (measured_distance  scale_factor)\n                      </div>\n\n                      <div class=\"mt-2\">\n                        = {{ knownDistance || '' }} /\n                        ({{ pixelDistanceDisplay || '' }} \n                        {{ scaleFactor ? scaleFactor.toFixed(3) : '' }}) =\n                        <strong>{{ pixelSizeDisplay || '' }} m/pixel</strong>\n                      </div>\n\n                      <v-divider class=\"my-3\"></v-divider>\n\n                      <div class=\"text-caption text-grey-darken-1\">\n                        <strong>Note:</strong><br />\n                        scale_factor = sensor_width / stream_width<br />\n                        = {{ sensorWidth || '' }} / {{ streamWidth || '' }}<br />\n                        = {{ scaleFactor ? scaleFactor.toFixed(3) : '' }}\n                      </div>\n                    </v-card-text>\n\n                    <v-card-actions>\n                      <v-spacer></v-spacer>\n                      <v-btn color=\"primary\" text @click=\"showFormula = false\">\n                        Close\n                      </v-btn>\n                    </v-card-actions>\n                  </v-card>\n                </v-dialog>\n              </v-col>\n            </v-row>\n\n            <v-btn\n              color=\"primary\"\n              block\n              class=\"mt-2\"\n              :disabled=\"!pixelSize\"\n              @click=\"saveCalibration\"\n            >\n              Save calibration\n            </v-btn>\n          </section>\n\n        </v-card>\n      </v-col>\n\n    </v-row>\n  </v-container>\n</template>\n\n\n<script>\nexport default {\n  props: [\"msg\"],\n  data() {\n    return {\n      markerA: { x: 250, y: 375 },\n      markerB: { x: 750, y: 375 },\n      dragging: null,\n      knownDistance: null,\n      pixelDistance: 0,\n      sensorWidth: 4056,\n      streamWidth: 1000,\n      scaleFactor: 4056 / 1000,\n      pixelSize: null,\n      scaleManual: false,\n      showFormula: false, //  Nouveau : tat du dialog\n    };\n  },\n  computed: {\n    midPoint() {\n      return {\n        x: (this.markerA.x + this.markerB.x) / 2,\n        y: (this.markerA.y + this.markerB.y) / 2,\n      };\n    },\n    pixelDistanceDisplay() {\n      return this.pixelDistance > 0 ? this.pixelDistance.toFixed(0) : \"\";\n    },\n    pixelSizeDisplay() {\n      return this.pixelSize ? this.pixelSize.toFixed(2) : \"\";\n    },\n    displayLabel() {\n      if (this.pixelSize)\n        return `${this.pixelSize.toFixed(2)} m/px`;\n      return `${this.pixelDistance.toFixed(0)} px`;\n    },\n  },\n  watch: {\n    msg: {\n      handler(newMsg) {\n        const p = newMsg?.payload || {};\n        if (p.calibration_pixel_size !== undefined) this.pixelSize = Number(p.calibration_pixel_size);\n        if (p.calibration_scale_factor !== undefined) this.scaleFactor = Number(p.calibration_scale_factor);\n        if (p.calibration_sensor_width !== undefined) this.sensorWidth = Number(p.calibration_sensor_width);\n        if (p.calibration_stream_width !== undefined) this.streamWidth = Number(p.calibration_stream_width);\n        if (p.calibration_known_distance !== undefined) this.knownDistance = Number(p.calibration_known_distance);\n        if (p.calibration_measured_distance !== undefined) this.pixelDistance = Number(p.calibration_measured_distance);\n        if (p.calibration_markerA_x !== undefined && p.calibration_markerA_y !== undefined)\n          this.markerA = { x: Number(p.calibration_markerA_x), y: Number(p.calibration_markerA_y) };\n        if (p.calibration_markerB_x !== undefined && p.calibration_markerB_y !== undefined)\n          this.markerB = { x: Number(p.calibration_markerB_x), y: Number(p.calibration_markerB_y) };\n      },\n      deep: true,\n    },\n    knownDistance() { this.autoCalculate(); },\n    scaleFactor() { this.autoCalculate(); },\n  },\n  mounted() {\n    this.updateScaleFactor();\n    this.updateDistance();\n  },\n  methods: {\n    sendUpdate(topic, extra = {}) {\n      if (typeof this.send === \"function\") {\n        this.send({\n          topic,\n          payload: {\n            calibration_pixel_size: this.round(this.pixelSize, 2),\n            calibration_scale_factor: this.round(this.scaleFactor, 3),\n            calibration_sensor_width: Math.round(this.sensorWidth),\n            calibration_stream_width: Math.round(this.streamWidth),\n            calibration_known_distance: this.round(this.knownDistance, 2),\n            calibration_measured_distance: Math.round(this.pixelDistance),\n            calibration_markerA_x: this.round(this.markerA.x, 1),\n            calibration_markerA_y: this.round(this.markerA.y, 1),\n            calibration_markerB_x: this.round(this.markerB.x, 1),\n            calibration_markerB_y: this.round(this.markerB.y, 1),\n            ...extra,\n          },\n        });\n      }\n    },\n    round(value, digits = 2) {\n      if (typeof value !== \"number\" || isNaN(value)) return 0;\n      const factor = 10 ** digits;\n      return Math.round(value * factor) / factor;\n    },\n    startDrag(marker, e) {\n      e.preventDefault();\n      this.dragging = marker;\n      e.target.setPointerCapture(e.pointerId);\n    },\n    onPointerMove(e) {\n      if (!this.dragging) return;\n      const container = this.$el.querySelector(\".calibration-container\");\n      const rect = container.getBoundingClientRect();\n      const x = Math.max(0, Math.min(e.clientX - rect.left, rect.width));\n      const y = Math.max(0, Math.min(e.clientY - rect.top, rect.height));\n      this[`marker${this.dragging}`] = { x, y };\n      this.updateDistance();\n      this.sendUpdate(\"calibration/live\");\n    },\n    stopDrag() {\n      this.dragging = null;\n    },\n    updateDistance() {\n      const dx = this.markerB.x - this.markerA.x;\n      const dy = this.markerB.y - this.markerA.y;\n      this.pixelDistance = Math.sqrt(dx * dx + dy * dy);\n      this.autoCalculate();\n    },\n    updateScaleFactor() {\n      if (!this.scaleManual && this.sensorWidth > 0 && this.streamWidth > 0) {\n        this.scaleFactor = this.sensorWidth / this.streamWidth;\n        this.autoCalculate();\n      }\n    },\n    manualScaleFactor() {\n      this.scaleManual = true;\n      this.autoCalculate();\n    },\n    autoCalculate() {\n      const { knownDistance, pixelDistance, scaleFactor } = this;\n      if (knownDistance > 0 && pixelDistance > 0 && scaleFactor > 0) {\n        const realDist = pixelDistance * scaleFactor;\n        this.pixelSize = knownDistance / realDist;\n      } else {\n        this.pixelSize = null;\n      }\n    },\n    reset() {\n      this.markerA = { x: 250, y: 375 };\n      this.markerB = { x: 750, y: 375 };\n      this.knownDistance = null;\n      this.pixelDistance = 0;\n      this.pixelSize = null;\n      this.dragging = null;\n      this.scaleManual = false;\n      this.updateScaleFactor();\n      this.updateDistance();\n      this.sendUpdate(\"calibration/reset\");\n    },\n    saveCalibration() {\n      if (this.pixelSize > 0) this.sendUpdate(\"calibration/save\");\n    },\n  },\n};\n</script>\n\n<style scoped>\n.calibration-iframe {\n  position: absolute;\n  top: 0;\n  left: 0;\n  width: 1000px;\n  height: 750px;\n  border: none;\n  pointer-events: none;\n}\n.overlay-line {\n  position: absolute;\n  width: 100%;\n  height: 100%;\n  pointer-events: none;\n}\n.marker {\n  position: absolute;\n  width: 24px;\n  height: 24px;\n  transform: translate(-50%, -50%);\n  cursor: crosshair;\n  touch-action: none;\n}\n.marker::before,\n.marker::after {\n  content: \"\";\n  position: absolute;\n  background: red;\n}\n.marker::before {\n  width: 2px;\n  height: 24px;\n  left: 50%;\n  top: 0;\n  transform: translateX(-50%);\n}\n.marker::after {\n  width: 24px;\n  height: 2px;\n  top: 50%;\n  left: 0;\n  transform: translateY(-50%);\n}\n.distance-label {\n  position: absolute;\n  color: white;\n  font-size: 16px;\n  background: rgba(0, 0, 0, 0.7);\n  padding: 4px 10px;\n  border-radius: 6px;\n  pointer-events: none;\n  transform: translate(-50%, -50%);\n}\n.highlight input {\n  background-color: #e3f2fd !important;\n  font-weight: 600;\n}\n</style>\n",
        "storeOutMessages": true,
        "passthru": true,
        "resendOnRefresh": true,
        "templateScope": "local",
        "className": "",
        "x": 420,
        "y": 140,
        "wires": [
            [
                "a30cdd39d7c3b802"
            ]
        ]
    },
    {
        "id": "d10ef113c9a4b297",
        "type": "ui-event",
        "z": "3afb1d2b21be9114",
        "ui": "e6ae26617c24c3ea",
        "name": "UI Event",
        "x": 80,
        "y": 40,
        "wires": [
            [
                "78cf0ca00b9e1214"
            ]
        ]
    },
    {
        "id": "78cf0ca00b9e1214",
        "type": "switch",
        "z": "3afb1d2b21be9114",
        "name": "msg.topic === \"$pageview\"",
        "property": "topic",
        "propertyType": "msg",
        "rules": [
            {
                "t": "eq",
                "v": "$pageview",
                "vt": "str"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 1,
        "x": 280,
        "y": 40,
        "wires": [
            [
                "943c62c18d43f2a6"
            ]
        ]
    },
    {
        "id": "943c62c18d43f2a6",
        "type": "switch",
        "z": "3afb1d2b21be9114",
        "name": "msg.payload.page.path === \"/calibration_pixel_size\"",
        "property": "payload.page.path",
        "propertyType": "msg",
        "rules": [
            {
                "t": "eq",
                "v": "/calibration_pixel_size",
                "vt": "str"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 1,
        "x": 620,
        "y": 40,
        "wires": [
            [
                "0deb8e29532f1503"
            ]
        ]
    },
    {
        "id": "0deb8e29532f1503",
        "type": "function",
        "z": "3afb1d2b21be9114",
        "name": "Get Global Variables",
        "func": "const keys = global.keys(); // Get all global variable keys\nmsg.payload = {}; // Initialize the payload object\n\nkeys.forEach(key => {\n    // Ignore keys that start with \"$\"\n    if (!key.startsWith('$')) {\n        msg.payload[key] = global.get(key);\n    }\n});\n\nreturn msg;\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 120,
        "y": 140,
        "wires": [
            [
                "2352be52ae097a08"
            ]
        ]
    },
    {
        "id": "a30cdd39d7c3b802",
        "type": "switch",
        "z": "3afb1d2b21be9114",
        "name": "",
        "property": "topic",
        "propertyType": "msg",
        "rules": [
            {
                "t": "eq",
                "v": "calibration/save",
                "vt": "str"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 1,
        "x": 590,
        "y": 140,
        "wires": [
            [
                "13cda406d9feacec"
            ]
        ]
    },
    {
        "id": "13cda406d9feacec",
        "type": "function",
        "z": "3afb1d2b21be9114",
        "name": "set calibration_pixel_size",
        "func": "if (msg.topic) {\n    global.set(\"process_pixel\", msg.payload.calibration_pixel_size);\n    global.set(\"calibration_pixel_size\", msg.payload.calibration_pixel_size);\n    global.set(\"calibration_scale_factor\", msg.payload.calibration_scale_factor);\n    global.set(\"calibration_sensor_width\", msg.payload.calibration_sensor_width);\n    global.set(\"calibration_stream_width\", msg.payload.calibration_stream_width);\n    global.set(\"calibration_known_distance\", msg.payload.calibration_known_distance);\n    global.set(\"calibration_measured_distance\", msg.payload.calibration_measured_distance);\n    global.set(\"calibration_markerA_x\", msg.payload.calibration_markerA_x);\n    global.set(\"calibration_markerA_y\", msg.payload.calibration_markerA_y);\n    global.set(\"calibration_markerB_x\", msg.payload.calibration_markerB_x);\n    global.set(\"calibration_markerB_y\", msg.payload.calibration_markerB_y);\n}\nreturn msg;\n",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1010,
        "y": 180,
        "wires": [
            []
        ]
    },
    {
        "id": "c92cd7e25b01278d",
        "type": "ui-template",
        "z": "d5b2c64b84f8ed4f",
        "g": "0861054b07c3373d",
        "group": "6039d653304537af",
        "page": "",
        "ui": "",
        "name": "Step Bar",
        "order": 1,
        "width": 0,
        "height": 0,
        "head": "",
        "format": "<template>\n  <div>\n    <v-stepper class=\"my-stepper\" model-value=\"4\" non-linear>\n      <v-stepper-header>\n        <v-stepper-item value=\"1\" editable @click=\"stepClicked(1)\" color=\"grey\">Saturation Level</v-stepper-item>\n        <v-divider></v-divider>\n        <v-stepper-item value=\"2\" editable @click=\"stepClicked(2)\" color=\"grey\">Lightness</v-stepper-item>\n        <v-divider></v-divider>\n        <v-stepper-item value=\"3\" editable @click=\"stepClicked(3)\" color=\"grey\">Pixel size</v-stepper-item>\n        <v-divider></v-divider>\n        <v-stepper-item value=\"4\" editable @click=\"stepClicked(4)\" class=\"selected-step\" color=\"primary\">Pump</v-stepper-item>\n      </v-stepper-header>\n    </v-stepper>\n  </div>\n</template>\n\n<script>\n  export default {\n    name: 'StepperComponent',\n    methods: {\n      stepClicked(step) {\n        const stepMapping = {\n          1: { page: 'Calibration - Saturation Level' },\n          2: { page: 'Calibration - Lightness' },\n          3: { page: 'Calibration - Pixel size' },\n          4: { page: 'Calibration - Pump' }\n        };\n\n        const msgPayload = stepMapping[step] || {};\n        \n        this.send({ payload: msgPayload });\n      }\n    }\n  }\n</script>\n",
        "storeOutMessages": true,
        "passthru": true,
        "resendOnRefresh": true,
        "templateScope": "local",
        "className": "",
        "x": 1080,
        "y": 60,
        "wires": [
            [
                "f8db1578262f6bc8"
            ]
        ]
    },
    {
        "id": "f8db1578262f6bc8",
        "type": "ui-control",
        "z": "d5b2c64b84f8ed4f",
        "g": "0861054b07c3373d",
        "name": "",
        "ui": "e6ae26617c24c3ea",
        "events": "all",
        "x": 1280,
        "y": 60,
        "wires": [
            []
        ]
    },
    {
        "id": "b69414b64961f4e9",
        "type": "ui-event",
        "z": "d5b2c64b84f8ed4f",
        "ui": "e6ae26617c24c3ea",
        "name": "UI Event",
        "x": 80,
        "y": 40,
        "wires": [
            [
                "2e99999b7cf152b7"
            ]
        ]
    },
    {
        "id": "2e99999b7cf152b7",
        "type": "switch",
        "z": "d5b2c64b84f8ed4f",
        "name": "msg.topic === \"$pageview\"",
        "property": "topic",
        "propertyType": "msg",
        "rules": [
            {
                "t": "eq",
                "v": "$pageview",
                "vt": "str"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 1,
        "x": 280,
        "y": 40,
        "wires": [
            [
                "138136e6a1917e49"
            ]
        ]
    },
    {
        "id": "138136e6a1917e49",
        "type": "switch",
        "z": "d5b2c64b84f8ed4f",
        "name": "msg.payload.page.path === \"/calibration_pump\"",
        "property": "payload.page.path",
        "propertyType": "msg",
        "rules": [
            {
                "t": "eq",
                "v": "/calibration_pump",
                "vt": "str"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 1,
        "x": 610,
        "y": 40,
        "wires": [
            []
        ]
    },
    {
        "id": "0a0c441d1757b9d2",
        "type": "function",
        "z": "d5b2c64b84f8ed4f",
        "name": "Get Global Variables",
        "func": "const keys = global.keys(); // Get all global variable keys\nmsg.payload = {}; // Initialize the payload object\n\nkeys.forEach(key => {\n    // Ignore keys that start with \"$\"\n    if (!key.startsWith('$')) {\n        msg.payload[key] = global.get(key);\n    }\n});\n\nreturn msg;\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 120,
        "y": 140,
        "wires": [
            [
                "1bd39bfcfab012fe"
            ]
        ]
    },
    {
        "id": "1bd39bfcfab012fe",
        "type": "ui-template",
        "z": "d5b2c64b84f8ed4f",
        "group": "6039d653304537af",
        "page": "",
        "ui": "",
        "name": "Calibration - Pump",
        "order": 2,
        "width": "0",
        "height": "0",
        "head": "",
        "format": "<template>\n  <v-container class=\"py-6 d-flex flex-column align-center\" style=\"gap: 24px;\">\n    <v-card width=\"440\" class=\"px-4\">\n      <v-card-title class=\"text-left text-primary\">Pump Calibration</v-card-title>\n      <v-divider class=\"mb-4\"></v-divider>\n\n      <!-- Step 1 -->\n      <section class=\"mb-6\">\n        <h3 class=\"text-subtitle-1 mb-2\">1. Place a scale</h3>\n        <p class=\"text-caption mb-3\">Place a scale  beneath the waste container.</p>\n      </section>\n\n      <v-divider class=\"mb-4\"></v-divider>\n      <!-- Step 2 -->\n      <section class=\"mb-6\">\n        <h3 class=\"text-subtitle-1 mb-2\">2. Run a liquid transfer</h3>\n        <p class=\"text-caption mb-3\">Run a liquid transfer to collect a known volume.</p>\n\n        <v-row dense align=\"center\">\n          <v-col cols=\"12\">\n            <v-text-field\n              v-model.number=\"targetVolume\"\n              label=\"Target Volume (mL)\"\n              type=\"number\"\n              variant=\"outlined\"\n              density=\"comfortable\"\n              min=\"0\"\n            />\n          </v-col>\n\n          <v-col cols=\"6\">\n            <v-btn\n              color=\"error\"\n              block\n              @click=\"stopPump\"\n              :disabled=\"!pumpRunning\"\n            >\n               Stop Pump\n            </v-btn>\n          </v-col>\n\n          <v-col cols=\"6\">\n            <v-btn\n              color=\"primary\"\n              block\n              @click=\"runTransferTest\"\n              :loading=\"pumpRunning\"\n              :disabled=\"pumpRunning\"\n            >\n              Run Test\n            </v-btn>\n          </v-col>\n        </v-row>\n      </section>\n\n      <v-divider class=\"mb-4\"></v-divider>\n      <!-- Step 3 -->\n      <section class=\"mb-0\">\n        <h3 class=\"text-subtitle-1 mb-2\">3. Measure the weight</h3>\n        <p class=\"text-caption mb-3\">\n          Enter the measured weight in milliliters (mL).\n        </p>\n\n        <v-row dense align=\"center\">\n          <v-col cols=\"7\">\n            <v-text-field\n              v-model.number=\"measuredVolume\"\n              label=\"Measured Volume (mL)\"\n              type=\"number\"\n              variant=\"outlined\"\n              density=\"comfortable\"\n              min=\"0\"\n              :disabled=\"!pumpDone\"\n            />\n          </v-col>\n\n          <v-col cols=\"5\" class=\"mb-6\">\n            <v-alert\n              v-if=\"pumpDone\"\n              color=\"error\"\n              variant=\"tonal\"\n              class=\"pa-3 text-caption text-primary-darken-3\"\n            >\n              <strong>Delta:</strong> {{ errorVolume.toFixed(2) }} mL\n            </v-alert>\n          </v-col>\n        </v-row>\n      </section>\n\n      <v-divider class=\"mb-4\"></v-divider>\n      <!-- Step 4 -->\n      <section class=\"mb-0\">\n        <h3 class=\"text-subtitle-1 mb-2\">4. Save your calibration.</h3>\n        <p class=\"text-caption mb-3\">\n          Click <b>Save</b> to store your calibration.\n        </p>\n\n        <div class=\"mb-3\">\n          <v-text-field\n            v-model.number=\"currentSteps\"\n            label=\"Current steps per 1 mL (S)\"\n            type=\"number\"\n            variant=\"outlined\"\n            density=\"comfortable\"\n            min=\"1\"\n            :disabled=\"!pumpDone\"\n\n          readonly\n          :style=\"{ pointerEvents: 'none', userSelect: 'none', opacity: 0.7 }\"\n          />\n        </div>\n\n        <div class=\"mb-3 d-flex align-center\">\n\n          <v-text-field\n            v-model.number=\"suggestedSteps\"\n            label=\"Suggested steps per 1 mL (S)\"\n            type=\"number\"\n            variant=\"outlined\"\n            density=\"comfortable\"\n            min=\"1\"\n            :disabled=\"!pumpDone\"\n    class=\"highlight\"\n\n  >\n    <!-- Icne append avec dialogue -->\n    <template #append>\n      <v-icon\n        class=\"cursor-pointer\"\n        color=\"primary\"\n        @click=\"dialog = true\"\n      >\n        mdi-information\n      </v-icon>\n    </template>\n          </v-text-field>\n        </div>\n      </section>\n\n      <section class=\"mb-6\">\n          <v-btn\n            color=\"primary\"\n            block\n            @click=\"validateCalibration\"\n            :disabled=\"!pumpDone\"\n          >\n            Validate\n          </v-btn>\n\n        <!-- Dialog with formula -->\n        <v-dialog v-model=\"dialog\" max-width=\"480\">\n          <v-card>\n            <v-card-title class=\"text-h6 text-primary\">Formula</v-card-title>\n            <v-card-text class=\"text-body-2\">\n              <p><strong>Suggested steps per 1 mL = (Volume to transfer (Y) / Transferred volume (X))  Current steps (S)</strong></p>\n              <p>\n                (Y / X)  S = ({{ targetVolume }} / {{ measuredVolume }})  {{ currentSteps }} = \n                <b>{{ suggestedSteps.toFixed(0) }}</b> steps\n              </p>\n            </v-card-text>\n            <v-card-actions>\n              <v-spacer></v-spacer>\n              <v-btn text color=\"primary\" @click=\"dialog = false\">Close</v-btn>\n            </v-card-actions>\n          </v-card>\n        </v-dialog>\n      </section>\n    </v-card>\n  </v-container>\n</template>\n\n<script>\nexport default {\n  props: [\"msg\"],\n  data() {\n    return {\n      targetVolume: 10, // Y\n      measuredVolume: 0, // X\n      currentSteps: 507, // S\n      pumpRunning: false,\n      pumpDone: false,\n      dialog: false,\n    };\n  },\n  computed: {\n    errorVolume() {\n      return this.targetVolume - this.measuredVolume;\n    },\n    suggestedSteps() {\n      const { targetVolume, measuredVolume, currentSteps } = this;\n      if (measuredVolume <= 0) return currentSteps;\n      return Math.round((targetVolume / measuredVolume) * currentSteps);\n    },\n  },\n  watch: {\n    msg: {\n      handler(newMsg) {\n        const topic = newMsg?.topic;\n        const payload = newMsg?.payload || {};\n        if (topic === \"status/pump\" && payload.status === \"Done\") {\n          this.pumpRunning = false;\n          this.pumpDone = true;\n        }\n      },\n      deep: true,\n    },\n  },\n  methods: {\n    sendUpdate(topic, extra = {}) {\n      if (typeof this.send === \"function\") {\n        this.send({ topic, payload: { ...extra } });\n      }\n    },\n    runTransferTest() {\n      this.pumpDone = false;\n      this.pumpRunning = true;\n      this.sendUpdate(\"actuator/pump\", {\n        action: \"move\",\n        direction: \"FORWARD\",\n        volume: this.targetVolume,\n        flowrate: 1,\n      });\n    },\n    stopPump() {\n      this.sendUpdate(\"actuator/pump\", { action: \"stop\" });\n      this.pumpRunning = false;\n    },\n    validateCalibration() {\n      const steps = Math.round(this.suggestedSteps);\n      this.sendUpdate(\"calibration/save\", {\n        calibration_nb_step: steps,\n      });\n    },\n  },\n};\n</script>\n<style>\n\n.highlight input {\n  background-color: #e3f2fd !important;\n  font-weight: 600;\n}\n</style>",
        "storeOutMessages": true,
        "passthru": true,
        "resendOnRefresh": true,
        "templateScope": "local",
        "className": "",
        "x": 410,
        "y": 140,
        "wires": [
            [
                "b4d023d76ef0504c"
            ]
        ]
    },
    {
        "id": "f2348c422d051cc9",
        "type": "mqtt out",
        "z": "d5b2c64b84f8ed4f",
        "name": "",
        "topic": "",
        "qos": "",
        "retain": "",
        "broker": "8dc3722c.06efa8",
        "x": 850,
        "y": 100,
        "wires": []
    },
    {
        "id": "b4d023d76ef0504c",
        "type": "switch",
        "z": "d5b2c64b84f8ed4f",
        "name": "",
        "property": "topic",
        "propertyType": "msg",
        "rules": [
            {
                "t": "eq",
                "v": "actuator/pump",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "calibration/save",
                "vt": "str"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 2,
        "x": 610,
        "y": 140,
        "wires": [
            [
                "f2348c422d051cc9"
            ],
            [
                "486bc5c0891a3a15"
            ]
        ]
    },
    {
        "id": "b49a9221938d1621",
        "type": "mqtt in",
        "z": "d5b2c64b84f8ed4f",
        "name": "",
        "topic": "status/pump",
        "qos": "0",
        "datatype": "json",
        "broker": "8dc3722c.06efa8",
        "nl": false,
        "rap": false,
        "inputs": 0,
        "x": 90,
        "y": 340,
        "wires": [
            [
                "1bd39bfcfab012fe"
            ]
        ]
    },
    {
        "id": "486bc5c0891a3a15",
        "type": "function",
        "z": "d5b2c64b84f8ed4f",
        "name": "set calibration_pump",
        "func": "if (msg.topic) {\n    global.set(\"calibration_nb_step\", msg.payload.calibration_nb_step);\n}\nreturn msg;\n",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1000,
        "y": 180,
        "wires": [
            []
        ]
    },
    {
        "id": "7ccb5c8c66ad170a",
        "type": "inject",
        "z": "a02961610bc3982a",
        "g": "153af3e4645145a8",
        "name": "inject",
        "props": [
            {
                "p": "payload.timezone",
                "v": "Europe/Paris",
                "vt": "str"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "",
        "x": 110,
        "y": 280,
        "wires": [
            [
                "89c198d4d49eca98"
            ]
        ]
    },
    {
        "id": "7bf0f35f3f491657",
        "type": "set timezone",
        "z": "a02961610bc3982a",
        "g": "153af3e4645145a8",
        "name": "",
        "x": 340,
        "y": 380,
        "wires": [
            [
                "2fe0de4d0d304630"
            ]
        ]
    },
    {
        "id": "89c198d4d49eca98",
        "type": "list timezones",
        "z": "a02961610bc3982a",
        "g": "153af3e4645145a8",
        "name": "",
        "x": 140,
        "y": 360,
        "wires": [
            [
                "7bf0f35f3f491657"
            ]
        ]
    },
    {
        "id": "2fe0de4d0d304630",
        "type": "get timezone",
        "z": "a02961610bc3982a",
        "g": "153af3e4645145a8",
        "name": "",
        "x": 540,
        "y": 400,
        "wires": [
            []
        ]
    },
    {
        "id": "abc662f31074fc22",
        "type": "inject",
        "z": "a02961610bc3982a",
        "g": "3bb20cd87e85a6b8",
        "name": "inject",
        "props": [
            {
                "p": "payload.country",
                "v": "FR",
                "vt": "str"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "",
        "x": 110,
        "y": 60,
        "wires": [
            [
                "d082d59bfaddcd80"
            ]
        ]
    },
    {
        "id": "d082d59bfaddcd80",
        "type": "list countries",
        "z": "a02961610bc3982a",
        "g": "3bb20cd87e85a6b8",
        "name": "",
        "x": 140,
        "y": 140,
        "wires": [
            [
                "9f5061a034f606a3"
            ]
        ]
    },
    {
        "id": "9f5061a034f606a3",
        "type": "set country",
        "z": "a02961610bc3982a",
        "g": "3bb20cd87e85a6b8",
        "name": "",
        "x": 330,
        "y": 160,
        "wires": [
            [
                "1f6f854383bffbc8"
            ]
        ]
    },
    {
        "id": "1f6f854383bffbc8",
        "type": "get country",
        "z": "a02961610bc3982a",
        "g": "3bb20cd87e85a6b8",
        "name": "",
        "x": 510,
        "y": 180,
        "wires": [
            []
        ]
    },
    {
        "id": "1433d7bb97c2b52e",
        "type": "inject",
        "z": "a02961610bc3982a",
        "g": "3fe3efd04fb1a41a",
        "name": "inject",
        "props": [],
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "",
        "x": 110,
        "y": 700,
        "wires": [
            [
                "58b352badddb48f5"
            ]
        ]
    },
    {
        "id": "58b352badddb48f5",
        "type": "get hostname",
        "z": "a02961610bc3982a",
        "g": "3fe3efd04fb1a41a",
        "name": "",
        "x": 140,
        "y": 760,
        "wires": [
            []
        ]
    },
    {
        "id": "39cd9534b43ef484",
        "type": "get name",
        "z": "a02961610bc3982a",
        "g": "9c49d230dea06fdf",
        "name": "",
        "x": 130,
        "y": 920,
        "wires": [
            []
        ]
    },
    {
        "id": "79d35d7ad73f89f9",
        "type": "inject",
        "z": "a02961610bc3982a",
        "g": "9c49d230dea06fdf",
        "name": "",
        "props": [],
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "",
        "x": 110,
        "y": 860,
        "wires": [
            [
                "39cd9534b43ef484"
            ]
        ]
    },
    {
        "id": "959839bc2c390088",
        "type": "storage info",
        "z": "a02961610bc3982a",
        "g": "27e22d982f0bcb2f",
        "name": "",
        "x": 530,
        "y": 920,
        "wires": [
            []
        ]
    },
    {
        "id": "0d10e66bb2b9d1cc",
        "type": "inject",
        "z": "a02961610bc3982a",
        "g": "27e22d982f0bcb2f",
        "name": "inject",
        "props": [],
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "",
        "x": 510,
        "y": 860,
        "wires": [
            [
                "959839bc2c390088"
            ]
        ]
    },
    {
        "id": "29b3163c363f83d7",
        "type": "list hardware versions",
        "z": "a02961610bc3982a",
        "g": "cef91df1f697848e",
        "name": "",
        "x": 170,
        "y": 560,
        "wires": [
            [
                "28f8ab1b6c179786"
            ]
        ]
    },
    {
        "id": "19da48e7c9119862",
        "type": "get hardware version",
        "z": "a02961610bc3982a",
        "g": "cef91df1f697848e",
        "name": "",
        "x": 660,
        "y": 600,
        "wires": [
            []
        ]
    },
    {
        "id": "28f8ab1b6c179786",
        "type": "set hardware version",
        "z": "a02961610bc3982a",
        "g": "cef91df1f697848e",
        "name": "",
        "x": 420,
        "y": 580,
        "wires": [
            [
                "19da48e7c9119862"
            ]
        ]
    },
    {
        "id": "4966524cdc764174",
        "type": "inject",
        "z": "a02961610bc3982a",
        "g": "cef91df1f697848e",
        "name": "inject",
        "props": [
            {
                "p": "payload.hardware_version",
                "v": "v3.0",
                "vt": "str"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "",
        "x": 110,
        "y": 500,
        "wires": [
            [
                "29b3163c363f83d7"
            ]
        ]
    },
    {
        "id": "0e1835e8b7c470ee",
        "type": "comment",
        "z": "a02961610bc3982a",
        "g": "3bb20cd87e85a6b8",
        "name": "country",
        "info": "",
        "x": 690,
        "y": 60,
        "wires": []
    },
    {
        "id": "bcdab829fb50bc57",
        "type": "comment",
        "z": "a02961610bc3982a",
        "g": "153af3e4645145a8",
        "name": "timezone",
        "info": "",
        "x": 740,
        "y": 280,
        "wires": []
    },
    {
        "id": "f640495d00bb68b9",
        "type": "comment",
        "z": "a02961610bc3982a",
        "g": "cef91df1f697848e",
        "name": "hardware version",
        "info": "",
        "x": 840,
        "y": 500,
        "wires": []
    },
    {
        "id": "1f1c86a14bf3ac61",
        "type": "comment",
        "z": "a02961610bc3982a",
        "g": "3fe3efd04fb1a41a",
        "name": "hostname",
        "info": "",
        "x": 300,
        "y": 700,
        "wires": []
    },
    {
        "id": "7e293f564d4fbfc4",
        "type": "comment",
        "z": "a02961610bc3982a",
        "g": "9c49d230dea06fdf",
        "name": "name",
        "info": "",
        "x": 310,
        "y": 860,
        "wires": []
    },
    {
        "id": "53516cda8e4f5a3c",
        "type": "comment",
        "z": "a02961610bc3982a",
        "g": "27e22d982f0bcb2f",
        "name": "storage",
        "info": "",
        "x": 690,
        "y": 860,
        "wires": []
    },
    {
        "id": "c34bff0e83b45e68",
        "type": "poweroff",
        "z": "a02961610bc3982a",
        "g": "fc6b573a63d6dfaa",
        "name": "",
        "x": 1180,
        "y": 140,
        "wires": [
            []
        ]
    },
    {
        "id": "dc07c747a235da10",
        "type": "reboot",
        "z": "a02961610bc3982a",
        "g": "fc6b573a63d6dfaa",
        "name": "",
        "x": 1180,
        "y": 200,
        "wires": [
            []
        ]
    },
    {
        "id": "f12fd63508bb1b63",
        "type": "inject",
        "z": "a02961610bc3982a",
        "g": "fc6b573a63d6dfaa",
        "name": "inject",
        "props": [],
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "",
        "x": 1030,
        "y": 140,
        "wires": [
            [
                "c34bff0e83b45e68"
            ]
        ]
    },
    {
        "id": "2babe27c1bf9d6ef",
        "type": "inject",
        "z": "a02961610bc3982a",
        "g": "fc6b573a63d6dfaa",
        "name": "inject",
        "props": [],
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "",
        "x": 1030,
        "y": 200,
        "wires": [
            [
                "dc07c747a235da10"
            ]
        ]
    },
    {
        "id": "15f16463c05bb479",
        "type": "comment",
        "z": "a02961610bc3982a",
        "g": "fc6b573a63d6dfaa",
        "name": "system ",
        "info": "",
        "x": 1200,
        "y": 80,
        "wires": []
    },
    {
        "id": "94a433cec8b54203",
        "type": "wake up",
        "z": "a02961610bc3982a",
        "g": "fc6b573a63d6dfaa",
        "name": "",
        "minutes": "2",
        "x": 1180,
        "y": 260,
        "wires": [
            []
        ]
    },
    {
        "id": "b552ca516cc07737",
        "type": "inject",
        "z": "a02961610bc3982a",
        "g": "fc6b573a63d6dfaa",
        "name": "inject",
        "props": [],
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "",
        "x": 1030,
        "y": 260,
        "wires": [
            [
                "94a433cec8b54203"
            ]
        ]
    },
    {
        "id": "61ebceb724041fb2",
        "type": "list acquisitions",
        "z": "a02961610bc3982a",
        "g": "dc792afbab434446",
        "name": "",
        "x": 1120,
        "y": 600,
        "wires": [
            []
        ]
    },
    {
        "id": "50128147f802f133",
        "type": "inject",
        "z": "a02961610bc3982a",
        "g": "dc792afbab434446",
        "name": "inject",
        "props": [],
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "",
        "x": 1090,
        "y": 540,
        "wires": [
            [
                "61ebceb724041fb2"
            ]
        ]
    },
    {
        "id": "b9c2e0abaad12bd9",
        "type": "comment",
        "z": "a02961610bc3982a",
        "g": "dc792afbab434446",
        "name": "acquisitions",
        "info": "",
        "x": 1310,
        "y": 540,
        "wires": []
    },
    {
        "id": "300343e6b56f088e",
        "type": "inject",
        "z": "a02961610bc3982a",
        "g": "dc307bb5d26c60f4",
        "name": "inject",
        "props": [],
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "",
        "x": 1090,
        "y": 700,
        "wires": [
            [
                "7d1f9414be49d7c3"
            ]
        ]
    },
    {
        "id": "da645aa8ebbed646",
        "type": "comment",
        "z": "a02961610bc3982a",
        "g": "dc307bb5d26c60f4",
        "name": "segmentations",
        "info": "",
        "x": 1300,
        "y": 700,
        "wires": []
    },
    {
        "id": "7d1f9414be49d7c3",
        "type": "list segmentations",
        "z": "a02961610bc3982a",
        "g": "dc307bb5d26c60f4",
        "name": "",
        "x": 1130,
        "y": 760,
        "wires": [
            []
        ]
    },
    {
        "id": "f7c18ab2aa687120",
        "type": "get machine info",
        "z": "a02961610bc3982a",
        "g": "855d9ef468b5db0f",
        "name": "",
        "x": 150,
        "y": 1080,
        "wires": [
            [
                "9249e16ed7ae4929"
            ]
        ]
    },
    {
        "id": "ede7a86fd97b5e1b",
        "type": "inject",
        "z": "a02961610bc3982a",
        "g": "855d9ef468b5db0f",
        "name": "inject",
        "props": [],
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "",
        "x": 110,
        "y": 1020,
        "wires": [
            [
                "f7c18ab2aa687120"
            ]
        ]
    },
    {
        "id": "af8ce4702c170449",
        "type": "comment",
        "z": "a02961610bc3982a",
        "g": "855d9ef468b5db0f",
        "name": "machine info",
        "info": "",
        "x": 290,
        "y": 1020,
        "wires": []
    },
    {
        "id": "a98bde5f8940edbc",
        "type": "inject",
        "z": "a02961610bc3982a",
        "g": "91f8b76bf61fc59c",
        "name": "",
        "props": [],
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "",
        "x": 1090,
        "y": 860,
        "wires": [
            [
                "59ec9623add53a47"
            ]
        ]
    },
    {
        "id": "59ec9623add53a47",
        "type": "capture",
        "z": "a02961610bc3982a",
        "g": "91f8b76bf61fc59c",
        "name": "",
        "x": 1100,
        "y": 920,
        "wires": [
            []
        ]
    },
    {
        "id": "750a1061c84bdae2",
        "type": "comment",
        "z": "a02961610bc3982a",
        "g": "91f8b76bf61fc59c",
        "name": "camera",
        "info": "",
        "x": 1330,
        "y": 860,
        "wires": []
    },
    {
        "id": "9249e16ed7ae4929",
        "type": "debug",
        "z": "a02961610bc3982a",
        "g": "855d9ef468b5db0f",
        "name": "debug 10",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "false",
        "statusVal": "",
        "statusType": "auto",
        "x": 470,
        "y": 1100,
        "wires": []
    }
]