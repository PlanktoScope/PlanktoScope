setup:
    # # smbus is needed by some python3 nodes in the Node-RED dashboard for the Adafruit HAT.
    # Since the Node-RED systemd service runs as the pi user by default (and we don't override that
    # default, we do `pip3 install` as the pi user. This makes the smbus2 module available to Node-RED.
    # FIXME: get rid of the Node-RED nodes depending on smbus! That functionality should be moved into
    # the Python backend.
    sudo apt install -y python3-smbus2
    npm list -g node-red@4.1.1 || npm install -g node-red@v4.1.1
    npm install --omit=dev
    sudo cp nodered.service /etc/systemd/system/
    sudo mkdir -p /etc/systemd/system/nodered.service.d
    sudo cp 30-override.conf /etc/systemd/system/nodered.service.d/
    sudo systemctl reenable nodered
    sudo systemctl restart nodered
    rm -rf /home/pi/.node-red

setup-dev:
    npm install --include=dev

dev:
    -sudo systemctl stop nodered
    node --watch-path ~/PlanktoScope/node-red/nodes/ ~/.local/bin/node-red --settings ~/PlanktoScope/node-red/settings.cjs

test:
    validator projects/adafruithat/flows.json
    validator projects/planktoscopehat/flows.json
    validator projects/dashboard/flows.json
    npx eslint .
    cd nodes && node --test

# Too many errors for now
# cd node-red && npx nrlint projects/adafruithat/flows.json
# cd node-red && npx nrlint projects/planktoscopehat/flows.json
# cd node-red && npx nrlint projects/dashboard/flows.json
