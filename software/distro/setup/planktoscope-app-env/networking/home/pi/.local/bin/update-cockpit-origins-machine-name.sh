#!/bin/bash -eux

serial_number="$(tr -d '\0' < /sys/firmware/devicetree/base/serial-number | cut -c 9-)"
machine_name="$(/home/pi/.local/bin/machine-name name --format=hex --sn="$serial_number")"

# Update /home/pi/.local/etc/cockpit/origins
echo "# Autogenerated file - edit the origins-*.snippet files instead!" \
  > /home/pi/.local/etc/cockpit/origins
echo "# Note: this file is not used directly by Cockpit; instead, it's used as an intermediate representation to generate the Origins setting in the Cockpit configuration file" \
  >> /home/pi/.local/etc/cockpit/origins
cat /home/pi/.local/etc/cockpit/origins-base.snippet >> /home/pi/.local/etc/cockpit/origins
sed "s/machine-name/$machine_name/g" /home/pi/.local/etc/cockpit/origins-machine-name.snippet \
  >> /home/pi/.local/etc/cockpit/origins

# Update /etc/cockpit/cockpit.conf
origins="$(sed 's/#.*$//g' /home/pi/.local/etc/cockpit/origins | sed '/^$/d' | paste -s -d ' ')"
sed -i "s|^Origins = .*$|Origins = ${origins}|g" /etc/cockpit/cockpit.conf
